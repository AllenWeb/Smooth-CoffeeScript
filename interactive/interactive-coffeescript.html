<!DOCTYPE html>
<html manifest="pandoc-template.appcache">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <title>Interactive Smooth CoffeeScript</title>
  <!--[if lt IE 9]>
    <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->
  <style type="text/css">
/*<![CDATA[*/
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode, table.sourceCode pre 
   { margin: 0; padding: 0; border: 0; vertical-align: baseline; border: none; }
td.lineNumbers { border-right: 1px solid #AAAAAA; text-align: right; color: #AAAAAA; padding-right: 5px; padding-left: 5px; }
td.sourceCode { padding-left: 5px; }
code.sourceCode span.kw { color: #007020; font-weight: bold; } 
code.sourceCode span.dt { color: #902000; }
code.sourceCode span.dv { color: #40a070; }
code.sourceCode span.bn { color: #40a070; }
code.sourceCode span.fl { color: #40a070; }
code.sourceCode span.ch { color: #4070a0; }
code.sourceCode span.st { color: #4070a0; }
code.sourceCode span.co { color: #60a0b0; font-style: italic; }
code.sourceCode span.ot { color: #007020; }
code.sourceCode span.al { color: red; font-weight: bold; }
code.sourceCode span.fu { color: #06287e; }
code.sourceCode span.re { }
code.sourceCode span.er { color: red; font-weight: bold; }
/*]]>*/
  </style>
  <link rel="stylesheet" href="pandoc-template.css" />
  <link rel="stylesheet" href="codemirror/codemirror.css" />
  <link rel="stylesheet" href="codemirror/pantheme.css" />
</head>
<body>
<div id="feature-detect">
  <div id="feature-javascript" style="color:#FF0000; display: block">
No JavaScript &rarr; no output and no interactivity.  </div>
  <div id="feature-mathml" style="color:#FF0000; display: none">
No MathML 1998 &rarr; math is not readable.  </div>
  <div id="feature-canvas" style="color:#FF0000; display: none">
No Canvas &rarr; graphical output is not rendered.  </div>
  <div id="feature-contenteditable" style="color:#FF0000; display: none">
No ContentEditable &rarr; CoffeeScript sections can not be changed.  </div>
</div>
<input class="field" type="button" value="Adjust layout" onclick="(function () {
        return this.value = toggleLayout() ? 'Layout: fixed' : 'Layout: freeflow';
      }).call(this);" />
<input class="field" type="button" value="Select editor" onclick="(function () {
        return this.value = switchEditor() ? 'Editor: CodeMirror' : 'Editor: plain text';
      }).call(this);" />
<input class="field" type="button" value="Evaluation" onclick="(function () {
        return this.value = switchEvaluation() ? '↑ ↩  Evaluate' : 'Auto Evaluate';
      }).call(this);" />
<script src="node_modules/coffee-script.js"></script>
<script src="node_modules/coffeekup.js"></script>
<script src="node_modules/underscore.js"></script>
<script src="node_modules/qc.js"></script>
<script src="codemirror/codemirror.js"></script>
<script src="codemirror/coffeescript.js"></script>
<script>var __slice = Array.prototype.slice;var __hasProp = Object.prototype.hasOwnProperty;var __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };var __extends = function(child, parent) {  for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; }  function ctor() { this.constructor = child; }  ctor.prototype = parent.prototype; child.prototype = new ctor; child.__super__ = parent.prototype;  return child; };var __indexOf = Array.prototype.indexOf || function(item) {  for (var i = 0, l = this.length; i < l; i++) {    if (this[i] === item) return i;  } return -1; };(function () {
      var featureDetect, switchLayout;
      this.reveal = function(instance) {
        var _ref, _ref2;
        if ((_ref = instance.getElementsByTagName('section')[0]) != null) {
          _ref.style.display = 'block';
        }
        if ((_ref2 = instance.getElementsByTagName('h5')[0]) != null) {
          _ref2.innerHTML = 'Solution';
        }
        return instance.onclick = void 0;
      };
      this.switchEditor = function() {
        if (typeof localStorage !== "undefined" && localStorage !== null) {
          localStorage.editor = this.useCodeMirror ? 'TextArea' : 'CodeMirror';
        }
        return this.useCodeMirror = !this.useCodeMirror;
      };
      this.switchEvaluation = function() {
        if (typeof localStorage !== "undefined" && localStorage !== null) {
          localStorage.evaluation = (typeof localStorage !== "undefined" && localStorage !== null ? localStorage.evaluation : void 0) === 'manual' ? 'automatic' : 'manual';
        }
        return (typeof localStorage !== "undefined" && localStorage !== null ? localStorage.evaluation : void 0) === 'manual';
      };
      this.toggleLayout = function() {
        var fixedLayout;
        fixedLayout = document.getElementById('page').style.maxWidth === '';
        if (typeof localStorage !== "undefined" && localStorage !== null) {
          localStorage.fixedLayout = fixedLayout;
        }
        return switchLayout(fixedLayout);
      };
      switchLayout = function(fixedLayout) {
        var s;
        document.getElementById('page').style.maxWidth = fixedLayout ? '600px' : '';
        s = document.getElementById('page').style;
        if (fixedLayout) {
          s.webkitHyphens = 'auto';
          s.mozHyphens = 'auto';
          s.msHyphens = 'auto';
          s.hyphens = 'auto';
          s.textAlign = 'justify';
        } else {
          s.webkitHyphens = '';
          s.mozHyphens = '';
          s.msHyphens = '';
          s.hyphens = '';
          s.textAlign = '';
        }
        return fixedLayout;
      };
      featureDetect = function() {
        var adjustCoverPosition, mathmlDetect, used, _ref, _ref2, _ref3, _ref4, _ref5;
        adjustCoverPosition = function(idFeature) {
          var canvasCover, lineHeight, topPos, _ref;
          canvasCover = document.getElementById('drawCanvas');
          topPos = parseInt(canvasCover != null ? canvasCover.style.top : void 0);
          lineHeight = (_ref = document.getElementById(idFeature)) != null ? _ref.scrollHeight : void 0;
          return canvasCover != null ? canvasCover.style.top = (topPos + lineHeight) + 'px' : void 0;
        };
        mathmlDetect = function() {
          var e, passed;
          (e = document.createElement('div')).innerHTML = '<math></math>';
          passed = e.firstChild && 'namespaceURI' in e.firstChild && e.firstChild.namespaceURI === 'http://www.w3.org/1998/Math/MathML';
          return passed && !/Chrome/.test(navigator.userAgent);
        };
        if ((_ref = document.getElementById('feature-javascript')) != null) {
          _ref.style.display = "none";
        }
        used = ((_ref2 = document.getElementsByTagName('math')) != null ? _ref2.length : void 0) > 0;
        if (used && mathmlDetect() === false) {
          if ((_ref3 = document.getElementById('feature-mathml')) != null) {
            _ref3.style.display = "block";
          }
          adjustCoverPosition('feature-mathml');
        }
        if (document.createElement('canvas').getContext == null) {
          if ((_ref4 = document.getElementById('feature-canvas')) != null) {
            _ref4.style.display = "block";
          }
          adjustCoverPosition('feature-canvas');
        }
        if (!('isContentEditable' in document.documentElement)) {
          if ((_ref5 = document.getElementById('feature-contenteditable')) != null) {
            _ref5.style.display = "block";
          }
          return adjustCoverPosition('feature-contenteditable');
        }
      };
      return window.onload = function() {
        var activateEditor, addElement, addFrame, canvas, clearCanvas, cmAutoEvaluation, cmEvaluation, cmManualEvaluation, createEditor, drawCanvas, evaluateSource, getParent, keyDownEvaluation, keyUpEvaluation, segment, separator, showDocumentHere, showHere, _i, _len, _ref;
        featureDetect();
        if ((typeof localStorage !== "undefined" && localStorage !== null ? localStorage.fixedLayout : void 0) !== 'false') {
          switchLayout(true);
        }
        this.useCodeMirror = (typeof localStorage !== "undefined" && localStorage !== null ? localStorage.editor : void 0) === 'CodeMirror';
        canvas = document.getElementById('drawCanvas');
        if (canvas != null) window.ctx = canvas.getContext('2d');
        clearCanvas = function() {
          if (window.ctx != null) {
            return window.ctx.clearRect(0, 0, window.ctx.canvas.width, window.ctx.canvas.height);
          }
        };
        drawCanvas = function(draw) {
          clearCanvas();
          return draw(window.ctx);
        };
        getParent = function(child) {
          var _ref;
          return (_ref = child != null ? child.parentElement : void 0) != null ? _ref : child != null ? child.parentNode : void 0;
        };
        addElement = function(parent, text) {
          var newelem;
          newelem = document.createElement('code');
          newelem.setAttribute('class', 'sourceCode output');
          newelem.innerHTML = text;
          return parent.appendChild(newelem);
        };
        separator = function(parent) {
          if (parent.getElementsByClassName('output').length === 0) {
            return addElement(parent, '<hr><br>');
          }
        };
        addFrame = function(parent, width, height, content) {
          var newelem;
          newelem = document.createElement('iframe');
          newelem.setAttribute('class', 'output');
          newelem.setAttribute('width', width);
          newelem.setAttribute('height', height);
          newelem.setAttribute('src', "data:text/html;charset=utf-8," + (encodeURIComponent(content)));
          newelem.innerHTML = '<div id="feature-dataurl" style="color:#FF0000; display: block">\nNo or insufficient Data URL support &rarr;\nweb page output is not rendered in this browser.</div>';
          return parent.appendChild(newelem);
        };
        showHere = function(atTag, obj, shallow, symbol) {
          var displayShallow, msg, parentTag;
          if (shallow == null) shallow = false;
          if (symbol == null) symbol = '&rarr;';
          displayShallow = function(o) {
            var k, v;
            return "{" + ((function() {
              var _results;
              _results = [];
              for (k in o) {
                if (!__hasProp.call(o, k)) continue;
                v = o[k];
                _results.push("\n  " + k + ": " + v);
              }
              return _results;
            })()) + "\n}";
          };
          msg = (function() {
            switch (typeof obj) {
              case 'undefined':
              case 'string':
              case 'function':
                return obj;
              case 'object':
                if (shallow) {
                  return displayShallow(obj);
                } else {
                  try {
                    return JSON.stringify(obj);
                  } catch (err) {
                    return displayShallow(obj);
                  }
                }
                break;
              default:
                return obj != null ? obj.toString() : void 0;
            }
          })();
          parentTag = getParent(atTag);
          separator(parentTag);
          addElement(parentTag, "" + symbol + " " + msg + "<br>");
          return obj;
        };
        showDocumentHere = function(atTag, content, width, height) {
          var parentTag;
          if (width == null) width = 300;
          if (height == null) height = 300;
          parentTag = getParent(atTag);
          separator(parentTag);
          addFrame(parentTag, width, height, content);
        };
        evaluateSource = function(field) {
          var HtmlListener, addErrorElement, codeSegment, codeTag, confirm, currentSegment, currentTag, elem, getCode, getCurrentTagId, i, incredibleIndex, incredibleLength, incredibleStart, incredibleTime, outLength, outList, prompt, qcConfig, runOnDemand, segment, segments, test, testPure, view, _fn, _i, _len, _len2;
          if (field == null) field = null;
          show = function(obj, shallow, symbol) {
            if (shallow == null) shallow = false;
            if (symbol == null) symbol = '&rarr;';
            showHere(currentTag, obj, shallow, symbol);
          };
          view = function(obj, shallow, symbol) {
            if (shallow == null) shallow = false;
            if (symbol == null) symbol = '&rarr;';
            return showHere(currentTag, obj, shallow, symbol);
          };
          showDocument = function(content, width, height) {
            if (width == null) width = 300;
            if (height == null) height = 300;
            return showDocumentHere(currentTag, content, width, height);
          };
          addErrorElement = function(text) {
            return show("<span class=\"er\">" + text + "</span>");
          };
          getCurrentTagId = function(id) {
            return id.match(/button-\w+-(.*)/)[1];
          };
          runOnDemand = function(func) {
            show("<button id='button-run-" + currentTag.id + "'> Run </button>");
            document.getElementById("button-run-" + currentTag.id).onclick = function() {
              var currentTag;
              currentTag = document.getElementById(getCurrentTagId(this.id));
              view = show = function(obj, shallow, symbol) {
                if (shallow == null) shallow = false;
                if (symbol == null) symbol = '&rArr;';
                return showHere(currentTag, obj, shallow, symbol);
              };
              showDocument = function(content, width, height) {
                if (width == null) width = 300;
                if (height == null) height = 300;
                return showDocumentHere(currentTag, content, width, height);
              };
              return func();
            };
          };
          confirm = function(message, func) {
            show(("" + message) + ("  <button id='button-yes-" + currentTag.id + "'> Yes </button>") + ("  <button id='button-no-" + currentTag.id + "'> No </button>"));
            document.getElementById("button-yes-" + currentTag.id).onclick = function() {
              var currentTag;
              currentTag = document.getElementById(getCurrentTagId(this.id));
              view = show = function(obj, shallow, symbol) {
                if (shallow == null) shallow = false;
                if (symbol == null) symbol = '&rArr;';
                return showHere(currentTag, obj, shallow, symbol);
              };
              showDocument = function(content, width, height) {
                if (width == null) width = 300;
                if (height == null) height = 300;
                return showDocumentHere(currentTag, content, width, height);
              };
              return func(true);
            };
            document.getElementById("button-no-" + currentTag.id).onclick = function() {
              var currentTag;
              currentTag = document.getElementById(getCurrentTagId(this.id));
              view = show = function(obj, shallow, symbol) {
                if (shallow == null) shallow = false;
                if (symbol == null) symbol = '&rArr;';
                return showHere(currentTag, obj, shallow, symbol);
              };
              showDocument = function(content, width, height) {
                if (width == null) width = 300;
                if (height == null) height = 300;
                return showDocumentHere(currentTag, content, width, height);
              };
              return func(false);
            };
          };
          prompt = function(message, defaultValue, func) {
            show(("" + message) + ("  <input id='input-prompt-" + currentTag.id + "' value='" + defaultValue + "' />") + ("  <button id='button-prompt-" + currentTag.id + "'> Go </button>"));
            document.getElementById("button-prompt-" + currentTag.id).onclick = function() {
              var currentTag;
              currentTag = document.getElementById(getCurrentTagId(this.id));
              view = show = function(obj, shallow, symbol) {
                if (shallow == null) shallow = false;
                if (symbol == null) symbol = '&rArr;';
                return showHere(currentTag, obj, shallow, symbol);
              };
              showDocument = function(content, width, height) {
                if (width == null) width = 300;
                if (height == null) height = 300;
                return showDocumentHere(currentTag, content, width, height);
              };
              return func(document.getElementById("input-prompt-" + (getCurrentTagId(this.id))).value);
            };
          };
          HtmlListener = (function(_super) {

            __extends(HtmlListener, _super);

            function HtmlListener(maxCollected) {
              this.maxCollected = maxCollected != null ? maxCollected : 10;
            }

            HtmlListener.prototype.log = function(str) {
              return show(str);
            };

            HtmlListener.prototype.passed = function(str) {
              return show("<span class=\"kw\">" + str + "</span>");
            };

            HtmlListener.prototype.invalid = function(str) {
              return show("<span class=\"dt\">" + str + "</span>");
            };

            HtmlListener.prototype.failure = function(str) {
              return show("<span class=\"al\">" + str + "</span>");
            };

            HtmlListener.prototype.done = function() {
              show('Completed test.');
              return resetProps();
            };

            return HtmlListener;

          })(ConsoleListener);
          Case.prototype.note = function(a) {
            this.noteArg(a);
            return a;
          };
          Case.prototype.noteVerbose = function(a) {
            this.noteArg(a);
            show(this.args);
            return a;
          };
          testPure = function(func, types, name, property) {
            declare(name, types, function() {
              var a, c;
              c = arguments[0], a = 2 <= arguments.length ? __slice.call(arguments, 1) : [];
              return c.assert(property.apply(null, [c].concat(__slice.call(a), [c.note(func.apply(null, a))])));
            });
          };
          qcConfig = new Config(100, 1000);
          test = function(msg, func) {
            return _.each([msg, func, runAllProps(qcConfig, new HtmlListener)], function(o) {
              if (!_.isUndefined(o)) return show(o);
            });
          };
          getCode = function(codeTag) {
            var code, segment;
            if (codeTag.value != null) {
              segment = codeTag.value;
            } else {
              segment = codeTag.innerHTML;
            }
            code = segment.replace(/<br>/g, '\n');
            code = code.replace(/<[\/]?span[^>]*>/g, '');
            code = code.replace(/[&]gt;/g, '>');
            code = code.replace(/[&]lt;/g, '<');
            code = code.replace(/[&]nbsp;/g, ' ');
            return {
              codeTag: codeTag,
              code: code
            };
          };
          if ((field != null) && this.incrementalEvaluation) {
            segments = [getCode(field)];
          } else {
            segments = (function() {
              var _i, _len, _ref, _results;
              _ref = window.document.getElementsByTagName('pre');
              _results = [];
              for (_i = 0, _len = _ref.length; _i < _len; _i++) {
                codeSegment = _ref[_i];
                if (codeSegment.className === 'sourceCode') {
                  codeTag = codeSegment.firstChild;
                  if (codeTag.className === 'sourceCode coffeescript' || codeTag.className === 'sourceCode CoffeeScript') {
                    _results.push(getCode(codeTag));
                  } else {
                    _results.push(void 0);
                  }
                } else {
                  _results.push(void 0);
                }
              }
              return _results;
            })();
            segments = (function() {
              var _i, _len, _results;
              _results = [];
              for (_i = 0, _len = segments.length; _i < _len; _i++) {
                segment = segments[_i];
                if (segment != null) _results.push(segment);
              }
              return _results;
            })();
            for (i = 0, _len = segments.length; i < _len; i++) {
              segment = segments[i];
              if (i > 0 && /^[\s]/.test(segment.code)) {
                segment.code = segments[i - 1].code + '\n' + segment.code;
                segments[i - 1] = void 0;
              }
            }
            segments = (function() {
              var _i, _len2, _results;
              _results = [];
              for (_i = 0, _len2 = segments.length; _i < _len2; _i++) {
                segment = segments[_i];
                if (segment != null) _results.push(segment);
              }
              return _results;
            })();
          }
          for (_i = 0, _len2 = segments.length; _i < _len2; _i++) {
            segment = segments[_i];
            outList = getParent(segment.codeTag).getElementsByClassName('output');
            outLength = outList != null ? outList.length : void 0;
            while (outList && outLength > 0) {
              elem = outList[--outLength];
              getParent(elem).removeChild(elem);
            }
          }
          incredibleLength = segments.length;
          _fn = function(currentTag) {
            var draw, incredibleResult, magic, promoteToGlobal, _j, _len3, _ref;
            try {
              draw = void 0;
              incredibleResult = eval(CoffeeScript.compile(currentSegment.code, {
                bare: true
              }));
              if (draw != null) drawCanvas(draw);
              if (incredibleResult !== void 0 && typeof incredibleResult !== 'function') {
                show(incredibleResult, true, '&crarr;');
              }
              if (typeof globalNames !== "undefined" && globalNames !== null) {
                promoteToGlobal = function(magic) {
                  var magicValue;
                  try {
                    magicValue = eval(magic);
                  } catch (error) {
                    return;
                  }
                  return this[magic] = magicValue;
                };
                _ref = globalNames.split(' ');
                for (_j = 0, _len3 = _ref.length; _j < _len3; _j++) {
                  magic = _ref[_j];
                  promoteToGlobal(magic);
                }
              }
            } catch (error) {
              console.log(error.message);
              addErrorElement(error);
            }
          };
          for (incredibleIndex = 0; incredibleIndex < incredibleLength; incredibleIndex += 1) {
            incredibleStart = new Date();
            currentSegment = segments[incredibleIndex];
            currentTag = currentSegment.codeTag;
            if (currentTag.id === '') currentTag.id = "codeTag" + incredibleIndex;
            _fn(currentTag);
            if ((typeof showTiming !== "undefined" && showTiming !== null) && showTiming === true) {
              incredibleTime = Number(0.001 * (new Date() - incredibleStart)).toFixed(3);
              show("" + incredibleTime + "s", true, '☕');
            }
          }
        };
        keyDownEvaluation = function(evt) {
          var _ref;
          if (evt == null) return;
          if ((typeof localStorage !== "undefined" && localStorage !== null ? localStorage.evaluation : void 0) === 'manual') {
            if (evt.keyCode === 13 && evt.shiftKey) {
              evt.preventDefault();
              evaluateSource(evt.currentTarget);
            }
          }
          if (evt.keyCode === 13 && !evt.shiftKey) {
            if ((_ref = evt.target) != null) _ref.rows++;
          }
        };
        keyUpEvaluation = function(evt) {
          var _ref;
          if (evt == null) return;
          if ((typeof localStorage !== "undefined" && localStorage !== null ? localStorage.evaluation : void 0) !== 'manual') {
            if ((_ref = evt.keyCode) !== 16 && _ref !== 37 && _ref !== 38 && _ref !== 39 && _ref !== 40) {
              return evaluateSource(evt.currentTarget);
            }
          }
        };
        cmEvaluation = function(editor) {
          editor.save();
          return evaluateSource(editor.getTextArea());
        };
        cmAutoEvaluation = function(editor) {
          if ((typeof localStorage !== "undefined" && localStorage !== null ? localStorage.evaluation : void 0) !== 'manual') {
            return cmEvaluation(editor);
          }
        };
        cmManualEvaluation = function(editor) {
          if ((typeof localStorage !== "undefined" && localStorage !== null ? localStorage.evaluation : void 0) === 'manual') {
            return cmEvaluation(editor);
          }
        };
        createEditor = function(codeElement, text) {
          var c, countLines, elemCodeMirror, newelem;
          newelem = document.createElement('textarea');
          newelem.setAttribute('id', codeElement.id);
          newelem.setAttribute('class', codeElement.getAttribute('class'));
          countLines = ((function() {
            var _i, _len, _results;
            _results = [];
            for (_i = 0, _len = text.length; _i < _len; _i++) {
              c = text[_i];
              if (c === '\n') _results.push(c);
            }
            return _results;
          })()).length + 1;
          newelem.setAttribute('rows', countLines);
          newelem.setAttribute('style', 'width: 98%;');
          newelem.setAttribute('autofocus', 'true');
          newelem.setAttribute('spellcheck', 'false');
          newelem.innerHTML = text;
          newelem.addEventListener('keydown', keyDownEvaluation, false);
          newelem.addEventListener('keyup', keyUpEvaluation, false);
          getParent(codeElement).replaceChild(newelem, codeElement);
          if (this.useCodeMirror) {
            return elemCodeMirror = CodeMirror.fromTextArea(newelem, {
              onChange: cmAutoEvaluation,
              extraKeys: {
                'Shift-Enter': cmManualEvaluation
              },
              lineNumbers: true,
              theme: 'pantheme'
            });
          }
        };
        activateEditor = function() {
          var sourcecode;
          this.removeEventListener('focus', activateEditor, false);
          sourcecode = this.innerHTML.toString().replace(/<\/?span[^>]*>/g, '');
          sourcecode = sourcecode.replace(/<br[ ]*[^>]*>/g, '\n');
          return createEditor(this, sourcecode);
        };
        _ref = document.getElementsByTagName('pre');
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          segment = _ref[_i];
          segment.firstChild.addEventListener('focus', activateEditor, false);
        }
        this.incrementalEvaluation = false;
        return evaluateSource();
      };
    }).call(this);</script>

<div id="page">
<!-- Formatting commands for acme using ssam & pandoc:
Edit ,>pandoc -f markdown -t html -S -5 --mathml --section-divs --css pandoc-template.css --css codemirror/codemirror.css --css codemirror/pantheme.css --template pandoc-template.html -B grimoire-output.html | ssam 's/(<code class="sourceCode [cC]offee[sS]cript")/\1 contenteditable=\"true\" spellcheck=\"false\"/g' | ssam 's/(<section id="view-solution[0-9\-]*")(>)(\n.*\n)(<section id="section[0-9\-]*")(>)/\1 onclick=\"reveal(this)\" \2\3\4 style=\"display:none\" \5/g' | ssam 's/<img src=\"[^\"]+\" alt=\"[^\"]+\" \/>/<canvas id=\"drawCanvas\" width=\"320\" height=\"320\" style=\"position: absolute; top: 333px; left: 200px\"><\/canvas>/' | ssam 's/(<p)(><img)/\1 align=center\2/g' >interactive-coffeescript.html; open interactive-coffeescript.html; plumb interactive-coffeescript.html
|tr A-Z a-z |tr a-z A-Z |fmt |a+ |a-
Edit ,x/^~~+[   ]*{\.[cC]offee[sS]cript.*}$/+,/^~~+$/-p
Edit ,>ssam -n 'x/^~~+[   ]*{\.[cC]offee[sS]cript.*}$/+,/^~~+$/-' |cat embed-standalone.coffee - |tee interactive-coffeescript.coffee | coffee -cs >interactive-coffeescript.js; coffee interactive-coffeescript.coffee >interactive-coffeescript.output; plumb interactive-coffeescript.output
Edit ,>markdown2pdf --listings --xetex '--template=pandoc-template.tex' -o interactive-coffeescript.pdf; open interactive-coffeescript.pdf
-->

<section id="section">
<h5></h5>
<p><canvas id="drawCanvas" width="320" height="320" style="position: absolute; top: 333px; left: 200px"></canvas><br /> <img src="../img/SmoothCoverInteractive.png" alt="Smooth Cover" /><br /> Scratch card disclaimer: Using a coin may cause damage to your screen.</p>
</section>
<section id="view-solution" onclick="reveal(this)" >
<h5>View Solution</h5>
<section id="section-1" style="display:none" >
<h6></h6>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">draw <span class="kw">=</span> <span class="fu">(ctx) -&gt;</span> <span class="co"># ctx is an HTML5 Canvas context</span><br />  <span class="kw">class</span> <span class="dt">Point</span><br />    <span class="kw">constructor</span><span class="kw">:</span> <span class="fu">(@x, @y) -&gt;</span><br />    drawDisc<span class="kw">:</span> <span class="fu">(context, style, size = 10) -&gt;</span><br />      context<span class="kw">.</span>beginPath<span class="kw">()</span><br />      context<span class="kw">.</span>fillStyle <span class="kw">=</span> style<br />      context<span class="kw">.</span>arc @x<span class="kw">,</span> @y<span class="kw">,</span> size<span class="kw">,</span> <span class="dv">0</span><span class="kw">,</span> <span class="dv">2</span><span class="kw">*</span><span class="ot">Math</span><span class="kw">.</span>PI<span class="kw">,</span> <span class="ot">false</span><br />      context<span class="kw">.</span>fill<span class="kw">()</span><br /><br />  renderInStyle <span class="kw">=</span> <span class="fu">(context, {back, front}, render) -&gt;</span><br />    background <span class="kw">=</span> <span class="fu">(context, style) -&gt;</span><br />      context<span class="kw">.</span>beginPath<span class="kw">()</span><br />      context<span class="kw">.</span>fillStyle <span class="kw">=</span> style<br />      context<span class="kw">.</span>fillRect <span class="dv">0</span><span class="kw">,</span> <span class="dv">0</span><span class="kw">,</span><br />        context<span class="kw">.</span>canvas<span class="kw">.</span>width<span class="kw">,</span> context<span class="kw">.</span>canvas<span class="kw">.</span>height<br />    background context<span class="kw">,</span> back<br />    context<span class="kw">.</span>beginPath<span class="kw">()</span><br />    context<span class="kw">.</span>fillStyle <span class="kw">=</span> front<br />    render<span class="kw">()</span><br /><br />  drawDrabSurface <span class="kw">=</span> <span class="fu">(context, font, text, style) -&gt;</span><br />    drawRepeatRotated <span class="kw">=</span> <span class="fu">(angle = 0.2) -&gt;</span><br />      context<span class="kw">.</span>save<span class="kw">()</span><br />      context<span class="kw">.</span>rotate angle<br />      context<span class="kw">.</span>font <span class="kw">=</span> font<br />      distance <span class="kw">=</span> <span class="dv">2</span> <span class="kw">*</span> <span class="ot">parseInt</span> font<span class="kw">,</span> <span class="dv">10</span><br />      textWidth <span class="kw">=</span> context<span class="kw">.</span>measureText<span class="kw">(</span>text<span class="kw">).</span>width<br />      height <span class="kw">=</span> context<span class="kw">.</span>canvas<span class="kw">.</span>height<br />      <span class="kw">for</span> x <span class="kw">in</span> <span class="kw">[</span><span class="dv">0</span><span class="kw">...</span>context<span class="kw">.</span>canvas<span class="kw">.</span>width<span class="kw">]</span> <span class="kw">by</span> textWidth<br />        <span class="kw">for</span> y <span class="kw">in</span> <span class="kw">[-</span>height<span class="kw">...</span>height<span class="kw">]</span> <span class="kw">by</span> distance<br />          context<span class="kw">.</span>fillText text<span class="kw">,</span> x<span class="kw">,</span> y<br />      context<span class="kw">.</span>restore<span class="kw">()</span><br />    renderInStyle context<span class="kw">,</span> style<span class="kw">,</span> drawRepeatRotated<br /><br />  drawPreciousBrush <span class="kw">=</span> <span class="fu">(context, lines, style) -&gt;</span><br />    createCanvasContext <span class="kw">=</span> <span class="fu">({width, height}) -&gt;</span><br />      canvas <span class="kw">=</span> document<span class="kw">.</span>createElement <span class="st">'canvas'</span><br />      <span class="kw">[</span>canvas<span class="kw">.</span>width<span class="kw">,</span> canvas<span class="kw">.</span>height<span class="kw">]</span> <span class="kw">=</span> <span class="kw">[</span>width<span class="kw">,</span> height<span class="kw">]</span><br />      canvas<span class="kw">.</span>getContext <span class="st">'2d'</span><br />    ctxBrush <span class="kw">=</span> createCanvasContext context<span class="kw">.</span>canvas<br />    renderInStyle ctxBrush<span class="kw">,</span> style<span class="kw">,</span> <span class="fu">-&gt;</span><br />      <span class="kw">for</span> <span class="kw">{</span>text<span class="kw">,</span> font<span class="kw">,</span> x<span class="kw">,</span> y<span class="kw">}</span> <span class="kw">in</span> lines<br />        ctxBrush<span class="kw">.</span>font <span class="kw">=</span> font<br />        ctxBrush<span class="kw">.</span>fillText text<span class="kw">,</span> x<span class="kw">,</span> y<br />      <span class="kw">return</span><br />    context<span class="kw">.</span>createPattern ctxBrush<span class="kw">.</span>canvas<span class="kw">,</span> <span class="st">'repeat'</span><br /><br />  <span class="co"># Slight obfuscation. The ... converts an array to arguments</span><br />  decode <span class="kw">=</span> <span class="fu">(nums) -&gt;</span> <span class="ot">String</span><span class="kw">.</span>fromCharCode nums<span class="kw">...</span><br />  <span class="kw">[</span>smallFont<span class="kw">,</span> bigFont<span class="kw">]</span> <span class="kw">=</span> <span class="kw">[</span><span class="st">'12px sans-serif'</span><span class="kw">,</span><span class="st">'52px sans-serif'</span><span class="kw">]</span><br />  surfaceText <span class="kw">=</span> <span class="st">'CoffeeScript   &#10037;   Scratch Card  &#10037;  '</span><br />  hidden <span class="kw">=</span> <span class="kw">[{</span>x<span class="kw">:</span><span class="dv">15</span><span class="kw">,</span> y<span class="kw">:</span><span class="dv">100</span><span class="kw">,</span> font<span class="kw">:</span> bigFont<span class="kw">,</span> text<span class="kw">:</span> decode \<br />              <span class="kw">[</span><span class="dv">67</span><span class="kw">,</span><span class="dv">111</span><span class="kw">,</span><span class="dv">102</span><span class="kw">,</span><span class="dv">102</span><span class="kw">,</span><span class="dv">101</span><span class="kw">,</span><span class="dv">101</span><span class="kw">,</span><span class="dv">83</span><span class="kw">,</span><span class="dv">99</span><span class="kw">,</span><span class="dv">114</span><span class="kw">,</span><span class="dv">105</span><span class="kw">,</span><span class="dv">112</span><span class="kw">,</span><span class="dv">116</span><span class="kw">]}</span><br />            <span class="kw">{</span>x<span class="kw">:</span><span class="dv">80</span><span class="kw">,</span> y<span class="kw">:</span><span class="dv">180</span><span class="kw">,</span> font<span class="kw">:</span> bigFont<span class="kw">,</span> text<span class="kw">:</span> decode \<br />              <span class="kw">[</span><span class="dv">73</span><span class="kw">,</span><span class="dv">116</span><span class="kw">,</span><span class="dv">39</span><span class="kw">,</span><span class="dv">115</span><span class="kw">,</span><span class="dv">32</span><span class="kw">,</span><span class="dv">106</span><span class="kw">,</span><span class="dv">117</span><span class="kw">,</span><span class="dv">115</span><span class="kw">,</span><span class="dv">116</span><span class="kw">]}</span><br />            <span class="kw">{</span>x<span class="kw">:</span><span class="dv">30</span><span class="kw">,</span> y<span class="kw">:</span><span class="dv">260</span><span class="kw">,</span> font<span class="kw">:</span> bigFont<span class="kw">,</span> text<span class="kw">:</span> decode \<br />              <span class="kw">[</span><span class="dv">74</span><span class="kw">,</span><span class="dv">97</span><span class="kw">,</span><span class="dv">118</span><span class="kw">,</span><span class="dv">97</span><span class="kw">,</span><span class="dv">83</span><span class="kw">,</span><span class="dv">99</span><span class="kw">,</span><span class="dv">114</span><span class="kw">,</span><span class="dv">105</span><span class="kw">,</span><span class="dv">112</span><span class="kw">,</span><span class="dv">116</span><span class="kw">,</span><span class="dv">33</span><span class="kw">]}</span><br />            <span class="kw">{</span>x<span class="kw">:</span><span class="dv">190</span><span class="kw">,</span> y<span class="kw">:</span><span class="dv">310</span><span class="kw">,</span> font<span class="kw">:</span> smallFont<span class="kw">,</span> text<span class="kw">:</span> decode \<br />              <span class="kw">[</span><span class="dv">68</span><span class="kw">,</span><span class="dv">79</span><span class="kw">,</span><span class="dv">85</span><span class="kw">,</span><span class="dv">66</span><span class="kw">,</span><span class="dv">76</span><span class="kw">,</span><span class="dv">69</span><span class="kw">,</span><span class="dv">80</span><span class="kw">,</span><span class="dv">76</span><span class="kw">,</span><span class="dv">85</span><span class="kw">,</span><span class="dv">83</span><span class="kw">,</span><span class="dv">71</span><span class="kw">,</span><span class="dv">79</span><span class="kw">,</span><span class="dv">79</span><span class="kw">,</span><span class="dv">68</span><span class="kw">]}]</span><br />  brush <span class="kw">=</span> drawPreciousBrush ctx<span class="kw">,</span> hidden<span class="kw">,</span><br />    back<span class="kw">:</span><span class="st">'darkgrey'</span><span class="kw">,</span> front<span class="kw">:</span><span class="st">'grey'</span><br />  drawDrabSurface ctx<span class="kw">,</span> smallFont<span class="kw">,</span> surfaceText<span class="kw">,</span><br />    back<span class="kw">:</span><span class="st">'silver'</span><span class="kw">,</span> front<span class="kw">:</span><span class="st">'#663300'</span><br /><br />  <span class="co"># Hook the brush up to mouse and touch events</span><br />  ctx<span class="kw">.</span>canvas<span class="kw">.</span>onmousemove <span class="kw">=</span> onmove <span class="kw">=</span> <span class="fu">(evt) -&gt;</span><br />    pos <span class="kw">=</span> <span class="kw">new</span> <span class="dt">Point</span> evt<span class="kw">.</span>pageX <span class="kw">-</span> ctx<span class="kw">.</span>canvas<span class="kw">.</span>offsetLeft<span class="kw">,</span><br />                    evt<span class="kw">.</span>pageY <span class="kw">-</span> ctx<span class="kw">.</span>canvas<span class="kw">.</span>offsetTop<br />    pos<span class="kw">.</span>drawDisc ctx<span class="kw">,</span> brush<br />  ctx<span class="kw">.</span>canvas<span class="kw">.</span>ontouchmove <span class="kw">=</span> ontouch <span class="kw">=</span> <span class="fu">(evt) -&gt;</span><br />    evt<span class="kw">.</span>preventDefault<span class="kw">()</span> <span class="co"># Don't scroll on touch</span><br />    onmove touch <span class="kw">for</span> touch <span class="kw">in</span> evt<span class="kw">.</span>targetTouches<br />    <span class="kw">return</span><br /><br /><span class="co"># The CoffeeScript is about &#8532; the size of the JavaScript.</span><br /><span class="co"># Remove the # sign on the next line to see the JavaScript.</span><br /><span class="co"># show draw</span></code></pre>
</section>
</section>
<section id="section-2">
<h5></h5>
<hr />
</section>
<section id="smooth-coffeescript----interactive-edition">
<h1>Smooth CoffeeScript — Interactive Edition</h1>
<hr />
<p><em>An introduction to programming in CoffeeScript with an emphasis on clarity and abstraction.</em></p>
<p>This edition requires an <a href="#fn2">HTML<sub>5</sub> web browser</a>. It is meant as a <em>gift</em> to welcome you into the wondrous world of programming. You can provide <a href="https://github.com/autotelicum/Smooth-CoffeeScript/issues">feedback</a> or have a look at the ghost in the machine: <a href="./grimoire.html">Grimoire</a>. It is ifself an interactive literate document.</p>
<p>The source of this book is a <a href="https://raw.github.com/autotelicum/Smooth-CoffeeScript/gh-pages/interactive/interactive-coffeescript.md">literate markdown program/document</a> which produces this code: <a href="./interactive-coffeescript.coffee">CoffeeScript</a>, that translates into <a href="./interactive-coffeescript.js">JavaScript</a> and produces this <a href="./interactive-coffeescript.output">output</a>.</p>
<p>The book is <a href="http://creativecommons.org/licenses/by/3.0/">freely (CCBYSA)</a> available, and may be used (as a whole or in parts) in any way you see fit, as long as credit is given to the original author. Interactive edition &amp; illustrations by E. Hoigaard<sup><a href="#fn1" class="footnoteRef" id="fnref1">1</a></sup> © 2555 <a href="http://www.accesstoinsight.org/history.html#fn-1">BE</a> / 2012 <a href="http://www.accesstoinsight.org/history.html#fn-2">CE</a>. Source code, static HTML and PDF editions at: <a href="http://autotelicum.github.com/Smooth-CoffeeScript">http://autotelicum.github.com/Smooth-CoffeeScript</a>.</p>
<section id="section-3">
<h5>○•○</h5>
<br />
<center>
<a href="http://eloquentjavascript.net/">Based on Eloquent JavaScript by Marijn Haverbeke</a>
</center>
<br />
<hr />
</section>
<section id="table-of-contents">
<h3>Table of Contents</h3>
<hr />
<ul>
<li><a href="#part-i.-preface">Part I: Preface</a>
<ul>
<li><a href="#foreword">Foreword</a></li>
<li><a href="#getting-started">Getting Started</a></li>
</ul></li>
<li><a href="#part-ii.-language">Part II: Language</a>
<ul>
<li><a href="#introduction">Introduction</a></li>
<li><a href="#basic-coffeescript">Basic CoffeeScript</a></li>
<li><a href="#functions">Functions</a></li>
<li><a href="#data-structures-objects-and-arrays">Data Structures</a></li>
<li><a href="#error-handling">Error Handling</a></li>
</ul></li>
<li><a href="#part-iii.-paradigm">Part III: Paradigm</a>
<ul>
<li><a href="#functional-programming">Functional Programming</a></li>
<li><a href="#searching">Searching</a></li>
<li><a href="#object-oriented-programming">Object Orientation</a></li>
<li><a href="#regular-expressions">Regular Expressions</a></li>
<li><a href="#modularity">Modularity</a></li>
</ul></li>
<li><a href="#part-iv.-appendix">Part IV: Appendix</a>
<ul>
<li><a href="#language-extras">Language Extras</a></li>
<li><a href="#binary-heaps">Binary Heaps</a></li>
<li><a href="#performance">Performance</a></li>
<li><a href="#command-line-utility">Command Line Utility</a></li>
</ul></li>
<li><a href="#part-v.-reference-and-index">Part V: Reference</a>
<ul>
<li><a href="#language-reference">Language Reference</a></li>
<li><a href="#reserved-words">Reserved Words</a></li>
<li><a href="#underscore">Underscore</a></li>
<li><a href="#quickcheck">QuickCheck</a></li>
<li><a href="#additional-words">Additional Words</a> <!--
Uncommented index since there is no tool support for labels.
Entries marked with [↓](#index-*) have had the ↓ removed.

* [Index](#index)
--></li>
<li><a href="#footnotes">Footnotes</a></li>
</ul></li>
</ul>
<hr />
</section>
<section id="part-i.-preface">
<h2>Part I. Preface</h2>
<hr />
<section id="foreword">
<h3>Foreword</h3>
<hr />
<p>CoffeeScript is a lucid evolution of JavaScript created by Jeremy Ashkenas. This book attempts to be an evolution of “Eloquent JavaScript” by Marijn Haverbeke. Apart from the major change in explaining CoffeeScript instead of JavaScript, numerous other changes have been made and sections have been added, edited or removed.</p>
<p>Everything that is expressed in this book is therefore solely the responsibility of the editor. In the sense of open source software, this book is a <a href="http://en.wikipedia.org/wiki/Fork_(software_development)">fork</a>. To read the excellent original JavaScript work as it was intended by its author refer to <a href="http://eloquentjavascript.net/">Eloquent JavaScript by Marijn Haverbeke</a>.</p>
<p>You do not need to know JavaScript but after reading Smooth CoffeeScript you can in <a href="http://autotelicum.github.com/Smooth-CoffeeScript/literate/js-intro.html">JavaScript Basics</a> by Rebecca Murphey find an overview that can be helpful when debugging or using JavaScript libraries.</p>
<section id="section-4">
<h5>○•○</h5>
<p>The program examples in this book live in an interactive environment where you can change the examples and create new solutions while you learn CoffeeScript. The environment also includes the Underscore functional library, the Coffeekup HTML markup, and <code>qc</code>, a QuickCheck based testing library. These libraries extend CoffeeScript with useful abstractions and testing tools to keep focus on the task at hand instead of distracting boilerplate code.</p>
<p>While it is possible to express programs from a very small set of language primitives, it quickly becomes tedious and error prone to do so. The approach taken here is to include a broader set of functional building blocks as if they were a native part of the programming language. By thinking in terms of these higher level constructs more complex problems can be handled with less effort.</p>
<p>To ensure correctness testing is required. This is especially true when developing reusable algorithms in a dynamic and untyped language. By integrating QuickCheck style test cases as soon as functions are introduced, it is intended that writing tests and declaring assumptions become a seamless part of writing software.</p>
</section>
<section id="section-5">
<h5>○•○</h5>
<p>CoffeeScript is available in browsers and environments where JavaScript is available. The screenshots below show CoffeeScript running the same web server and client application on Mac OS X, Windows and iOS.</p>
<p align=center><img src="../img/TadaOnMacOSX-small.png" alt="figure ../img/TadaOnMacOSX-small.png" /><br /></p>
<p align=center><img src="../img/TadaOnWin7-small.png" alt="figure ../img/TadaOnWin7-small.png" /><br /></p>
<p align=center><img src="../img/TadaOnIOS-small.png" alt="figure ../img/TadaOnIOS-small.png" /><br /></p>
<p>The CoffeeScript below shows the brevity of the self-contained application from the screenshots. It contains an HTML 5 web page in Coffeekup markup and its own HTTP web server. The page has a Canvas element with a drawing of the ‘Seed of Life’. Coffeekup is a few hundred lines of CoffeeScript. No frameworks. No JavaScript. Pure and smooth.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">webdesign <span class="kw">=</span> <span class="fu">-&gt;</span> <br />  doctype <span class="dv">5</span><br />  html <span class="fu">-&gt;</span><br />    head <span class="fu">-&gt;</span><br />      meta charset<span class="kw">:</span> <span class="st">'utf-8'</span><br />      title <span class="st">'My drawing | My awesome website'</span><br />      style <span class="st">'''</span><br /><span class="st">        body {font-family: sans-serif}</span><br /><span class="st">        header, nav, section, footer {display: block}</span><br /><span class="st">      '''</span><br />      coffeescript <span class="fu">-&gt;</span><br />        draw <span class="kw">=</span> <span class="fu">(ctx, x, y) -&gt;</span><br />          circle <span class="kw">=</span> <span class="fu">(ctx, x, y) -&gt;</span><br />            ctx<span class="kw">.</span>beginPath<span class="kw">()</span><br />            ctx<span class="kw">.</span>arc x<span class="kw">,</span> y<span class="kw">,</span> <span class="dv">100</span><span class="kw">,</span> <span class="dv">0</span><span class="kw">,</span> <span class="dv">2</span><span class="kw">*</span><span class="ot">Math</span><span class="kw">.</span>PI<span class="kw">,</span> <span class="ot">false</span><br />            ctx<span class="kw">.</span>stroke<span class="kw">()</span><br />          ctx<span class="kw">.</span>strokeStyle <span class="kw">=</span> <span class="st">'rgba(255,40,20,0.7)'</span><br />          circle ctx<span class="kw">,</span> x<span class="kw">,</span> y<br />          <span class="kw">for</span> angle <span class="kw">in</span> <span class="kw">[</span><span class="dv">0</span><span class="kw">...</span><span class="dv">2</span><span class="kw">*</span><span class="ot">Math</span><span class="kw">.</span>PI<span class="kw">]</span> <span class="kw">by</span> <span class="dv">1</span><span class="kw">/</span><span class="dv">3</span><span class="kw">*</span><span class="ot">Math</span><span class="kw">.</span>PI<br />            circle ctx<span class="kw">,</span> x<span class="dv">+100</span><span class="kw">*</span><span class="ot">Math</span><span class="kw">.</span>cos<span class="kw">(</span>angle<span class="kw">),</span><br />                        y<span class="dv">+100</span><span class="kw">*</span><span class="ot">Math</span><span class="kw">.</span>sin<span class="kw">(</span>angle<span class="kw">)</span><br />        window<span class="kw">.</span>onload <span class="kw">=</span> <span class="fu">-&gt;</span><br />          canvas <span class="kw">=</span> document<span class="kw">.</span>getElementById <span class="st">'drawCanvas'</span><br />          context <span class="kw">=</span> canvas<span class="kw">.</span>getContext <span class="st">'2d'</span><br />          draw context<span class="kw">,</span> <span class="dv">300</span><span class="kw">,</span> <span class="dv">200</span><br />    body <span class="fu">-&gt;</span><br />      header <span class="fu">-&gt;</span> h1 <span class="st">'Seed of Life'</span><br />      canvas id<span class="kw">:</span> <span class="st">'drawCanvas'</span><span class="kw">,</span> width<span class="kw">:</span> <span class="dv">550</span><span class="kw">,</span> height<span class="kw">:</span> <span class="dv">400</span><br /><br />kup <span class="kw">=</span> <span class="kw">if</span> exports<span class="kw">?</span> <span class="kw">then</span> require <span class="st">'coffeekup'</span> <span class="kw">else</span> CoffeeKup<br />webpage <span class="kw">=</span> kup<span class="kw">.</span>render webdesign<span class="kw">,</span> format<span class="kw">:</span><span class="ot">on</span><br />showDocument webpage<span class="kw">,</span> <span class="dv">565</span><span class="kw">,</span> <span class="dv">500</span></code></pre>
<p>An accompanying web server can be written as easy as:</p>
<pre class="sourceCode"><code class="sourceCode COFFEESCRIPT">http <span class="kw">=</span> require <span class="st">'http'</span><br />server <span class="kw">=</span> http<span class="kw">.</span>createServer <span class="fu">(req, res) -&gt;</span><br />  show <span class="st">&quot;</span><span class="ch">#{</span>req.client.remoteAddress<span class="ch">}</span><span class="st"> </span><span class="ch">#{</span>req.method<span class="ch">}</span><span class="st"> </span><span class="ch">#{</span>req.url<span class="ch">}</span><span class="st">&quot;</span><br />  res<span class="kw">.</span>writeHead <span class="dv">200</span><span class="kw">,</span> <span class="st">'Content-Type'</span><span class="kw">:</span> <span class="st">'text/html'</span><br />  res<span class="kw">.</span>write webpage<br />  res<span class="kw">.</span>end<span class="kw">()</span><br />server<span class="kw">.</span>listen <span class="dv">3389</span><br />show <span class="st">'Server running at'</span><br />show  server<span class="kw">.</span>address<span class="kw">()</span></code></pre>
<hr />
</section>
</section>
<section id="getting-started">
<h3>Getting Started</h3>
<hr />
<p>You do not need to install anything to learn CoffeeScript and complete this book … as long as you have an up-to-date standard compliant HTML<sub>5</sub> web browser.<sup><a href="#fn2" class="footnoteRef" id="fnref2">2</a></sup></p>
<p>If you are new to programming then I recommend that you read through the book sequentially and solve the exercises along the way. If you already know JavaScript, then you can choose to read through the language overview at <a href="http://www.coffeescript.org">coffeescript.org</a> and skip forward to solve some of the exercises in the <a href="#part-iii.-paradigm">Paradigm</a> chapters.</p>
<p>In this Interactive Edition almost all examples<sup><a href="#fn3" class="footnoteRef" id="fnref3">3</a></sup> can be edited and the changes you make take effect instantly. To open an editor, touch or click on the program text in the example.</p>
<p>You can choose to disable automatic evaluation in the menu at the top of this page; then you will have to use a keystroke combination instead.<sup><a href="#fn4" class="footnoteRef" id="fnref4">4</a></sup> There you can also choose between editing in a plain text area or with the embedded CodeMirror editor. If you have a compatible browser then try the CodeMirror option — it has syntax highlighting and semi-automatic indentation.</p>
<blockquote>
<p><strong>Tip</strong>: Some browsers may become unresponsive when running for example a never ending loop — so save work you may have in other tabs before proceeding. Should it happen then refresh this web page or restart your browser.</p>
</blockquote>
<p>Some of the examples in the last chapter of the book show WebSockets — it is optional but to run them you need a <a href="../literate/web-socket-status.html">compatible browser</a> and CoffeeScript on your system. Installing CoffeeScript on Windows and Mac OS X is easy, see the couple of steps involved in <a href="../literate/install-notes.html">Quick CoffeeScript Install</a>. You get a Read-Eval-Print-Loop (REPL), a commandline interpreter and compiler that can watch for file changes and compile your CoffeeScript modules whenever you save them.</p>
<section id="section-6">
<h5>○•○</h5>
<p>You will encounter some functions and symbols that are not part of CoffeeScript when you read through the rest of the book. They are needed to run the interactive environment and are explained as they are introduced. The following tables summarize them:</p>
<hr />
<table>
<thead>
<tr class="header">
<th style="align: center">Function</th>
<th style="align: left">Action</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="align: center"><code>show</code>/<code>view</code></td>
<td style="align: left">serialized object without or with a return value</td>
</tr>
<tr class="even">
<td style="align: center"><code>showDocument</code></td>
<td style="align: left">embeds an HTML web page inside this web page</td>
</tr>
<tr class="odd">
<td style="align: center"><code>runOnDemand</code></td>
<td style="align: left">creates a ‘Run’ button; click it to try the code</td>
</tr>
<tr class="even">
<td style="align: center"><code>confirm</code></td>
<td style="align: left">displays a question and ‘Yes’ and ‘No’ buttons</td>
</tr>
<tr class="odd">
<td style="align: center"><code>prompt</code></td>
<td style="align: left">displays a message and an input field</td>
</tr>
</tbody>
</table>
<hr />
<table>
<thead>
<tr class="header">
<th style="align: center">Symbol</th>
<th style="align: left">Explanation</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="align: center"><code>→</code></td>
<td style="align: left">normal output from <code>show</code>/<code>view</code> functions</td>
</tr>
<tr class="even">
<td style="align: center"><code>⇒</code></td>
<td style="align: left">asynchronous output from display functions</td>
</tr>
<tr class="odd">
<td style="align: center"><code>↵</code></td>
<td style="align: left">return value from an executed code block</td>
</tr>
<tr class="even">
<td style="align: center"><code>☕</code></td>
<td style="align: left">timing information if enabled</td>
</tr>
</tbody>
</table>
<hr />
<p><strong>Included software</strong></p>
<ul>
<li><p>The CoffeeScript language (MIT) from <a href="http://www.coffeescript.org">Jeremy Ashkenas</a></p></li>
<li><p>The Underscore library (MIT) from <a href="http://documentcloud.github.com/underscore/">DocumentCloud</a></p></li>
<li><p>The Coffeekup library (MIT) from <a href="http://coffeekup.org/">Maurice Machado</a></p></li>
<li><p>The <code>qc</code> testing library (BSD) from <a href="https://bitbucket.org/darrint/qc.js/">Darrin Thompson</a></p></li>
</ul>
<hr />
<p><strong>Software version details</strong></p>
</section>
<section id="view-solution-1" onclick="reveal(this)" >
<h5>View Solution</h5>
<section id="section-7" style="display:none" >
<h6></h6>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">show <span class="st">&quot;&quot;&quot;</span><br /><span class="st">  Library            Version</span><br /><span class="st">------------------   -------------</span><br /><span class="st">Coffeescript         </span><span class="ch">#{</span>CoffeeScript.VERSION<span class="ch">}</span><br /><span class="st">Underscore           </span><span class="ch">#{</span>_.VERSION<span class="ch">}</span><br /><span class="st">CoffeeKup            </span><span class="ch">#{</span>CoffeeKup.version<span class="ch">}</span><br /><span class="st">QuickCheck           qc.js-2009&quot;&quot;&quot;</span></code></pre>
</section>
<section id="section-8">
<h6></h6>
<hr />
<p><strong>Interactive environment details</strong></p>
</section>
</section>
<section id="view-solution-2" onclick="reveal(this)" >
<h5>View Solution</h5>
<section id="section-9" style="display:none" >
<h6></h6>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false"><span class="co"># Show timing for compilation and execution of code blocks</span><br /><span class="dt">@showTiming</span> <span class="kw">=</span> <span class="ot">off</span><br /><br /><span class="co"># Variable names that are promoted from the execution</span><br /><span class="co"># environment to the global environment. These names can</span><br /><span class="co"># be used in other code blocks than where they are defined. </span><br /><span class="dt">@globalNames</span> <span class="kw">=</span> <span class="st">'Account HTML Rabbit _break _forEach absolute</span><br /><span class="st"> addCats addPoints addToSet between bits blackRabbit catData catNames</span><br /><span class="st"> catRecord deadCats escapeHTML estimatedDistance extractDate</span><br /><span class="st"> extractFootnotes extractMother fatRabbit findReached findRoute</span><br /><span class="st"> footnote forEach hasSevenTruths heightAt htmlDoc image killerRabbit</span><br /><span class="st"> link linkOstrich livingCats livingCats mailArchive makeReachedList</span><br /><span class="st"> makeRoad makeRoads map oldestCat op paragraph paragraphs partial</span><br /><span class="st"> point possibleDirections possibleRoutes power powerRec processParagraph</span><br /><span class="st"> range recluseFile reduce removeFromSet renderFootnote renderHTML</span><br /><span class="st"> renderParagraph retrieveMails roadsFrom route samePoint shortestRoute</span><br /><span class="st"> shortestRouteAbstract simpleObject speak splitParagraph square</span><br /><span class="st"> startsWith storeReached tag traverseRoute weightedDistance yell'</span><br /><br /><span class="co"># An encoded picture of the signature ostrich. To obtain a base64</span><br /><span class="co"># encoding of a file run the CoffeeScript compiler like this:</span><br /><span class="co"># coffee -e &quot;console.log require('fs').readFileSync('../img/ostrich.jpg').toString 'base64'&quot;</span><br /><span class="dt">@ostrich</span> <span class="kw">=</span> ostrich <span class="kw">=</span> <span class="st">'data:image/png;base64,/9j/4AAQSkZJRgABAgAAZABkAAD/7AARRHVja3kAAQAEAAAAHgAA/+4ADkFkb2JlAGTAAAAAAf/bAIQAEAsLCwwLEAwMEBcPDQ8XGxQQEBQbHxcXFxcXHx4XGhoaGhceHiMlJyUjHi8vMzMvL0BAQEBAQEBAQEBAQEBAQAERDw8RExEVEhIVFBEUERQaFBYWFBomGhocGhomMCMeHh4eIzArLicnJy4rNTUwMDU1QEA/QEBAQEBAQEBAQEBA/8AAEQgAWgBaAwEiAAIRAQMRAf/EAIYAAAIDAQEBAAAAAAAAAAAAAAQFAgMGAAEHAQEBAQEBAAAAAAAAAAAAAAACAQMABBAAAgEDAwIDBQYFBQEAAAAAAQIDABEEITESQQVhIhNRcYGhMrFCMxQVBpHBUmJDcqIjUzQ1EQACAgICAgIDAAAAAAAAAAAAARECITFBElFhcaHBIgP/2gAMAwEAAhEDEQA/AMtBEzW3o9ICBUsWG9qPWHTavPa2TZIDENx1qxI7WvRHEA6Uwwe1evxyMg8YL6KPqe32CopZXgAQAUdBBE/l4sQw/EPQ+FNJcjs+DFI6wxsVGq738LtSXJ/c8EbGD0OOPIBqAAyk+weyr19yTt6ITxMjFG3XehJUa2hNTHdcOWVTJo4urno69D764EMGN9msviLXvRiCyATcgLXNBSEnrameQnKhGxz7KdWFoFQsrbmir+J+mq0j81qK9Mf7aU5JBZiMRqaY+cwGYWKqeJA3FKYHKi23zptjIqQmVnLBgeSrp5RsdayssjQNI3AGQgkDUr1tUcvvxkUeivkQeXXa39tC5vcV+kPzXxFiPfQQMUqtYWO5+NKtfKC34LTm5mTxlPKXgeTCwVVHhrQjRnmVD+oSwW4Gt99KIWZorBVFiOJuP6tzTjHxsJceKZQpyI+DWUEkm9yoBsSRtTbjgmxNNjH8xxhQqIyRITtyP0r8qtORLCI1IvLExDBhbS2laTgmH6QCI6yHk6cbt6h6szgdTakWefWeQqi+RmvIu21+Itp8RU3tFiCw5MT8OZCO6huOttakGjlBEZ5eIpbMuRIy2GllBB95ozFj9MlmIUMblR0otJIqZJILtfeifQ+yjsSGOYC2/W1F/p/9w2oyywjLRMVfanU2eZYjBCllIs5OpNht4ClSY8ryqsQJdiAoHtphMpjurqL3N2F9TVbIjNZ6OkpO19Bapfp2Tr6ciyzqvqPDGSzKgsSSdtL6gUz9PEfuOOJyBCWHNjsF9poPP7aqZTMJAOOu41HRgeoNaK8RJy/n2mNrieOSjHkZivIXuQCfcafYYAaOc6kCykai/wBX2mhcbtU57eJuJtIzPbrw2U2rSdiwZAkWRIto7WWMDRr7tY1Hl4DoDZMhsmR52u8YW0SnzctW8NTyoKZLEgLxBbz21BtqSTWpzO0JLOkoJGOtiygnTieVh76Q9/xUSKXJwrLEt/VjB2c25Fajq5KmZ/IzURLfe020/hQP52d2trr93f7K8m5hwQnK4AG++9GxQKncIGVfTuoZhuAaWESLPOtfY8/bjZLLcxFkPW38603n/wCofT4UsTusMYCgC/Wwq39VHyvQ7L8izoSiBgbjQjYjeo5JkWKxJa/QnX505jxhuRQvcsc+g1h40SmYmkBewTfQAmtBidjxpcaOZoNRbmisWI5amyXtb3Vm/VBkCML67bWp3h50UMKoh5MDsGPEDfVSfsrRhXJr8bGUYrLJ5kItxPQW/lV0UsarwH+Py2pR23v8bERyNzhbdGN3S/3lc/Uvv1FB9+7zldqzA2NgPNBoWnflwcW2XhsffST1AX7NQ8SzQsDpyv8AZWRkR1xpo528zlkkVRYctdSPnWsxclMvt2PloCiTIHVTuAwBsay3fHwl/c2JiJzWSfi8jg+Tz3AFvtqXrMNcHVZn82F8ObkqcogRyBNzp0vQqyvLlGeQ2JOi/wBKjYU87/DFFkMuPYq44sx+pjsSvsFIVThLY73/AIVFz5E23Clx4GXM35A1d+Yb29KGRgwtVnE/KiU2CkBaHyQGjYFb6bVR+bFSE4kNuVvGo7I6GYzumPJFO9l4A6hfCgVyJkOjWp73lY/UK3Y3OrEaUhljYagfGtaOUgWUMmmfJGwJ1tsb6i/srYftv92RMq4eawZNk5bgezxFYU71wuCCDYjY0uq+Ayz7XFlYuTF/wlSg0BW1tPdSPuGUkOohDTqvGOZtBY3vyfw3rC9v/cWfgyrIrliNGF/qH91d3HvWZ3NzyuikWKA6W9nuotN40JdV7O7h3P8AMZhkXzKiiOM9NN2+Jr3Fj5ed73NDxQAbijYmCWtpUeoRVPIZGgA2tV1h8qEjmuas9Tx6UIYgh8hlFShmEikN10ub2A9ulUP8KPX/AOZ/i3P4P4m33qOCiPNZg11tx0A1NhQWQxMY06EUc/8A5D/q+Hx8aAyfxW3361tUFtgbC1QNTPwrw/CtDM4UVjRlt/hQw26Uww/o6UWVFuwr0Iz2C163wonF3H00Bl2LgXF2or9NTxojH2G3woj+FZ/tI8H/2Q=='</span><br /><br /><span class="co"># When changes are made in a code block, only that block is</span><br /><span class="co"># evaluated. Turning this `off` will cause an evaluation of all</span><br /><span class="co"># code in the book on *every* keystroke. Only for articles.</span><br /><span class="dt">@incrementalEvaluation</span> <span class="kw">=</span> <span class="ot">on</span><br /><br /><span class="co"># Dummy definitions for standalone execution</span><br /><span class="kw">if</span> exports<span class="kw">?</span><br />  view <span class="kw">=</span> <span class="fu">(obj) -&gt;</span> show<span class="kw">(</span>obj<span class="kw">);</span> obj<br />  runOnDemand <span class="kw">=</span> confirm <span class="kw">=</span> prompt <span class="kw">=</span> <span class="fu">-&gt;</span></code></pre>
</section>
</section>
<section id="section-10">
<h5></h5>
<hr />
</section>
</section>
</section>
<section id="part-ii.-language">
<h2>Part II. Language</h2>
<hr />
<section id="introduction">
<h3>Introduction</h3>
<hr />
<p>When personal computers were first introduced, most of them came equipped with a simple programming language, usually a variant of BASIC. Interacting with the computer was closely integrated with this language, and thus every computer-user, whether he wanted to or not, would get a taste of it. Now that computers have become plentiful and cheap, typical users do not get much further than clicking things with a mouse. For most people, this works very well. But for those of us with a natural inclination towards technological tinkering, the removal of programming from every-day computer use presents something of a barrier.</p>
<p>Fortunately, as an effect of developments in the World Wide Web, it so happens that every computer equipped with a modern web-browser also has an environment for programming JavaScript which can easily be adapted to an environment for CoffeeScript. In today’s spirit of not bothering the user with technical details, it is kept well hidden, but a web-page can make it accessible, and use it as a platform for learning to program. This is such a page.</p>
<section id="section-11">
<h5>○•○</h5>
<blockquote>
<p><em>I do not enlighten those who are not eager to learn, nor arouse those who are not anxious to give an explanation themselves. If I have presented one corner of the square and they cannot come back to me with the other three, I should not go over the points again.</em></p>
</blockquote>
<p>Confucius</p>
<p>Besides explaining CoffeeScript, this book tries to be an introduction to the basic principles of programming. Programming, it turns out, is hard. The fundamental rules are, most of the time, simple and clear. But programs, while built on top of these basic rules, tend to become complex enough to introduce their own rules, their own complexity. Because of this, programming is rarely simple or predictable. As Donald Knuth, who is something of a founding father of the field, says, it is an <em>art</em>.</p>
<p>To get something out of this book, more than just passive reading is required. Try to stay sharp, make an effort to solve the exercises, and only continue on when you are reasonably sure you understand the material that came before.</p>
</section>
<section id="section-12">
<h5>○•○</h5>
<blockquote>
<p><em>The computer programmer is a creator of universes for which he alone is responsible. Universes of virtually unlimited complexity can be created in the form of computer programs.</em></p>
</blockquote>
<p>Joseph Weizenbaum, <em>Computer Power and Human Reason</em><br /></p>
<p>A program is many things. It is a piece of text typed by a programmer, it is the directing force that makes the computer do what it does, it is data in the computer’s memory, yet it controls the actions performed on this same memory. Analogies that try to compare programs to objects we are familiar with tend to fall short, but a superficially fitting one is that of a machine. The gears of a mechanical watch fit together ingeniously, and if the watchmaker was any good, it will accurately show the time for many years. The elements of a program fit together in a similar way, and if the programmer knows what he is doing, the program will run without crashing.</p>
<p>A computer is a machine built to act as a host for these immaterial machines. Computers themselves can only do stupidly straightforward things. The reason they are so useful is that they do these things at an incredibly high speed. A program can, by ingeniously combining many of these simple actions, do very complicated things.</p>
<p>To some of us, writing computer programs is a fascinating game. A program is a building of thought. It is costless to build, weightless, growing easily under our typing hands. If we get carried away, its size and complexity will grow out of control, confusing even the one who created it. This is the main problem of programming. It is why so much of today’s software tends to crash, fail, screw up.</p>
<p>When a program works, it is beautiful. The art of programming is the skill of controlling complexity. The great program is subdued, made simple in its complexity.</p>
</section>
<section id="section-13">
<h5>○•○</h5>
<p>Today, many programmers believe that this complexity is best managed by using only a small set of well-understood techniques in their programs. They have composed strict rules about the form programs should have, and the more zealous among them will denounce those who break these rules as <em>bad</em> programmers.</p>
<p>What hostility to the richness of programming! To try to reduce it to something straightforward and predictable, to place a taboo on all the weird and beautiful programs. The landscape of programming techniques is enormous, fascinating in its diversity, still largely unexplored.</p>
<p>It is certainly littered with traps and snares, luring the inexperienced programmer into all kinds of horrible mistakes, but that only means you should proceed with caution, keep your wits about you. As you learn, there will always be new challenges, new territory to explore. The programmer who refuses to keep exploring will surely stagnate, forget his joy, lose the will to program (and become a manager).</p>
<p>As far as I am concerned, the definite criterion for a program is whether it is correct. Efficiency, clarity, and size are also important, but how to balance these against each other is always a matter of judgement, a judgement that each programmer must make for himself. Rules of thumb are useful, but one should never be afraid to break them.</p>
</section>
<section id="section-14">
<h5>○•○</h5>
<p>In the beginning, at the birth of computing, there were no programming languages. Programs looked something like this:</p>
<pre class="listing"><code>00110001 00000000 00000000 00110001 00000001 00000001
00110011 00000001 00000010 01010001 00001011 00000010
00100010 00000010 00001000 01000011 00000001 00000000
01000001 00000001 00000001 00010000 00000010 00000000
01100010 00000000 00000000
</code></pre>
<p>That is a program to add the numbers from one to ten together, and print out the result (1 + 2 + … + 10 = 55). It could run on a very simple kind of computer. To program early computers, it was necessary to set large arrays of switches in the right position, or punch holes in strips of cardboard and feed them to the computer. You can imagine how this was a tedious, error-prone procedure. Even the writing of simple programs required much cleverness and discipline, complex ones were nearly inconceivable.</p>
<p>Of course, manually entering these arcane patterns of bits (which is what the 1s and 0s above are generally called) did give the programmer a profound sense of being a mighty wizard. And that has to be worth something, in terms of job satisfaction.</p>
<p>Each line of the program contains a single instruction. It could be written in English like this:</p>
<pre class="listing"><code>1 Store the number 0 in memory location 0
2 Store the number 1 in memory location 1
3 Store the value of memory location 1 in location 2
4 Subtract the number 11 from the value in location 2
5 If the value in memory location 2 is the number 0,
    continue with instruction 9
6 Add the value of memory location 1 to location 0
7 Add the number 1 to the value of memory location 1
8 Continue with instruction 3
9 Output the value of memory location 0
</code></pre>
<p>While that is more readable than the binary soup, it is still rather unpleasant. It might help to use names instead of numbers for the instructions and memory locations:</p>
<pre class="listing"><code>Set 'total' to 0
Set 'count' to 1
[loop]
Set 'compare' to 'count'
Subtract 11 from 'compare'
If 'compare' is zero, continue at [end]
Add 'count' to 'total'
Add 1 to 'count'
Continue at [loop]
[end]
Output 'total'
</code></pre>
<p>At this point it is not too hard to see how the program works. Can you? The first two lines give two memory locations their starting values: <code>total</code> will be used to build up the result of the program, and <code>count</code> keeps track of the number that we are currently looking at. The lines using <code>compare</code> are probably the weirdest ones. What the program wants to do is see if <code>count</code> is equal to 11, in order to decide whether it can stop yet. Because the machine is so primitive, it can only test whether a number is zero, and make a decision (jump) based on that. So it uses the memory location labelled <code>compare</code> to compute the value of <code>count - 11</code>, and makes a decision based on that value. The next two lines add the value of <code>count</code> to the result, and increment <code>count</code> by one every time the program has decided that it is not 11 yet. Here is the same program in CoffeeScript:</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">total <span class="kw">=</span> <span class="dv">0</span><br />count <span class="kw">=</span> <span class="dv">1</span><br /><span class="kw">while</span> count <span class="kw">&lt;=</span> <span class="dv">10</span><br />  total <span class="kw">+=</span> count<br />  count <span class="kw">+=</span> <span class="dv">1</span><br />total</code></pre>
<p>This gives us a few more improvements. Most importantly, there is no need to specify the way we want the program to jump back and forth anymore. The magic word <code>while</code> takes care of that. It continues executing the lines indented below it as long as the condition it was given holds: <code>count &lt;= 10</code>, which means ‘<code>count</code> is less than or equal to <code>10</code>’. Apparently, there is no need anymore to create a temporary value and compare that to zero. This was a stupid little detail, and the power of programming languages is that they take care of stupid little details for us.</p>
<p>This can also be expressed in a shorter form in CoffeeScript:</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">total <span class="kw">=</span> <span class="dv">0</span><br />total <span class="kw">+=</span> count <span class="kw">for</span> count <span class="kw">in</span> <span class="kw">[</span><span class="dv">1</span><span class="kw">..</span><span class="dv">10</span><span class="kw">]</span><br />total</code></pre>
<p>The <code>for</code> and <code>in</code> words goes through the range of numbers from 1 to 10 <code>[1..10]</code>, assigning each number in turn to <code>count</code>. Each value in <code>count</code> is then added to <code>total</code>.</p>
<p>Finally, here is what the program could look like if we happened to have the convenient operation <code>sum</code> available, which computes the sum of a collection of numbers similar to the mathematical notation <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><mrow><msubsup><mo>&#8721;</mo><mrow><mi>n</mi><mo>=</mo><mn>1</mn></mrow><mn>10</mn></msubsup><mi>n</mi></mrow></math>:</p>
<pre class="sourceCode"><code class="sourceCode COFFEESCRIPT">sum <span class="kw">[</span><span class="dv">1</span><span class="kw">..</span><span class="dv">10</span><span class="kw">]</span></code></pre>
</section>
<section id="view-solution-3" onclick="reveal(this)" >
<h5>View Solution</h5>
<section id="section-15" style="display:none" >
<h6></h6>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false"><span class="co"># Summation using a reduce function</span><br />sum <span class="kw">=</span> <span class="fu">(v) -&gt;</span> _<span class="kw">.</span>reduce v<span class="kw">,</span> <span class="kw">(</span><span class="fu">(a,b) -&gt;</span> a<span class="kw">+</span>b<span class="kw">),</span> <span class="dv">0</span><br />sum <span class="kw">[</span><span class="dv">1</span><span class="kw">..</span><span class="dv">10</span><span class="kw">]</span></code></pre>
</section>
</section>
<section id="section-16">
<h5></h5>
<p>Another possibility is to have functions attached to datatypes. Here a sum function is attached to an array, giving the sum of the elements in the array.</p>
<pre class="sourceCode"><code class="sourceCode COFFEESCRIPT"><span class="kw">[</span><span class="dv">1</span><span class="kw">..</span><span class="dv">10</span><span class="kw">].</span>sum<span class="kw">()</span></code></pre>
</section>
<section id="view-solution-4" onclick="reveal(this)" >
<h5>View Solution</h5>
<section id="section-17" style="display:none" >
<h6></h6>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false"><span class="co"># Summation using reduce attached to Array</span><br /><span class="ot">Array</span><span class="kw">::</span>sum <span class="kw">=</span> <span class="fu">-&gt;</span> <span class="dt">@reduce</span> <span class="kw">(</span><span class="fu">(a,b) -&gt;</span> a<span class="kw">+</span>b<span class="kw">),</span> <span class="dv">0</span><br />show <span class="kw">[</span><span class="dv">1</span><span class="kw">..</span><span class="dv">10</span><span class="kw">].</span>sum<span class="kw">()</span><br /><span class="kw">delete</span> <span class="ot">Array</span><span class="kw">::</span>sum</code></pre>
</section>
</section>
<section id="section-18">
<h5></h5>
<p>The moral of this story, then, is that the same program can be expressed in long and short, unreadable and readable ways. The first version of the program was extremely obscure, while the last ones are almost English: <code>show</code> the <code>sum</code> of the numbers from <code>1</code> to <code>10</code>. (We will see in later chapters how to build things like <code>sum</code>.)</p>
<p>A good programming language helps the programmer by providing a more abstract way to express himself. It hides uninteresting details, provides convenient building blocks (such as the <code>while</code> construct), and, most of the time, allows the programmer to add building blocks himself (such as the <code>sum</code> operation).</p>
</section>
<section id="section-19">
<h5>○•○</h5>
<p>JavaScript is the language that is, at the moment, mostly being used to do all kinds of clever and horrible things with pages on the World Wide Web. JavaScript is also used for scripting in <a href="http://en.wikipedia.org/wiki/JavaScript#Uses_outside_web_pages">a variety of applications and operating systems</a>. Of special note is server-side JavaScript (SSJS), where the server portion of a web application is written in JavaScript, so a full application can be expressed in one programming language. CoffeeScript generates standard JavaScript code and can therefore be used in environments where standard JavaScript is accepted. It means that both browser portions and server portions can be written in CoffeeScript.</p>
<p>CoffeeScript is a new language so it remains to be seen how popular it becomes for general application development, but if you are interested in programming, CoffeeScript is definitely a useful language to learn. Even if you do not end up doing much web programming, the mind-bending programs in this book will always stay with you, haunt you, and influence the programs you write in other languages.</p>
<p>There are those who will say <em>terrible</em> things about JavaScript. Many of these things are true. When I was for the first time required to write something in JavaScript, I quickly came to despise the language. It would accept almost anything I typed, but interpret it in a way that was completely different from what I meant. This had a lot to do with the fact that I did not have a clue what I was doing, but there is also a real issue here: JavaScript is ridiculously liberal in what it allows. The idea behind this design was that it would make programming in JavaScript easier for beginners. In actuality, it mostly makes finding problems in your programs harder, because the system will not point them out to you.</p>
<p>However, the flexibility of the language is also an advantage. It leaves space for a lot of techniques that are impossible in more rigid languages, and it can be used to overcome some of JavaScript’s shortcomings. After learning it properly, and working with it for a while, I have really learned to <em>like</em> this language. CoffeeScript repairs many of the confusing and cumbersome aspects of JavaScript, while keeping its underlying flexibility and beauty. It is <em>doubleplusgood</em>.</p>
</section>
<section id="section-20">
<h5>○•○</h5>
<p>Most chapters in this book contain quite a lot of code<sup><a href="#fn5" class="footnoteRef" id="fnref5">5</a></sup>. In my experience, reading and writing code is an important part of learning to program. Try to not just glance over these examples, but read them attentively and understand them. This can be slow and confusing at first, but you will quickly get the hang of it. The same goes for the exercises. Do not assume you understand them until you have actually written a working solution.</p>
<p>Because of the way the web works, it is always possible to look at the JavaScript programs that people put in their web-pages. This can be a good way to learn how some things are done. Because most web programmers are not ‘professional’ programmers, or consider JavaScript programming so uninteresting that they never properly learned it, a lot of the code you can find like this is of a <em>very</em> bad quality. When learning from ugly or incorrect code, the ugliness and confusion will propagate into your own code, so be careful who you learn from. Another source of programs are CoffeeScript projects hosted on open source services such as <a href="https://github.com">github</a>.</p>
<hr />
</section>
</section>
<section id="basic-coffeescript-values-variables-and-control-flow">
<h3>Basic CoffeeScript:<br /> values, variables, and control flow</h3>
<hr />
<p>Inside the computer’s world, there is only data. That which is not data, does not exist. Although all data is in essence just a sequence of bits<sup><a href="#fn6" class="footnoteRef" id="fnref6">6</a></sup>, and is thus fundamentally alike, every piece of data plays its own role. In CoffeeScript’s system, most of this data is neatly separated into things called value<a href="#index-value"></a>s. Every value has a type, which determines the kind of role it can play. There are six basic types of values: Numbers, strings, booleans, objects, functions, and undefined values.</p>
<p>To create a value, one must merely invoke its name. This is very convenient. You do not have to gather building material for your values, or pay for them, you just call for one and <em>woosh</em>, you have it. They are not created from thin air, of course. Every value has to be stored somewhere, and if you want to use a gigantic amount of them at the same time you might run out of computer memory. Fortunately, this is only a problem if you need them all simultaneously. As soon as you no longer use a value, it will dissipate, leaving behind only a few bits. These bits are recycled to make the next generation of values.</p>
<section id="section-21">
<h5>○•○</h5>
<p>Values of the type number<a href="#index-number"></a> are, as you might have deduced, numeric values. They are written the way numbers are usually written:</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false"><span class="dv">144</span></code></pre>
<p>Enter that in the console, and the same thing is printed in the output window. The text you typed in gave rise to a number value, and the console took this number and wrote it out to the screen again. In a case like this, that was a rather pointless exercise, but soon we will be producing values in less straightforward ways, and it can be useful to ‘try them out’ on the console to see what they produce.</p>
<p>This is what <code>144</code> looks like in bits<sup><a href="#fn7" class="footnoteRef" id="fnref7">7</a></sup>:</p>
<pre class="listing"><code>01000000 01100010 00000000 00000000 00000000 00000000 00000000 00000000
</code></pre>
<p>The number above has 64 bits. Numbers in CoffeeScript always do. This has one important repercussion: There is a limited amount of different numbers that can be expressed. With three decimal digits, only the numbers 0 to 999 can be written, which is 10<sup>3</sup> = 1000 different numbers. With 64 binary digits, 2<sup>64</sup> different numbers can be written. This is a lot, more than 10<sup>19</sup> (a one with nineteen zeros).</p>
<p>Not all whole numbers below 10<sup>19</sup> fit in a CoffeeScript number though. For one, there are also negative numbers, so one of the bits has to be used to store the sign of the number. A bigger issue is that non-whole numbers must also be represented. To do this, 11 bits are used to store the position of the decimal dot within the number.</p>
<p>That leaves 52 bits<sup><a href="#fn8" class="footnoteRef" id="fnref8">8</a></sup>. Any whole number less than 2<sup>52</sup>, which is over 10<sup>15</sup>, will safely fit in a CoffeeScript number. In most cases, the numbers we are using stay well below that, so we do not have to concern ourselves with bits at all. Which is good. I have nothing in particular against bits, but you <em>do</em> need a terrible lot of them to get anything done. When at all possible, it is more pleasant to deal with bigger things.</p>
<p>Fractional numbers are written by using a dot.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false"><span class="fl">9.81</span></code></pre>
<p>For very big or very small numbers, one can also use ‘scientific’ notation by adding an <code>e</code>, followed by the exponent of the number:</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false"><span class="fl">2.998e8</span></code></pre>
<p>Which is 2.998 ⋅ 10<sup>8</sup> = 299 800 000.</p>
<p>Calculations with whole numbers (also called integers) that fit in 52 bits are guaranteed to always be precise. Unfortunately, calculations with fractional numbers are generally not. Like <em>π</em> (pi) can not be precisely expressed by a finite amount of decimal digits, many numbers lose some precision when only 64 bits are available to store them. This is a shame, but it only causes practical problems in very specific situations<sup><a href="#fn9" class="footnoteRef" id="fnref9">9</a></sup>. The important thing is to be aware of it, and treat fractional digital numbers as approximations, not as precise values.</p>
</section>
<section id="section-22">
<h5>○•○</h5>
<p>The main thing to do with numbers is arithmetic. Arithmetic operations such as addition or multiplication take two number values and produce a new number from them. Here is what they look like in CoffeeScript:</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false"><span class="dv">100</span> <span class="kw">+</span> <span class="dv">4</span> <span class="kw">*</span> <span class="dv">11</span></code></pre>
<p>The <code>+</code> and <code>*</code> symbols are called operators. The first stands for addition, and the second for multiplication. Putting an operator between two values will apply<a href="#index-applying"></a> it to those values, and produce a new value.</p>
<p>Does the example mean ‘add 4 and 100, and multiply the result by 11’, or is the multiplication done before the adding? As you might have guessed, the multiplication happens first. But, as in mathematics, this can be changed by wrapping the addition in parentheses<a href="#index-()"></a>:</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false"><span class="kw">(</span><span class="dv">100</span> <span class="kw">+</span> <span class="dv">4</span><span class="kw">)</span> <span class="kw">*</span> <span class="dv">11</span></code></pre>
<p>For subtraction, there is the <code>-</code> operator, and division can be done with <code>/</code>. When operators appear together without parentheses, the order in which they are applied is determined by the precedence<a href="#index-precedence"></a> of the operators. The first example shows that multiplication has a higher precedence than addition. Division and multiplication always come before subtraction and addition. When multiple operators with the same precedence appear next to each other (<code>1 - 1 + 1</code>) they are applied left-to-right.</p>
<p>Try to figure out what value this produces, and then copy it to the next field to see if you were correct…</p>
<pre class="sourceCode"><code class="sourceCode COFFEESCRIPT"><span class="dv">115</span> <span class="kw">*</span> <span class="dv">4</span> <span class="kw">-</span> <span class="dv">4</span> <span class="kw">+</span> <span class="dv">88</span> <span class="kw">/</span> <span class="dv">2</span></code></pre>
<blockquote>
<p>Touch or click in the following field to write in it. To evaluate some CoffeeScript, either just type it in Auto Evaluation mode or press ↑ / ↩ (Shift/Enter) while in the field in manual mode.</p>
</blockquote>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false"><span class="co"># Compose a solution here</span></code></pre>
<p>These rules of precedence are not something you should worry about. When in doubt, just add parentheses.</p>
<p>There is one more arithmetic operator which is probably less familiar to you. The <code>%</code> symbol is used to represent the modulo<a href="#index-modulo"></a> operation. <code>X</code> modulo <code>Y</code> is the remainder of dividing <code>X</code> by <code>Y</code>. For example <code>314 % 100</code> is <code>14</code>, <code>10 % 3</code> is <code>1</code>, and <code>144 % 12</code> is <code>0</code>. Modulo has the same precedence as multiplication and division.</p>
</section>
<section id="section-23">
<h5>○•○</h5>
<p>The next data type is the string<a href="#index-string"></a>. Its use is not as evident from its name as with numbers, but it also fulfills a very basic role. Strings are used to represent text, the name supposedly derives from the fact that it strings together a bunch of characters. Strings are written by enclosing their content in quotes:</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false"><span class="st">'Patch my boat with chewing gum.'</span></code></pre>
<p>Almost anything can be put between quotes, and CoffeeScript will make a string value out of it. But a few characters are tricky. You can imagine how putting quotes between quotes might be hard.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false"><span class="st">'The programmer pondered: &quot;0x2b or not 0x2b&quot;'</span></code></pre>
<p>CoffeeScript implements both single quoted and double quoted strings, which can be handy when you have only one kind of quote in a string.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false"><span class="st">&quot;Aha! It's 43 if I'm not a bit off&quot;</span></code></pre>
<p>Double quoted strings can contain interpolated values, small snippets of CoffeeScript code between <code>#{</code> and <code>}</code>. The code is evaluated and inserted into the string.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false"><span class="st">&quot;2 + 2 gives </span><span class="ch">#{</span>2 + 2<span class="ch">}</span><span class="st">&quot;</span></code></pre>
<p>Newlines, the things you get when you press enter, can not be put between quotes in the normal form of strings. A string can span multiple lines to help avoid overly long lines in the program but the line breaks are not shown in the output.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false"><span class="st">'Imagine if this was a</span><br /><span class="st"> very long line of text'</span></code></pre>
</section>
<section id="section-24">
<h5>○•○</h5>
<p>CoffeeScript has triple-quoted strings aka heredocs<a href="#index-heredocs"></a> to make it easy to have strings that span multiple lines where the line breaks are preserved in the output. Indentation before the quotes are ignored so the following lines can be aligned nicely.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false"><span class="st">'''First comes A</span><br /><span class="st">   then comes B'''</span></code></pre>
<p>The triple double quoted variant allows for interpolated values.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false"><span class="st">&quot;&quot;&quot;Math 101:</span><br /><span class="st">     1</span><br /><span class="st">   + 1</span><br /><span class="st">   ---</span><br /><span class="st">     </span><span class="ch">#{</span>1 + 1<span class="ch">}</span><span class="st">&quot;&quot;&quot;</span></code></pre>
<p>Still to be able to have special characters in a string, the following trick is used: Whenever a backslash (‘<code>\</code>’) is found inside quoted text, it indicates that the character after it has a special meaning. A quote that is preceded by a backslash will not end the string, but be part of it. When an ‘<code>n</code>’ character occurs after a backslash, it is interpreted as a newline<a href="#index-newline"></a>. Similarly, a ‘<code>t</code>’ after a backslash means a tab character.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false"><span class="st">'This is the first line\nAnd this is the second'</span></code></pre>
<p>There are of course situations where you want a backslash in a string to be just a backslash, not a special code. If two backslashes follow each other, they will collapse right into each other, and only one will be left in the resulting string value:</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false"><span class="st">'A newline character is written like &quot;\\n&quot;.'</span></code></pre>
</section>
<section id="section-25">
<h5>○•○</h5>
<p>Strings can not be divided, multiplied, or subtracted. The <code>+</code> operator <em>can</em> be used on them. It does not add, but it concatenates, it glues two strings together.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false"><span class="st">'con'</span> <span class="kw">+</span> <span class="st">'cat'</span> <span class="kw">+</span> <span class="st">'e'</span> <span class="kw">+</span> <span class="st">'nate'</span></code></pre>
<p>There are more ways of manipulating strings, but these are discussed later.</p>
</section>
<section id="section-26">
<h5>○•○</h5>
<p>Not all operators are symbols, some are written as words. For example, the <code>typeof</code> operator, which produces a string value naming the type of the value you give it.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false"><span class="kw">typeof</span> <span class="fl">4.5</span></code></pre>
<p>The other operators we saw all operated on two values, <code>typeof</code> takes only one. Operators that use two values are called binary operators<a href="#index-binary-operator"></a>, while those that take one are called unary operators<a href="#index-unary-operator"></a>. The minus<a href="#index--"></a> operator can be used both as a binary and unary operator<sup><a href="#fn10" class="footnoteRef" id="fnref10">10</a></sup>:</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false"><span class="kw">-(</span><span class="dv">10</span> <span class="kw">-</span> <span class="dv">2</span><span class="kw">)</span></code></pre>
</section>
<section id="section-27">
<h5>○•○</h5>
<p>Then there are values of the boolean<a href="#index-boolean"></a> type. There are two of these: <code>true</code> and <code>false</code>. CoffeeScript has some aliases for them: <code>true</code> can be written as <code>yes</code> or <code>on</code>. <code>false</code> as <code>no</code> or <code>off</code>. These alternatives can in some cases make a program easier to read. Here is one way to produce a <code>true</code> value:</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false"><span class="dv">3</span> <span class="kw">&gt;</span> <span class="dv">2</span></code></pre>
<p>And <code>false</code> can be produced like this:</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false"><span class="dv">3</span> <span class="kw">&lt;</span> <span class="dv">2</span></code></pre>
<p>I hope you have seen the <code>&gt;</code> and <code>&lt;</code> signs before. They mean, respectively, ‘is greater than’ and ‘is less than’. They are binary operators, and the result of applying them is a boolean value that indicates whether they hold in this case. You can chain comparisons<a href="#index-chained-comparison"></a> to test if something is within an interval. These comparisons give respectively <code>true</code> and <code>false</code>:</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false"><span class="dv">100</span> <span class="kw">&lt;</span> <span class="dv">115</span> <span class="kw">&lt;</span> <span class="dv">200</span></code></pre>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false"><span class="dv">100</span> <span class="kw">&lt;</span> <span class="dv">315</span> <span class="kw">&lt;</span> <span class="dv">200</span></code></pre>
<p>Strings can be compared in the same way:</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false"><span class="st">'Aardvark'</span> <span class="kw">&lt;</span> <span class="st">'Zoroaster'</span></code></pre>
<p>The way strings are ordered is more or less alphabetic. More or less… Uppercase letters are always ‘less’ than lowercase ones, so <code>'Z' &lt; 'a'</code> is <code>true</code>, and non-alphabetic characters (’ <code>!</code>’, ‘<code>@</code>’, etc) are also included in the ordering. The actual way in which the comparison is done is based on the Unicode<a href="#index-Unicode"></a> standard. This standard assigns a number to virtually every character one would ever need, including characters from Greek, Arabic, Japanese, Tamil, and so on. Having such numbers is practical for storing strings inside a computer — you can represent them as a list of numbers. When comparing strings, CoffeeScript just compares the numbers of the characters inside the string, from left to right.</p>
<p>Other similar operators are <code>&gt;=</code> (‘is greater than or equal to’), <code>&lt;=</code> (‘is less than or equal to’), <code>==</code> (‘is equal to’), and <code>!=</code> (‘is not equal to’). Equal to can also be written in text as <code>is</code> and not equal to as <code>isnt</code>.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false"><span class="st">'Itchy'</span> <span class="kw">isnt</span> <span class="st">'Scratchy'</span></code></pre>
</section>
<section id="section-28">
<h5>○•○</h5>
<p>There are also some useful operations that can be applied to boolean values themselves. CoffeeScript supports three logical operators: <code>and</code>, <code>or</code>, and <code>not</code>. These can be used to ‘reason’ about booleans.</p>
<p>The logical <code>and</code> operator can also be written as <code>&amp;&amp;</code>. It is a binary operator, and its result is only <code>true</code> if both of the values given to it are <code>true</code>.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false"><span class="ot">true</span> <span class="kw">and</span> <span class="ot">false</span></code></pre>
<p>Logical <code>or</code> with alias <code>||</code>, is <code>true</code> if either of the values given to it is <code>true</code>:</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false"><span class="ot">true</span> <span class="kw">or</span> <span class="ot">false</span></code></pre>
<p><code>not</code> can be written as an exclamation mark, <code>!</code>, it is a unary operator that flips the value given to it, <code>!true</code> is <code>false</code>, and <code>not false</code> is <code>true</code>.</p>
</section>
<section id="exercise-1">
<h4><em>Exercise 1</em></h4>
<pre class="sourceCode"><code class="sourceCode COFFEESCRIPT"><span class="kw">((</span><span class="dv">4</span> <span class="kw">&gt;=</span> <span class="dv">6</span><span class="kw">)</span> <span class="kw">||</span> <span class="kw">(</span><span class="st">'grass'</span> <span class="kw">!=</span> <span class="st">'green'</span><span class="kw">))</span> <span class="kw">and</span> <span class="kw">!(((</span><span class="dv">12</span> <span class="kw">*</span> <span class="dv">2</span><span class="kw">)</span> <span class="kw">==</span> <span class="dv">144</span><span class="kw">)</span> <span class="kw">and</span> <span class="ot">true</span><span class="kw">)</span></code></pre>
<p>Is this true? For readability, there are a lot of unnecessary parentheses in there. This simple version means the same thing:</p>
<pre class="sourceCode"><code class="sourceCode COFFEESCRIPT"><span class="kw">(</span><span class="dv">4</span> <span class="kw">&gt;=</span> <span class="dv">6</span> <span class="kw">or</span> <span class="st">'grass'</span> <span class="kw">isnt</span> <span class="st">'green'</span><span class="kw">)</span> <span class="kw">and</span> <span class="kw">not</span><span class="kw">(</span><span class="dv">12</span> <span class="kw">*</span> <span class="dv">2</span> <span class="kw">is</span> <span class="dv">144</span> <span class="kw">and</span> <span class="ot">true</span><span class="kw">)</span></code></pre>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false"><span class="co"># Compose a solution here</span></code></pre>
<section id="view-solution-5" onclick="reveal(this)" >
<h5>View Solution</h5>
<section id="section-29" style="display:none" >
<h6></h6>
<p>Yes, it is <code>true</code>. You can reduce it step by step like this:</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false"><span class="kw">(</span><span class="ot">false</span> <span class="kw">or</span> <span class="ot">true</span><span class="kw">)</span> <span class="kw">and</span> <span class="kw">not</span> <span class="kw">(</span><span class="ot">false</span> <span class="kw">and</span> <span class="ot">true</span><span class="kw">)</span><br /><span class="ot">true</span> <span class="kw">and</span> <span class="kw">not</span> <span class="ot">false</span><br /><span class="ot">true</span></code></pre>
<p>I hope you noticed that <code>'grass'  != 'green'</code> is <code>true</code>. Grass may be green, but it is not equal to green.</p>
</section>
</section>
</section>
<section id="section-30">
<h4></h4>
<p>It is not always obvious when parentheses are needed. In practice, one can usually get by with knowing that of the operators we have seen so far, <code>or</code> has the lowest precedence, then comes <code>and</code>, then the comparison operators ( <code>&gt;</code>, <code>==</code>, etcetera), and then the rest. This has been chosen in such a way that, in simple cases, as few parentheses as possible are necessary.</p>
<section id="section-31">
<h5>○•○</h5>
<p>All the examples so far have used the language like you would use a pocket calculator. Make some values and apply operators to them to get new values. Creating values like this is an essential part of every CoffeeScript program, but it is only a part. A piece of code that produces a value is called an expression<a href="#index-expression"></a>. Every value that is written directly (such as <code>22</code> or <code>'psychoanalysis'</code>) is an expression. An expression between parentheses is also an expression. And a binary operator applied to two expressions, or a unary operator applied to one, is also an expression.</p>
<p>There are a few more ways of building expressions, which will be revealed when the time is ripe.</p>
<p>There exists a unit that is bigger than an expression. It is called a statement<a href="#index-statement"></a>. A program is built as a list of statements. Most statements end with a newline, although a statement can stretch over many lines. Statements can also end with a semicolon<a href="#index-semicolon"></a> (<code>;</code>). In CoffeeScript semicolon is mostly used if you want to place multiple statements on the same line. The simplest kind of statement is an expression with a semicolon after it. This is a program:</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false"><span class="dv">1</span><span class="kw">;</span> <span class="kw">not</span> <span class="ot">false</span></code></pre>
<p>It is a useless program. An expression can be content to just produce a value, but a statement only amounts to something if it somehow changes the world. It could print something to the screen — that counts as changing the world — or it could change the internal state of the program in a way that will affect the statements that come after it. These changes are called ‘side effects<a href="#index-side-effect"></a>’. The statements in the example above just produce the values <code>1</code> and <code>true</code>, and then immediately throw them into the bit bucket<sup><a href="#fn11" class="footnoteRef" id="fnref11">11</a></sup>. This leaves no impression on the world at all, and is not a side effect.</p>
</section>
<section id="section-32">
<h5>○•○</h5>
<p>How does a program keep an internal state? How does it remember things? We have seen how to produce new values from old values, but this does not change the old values, and the new value has to be immediately used or it will dissipate again. To catch and hold values, CoffeeScript provides a thing called a variable<a href="#index-variable"></a>.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">caught <span class="kw">=</span> <span class="dv">5</span> <span class="kw">*</span> <span class="dv">5</span></code></pre>
<p>A variable always has a name, and it can point at a value, holding on to it. The statement above creates a variable called <code>caught</code> and uses it to grab hold of the number that is produced by multiplying <code>5</code> by <code>5</code>.</p>
<p>After running the above program, you can type the word <code>caught</code> into the console, and it will retrieve the value <code>25</code> for you. The name of a variable is used to fetch its value. <code>caught + 1</code> also works. A variable name can be used as an expression, and thus can be part of bigger expressions.</p>
<p>Assigning a value to a new variable name with the <code>=</code> operator, creates the new variable. Variable names can be almost every word, but they may not include spaces. Digits can be part of variable names, <code>catch22</code> is a valid name, but the name must not start with one. The characters ‘<code>$</code>’ and ‘<code>_</code>’ can be used in names as if they were letters, so <code>$_$</code> is a correct variable name.</p>
<p>When a variable points at a value, that does not mean it is tied to that value forever. At any time, the <code>=</code> operator can be used on existing variables to yank them away from their current value and make them point to a new one.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">caught <span class="kw">=</span> <span class="dv">4</span> <span class="kw">*</span> <span class="dv">4</span></code></pre>
</section>
<section id="section-33">
<h5>○•○</h5>
<p>You should imagine variables as tentacles, rather than boxes. They do not <em>contain</em> values, they <em>grasp</em> them — two variables can refer to the same value. Only the values that the program still has a hold on can be accessed by it. When you need to remember something, you grow a tentacle to hold on to it, or re-attach one of your existing tentacles to a new value:</p>
<blockquote>
<p>To remember the amount of dollars that Luigi still owes you, you could use a variable… Then, every time Luigi pays something back, this amount can be decremented by giving the variable a new number:</p>
</blockquote>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">luigiDebt <span class="kw">=</span> <span class="dv">140</span><br />luigiDebt <span class="kw">=</span> luigiDebt <span class="kw">-</span> <span class="dv">35</span></code></pre>
<p>The collection of variables and their values that exist at a given time is called the environment<a href="#index-environment"></a>. When a program starts up, this environment is not empty. It always contains a number of standard variables.</p>
<p>If you install CoffeeScript and use the <code>coffee</code> command line program to execute a CoffeeScript program or run the interactive environment with <code>coffee -r ./prelude</code> then the environment is called <code>global</code>. You can view it by typing: →∣ / ‘Tab’. When your browser loads a page, it creates a new environment called <code>window</code> and attaches these standard values to it. The variables created and modified by programs on that page survive until the browser goes to a new page.<sup><a href="#fn12" class="footnoteRef" id="fnref12">12</a></sup></p>
</section>
<section id="section-34">
<h5>○•○</h5>
<p>A lot of the values provided by the standard environment have the type ‘function’<a href="#index-function"></a>. A function is a piece of program wrapped in a value. Generally, this piece of program does something useful, which can be evoked using the function value that contains it. In the development environment, the variable <code>show</code> <a href="#index-show"></a> holds a function that shows a message in the terminal or command line window. You can use it like this:</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">show <span class="st">'Also, your hair is on fire.'</span></code></pre>
<p><a href="#index-()"></a>Executing the code in a function is called invoking<a href="#index-invoking"></a> or applying<a href="#index-applying"></a> it. The notation for doing this is the function name followed by parentheses or a comma separated list of values. Every expression that produces a function value can be invoked by putting parentheses after it. The parentheses can be left out when values are passed. The string value is given to the function, which uses it as the text to show in the console window. Values given to functions are called parameters<a href="#index-parameter"></a> or arguments<a href="#index-argument"></a>. <code>show</code> needs only one of them, but other functions might need a different number.</p>
</section>
<section id="section-35">
<h5>○•○</h5>
<p>Showing a message is a side effect. A lot of functions are useful because of the side effects they produce. It is also possible for a function to produce a value, in which case it does not need to have a side effect to be useful. For example, there is a function <code>Math.max</code><a href="#index-Math.max"></a>, which takes two arguments and gives back the biggest of the two:</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">show <span class="ot">Math</span><span class="kw">.</span>max <span class="dv">2</span><span class="kw">,</span> <span class="dv">4</span></code></pre>
<p><a href="#index-Math.max"></a>When a function produces a value, it is said to return<a href="#index-return"></a> it. Because things that produce values are always expressions in CoffeeScript, function calls can be used as a part of bigger expressions:</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">show <span class="dv">100</span> <span class="kw">+</span> <span class="ot">Math</span><span class="kw">.</span>max <span class="dv">7</span><span class="kw">,</span> <span class="dv">4</span><br />show <span class="ot">Math</span><span class="kw">.</span>max<span class="kw">(</span><span class="dv">7</span><span class="kw">,</span> <span class="dv">4</span><span class="kw">)</span> <span class="kw">+</span> <span class="dv">100</span><br />show <span class="ot">Math</span><span class="kw">.</span>max<span class="kw">(</span><span class="dv">7</span><span class="kw">,</span> <span class="dv">4</span> <span class="kw">+</span> <span class="dv">100</span><span class="kw">)</span><br />show <span class="ot">Math</span><span class="kw">.</span>max <span class="dv">7</span><span class="kw">,</span> <span class="dv">4</span> <span class="kw">+</span> <span class="dv">100</span></code></pre>
<p>When parentheses are left out from a function call then CoffeeScript implicitly inserts them stretching to the end of the line. In the example above it means that the first two lines gives the answer <code>107</code> and the last two <code>104</code>. So depending on your intention you may have to use parentheses to get the result you want. <a href="#functions">Functions↓</a> discusses writing your own functions.</p>
</section>
<section id="section-36">
<h5>○•○</h5>
<p>As the previous examples illustrated, <code>show</code> can be useful for showing the result of an expression. <code>show</code> is not a standard CoffeeScript function, browsers do not provide it for you, it is made available by the interactive environment. When you create your own programs in the web browser, you can instead use <code>alert</code> to pop up a dialog with a message or <code>console.log</code> to direct output to your browsers built-in console.</p>
<p>We will continue in the CoffeeScript environment. <code>show</code><a href="#index-show"></a> tries to display its argument the way it would look in a program, which can give more information about the type of a value. In an interactive console, started with <code>coffee -r ./prelude</code>, you can explore the environment or you can try it right here:</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">show <span class="ot">Math</span><span class="kw">.</span>PI<br />show <span class="ot">console</span> <span class="kw">if</span> <span class="ot">console</span><span class="kw">?</span><br />show showDocument</code></pre>
<p>What the output means is not so important for now. <code>show</code> is a tool that can give you details on the things in your programs, which can be handy later, if something does not behave the way you had expected. A variant of <code>show</code> is <code>view</code> it returns the value it displays. That can be helpful when you want to see what is going on inside a long expression.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">show <span class="dv">1</span> <span class="kw">+</span> <span class="dv">2</span> <span class="kw">+</span> <span class="dv">3</span> <span class="kw">+</span> <span class="dv">4</span> <span class="kw">+</span> <span class="dv">5</span> <span class="kw">+</span> view <span class="dv">6</span> <span class="kw">+</span> <span class="dv">7</span></code></pre>
</section>
<section id="section-37">
<h5>○•○</h5>
<p>The environment provided by browsers contains a few more functions for popping up windows. You can ask the user an OK/Cancel question using <code>confirm</code><a href="#index-confirm"></a>. This returns a boolean, <code>true</code> if the user presses ‘OK’, and <code>false</code> if he presses ‘Cancel’. The interactive environment has a similar <code>confirm</code> function where the user is asked yes or no to a question. It displays the question and its buttons inline in the output.</p>
<p>Blocking a user interface with a question should only happen when getting an answer <em>right</em> now is <em>really</em> critical. None of the questions on this page are, you can continue reading without answering any of them. In a CoffeeScript server, a question should normally not stop the process and wait for a user to reply. Instead the program continues running the code following the function call. Eventually when the user has answered the question, then a function given as an argument is called with the answer. This piece of code involves a bit of magic, that will be explained in <a href="#functions">Functions↓</a>. While it is more complicated for this use, we will in later chapters see that it makes perfect sense for web applications with many users and in responsive user interfaces.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">confirm <span class="st">'Shall we, then?'</span><span class="kw">,</span> <span class="fu">(answer) -&gt;</span> show answer</code></pre>
</section>
</section>
<section id="prompt">
<h4>Prompt</h4>
<p><code>prompt</code><a href="#index-prompt"></a> can be used to ask an ‘open’ question. The first argument is the question, the second one is the text that the user starts with. A line of text can be typed into the window, and the function will — in a browsers’ default implementation — return this as a string. As with <code>confirm</code> the interactive environment offers a similar function, that takes a third argument which will receive the answer.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">prompt <span class="st">'Tell us everything you know'</span><span class="kw">,</span> <span class="st">'...'</span><span class="kw">,</span><br />  <span class="fu">(answer) -&gt;</span> show <span class="st">'So you know: '</span> <span class="kw">+</span> answer</code></pre>
<section id="section-38">
<h5>○•○</h5>
<p>It is possible to give almost every variable in the environment a new value. This can be useful, but also dangerous. If you give <code>show</code> the value <code>8</code>, you will not be able to show things anymore. You can refresh this web page to start over. If your browser supports offline web apps then you can even refresh this web page when you are somewhere without internet - this works for example on iOS 5. Some functions like <code>confirm</code> and <code>prompt</code> also work when you run your program from a file, but they interact poorly with the server environment. So should you try these examples there, then fortunately… you can stop a server program with <code>CTRL-C</code> and pick up where you left off.</p>
</section>
<section id="section-39">
<h5>○•○</h5>
<p>One-line programs are not very interesting. When you put more than one statement into a program, the statements are, predictably, executed one at a time, from top to bottom.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">prompt <span class="st">'Pick a number'</span><span class="kw">,</span> <span class="st">''</span><span class="kw">,</span> <span class="fu">(answer) -&gt;</span><br />  theNumber <span class="kw">=</span> <span class="ot">Number</span> answer<br />  show <span class="st">'Your number is the square root of '</span> <span class="kw">+</span><br />    <span class="kw">(</span>theNumber <span class="kw">*</span> theNumber<span class="kw">)</span></code></pre>
<p>The function <code>Number</code><a href="#index-Number"></a> converts a value to a number, which is needed in this case because the answer from <code>prompt</code> is a string value. There are similar functions called <code>String</code><a href="#index-String"></a> and <code>Boolean</code><a href="#index-Boolean"></a> which convert values to those types.</p>
</section>
<section id="section-40">
<h5>○•○</h5>
<p>Consider a program that prints out all even numbers from 0 to 12. One way to write this is:</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">show <span class="dv">0</span><br />show <span class="dv">2</span><br />show <span class="dv">4</span><br />show <span class="dv">6</span><br />show <span class="dv">8</span><br />show <span class="dv">10</span><br />show <span class="dv">12</span></code></pre>
<p>That works, but the idea of writing a program is to make something <em>less</em> work, not more. If we needed all even numbers below 1000, the above would be unworkable. What we need is a way to automatically repeat some code.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">currentNumber <span class="kw">=</span> <span class="dv">0</span><br /><span class="kw">while</span> currentNumber <span class="kw">&lt;=</span> <span class="dv">12</span><br />  show currentNumber<br />  currentNumber <span class="kw">=</span> currentNumber <span class="kw">+</span> <span class="dv">2</span></code></pre>
<p>You may have seen <code>while</code><a href="#index-while"></a> in the <a href="#introduction">Introduction↑</a> chapter. A statement starting with the word <code>while</code> creates a loop<a href="#index-loop"></a>. A loop is a disturbance in the sequence of statements, it may cause the program to repeat some statements multiple times. In this case, the word <code>while</code> is followed by an expression, which is used to determine whether the loop will loop or finish. As long as the boolean value produced by this expression is <code>true</code>, the code in the loop is repeated. As soon as it is false, the program goes to the bottom of the loop and continues as normal.</p>
<p>The variable <code>currentNumber</code> demonstrates the way a variable can track the progress of a program. Every time the loop repeats, it is incremented by <code>2</code>, and at the beginning of every repetition, it is compared with the number <code>12</code> to decide whether to keep on looping.</p>
<p>The third part of a <code>while</code> statement is another statement. This is the body<a href="#index-body"></a> of the loop, the action or actions that must take place multiple times. Indentation<a href="#index-indentation"></a> is used to group statements into blocks<a href="#index-block"></a>. To the world outside the block, a block counts as a single statement. In the example, this is used to include in the loop both the call to <code>show</code> and the statement that updates <code>currentNumber</code>.</p>
<p>If we did not have to print the numbers, the program could have been:</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">counter <span class="kw">=</span> <span class="dv">0</span><br /><br /><span class="kw">while</span> counter <span class="kw">&lt;=</span> <span class="dv">12</span> <span class="kw">then</span> counter <span class="kw">=</span> counter <span class="kw">+</span> <span class="dv">2</span></code></pre>
<p>Here, <code>counter = counter + 2</code> is the statement that forms the body of the loop. The <code>then</code> keyword separates the boolean from the body, so both can be on the same line.</p>
</section>
</section>
<section id="exercise-2">
<h4><em>Exercise 2</em></h4>
<p>Use the techniques shown so far to write a program that calculates and shows the value of 2<sup>10</sup> (2 to the 10th power). You are, obviously, not allowed to use a cheap trick like just writing <code>2 * 2 * ...</code></p>
<p>If you are having trouble with this, try to see it in terms of the even-numbers example. The program must perform an action a certain amount of times. A counter variable with a <code>while</code> loop can be used for that. Instead of printing the counter, the program must multiply something by 2. This something should be another variable, in which the result value is built up.</p>
<p>Do not worry if you do not quite see how this would work yet. Even if you perfectly understand all the techniques this chapter covers, it can be hard to apply them to a specific problem. Reading and writing code will help develop a feeling for this, so study the solution, and try the next exercise.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false"><span class="co"># Compose a solution here</span></code></pre>
<section id="view-solution-6" onclick="reveal(this)" >
<h5>View Solution</h5>
<section id="section-41" style="display:none" >
<h6></h6>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">result <span class="kw">=</span> <span class="dv">1</span><br />counter <span class="kw">=</span> <span class="dv">0</span><br /><span class="kw">while</span> counter <span class="kw">&lt;</span> <span class="dv">10</span><br />  result <span class="kw">=</span> result <span class="kw">*</span> <span class="dv">2</span><br />  counter <span class="kw">=</span> counter <span class="kw">+</span> <span class="dv">1</span><br />show result</code></pre>
<p>The counter could also start at <code>1</code> and check for <code>&lt;= 10</code>, but, for reasons that will become apparent later on, it is a good idea to get used to counting from 0.</p>
<p>Obviously, your own solutions are not required to be precisely the same as mine. They should work. And if they are very different, make sure you also understand my solution.</p>
</section>
</section>
</section>
<section id="section-42">
<h4></h4>
</section>
<section id="exercise-3">
<h4><em>Exercise 3</em></h4>
<p>With some slight modifications, the solution to the previous exercise can be made to draw a triangle. And when I say ‘draw a triangle’ I mean ‘print out some text that almost looks like a triangle when you squint’.</p>
<p>Print out ten lines. On the first line there is one ‘#’ character. On the second there are two. And so on.</p>
<p>How does one get a string with X ‘#’ characters in it? One way is to build it every time it is needed with an ‘inner loop’ — a loop inside a loop. A simpler way is to reuse the string that the previous iteration of the loop used, and add one character to it.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false"><span class="co"># Compose a solution here</span></code></pre>
<section id="view-solution-7" onclick="reveal(this)" >
<h5>View Solution</h5>
<section id="section-43" style="display:none" >
<h6></h6>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">line <span class="kw">=</span> <span class="st">''</span><br />counter <span class="kw">=</span> <span class="dv">0</span><br /><span class="kw">while</span> counter <span class="kw">&lt;</span> <span class="dv">10</span><br />  line <span class="kw">=</span> line <span class="kw">+</span> <span class="st">'#'</span><br />  show line<br />  counter <span class="kw">=</span> counter <span class="kw">+</span> <span class="dv">1</span></code></pre>
</section>
</section>
</section>
<section id="section-44">
<h4></h4>
<p>You will have noticed the spaces I put in front of some statements. These are required: The level of indentation decides which block a line belongs to. The role of the indentation<a href="#index-indentation"></a> inside blocks is to make the structure of the code clearer to a reader. Because new blocks can be opened inside other blocks, it can become hard to see where one block ends and another begins if they were not indented. When lines are indented, the visual shape of a program corresponds to the shape of the blocks inside it. I like to use two spaces for every open block, but tastes differ. If a line becomes too long, then you can split it between two words or place a <code>\</code> at the end of the line and continue on the next.</p>
<section id="section-45">
<h5>○•○</h5>
<p>The uses of <code>while</code> we have seen so far all show the same pattern. First, a ‘counter’ variable is created. This variable tracks the progress of the loop. The <code>while</code> itself contains a check, usually to see whether the counter has reached some boundary yet. Then, at the end of the loop body, the counter is updated.</p>
<p>A lot of loops fall into this pattern. For this reason, CoffeeScript, and similar languages, also provide a slightly shorter and more comprehensive form:</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false"><span class="kw">for</span> number <span class="kw">in</span> <span class="kw">[</span><span class="dv">0</span><span class="kw">..</span><span class="dv">12</span><span class="kw">]</span> <span class="kw">by</span> <span class="dv">2</span> <span class="kw">then</span> show number</code></pre>
<p>This program is exactly equivalent to the earlier even-number-printing example. The only change is that all the statements that are related to the ‘state’ of the loop are now on one line. The numbers in square brackets are a range<a href="#index-range"></a> <code>[4..7]</code>, a list of numbers starting from the first number and going up one by one to the last. A range with two dots includes the last number in the list <code>(4,5,6,7)</code>, with three dots <code>[4...7]</code> the last number is excluded <code>(4,5,6)</code>. The amount of each step can be changed with the <code>by</code> keyword. So <code>[2..6] by 2</code> gives the list <code>(2,4,6)</code>. Ranges can also decrement if the first number is largest, or involve negative numbers or floating point numbers.</p>
<p>The <code>number</code> in the <code>for</code><a href="#index-for"></a> comprehension take on each successive value from the range during each turn through the loop. The <code>number</code> value is then available in the loop body where it can be used in computations or as here in <code>show number</code>. In most cases this is shorter and clearer than a <code>while</code> construction.</p>
<p>The <code>for</code> comprehension can take on other forms as well.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false"><span class="co"># For with indented body</span><br /><span class="kw">for</span> number <span class="kw">in</span> <span class="kw">[</span><span class="dv">0</span><span class="kw">..</span><span class="dv">12</span><span class="kw">]</span> <span class="kw">by</span> <span class="dv">2</span><br />  show number</code></pre>
<p>Another is that the body of the loop can be given before the <code>for</code> statement.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false"><span class="co"># For with prepended body</span><br />show number <span class="kw">for</span> number <span class="kw">in</span> <span class="kw">[</span><span class="dv">0</span><span class="kw">..</span><span class="dv">12</span><span class="kw">]</span> <span class="kw">by</span> <span class="dv">2</span></code></pre>
</section>
<section id="section-46">
<h5>○•○</h5>
<p>The lines that starts with ‘#’ in the previous example might have looked a bit suspicious to you. It is often useful to include extra text in a program. The most common use for this is adding some explanations in human language to a program.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false"><span class="co"># The variable counter, which is about to be defined,</span><br /><span class="co"># is going to start with a value of 0, which is zero.</span><br />counter <span class="kw">=</span> <span class="dv">0</span><br /><span class="co"># Now, we are going to loop, hold on to your hat.</span><br /><span class="kw">while</span>  counter <span class="kw">&lt;</span> <span class="dv">100</span> <span class="co"># counter is less than one hundred</span><br />  <span class="co">###</span><br /><span class="co">  Every time we loop, we INCREMENT the value of counter</span><br /><span class="co">  Seriously, we just add one to it.</span><br /><span class="co">  ###</span><br />  counter<span class="kw">++</span><br /><span class="co"># And then, we are done.</span></code></pre>
<p>This kind of text is called a comment<a href="#index-comment"></a>. The rules are like this: ‘<code>#</code>’ starts a comment, which goes on until the end of the line. ‘<code>###</code>’ starts another kind of comment that goes on until a ‘<code>###</code>’ is found so it can stretch over multiple lines.</p>
<p>As you can see, even the simplest programs can be made to look big, ugly, and complicated by simply adding a lot of comments to them.</p>
</section>
<section id="section-47">
<h5>○•○</h5>
<p>I have been using some rather odd capitalisation<a href="#index-capitalisation"></a> in some variable names. Because you can not have spaces in these names — the computer would read them as two separate variables — your choices for a name that is made of several words are more or less limited to the following:</p>
<pre class="listing"><code>  fuzzylittleturtle                 FuzzyLittleTurtle
  fuzzy_little_turtle               fuzzyLittleTurtle
</code></pre>
<p>The first one is hard to read. Personally, I like the one with the underscores, though it is a little painful to type. However, since CoffeeScript evolved from JavaScript, most CoffeeScript programmers follow the JavaScript convention with the last one. Its the one used by the standard JavaScript functions. It is not hard to get used to little things like that, so I will just follow the crowd and capitalise the first letter of every word after the first.</p>
<p>In a few cases, such as the <code>Number</code> function, the first letter of a variable is also capitalised. This was done to mark this function as a constructor. What a constructor is will become clear in <a href="#object-oriented-programming">Object Orientation↓</a>. For now, the important thing is not to be bothered by this apparent lack of consistency.</p>
</section>
<section id="section-48">
<h5>○•○</h5>
<p>Note that names that have a special meaning, such as <code>while</code>, and <code>for</code> may not be used as variable names. These are called keywords<a href="#index-keyword"></a>. There are also a number of <a href="#index-reserved-words"></a>words which are ‘reserved for use’ in future versions of JavaScript and CoffeeScript. These are also officially not allowed to be used as variable names, though some environments do allow them. The full list in <a href="#reserved-words">Reserved Words↓</a> is rather long.</p>
<p>Do not worry about memorising these for now, but remember that this might be the problem when something does not work as expected. In my experience, <code>char</code> (to store a one-character string) and <code>class</code><a href="#index-class"></a> are the most common names to accidentally use.</p>
</section>
</section>
<section id="exercise-4">
<h4><em>Exercise 4</em></h4>
<p>Rewrite the solutions of the previous two exercises to use <code>for</code> instead of <code>while</code>.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false"><span class="co"># Compose a solution here</span></code></pre>
<section id="view-solution-8" onclick="reveal(this)" >
<h5>View Solution</h5>
<section id="section-49" style="display:none" >
<h6></h6>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">result <span class="kw">=</span> <span class="dv">1</span><br /><span class="kw">for</span> counter <span class="kw">in</span> <span class="kw">[</span><span class="dv">0</span><span class="kw">...</span><span class="dv">10</span><span class="kw">]</span><br />  result <span class="kw">=</span> result <span class="kw">*</span> <span class="dv">2</span><br />show result</code></pre>
<p>Note the use of the exclusive range and that — as required by CoffeeScript — the statement in the loop is indented two spaces which make it clear that it ‘belongs’ to the line above it.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">line <span class="kw">=</span> <span class="st">''</span><br /><span class="kw">for</span> counter <span class="kw">in</span> <span class="kw">[</span><span class="dv">0</span><span class="kw">...</span><span class="dv">10</span><span class="kw">]</span><br />  line <span class="kw">=</span> line <span class="kw">+</span> <span class="st">'#'</span><br />  show line</code></pre>
</section>
</section>
</section>
<section id="section-50">
<h4></h4>
<p><a href="#index-+="></a><a href="#index--="></a><a href="#index-/="></a><a href="#index-*="></a>A program often needs to ‘update’ a variable with a value that is based on its previous value. For example <code>counter = counter + 1</code>. CoffeeScript provides a shortcut for this: <code>counter += 1</code>. This also works for many other operators, for example <code>result *= 2</code> to double the value of <code>result</code>, or <code>counter -= 1</code> to count downwards. <code>counter++</code> and <code>counter--</code><a href="#index-++"></a><a href="#index--"></a> are shorter versions of <code>counter += 1</code> and <code>counter -= 1</code>.</p>
<section id="section-51">
<h5>○•○</h5>
<p>Loops are said to affect the control flow<a href="#index-control-flow"></a> of a program. They change the order in which statements are executed. In many cases, another kind of flow is useful: skipping statements.</p>
<p>We want to show all numbers between 0 and 20 which are divisible both by 3 and by 4.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false"><span class="kw">for</span> counter <span class="kw">in</span> <span class="kw">[</span><span class="dv">0</span><span class="kw">..</span><span class="dv">20</span><span class="kw">]</span><br />  <span class="kw">if</span> counter <span class="kw">%</span> <span class="dv">3</span> <span class="kw">is</span> <span class="dv">0</span> <span class="kw">and</span> counter <span class="kw">%</span> <span class="dv">4</span> <span class="kw">is</span> <span class="dv">0</span><br />    show counter</code></pre>
<p>The keyword <code>if</code><a href="#index-if"></a> is not too different from the keyword <code>while</code>: It checks the condition it is given, and executes the statement after it based on this condition. But it does this only once, so that the statement is executed zero or one time.</p>
<p>The trick with the modulo (<code>%</code><a href="#index-%"></a>) operator is an easy way to test whether a number is divisible by another number. If it is, the remainder of their division, which is what modulo gives you, is zero.</p>
<p>If we wanted to print all of the numbers between 0 and 20, but put parentheses around the ones that are not divisible by 4, we can do it like this:</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false"><span class="kw">for</span> counter <span class="kw">in</span> <span class="kw">[</span><span class="dv">0</span><span class="kw">..</span><span class="dv">20</span><span class="kw">]</span><br />  <span class="kw">if</span> counter <span class="kw">%</span> <span class="dv">4</span> <span class="kw">is</span> <span class="dv">0</span><br />    show counter<br />  <span class="kw">if</span> counter <span class="kw">%</span> <span class="dv">4</span> <span class="kw">isnt</span> <span class="dv">0</span><br />    show <span class="st">'('</span> <span class="kw">+</span> counter <span class="kw">+</span> <span class="st">')'</span></code></pre>
<p>But now the program has to determine whether <code>counter</code> is divisible by <code>4</code> two times. The same effect can be gotten by appending an <code>else</code> part after an <code>if</code> statement. The <code>else</code><a href="#index-else"></a> statement is executed only when the <code>if</code>’s condition is false.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false"><span class="kw">for</span> counter <span class="kw">in</span> <span class="kw">[</span><span class="dv">0</span><span class="kw">..</span><span class="dv">20</span><span class="kw">]</span><br />  <span class="kw">if</span> counter <span class="kw">%</span> <span class="dv">4</span> <span class="kw">is</span> <span class="dv">0</span><br />    show counter<br />  <span class="kw">else</span><br />    show <span class="st">'('</span> <span class="kw">+</span> counter <span class="kw">+</span> <span class="st">')'</span></code></pre>
<p>To stretch this trivial example a bit further, we now want to print these same numbers, but add two stars after them when they are greater than 15, one star when they are greater than 10 (but not greater than 15), and no stars otherwise.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false"><span class="kw">for</span> counter <span class="kw">in</span> <span class="kw">[</span><span class="dv">0</span><span class="kw">..</span><span class="dv">20</span><span class="kw">]</span><br />  <span class="kw">if</span> counter <span class="kw">&gt;</span> <span class="dv">15</span><br />    show counter <span class="kw">+</span> <span class="st">'**'</span><br />  <span class="kw">else</span> <span class="kw">if</span> counter <span class="kw">&gt;</span> <span class="dv">10</span><br />    show counter <span class="kw">+</span> <span class="st">'*'</span><br />  <span class="kw">else</span><br />    show counter</code></pre>
<p>This demonstrates that you can chain <code>if</code> statements together. In this case, the program first looks if <code>counter</code> is greater than <code>15</code>. If it is, the two stars are printed and the other tests are skipped. If it is not, we continue to check if <code>counter</code> is greater than <code>10</code>. Only if <code>counter</code> is also not greater than <code>10</code> does it arrive at the last <code>show</code> statement.</p>
</section>
</section>
<section id="exercise-5">
<h4><em>Exercise 5</em></h4>
<p>Write a program to ask yourself, using <code>prompt</code>, what the value of 2 + 2 is. If the answer is ‘4’, use <code>show</code> to say something praising. If it is ‘3’ or ‘5’, say ‘Almost!’. In other cases, say something mean. Refer <a href="#prompt">back↑</a> for the little bit of magic needed with <code>prompt</code>.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false"><span class="co"># Compose a solution here</span></code></pre>
<section id="view-solution-9" onclick="reveal(this)" >
<h5>View Solution</h5>
<section id="section-52" style="display:none" >
<h6></h6>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">prompt <span class="st">'You! What is the value of 2 + 2?'</span><span class="kw">,</span> <span class="st">''</span><span class="kw">,</span><br />  <span class="fu">(answer) -&gt;</span><br />    <span class="kw">if</span> answer <span class="kw">is</span> <span class="st">'4'</span><br />      show <span class="st">'You must be a genius or something.'</span><br />    <span class="kw">else</span> <span class="kw">if</span> answer <span class="kw">is</span> <span class="st">'3'</span> <span class="kw">or</span> answer <span class="kw">is</span> <span class="st">'5'</span><br />      show <span class="st">'Almost!'</span><br />    <span class="kw">else</span><br />      show <span class="st">'You are an embarrassment.'</span></code></pre>
</section>
</section>
</section>
<section id="section-53">
<h4></h4>
<p>The logic tests in a program can become complicated. To help write conditions clearly CoffeeScript provides a couple of variations on the <code>if</code> statement: The body of an <code>if</code> statement can be placed before the condition. And an <code>if not</code> can be written as <code>unless</code><a href="#index-unless"></a>.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">fun <span class="kw">=</span> <span class="ot">on</span><br />show <span class="st">'The show is on!'</span> <span class="kw">unless</span> fun <span class="kw">is</span> <span class="ot">off</span></code></pre>
<section id="section-54">
<h5>○•○</h5>
<p>When a loop does not always have to go all the way through to its end, the <code>break</code><a href="#index-break"></a> keyword can be useful. It immediately jumps out of the current loop, continuing after it. This program finds the first number that is greater than 20 and divisible by 7:</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">current <span class="kw">=</span> <span class="dv">20</span><br /><span class="kw">loop</span><br />  <span class="kw">if</span> current <span class="kw">%</span> <span class="dv">7</span> <span class="kw">is</span> <span class="dv">0</span><br />    <span class="kw">break</span><br />  current<span class="kw">++</span><br />show current</code></pre>
<p>The <code>loop</code><a href="#index-loop"></a> construct does not have a part that checks for the end of the loop. It is the same as <code>while true</code>. This means that it is dependent on the <code>break</code> statement inside it to ever stop. The same program could also have been written as simply…</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">current <span class="kw">=</span> <span class="dv">20</span><br />current<span class="kw">++</span> <span class="kw">until</span> current <span class="kw">%</span> <span class="dv">7</span> <span class="kw">is</span> <span class="dv">0</span><br />show current</code></pre>
<p>In this case, the body of the loop comes before the loop test. The <code>until</code><a href="#index-until"></a> keyword is similar to the <code>unless</code> keyword, but translates into <code>while not</code>. The only effect of the loop is to increment the variable <code>current</code> to its desired value. But I needed an example that uses <code>break</code>, so pay attention to the first version too.</p>
</section>
</section>
<section id="exercise-6">
<h4><em>Exercise 6</em></h4>
<p>Pick a lucky number from 1 to 6 then keep rolling a simulated die, until your lucky number comes up. Count the number of rolls. Use a loop and optionally a <code>break</code>. Casting a die can be simulated with:</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">roll <span class="kw">=</span> <span class="ot">Math</span><span class="kw">.</span>floor <span class="ot">Math</span><span class="kw">.</span>random<span class="kw">()</span> <span class="kw">*</span> <span class="dv">6</span> <span class="kw">+</span> <span class="dv">1</span></code></pre>
<p>Note that <code>loop</code> is the same as <code>while true</code> and both can be used to create a loop that does not end on its own account. Writing <code>while true</code> is a useful trick but a bit silly, you ask the program to loop as long as <code>true</code> is <code>true</code>, so the preferred way is to write <code>loop</code>.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false"><span class="co"># Compose a solution here</span></code></pre>
<section id="view-solution-10" onclick="reveal(this)" >
<h5>View Solution</h5>
<section id="section-55" style="display:none" >
<h6></h6>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">luckyNumber <span class="kw">=</span> <span class="dv">5</span> <span class="co"># Choose from 1 to 6</span><br />show <span class="st">&quot;Your lucky number is </span><span class="ch">#{</span>luckyNumber<span class="ch">}</span><span class="st">&quot;</span><br />count <span class="kw">=</span> <span class="dv">0</span><br /><span class="kw">loop</span><br />  show roll <span class="kw">=</span> <span class="ot">Math</span><span class="kw">.</span>floor <span class="ot">Math</span><span class="kw">.</span>random<span class="kw">()</span> <span class="kw">*</span> <span class="dv">6</span> <span class="kw">+</span> <span class="dv">1</span><br />  count<span class="kw">++</span><br />  <span class="kw">if</span> roll <span class="kw">is</span> luckyNumber <span class="kw">then</span> <span class="kw">break</span><br />show <span class="st">&quot;Luck took </span><span class="ch">#{</span>count<span class="ch">}</span><span class="st"> roll(s)&quot;</span></code></pre>
<p>Another solution, arguably nicer, without <code>break</code> but abusing statistics:</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">luckyNumber <span class="kw">=</span> <span class="dv">3</span> <span class="co"># Choose from 1 to 6</span><br />show <span class="st">'Your lucky number is '</span> <span class="kw">+</span> luckyNumber<br />count <span class="kw">=</span> <span class="dv">0</span><br /><span class="kw">until</span> roll <span class="kw">is</span> luckyNumber<br />  show roll <span class="kw">=</span> <span class="ot">Math</span><span class="kw">.</span>floor <span class="ot">Math</span><span class="kw">.</span>random<span class="kw">()</span> <span class="kw">*</span> <span class="dv">6</span> <span class="kw">+</span> <span class="dv">1</span><br />  count<span class="kw">++</span><br />show <span class="st">'You are lucky '</span> <span class="kw">+</span><br />    <span class="ot">Math</span><span class="kw">.</span>floor<span class="kw">(</span><span class="dv">100</span><span class="kw">/</span>count<span class="kw">)</span> <span class="kw">+</span> <span class="st">'% of the time'</span></code></pre>
</section>
</section>
</section>
<section id="section-56">
<h4></h4>
<p>In the second solution to the previous exercise <code>roll</code> has not been set to a value the first time through the loop. It is only assigned a value in the next statement. What happens when you take the value of this variable?</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">show mysteryVariable<br />mysteryVariable <span class="kw">=</span> <span class="st">'nothing'</span></code></pre>
<p>In terms of tentacles, this variable ends in thin air, it has nothing to grasp. When you ask for the value of an empty place, you get a special value named <code>undefined</code><a href="#index-undefined"></a>. Functions which do not return an interesting value, such as the <code>show</code> function also return an <code>undefined</code> value. Most things in CoffeeScript however return a value, even most statements.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">show show <span class="st">'I am a side effect.'</span></code></pre>
<p>There is a similar value, <code>null</code><a href="#index-null"></a>, whose meaning is ‘this variable is defined, but it does not have a value’. The difference in meaning between <code>undefined</code> and <code>null</code> is mostly academic, and usually not very interesting. In practical programs, it is often necessary to check whether something ‘has a value’. In these cases, the expression <code>something?</code> may be used, the <code>?</code><a href="#index-?"></a> is called the existential operator<a href="#index-existential-operator"></a>. It returns <code>true</code> unless something is <code>null</code> or <code>undefined</code>. It also comes in an existential assignment form <code>?=</code> which will only assign to a variable that is either <code>null</code> or <code>undefined</code>.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">show iam <span class="kw">?</span> <span class="ot">undefined</span><br />iam <span class="kw">?=</span> <span class="st">'I want to be'</span><br />show iam<br />iam <span class="kw">?=</span> <span class="st">'I am already'</span><br />show iam <span class="kw">if</span> iam<span class="kw">?</span></code></pre>
<section id="section-57">
<h5>○•○</h5>
<p>Which brings us to another subject… If you have been exposed to JavaScript then you know that comparisons of different types can be tricky.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">show <span class="ot">false</span> <span class="kw">==</span> <span class="dv">0</span><br />show <span class="st">''</span> <span class="kw">==</span> <span class="dv">0</span><br />show <span class="st">'5'</span> <span class="kw">==</span> <span class="dv">5</span></code></pre>
<p><a href="#index-type-conversion"></a>In JavaScript all these give the value <code>true</code> — not so in CoffeeScript where they are all <code>false</code>. When comparing values that have different types, you have to convert them into compatible types first. We saw this earlier with <code>Number</code> so <code>Number('5') == 5</code> gives <code>true</code>. The behaviour of <code>is</code>/<code>==</code> in CoffeeScript is the same as <code>===</code> in JavaScript.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">show <span class="al">`</span>null === undefined<span class="al">`</span><br />show <span class="al">`</span>false === <span class="dv">0</span><span class="al">`</span><br />show <span class="al">`</span><span class="ch">''</span> === <span class="dv">0</span><span class="al">`</span><br />show <span class="al">`</span><span class="ch">'</span><span class="al">5</span><span class="ch">'</span> === <span class="dv">5</span><span class="al">`</span></code></pre>
<p>All these are <code>false</code>. You can embed JavaScript<a href="#index-embedded-JavaScript"></a> in CoffeeScript by surrounding the JavaScript code with backquotes<a href="#index-backquotes"></a>. Using JavaScript when you have CoffeeScript is similar to embedding assembly language in a high-level language. It should be something you very rarely need to do.</p>
</section>
<section id="section-58">
<h5>○•○</h5>
<p>There are some other situations that cause automatic type conversions<a href="#index-type-conversion"></a> to happen. If you add a non-string value to a string, the value is automatically converted to a string before it is concatenated. If you multiply a number and a string, CoffeeScript tries to make a number out of the string.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">show <span class="st">'Apollo'</span> <span class="kw">+</span> <span class="dv">5</span><br />show <span class="ot">null</span> <span class="kw">+</span> <span class="st">'ify'</span><br />show <span class="st">'5'</span> <span class="kw">*</span> <span class="dv">5</span><br />show <span class="st">'strawberry'</span> <span class="kw">*</span> <span class="dv">5</span></code></pre>
<p>The last statement prints <code>NaN</code><a href="#index-NaN"></a>, which is a special value. It stands for ‘not a number’, and is of type number (which might sound a little contradictory). In this case, it refers to the fact that a strawberry is not a number. All arithmetic operations on the value <code>NaN</code> result in <code>NaN</code>, which is why multiplying it by <code>5</code>, as in the example, still gives a <code>NaN</code> value. Also, and this can be disorienting at times, <code>NaN == NaN</code> equals <code>false</code>, checking whether a value is <code>NaN</code> can be done with the <code>isNaN</code><a href="#index-isNaN"></a> function.</p>
<p>These automatic conversions can be very convenient, but they are also rather weird and error prone. Even though <code>+</code> and <code>*</code> are both arithmetic operators, they behave completely different in the example. In my own code, I use <code>+</code> on non-strings a lot, but make it a point not to use <code>*</code> and the other numeric operators on string values.</p>
<p>Converting a number to a string is always possible and straightforward, but converting a string to a number may not even work (as in the last line of the example). We can use <code>Number</code> to explicitly convert the string to a number, making it clear that we might run the risk of getting a <code>NaN</code> value.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">show <span class="ot">Number</span><span class="kw">(</span><span class="st">'5'</span><span class="kw">)</span> <span class="kw">*</span> <span class="dv">5</span></code></pre>
</section>
<section id="section-59">
<h5>○•○</h5>
<p>When we discussed the boolean operators <code>and</code> / <code>&amp;&amp;</code> and <code>or</code> / <code>||</code> earlier, I claimed they produced boolean values. This turns out to be a bit of an oversimplification. If you apply them to boolean values, they will indeed return booleans. But they can also be applied to other kinds of values, in which case they will return one of their arguments.</p>
<p>What <code>or</code><a href="#index---"></a> really does is this: It looks at the value to the left of it first. If converting this value to a boolean would produce <code>true</code>, it returns this left value, and otherwise it returns the one on its right. Check for yourself that this does the correct thing when the arguments are booleans. Why does it work like that? It turns out this is very practical. Consider this example:</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">prompt <span class="st">'What is your name?'</span><span class="kw">,</span> <span class="st">''</span><span class="kw">,</span><br />  <span class="fu">(input) -&gt;</span> show <span class="st">'Well hello '</span> <span class="kw">+</span> <span class="kw">(</span>input <span class="kw">or</span> <span class="st">'dear'</span><span class="kw">)</span></code></pre>
<p>If the user confirms without giving a name, the variable <code>input</code> will hold the value <code>''</code>. This would give <code>false</code> when converted to a boolean. The expression <code>input or 'dear'</code> can in this case be read as ‘the value of the variable <code>input</code>, or else the string <code>'dear'</code>’. It is an easy way to provide a ‘fallback’ value.</p>
<p>The <code>and</code><a href="#index-&amp;&amp;"></a> operator works similarly, but the other way around. When the value to its left is something that would give <code>false</code> when converted to a boolean, it returns that value, and otherwise it returns the value on its right.</p>
<p>Another property of these two operators is that the expression to their right is only evaluated when necessary. In the case of <code>true or X</code>, no matter what <code>X</code> is, the result will be <code>true</code>, so <code>X</code> is never evaluated, and if it has side effects they never happen. The same goes for <code>false and X</code>.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false"><span class="ot">false</span> <span class="kw">or</span> show <span class="st">'I am happening!'</span><br /><span class="ot">true</span>  <span class="kw">or</span> show <span class="st">'Not me.'</span></code></pre>
<hr />
</section>
</section>
</section>
<section id="functions">
<h3>Functions</h3>
<hr />
<p>A program often needs to do the same thing in different places. Repeating all the necessary statements every time is tedious and error-prone. It would be better to put them in one place, and have the program take a detour through there whenever necessary. This is what functions<a href="#index-function"></a> were invented for: They are canned code that a program can go through whenever it wants. Putting a string on the screen requires quite a few statements, but when we have a <code>show</code> function we can just write <code>show 'Aleph'</code> and be done with it.</p>
<p>To view functions merely as canned chunks of code does not do them justice though. When needed, they can play the role of pure functions, algorithms, indirections, abstractions, decisions, modules, continuations, data structures, and more. Being able to effectively use functions is a necessary skill for any kind of serious programming. This chapter provides an introduction into the subject, <a href="#functional-programming">Functional Programming↓</a> discusses the subtleties of functions in more depth.</p>
<section id="section-60">
<h5>○•○</h5>
<p><a href="#index-pure-function"></a>Pure functions, for a start, are the things that were called functions in the mathematics classes that I hope you have been subjected to at some point in your life. Taking the cosine or the absolute value of a number is a pure function of one argument. Addition is a pure function of two arguments.</p>
<p>The defining properties of pure functions are that they always return the same value when given the same arguments, and never have side effects. They take some arguments, return a value based on these arguments, and do not monkey around with anything else.</p>
<p>In CoffeeScript, addition is an operator, but it could be wrapped in a function like this (and as pointless as this looks, we will come across situations where it is actually useful):</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">add <span class="kw">=</span> <span class="fu">(a, b) -&gt;</span> a <span class="kw">+</span> b<br />add <span class="dv">2</span><span class="kw">,</span> <span class="dv">2</span></code></pre>
<p><code>add</code> is the name of the function. <code>a</code> and <code>b</code> are the names of the two arguments. <code>a + b</code> is the body of the function.</p>
<p><a href="#index--%3E"></a>The construct <code>-&gt;</code> is used when creating a new function. When it is assigned to a variable name, the resulting function will be stored under this name. Before the <code>-&gt;</code> comes a list of argument<a href="#index-argument"></a> names in parentheses. If a function does not take any arguments, then the parentheses are not needed. After the <code>-&gt;</code> follows the body<a href="#index-body"></a> of the function. The body can follow the <code>-&gt;</code> on the same line or indented on the following line.</p>
<p><a href="#index-return"></a>The last statement in a function determines its value. The keyword <code>return</code>, followed by an expression, can also be used to determine the value the function returns. When control comes across a <code>return</code> statement, it immediately jumps out of the current function and gives the returned value to the code that called the function. A <code>return</code> statement without an expression after it will cause the function to return <code>undefined</code>.</p>
<p>A body can, of course, have more than one statement in it. Here is a function for computing powers (with positive, integer exponents):</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">power <span class="kw">=</span> <span class="fu">(base, exponent) -&gt;</span><br />  result <span class="kw">=</span> <span class="dv">1</span><br />  <span class="kw">for</span> count <span class="kw">in</span> <span class="kw">[</span><span class="dv">0</span><span class="kw">...</span>exponent<span class="kw">]</span><br />    result <span class="kw">*=</span> base<br />  result<br />power <span class="dv">2</span><span class="kw">,</span> <span class="dv">10</span></code></pre>
<p>If you solved <a href="#exercise-2">Exercise 2↑</a>, this technique for computing a power should look familiar. Creating a variable (<code>result</code>) and updating it are side effects. Did I not just say pure functions had no side effects? A variable created inside a function exists only inside the function. This is fortunate, or a programmer would have to come up with a different name for every variable he needs throughout a program. Because <code>result</code> only exists inside <code>power</code>, the changes to it only last until the function returns, and from the perspective of code that calls it there are no side effects.</p>
</section>
<section id="exercise-7">
<h4><em>Exercise 7</em></h4>
<p>Write a function called <code>absolute</code>, which returns the absolute value of the number it is given as its argument. The absolute value of a negative number is the positive version of that same number, and the absolute value of a positive number (or zero) is that number itself.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false"><span class="co"># Compose a solution here</span></code></pre>
<section id="view-solution-11" onclick="reveal(this)" >
<h5>View Solution</h5>
<section id="section-61" style="display:none" >
<h6></h6>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">absolute <span class="kw">=</span> <span class="fu">(number) -&gt;</span><br />  <span class="kw">if</span> number <span class="kw">&lt;</span> <span class="dv">0</span><br />    <span class="kw">-</span>number<br />  <span class="kw">else</span><br />    number<br />absolute <span class="kw">-</span><span class="dv">144</span></code></pre>
</section>
</section>
</section>
<section id="section-62">
<h4></h4>
<p>Pure functions have two very nice properties. They are easy to think about, and they are easy to re-use.</p>
<p>If a function is pure, a call to it can be seen as a thing in itself. When you are not sure that it is working correctly, you can test it by calling it directly from the console, which is simple because it does not depend on any context<sup><a href="#fn13" class="footnoteRef" id="fnref13">13</a></sup>. It is easy to make these tests automatic — to write a program that tests a specific function. Non-pure functions might return different values based on all kinds of factors, and have side effects that might be hard to test and think about.</p>
<p>Because pure functions are self-sufficient, they are likely to be useful and relevant in a wider range of situations than non-pure ones. Take <code>show</code>, for example. This function’s usefulness depends on the presence of a special place on the screen for printing output. If that place is not there, the function is useless. We can imagine a related function, let’s call it <code>format</code>, that takes a value as an argument and returns a string that represents this value. This function is useful in more situations than <code>show</code>.</p>
<p>Of course, <code>format</code> does not solve the same problem as <code>show</code>, and no pure function is going to be able to solve that problem, because it requires a side effect. In many cases, non-pure functions are precisely what you need. In other cases, a problem can be solved with a pure function but the non-pure variant is much more convenient or efficient.</p>
<p>Thus, when something can easily be expressed as a pure function, write it that way. But never feel dirty for writing non-pure functions.</p>
<section id="section-63">
<h5>○•○</h5>
<p><a href="#index-testing"></a>How do we make sure that a function gives the result that we expect? In the last exercise we tried with <code>absolute -144</code> and got the answer we wanted. For a simple function that is likely enough, but functions quickly become much more complicated and it becomes difficult to predict the output just from reading the program text. To reassure ourselves that <code>absolute</code> actually works many more test cases are needed. But typing test case after test case very quickly becomes very boring — so there must be a better way…</p>
<p>The exercise described the properties that the function should have as: <em>‘The absolute value of a negative number is the positive version of that same number, and the absolute value of a positive number (or zero) is that number itself.’</em> This description can be turned into properties that the computer can test for us.</p>
<p>The <code>testAbsolute</code> function calls on testPure in <code>qc</code> — <code>qc</code> stands for quick check<sup><a href="#fn14" class="footnoteRef" id="fnref14">14</a></sup> — and tells it in the first argument to test <code>absolute</code>. The next argument, <code>arbInt</code>, declare that <code>absolute</code> takes an arbitrary integer as its only argument. Don’t worry about the brackets and dots, they will be explained in the next chapters. Calling <code>testAbsolute</code> with a descriptive name and a property is all that is needed to tell what to expect of <code>absolute</code>.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">runOnDemand <span class="fu">-&gt;</span> <span class="co"># Create the Run button further down</span><br />  testAbsolute <span class="kw">=</span> <span class="fu">(name, property) -&gt;</span><br />    testPure absolute<span class="kw">,</span> <span class="kw">[</span>arbInt<span class="kw">],</span> name<span class="kw">,</span> property<br /><br />  testAbsolute <span class="st">'returns positive integers'</span><span class="kw">,</span><br />    <span class="fu">(c, arg, result) -&gt;</span><br />      result <span class="kw">&gt;=</span> <span class="dv">0</span><br /><br />  testAbsolute <span class="st">'positive returns positive'</span><span class="kw">,</span><br />    <span class="fu">(c, arg, result) -&gt;</span><br />      c<span class="kw">.</span>guard arg <span class="kw">&gt;=</span> <span class="dv">0</span><br />      result <span class="kw">is</span> arg<br /><br />  testAbsolute <span class="st">'negative returns positive'</span><span class="kw">,</span><br />    <span class="fu">(c, arg, result) -&gt;</span><br />      c<span class="kw">.</span>guard arg <span class="kw">&lt;</span> <span class="dv">0</span><br />      result <span class="kw">is</span> <span class="kw">-</span>arg<br /><br />  test<span class="kw">()</span></code></pre>
<p>First from the description of the function, clearly <code>absolute</code> should return a value larger than or equal to zero. That is what <code>result &gt;= 0</code> in the property says. A property here is a function which is given three arguments; a test case (called <code>c</code> since <code>case</code> is a reserved word), the argument that <code>absolute</code> was called with and the <code>result</code> it gave back. Based on these values the property then returns true or false depending on whether the function conformed to the property.</p>
<p>The description says: ‘the absolute value of a positive number (or zero) is that number itself.’ So this property only needs positive numbers, a call to <code>guard</code> can to tell <code>qc</code> to disregard values that are not positive. The property then checks that the <code>result</code> is the same as the argument. Almost the same goes for negative arguments, except we use unary minus in the property.</p>
<p>So far only the desired properties of the function has been declared. No tests have been performed. Calling <code>test()</code> at then end starts the testing process when you press the ‘Run’ button, <code>qc</code> then generates test data and checks the properties.</p>
<pre class="listing"><code>My results:
Pass: returns positive integers (pass=100, invalid=0)
Pass: positive returns positive (pass=100, invalid=103)
Pass: negative returns positive (pass=100, invalid=90)
</code></pre>
<p>That was nice. <code>absolute</code> has passed 300 test cases in the blink of an eye. The invalid counts comes from the <code>guard</code> calls that throw away test cases. If you want to see the test values then you can insert a <code>show c.args</code> in the property.</p>
<p>So what does it look like if a test fails? The <code>power</code> function from earlier in this chapter is a good candidate for a function that will fail to live up to expectations. We could reasonably expect that <code>power</code> will behave the same as the standard <code>Math.pow</code> function — but only for integers of course.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">runOnDemand <span class="fu">-&gt;</span><br />  testPure power<span class="kw">,</span> <span class="kw">[</span>arbInt<span class="kw">,</span> arbInt<span class="kw">],</span><br />    <span class="st">'power equals Math.pow for integers'</span><span class="kw">,</span><br />    <span class="fu">(c, base, exponent, result) -&gt;</span><br />      result <span class="kw">is</span> c<span class="kw">.</span>note <span class="ot">Math</span><span class="kw">.</span>pow base<span class="kw">,</span> exponent<br />  test<span class="kw">()</span></code></pre>
<p>Calling <code>testPure</code> and describing <code>power</code> as a function with two integer arguments does that. The property is then declaring that the <code>result</code> from <code>power</code> is the same as that from <code>Math.pow</code>. To see the value that <code>Math.pow</code> returns, a call is made to <code>c.note</code> which registers the value it is given.</p>
<pre class="listing"><code>My results:
fail: power equals Math.pow for integers
pass=9, invalid=0
shrinkedArgs=3,-2,9,0.1111111111111111
Failed case:
[ -9,
  -9,
  -387420489,
  -2.581174791713197e-9 ]
</code></pre>
<p>That failed and <code>qc</code> shows why. The <code>-9</code> and <code>-9</code> in the last lines refer to the arguments that <code>qc</code> generated for the test case. The <code>-387420489</code> is the result from <code>power</code>. The last number is the value noted from <code>Math.pow</code>, it is a close approximation of the correct answer –9<sup>–9</sup> = <sup>–1</sup>/<sub>387420489</sub></p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">runOnDemand <span class="fu">-&gt;</span><br />  testPure power<span class="kw">,</span> <span class="kw">[</span>arbWholeNum<span class="kw">,</span> arbWholeNum<span class="kw">],</span><br />    <span class="st">'power equals Math.pow for positive integers'</span><span class="kw">,</span><br />    <span class="fu">(c, base, exponent, result) -&gt;</span><br />      result <span class="kw">is</span> c<span class="kw">.</span>note <span class="ot">Math</span><span class="kw">.</span>pow base<span class="kw">,</span> exponent<br />  test<span class="kw">()</span></code></pre>
<p>The expectation that <code>power</code> works for integers was too broad, but surely the functions will work the same for positive integers or what do you think? Instead of using guard to throw away test cases as before, the description of the arguments can be changed. Many different argument types are included in <code>qc</code> (ranges, strings, dates, lists, …) and there is also one for positive integers, <code>arbWholeNum</code>.</p>
<pre class="listing"><code>My results:
fail: power equals Math.pow for positive integers
pass=28, invalid=0
shrinkedArgs=9,18,150094635296999100,150094635296999140
Failed case:
[ 27,
  27,
  4.434264882430377e+38,
  4.434264882430378e+38 ]
</code></pre>
<p>Well it passed 28 tests before a test case for 27<sup>27</sup> gave a difference on the last digit<sup><a href="#fn15" class="footnoteRef" id="fnref15">15</a></sup>. Notice the line with <code>shrinkedArgs</code>. When a test fails then <code>qc</code> tries to find a simpler test that reproduces the problem. Simpler can mean shorter strings, lists or in this case smaller numbers. So <code>qc</code> found that there was a difference already for 9<sup>18</sup>. The result from <code>power</code> ends with <code>100</code> and from <code>Math.pow</code> with <code>140</code>. So which is correct? None<sup><a href="#fn16" class="footnoteRef" id="fnref16">16</a></sup> of them: 9<sup>18</sup> = 150094635296999121.</p>
</section>
</section>
<section id="exercise-8">
<h4><em>Exercise 8</em></h4>
<p>Modify the function <code>intensify</code> in the following program until it passes the test properties. You can find descriptions of many <code>qc</code> definitions such as <code>arbConst</code> in the <a href="#quickcheck"><code>qc</code> reference↓</a>. A predefined function <code>c.noteVerbose</code> can help by both recording a result if the test fails and displaying values as they are tested.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">intensify <span class="kw">=</span> <span class="fu">(n) -&gt;</span><br />  <span class="dv">2</span><br /><br />runOnDemand <span class="fu">-&gt;</span><br />  testPure intensify<span class="kw">,</span> <span class="kw">[</span>arbInt<span class="kw">],</span><br />    <span class="st">'intensify grows by 2 when positive'</span><span class="kw">,</span><br />    <span class="fu">(c, arg, result) -&gt;</span><br />      c<span class="kw">.</span>guard arg <span class="kw">&gt;</span> <span class="dv">0</span><br />      arg <span class="kw">+</span> <span class="dv">2</span> <span class="kw">is</span> result<br /><br />  testPure intensify<span class="kw">,</span> <span class="kw">[</span>arbInt<span class="kw">],</span><br />    <span class="st">'intensify grows by 2 when negative'</span><span class="kw">,</span><br />    <span class="fu">(c, arg, result) -&gt;</span><br />      c<span class="kw">.</span>guard arg <span class="kw">&lt;</span> <span class="dv">0</span><br />      arg <span class="kw">-</span> <span class="dv">2</span> <span class="kw">is</span> result<br /><br />  testPure intensify<span class="kw">,</span> <span class="kw">[</span>arbConst<span class="kw">(</span><span class="dv">0</span><span class="kw">)],</span><br />    <span class="st">'only non-zero intensify grows'</span><span class="kw">,</span><br />    <span class="fu">(c, arg, result) -&gt;</span><br />      result <span class="kw">is</span> <span class="dv">0</span><br /><br />  test<span class="kw">()</span></code></pre>
<section id="view-solution-12" onclick="reveal(this)" >
<h5>View Solution</h5>
<section id="section-64" style="display:none" >
<h6></h6>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">intensify <span class="kw">=</span> <span class="fu">(n) -&gt;</span><br />  <span class="kw">if</span> n <span class="kw">&gt;</span> <span class="dv">0</span><br />    n <span class="kw">+</span> <span class="dv">2</span><br />  <span class="kw">else</span> <span class="kw">if</span> n <span class="kw">&lt;</span> <span class="dv">0</span><br />    n <span class="kw">-</span> <span class="dv">2</span><br />  <span class="kw">else</span><br />    n</code></pre>
</section>
</section>
</section>
<section id="section-65">
<h4></h4>
<p>Writing test declarations before writing a function can be a good way of specifying it. The test declarations in these examples are much larger than the functions they are testing. In <a href="#binary-heaps">Binary Heaps↓</a> is a more realistic example of a class and tests for it. Declarative testing is well suited to testing algorithms and reusable libraries. There are many other test tools that you can choose depending on your preference and task<sup><a href="#fn17" class="footnoteRef" id="fnref17">17</a></sup>. The main point here is that a reasonable level of testing is part of writing code.</p>
<section id="section-66">
<h5>○•○</h5>
<p>Back to functions, they do not have to contain a <code>return</code> statement. If no <code>return</code> statement is encountered, the function returns the value of the last statement. The predefined function <code>view</code> returns its argument so that it can be used inside expressions. If you want the function to return <code>undefined</code> then the last statement can be a <code>return</code>.<sup><a href="#fn18" class="footnoteRef" id="fnref18">18</a></sup></p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">yell <span class="kw">=</span> <span class="fu">(message) -&gt;</span><br />  view message <span class="kw">+</span> <span class="st">'!!'</span><br />  <span class="kw">return</span><br />yell <span class="st">'Yow'</span></code></pre>
</section>
<section id="section-67">
<h5>○•○</h5>
<p>The names of the arguments of a function are available as variables inside it. They will refer to the values of the arguments the function is being called with, and like normal variables created inside a function, they do not exist outside it. Aside from the top-level environment<a href="#index-top-level-environment"></a>, there are smaller, local environments<a href="#index-local-environment"></a> created by functions. When looking up a variable inside a function, the outer environment is checked first, and only if the variable does not exist there is it created in the local environment.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">dino <span class="kw">=</span> <span class="st">'I am alive'</span><br />reptile <span class="kw">=</span> <span class="st">'I am A-OK'</span><br />meteor <span class="kw">=</span> <span class="fu">(reptile) -&gt;</span><br />  show reptile            <span class="co"># Argument</span><br />  dino <span class="kw">=</span> <span class="st">'I am extinct'</span><br />  reptile <span class="kw">=</span> <span class="st">'I survived'</span><br />  possum <span class="kw">=</span> <span class="st">'I am new'</span><br />show dino                 <span class="co"># Outer</span><br />meteor <span class="st">'What happened?'</span><br />show dino                 <span class="co"># Outer changed</span><br />show reptile              <span class="co"># Outer unchanged</span><br /><span class="kw">try</span> show possum <span class="kw">catch</span> e<br />  show e<span class="kw">.</span>message          <span class="co"># Error undefined</span></code></pre>
<p>This makes it possible for arguments to a function to ‘shadow’<a href="#index-shadow"></a> outer level variables that have the same name. The easiest way to deal with variables is to use unique names for variables throughout a file. In <a href="#modularity">Modularity↓</a> you will see that the top-level is not shared between files unless variables are specifically exported.</p>
<p align=center><img src="../img/environments-small.png" alt="figure ../img/environments-small.png" /><br /></p>
<p>So if the name of variable in an inner function exists in an outer environment then the variable is referring to the outer one, it is not a new definition. That is an expression like <code>variable = 'something'</code> may be a definition of a new variable or it may be an assignment to a previously defined variable. As a matter of style, when you are using top-level variables then it makes sense to introduce them at the top of a file with a default value.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">variable <span class="kw">=</span> <span class="st">'first'</span>                    <span class="co"># Definition</span><br /><br />showVariable <span class="kw">=</span> <span class="fu">-&gt;</span><br />  show <span class="st">'In showVariable, the variable holds: '</span> <span class="kw">+</span><br />        variable                      <span class="co"># second</span><br /><br />testIt <span class="kw">=</span> <span class="fu">-&gt;</span><br />  variable <span class="kw">=</span> <span class="st">'second'</span>                 <span class="co"># Assignment</span><br />  show <span class="st">'In test, the variable holds '</span> <span class="kw">+</span><br />       variable <span class="kw">+</span> <span class="st">'.'</span>                 <span class="co"># second</span><br />  showVariable<span class="kw">()</span><br /><br />show <span class="st">'The variable is: '</span> <span class="kw">+</span> variable   <span class="co"># first</span><br />testIt<span class="kw">()</span><br />show <span class="st">'The variable is: '</span> <span class="kw">+</span> variable   <span class="co"># second</span></code></pre>
<p>The variables defined in the local environment are only visible to the code inside the function. If a function calls another function, the newly called function does not see the variables inside the first function.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">andHere <span class="kw">=</span> <span class="fu">-&gt;</span><br />  <span class="kw">try</span> show aLocal                     <span class="co"># Not defined</span><br />  <span class="kw">catch</span> e <span class="kw">then</span> show e<span class="kw">.</span>message<br />isHere <span class="kw">=</span> <span class="fu">-&gt;</span><br />  aLocal <span class="kw">=</span> <span class="st">'aLocal is defined'</span><br />  andHere<span class="kw">()</span><br />isHere<span class="kw">()</span></code></pre>
<p>However, and this is a subtle but extremely useful phenomenon, when a function is defined <em>inside</em> another function, its local environment will be based on the local environment that surrounds it.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">isHere <span class="kw">=</span> <span class="fu">-&gt;</span><br />  andHere <span class="kw">=</span> <span class="fu">-&gt;</span><br />    <span class="kw">try</span> show aLocal                   <span class="co"># Is defined</span><br />    <span class="kw">catch</span> e <span class="kw">then</span> show e<span class="kw">.</span>message<br />  aLocal <span class="kw">=</span> <span class="st">'aLocal is defined'</span><br />  andHere<span class="kw">()</span><br />isHere<span class="kw">()</span></code></pre>
</section>
<section id="section-68">
<h5>○•○</h5>
<p>Here is a special case that might surprise you:</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">varWhich <span class="kw">=</span> <span class="st">'top-level'</span><br />parentFunction <span class="kw">=</span> <span class="fu">-&gt;</span><br />  varWhich <span class="kw">=</span> <span class="st">'local'</span><br />  childFunction <span class="kw">=</span> <span class="fu">-&gt;</span><br />    show varWhich<br />  childFunction<br />child <span class="kw">=</span> parentFunction<span class="kw">()</span><br />child<span class="kw">()</span></code></pre>
<p><code>parentFunction</code> <em>returns</em> its internal function, and the code at the bottom calls this function. Even though <code>parentFunction</code> has finished executing at this point, the local environment where <code>variable</code> has the value <code>'local'</code> still exists, and <code>childFunction</code> still uses it. This phenomenon is called closure<a href="#index-closure"></a>.</p>
</section>
<section id="section-69">
<h5>○•○</h5>
<p>With scoping we can ‘synthesise’ functions. By using some of the variables from an enclosing function, an inner function can be made to do different things. Imagine we need a few different but similar functions, one that adds 2 to its argument, one that adds 5, and so on.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">makeAddFunction <span class="kw">=</span> <span class="fu">(amount) -&gt;</span><br />  add <span class="kw">=</span> <span class="fu">(number) -&gt;</span> number <span class="kw">+</span> amount<br /><br />addTwo <span class="kw">=</span> makeAddFunction <span class="dv">2</span><br />addFive <span class="kw">=</span> makeAddFunction <span class="dv">5</span><br />show addTwo<span class="kw">(</span><span class="dv">1</span><span class="kw">)</span> <span class="kw">+</span> addFive<span class="kw">(</span><span class="dv">1</span><span class="kw">)</span></code></pre>
</section>
<section id="section-70">
<h5>○•○</h5>
<p>On top of the fact that different functions can contain variables of the same name without getting tangled up, these scoping rules also allow functions to call <em>themselves</em> without running into problems. A function that calls itself is called recursive. Recursion<a href="#index-recursion"></a> allows for some interesting definitions. When you define recursive functions the first thing you need is a stop condition, otherwise your recursive function becomes an elaborate but never ending loop. Look at this implementation of <code>power</code>:</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">powerRec <span class="kw">=</span> <span class="fu">(base, exponent) -&gt;</span><br />  <span class="kw">if</span> exponent <span class="kw">is</span> <span class="dv">0</span><br />    <span class="dv">1</span><br />  <span class="kw">else</span><br />    base <span class="kw">*</span> powerRec base<span class="kw">,</span> exponent <span class="kw">-</span> <span class="dv">1</span><br />show <span class="st">'power 3, 3 = '</span> <span class="kw">+</span> powerRec <span class="dv">3</span><span class="kw">,</span> <span class="dv">3</span></code></pre>
<p>This is rather close to the way mathematicians define exponentiation, and to me it looks a lot nicer than the earlier version. It sort of loops, but there is no <code>while</code>, <code>for</code>, or even a local side effect to be seen. By calling itself, the function produces the same effect. The stop condition is when <code>exponent</code> becomes <code>0</code> and the <code>exponent - 1</code> ensures that <code>exponent</code> gets closer to <code>0</code> for each call. Note the assumption that exponent is a positive integer, that should be clearly documented if <code>powerRec</code> was a part of a reusable library.</p>
</section>
<section id="section-71">
<h5>○•○</h5>
<p>Does this elegance affect performance? There is only one way to know for sure: measure it. The timings below are from my machine, you should not rely much on those. CPU’s, operating systems, compilers and interpreters in browsers all has an effect on performance, so measure in something that is as close to your target environment as possible.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">timeIt <span class="kw">=</span> <span class="fu">(func) -&gt;</span><br />  start <span class="kw">=</span> <span class="kw">new</span> <span class="dt">Date</span><span class="kw">()</span><br />  <span class="kw">for</span> i <span class="kw">in</span> <span class="kw">[</span><span class="dv">0</span><span class="kw">...</span><span class="dv">1000000</span><span class="kw">]</span> <span class="kw">then</span> func<span class="kw">()</span><br />  show <span class="st">&quot;Timing: </span><span class="ch">#{</span>(new Date() - start)*0.001<span class="ch">}</span><span class="st">s&quot;</span><br /><br />add <span class="kw">=</span> <span class="fu">(n, m) -&gt;</span> n <span class="kw">+</span> m <span class="co"># Baseline comparison</span><br /><br />runOnDemand <span class="fu">-&gt;</span><br />  timeIt <span class="fu">-&gt;</span> p <span class="kw">=</span> add <span class="dv">9</span><span class="kw">,</span><span class="dv">18</span>                <span class="co"># 0.042s</span><br />  timeIt <span class="fu">-&gt;</span> p <span class="kw">=</span> <span class="ot">Math</span><span class="kw">.</span>pow <span class="dv">9</span><span class="kw">,</span><span class="dv">18</span>           <span class="co"># 0.049s</span><br />  timeIt <span class="fu">-&gt;</span> p <span class="kw">=</span> power <span class="dv">9</span><span class="kw">,</span><span class="dv">18</span>              <span class="co"># 0.464s</span><br />  timeIt <span class="fu">-&gt;</span> p <span class="kw">=</span> powerRec <span class="dv">9</span><span class="kw">,</span><span class="dv">18</span>           <span class="co"># 0.544s</span></code></pre>
<p><a href="#index-efficiency"></a>The dilemma of speed versus elegance<a href="#index-elegance"></a> is an interesting one. It not only occurs when deciding for or against recursion. In many situations, an elegant, intuitive, and often short solution can be replaced by a more convoluted but faster solution.</p>
<p>In the case of the <code>power</code> function above the un-elegant version is still sufficiently simple and easy to read. It does not make very much sense to replace it with the recursive version. Often, though, the concepts a program is dealing with get so complex that giving up some efficiency in order to make the program more straightforward becomes an attractive choice.</p>
<p>The basic rule, which has been repeated by many programmers and with which I wholeheartedly agree, is not to worry about efficiency until your program is provably too slow. When it is, find out which parts are too slow, and start exchanging elegance for efficiency in those parts.</p>
<p>Of course, the above rule does not mean one should start ignoring performance altogether. In many cases, like the <code>power</code> function, not much simplicity is gained by the ‘elegant’ approach. In other cases, an experienced programmer can see right away that a simple approach is never going to be fast enough.</p>
<p>The reason I am making a big deal out of this is that surprisingly many programmers focus fanatically on efficiency, even in the smallest details. The result is bigger, more complicated, and often less correct programs, which take longer to write than their more straightforward equivalents and often run only marginally faster.</p>
<p>When you have a simple, correct implementation that is too slow, then you can use that as a reference implementation to test your improved version. The one thing you do need to consider up front is what kind of data structures and algorithms can handle the task at hand. There is a huge difference between searching in a list with ten items and searching in a list with millions of items. These kind of considerations are covered in more detail in <a href="#searching">Searching↓</a>.</p>
</section>
<section id="section-72">
<h5>○•○</h5>
<p>But I was talking about recursion. A concept closely related to recursion is a thing called the stack<a href="#index-stack"></a>. When a function is called, control is given to the body of that function. When that body returns, the code that called the function is resumed. While the body is running, the computer must remember the context from which the function was called, so that it knows where to continue afterwards. The place where this context is stored is called the stack.</p>
<p>The fact that it is called ‘stack’ has to do with the fact that, as we saw, a function body can again call a function. Every time a function is called, another context has to be stored. One can visualise this as a stack of contexts. Every time a function is called, the current context is thrown on top of the stack. When a function returns, the context on top is taken off the stack and resumed.</p>
<p>This stack requires space in the computer’s memory to be stored. When the stack grows too big, the computer will give up with a message like “out of stack space” or “too much recursion”. This is something that has to be kept in mind when writing recursive functions.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">chicken <span class="kw">=</span> <span class="fu">-&gt;</span><br />  show <span class="st">'Lay an egg'</span><br />  egg<span class="kw">()</span><br /><br />egg <span class="kw">=</span> <span class="fu">-&gt;</span><br />  show <span class="st">'Chick hatched'</span><br />  chicken<span class="kw">()</span><br /><br /><span class="co"># </span><span class="al">WARNING</span><span class="co">! Clicking `Run` may cause your</span><br /><span class="co"># browser to enter a catatonic state</span><br />runOnDemand <span class="fu">-&gt;</span><br />  <span class="kw">try</span> show chicken<span class="kw">()</span> <span class="kw">+</span> <span class="st">' came first.'</span><br />  <span class="kw">catch</span> error <span class="kw">then</span> show error<span class="kw">.</span>message</code></pre>
<p>In addition to demonstrating a very interesting way of writing a broken program, this example shows that a function does not have to call itself directly to be recursive. If it calls another function which (directly or indirectly) calls the first function again, it is still recursive. The <code>try</code> and <code>catch</code> parts are covered in <a href="#error-handling">Error Handling↓</a>.</p>
</section>
<section id="section-73">
<h5>○•○</h5>
<p>Recursion is not always just a less-efficient alternative to looping. Some problems are much easier to solve with recursion than with loops. Most often these are problems that require exploring or processing several ‘branches’, each of which might branch out again into more branches.</p>
<p>Consider this puzzle: By starting from the number 1 and repeatedly either adding 5 or multiplying by 3, an infinite amount of new numbers can be produced. How would you write a function that, given a number, tries to find a sequence of additions and multiplications that produce that number?</p>
<p>For example, the number 13 could be reached by first multiplying 1 by 3, and then adding 5 twice. The number 15 can not be reached at all.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">findSequence <span class="kw">=</span> <span class="fu">(goal) -&gt;</span><br />  find <span class="kw">=</span> <span class="fu">(start, history) -&gt;</span><br />    <span class="kw">if</span> start <span class="kw">is</span> goal<br />      history<br />    <span class="kw">else</span> <span class="kw">if</span> start <span class="kw">&gt;</span> goal<br />      <span class="ot">null</span><br />    <span class="kw">else</span><br />      find<span class="kw">(</span>start <span class="kw">+</span> <span class="dv">5</span><span class="kw">,</span> <span class="st">'('</span> <span class="kw">+</span> history <span class="kw">+</span> <span class="st">' + 5)'</span><span class="kw">)</span> <span class="kw">?</span> \<br />      find<span class="kw">(</span>start <span class="kw">*</span> <span class="dv">3</span><span class="kw">,</span> <span class="st">'('</span> <span class="kw">+</span> history <span class="kw">+</span> <span class="st">' * 3)'</span><span class="kw">)</span><br />  find <span class="dv">1</span><span class="kw">,</span> <span class="st">'1'</span><br />show findSequence <span class="dv">24</span></code></pre>
<p>Note that the solution does not necessarily find the <em>shortest</em> sequence of operations, it is satisfied when it finds any sequence at all.</p>
<p>The inner <code>find</code> function, by calling itself in two different ways, explores both the possibility of adding 5 to the current number and of multiplying it by 3. When it finds the number, it returns the <code>history</code> string, which is used to record all the operators that were performed to get to this number. It also checks whether the current number is bigger than <code>goal</code>, because if it is, we should stop exploring this branch, it is not going to give us our number.</p>
<p>The use of the existential <code>?</code> operator in the example can be read as ‘return the solution found by adding 5 to <code>start</code>, and if that fails, return the solution found by multiplying <code>start</code> by 3’.</p>
</section>
<section id="section-74">
<h5>○•○</h5>
<p>Usually when you define a function you assign it to a name that you can use to refer to it later. That is not required and sometimes it is not worthwhile to give a function a name, then you can use an anonymous function<a href="#index-anonymous-function"></a> instead.</p>
<p>Like in the <code>makeAddFunction</code> example we saw earlier:</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">makeAddFunction <span class="kw">=</span> <span class="fu">(amount) -&gt;</span><br />  <span class="fu">(number) -&gt;</span> number <span class="kw">+</span> amount<br /><br />show makeAddFunction<span class="kw">(</span><span class="dv">11</span><span class="kw">)</span> <span class="dv">3</span></code></pre>
<p>Since the function named <code>add</code> in the first version of <code>makeAddFunction</code> was referred to only once, the name does not serve any purpose and we might as well directly return the function value.</p>
</section>
</section>
<section id="exercise-9">
<h4><em>Exercise 9</em></h4>
<p>Write a function <code>greaterThan</code>, which takes one argument, a number, and returns a function that represents a test. When this returned function is called with a single number as argument, it returns a boolean: <code>true</code> if the given number is greater than the number that was used to create the test function, and <code>false</code> otherwise.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false"><span class="co"># Compose a solution here</span></code></pre>
<section id="view-solution-13" onclick="reveal(this)" >
<h5>View Solution</h5>
<section id="section-75" style="display:none" >
<h6></h6>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">greaterThan <span class="kw">=</span> <span class="fu">(x) -&gt;</span><br />  <span class="fu">(y) -&gt;</span> y <span class="kw">&gt;</span> x<br /><br />greaterThanTen <span class="kw">=</span> greaterThan <span class="dv">10</span><br />show greaterThanTen <span class="dv">9</span></code></pre>
</section>
</section>
</section>
<section id="section-76">
<h4></h4>
<p>Try the following:</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">yell <span class="st">'Hello'</span><span class="kw">,</span> <span class="st">'Good Evening'</span><span class="kw">,</span> <span class="st">'How do you do?'</span></code></pre>
<p>The function <code>yell</code> defined earlier in this chapter only accepts one argument. Yet when you call it like this, the computer does not complain at all, but just ignores the other arguments.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">yell<span class="kw">()</span></code></pre>
<p>You can, apparently, even get away with passing too few arguments. When an argument is not passed, its value inside the function is <code>undefined</code>.</p>
<p>In the next chapter, we will see a way in which a function body can get at the exact list of arguments that were passed to it. This can be useful, as it makes it possible to have a function accept any number of arguments. A debugging function <code>console.log</code> makes use of this:</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false"><span class="ot">console</span><span class="kw">?.</span>log <span class="st">'R'</span><span class="kw">,</span> <span class="dv">2</span><span class="kw">,</span> <span class="st">'D'</span><span class="kw">,</span> <span class="dv">2</span></code></pre>
<p>To see the output from <code>console.log</code> you have to enable and open your browser’s built-in developer tools. The question mark is to prevent Internet Explorer 9 from throwing an error if Developer Tools (F12) has not been activated.</p>
<p>Of course, the downside of a variable number of arguments is that it is also possible to accidentally pass the wrong number of arguments to functions that expect a fixed amount of them and never be told about it.</p>
<hr />
</section>
</section>
<section id="data-structures-objects-and-arrays">
<h3>Data Structures: Objects and Arrays</h3>
<hr />
<p>This chapter will be devoted to solving a few simple problems. In the process, we will discuss two new types of values, arrays and objects, and look at some techniques related to them.</p>
<p>Consider the following situation: Your crazy aunt Emily, who is rumoured to have over fifty cats living with her (you never managed to count them), regularly sends you e-mails to keep you up to date on her exploits. They usually look like this:</p>
<blockquote>
<p><em>Dear nephew,</em><br /> <em>Your mother told me you have taken up skydiving. Is this true? You watch yourself, young man! Remember what happened to my husband? And that was only from the second floor!</em><br /> <em>Anyway, things are very exciting here. I have spent all week trying to get the attention of Mr. Drake, the nice gentleman who moved in next door, but I think he is afraid of cats. Or allergic to them? I am going to try putting Fat Igor on his shoulder next time I see him, very curious what will happen.</em><br /> <em>Also, the scam I told you about is going better than expected. I have already gotten back five ‘payments’, and only one complaint. It is starting to make me feel a bit bad though. And you are right that it is probably illegal in some way.</em></p>
</blockquote>
<blockquote>
<p><em>(</em>…<em>etc</em>…<em>)</em></p>
</blockquote>
<blockquote>
<p><em>Much love,</em><br /> <em>Aunt Emily</em><br /> <em>died 27/04/2006: Black Leclère</em><br /> <em>born 05/04/2006 (mother Lady Penelope): Red Lion, Doctor Hobbles the 3rd, Little Iroquois</em></p>
</blockquote>
<p>To humour the old dear, you would like to keep track of the genealogy of her cats, so you can add things like “P.S. I hope Doctor Hobbles the 2nd enjoyed his birthday this Saturday!”, or “How is old Lady Penelope doing? She’s five years old now, isn’t she?”, preferably without accidentally asking about dead cats. You are in the possession of a large quantity of old e-mails from your aunt, and fortunately she is very consistent in always putting information about the cats’ births and deaths at the end of her mails in precisely the same format.</p>
<p>You are hardly inclined to go through all those mails by hand. Fortunately, we were just in need of an example problem, so we will try to work out a program that does the work for us. For a start, we write a program that gives us a list of cats that are still alive after the last e-mail.</p>
<p>Before you ask, at the start of the correspondence, aunt Emily had only a single cat: Spot. (She was still rather conventional in those days.)</p>
<p align=center><img src="../img/eyes-small.jpg" alt="figure ../img/eyes-small.jpg" /><br /></p>
<p>It usually pays to have some kind of clue what one’s program is going to do before starting to type. Here’s a plan:</p>
<ol type="1">
<li>Start with a set of cat names that has only “Spot” in it.</li>
<li>Go over every e-mail in our archive, in chronological order.</li>
<li>Look for paragraphs that start with “born” or “died”.</li>
<li>Add the names from paragraphs that start with “born” to our set of names.</li>
<li>Remove the names from paragraphs that start with “died” from our set.</li>
</ol>
<p>Where taking the names from a paragraph goes like this:</p>
<ol type="1">
<li>Find the colon in the paragraph.</li>
<li>Take the part after this colon.</li>
<li>Split this part into separate names by looking for commas.</li>
</ol>
<p>It may require some suspension of disbelief to accept that aunt Emily always used this exact format, and that she never forgot or misspelled a name, but that is just how your aunt is.</p>
<section id="section-77">
<h5>○•○</h5>
<p>First, let me tell you about properties<a href="#index-properties"></a>. A lot of CoffeeScript values have other values associated with them. These associations are called properties. Every string has a property called <code>length</code><a href="#index-length"></a>, which refers to a number, the amount of characters in that string.</p>
<p><a href="#index-[]"></a>Properties can be accessed in two ways:</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">text <span class="kw">=</span> <span class="st">'purple haze'</span><br />show text<span class="kw">[</span><span class="st">'length'</span><span class="kw">]</span><br />show text<span class="kw">.</span>length</code></pre>
<p>The second way is a shorthand for the first, and it only works when the name of the property would be a valid variable name — when it does not have any spaces or symbols in it and does not start with a digit character.</p>
<p>Numbers, booleans, the value <code>null</code>, and the value <code>undefined</code> do not have any properties. Trying to read properties from such a value produces an error. Try the following code, if only to get an idea about the kind of error-message you get in such a case (which, for some browsers, can be rather cryptic).</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">nothing <span class="kw">=</span> <span class="ot">null</span><br /><span class="kw">try</span> show nothing<span class="kw">.</span>length <span class="kw">catch</span> error <span class="kw">then</span> show error<span class="kw">.</span>message</code></pre>
<p>The properties of a string value can not be changed. There are quite a few more than just <code>length</code>, as we will see, but you are not allowed to add or remove any.</p>
<p>This is different with values of the type object<a href="#index-object"></a>. Their main role is to hold other values. They have, you could say, their own set of tentacles in the form of properties. You are free to modify these, remove them, or add new ones.</p>
<p><a href="#index-%7B%7D"></a>An object can be written like this:</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">cat <span class="kw">=</span><br />  colour<span class="kw">:</span> <span class="st">'grey'</span><br />  name<span class="kw">:</span> <span class="st">'Spot'</span><br />  size<span class="kw">:</span> <span class="dv">46</span><br /><span class="co"># Or: cat = {colour: 'grey', name: 'Spot', size: 46}</span><br />cat<span class="kw">.</span>size <span class="kw">=</span> <span class="dv">47</span><br />show cat<span class="kw">.</span>size<br /><span class="kw">delete</span> cat<span class="kw">.</span>size<br />show cat<span class="kw">.</span>size<br />show cat</code></pre>
<p>Like variables, each property attached to an object is labelled by a string. The first statement creates an object in which the property <code>'colour'</code> holds the string <code>'grey'</code>, the property <code>'name'</code> is attached to the string <code>'Spot'</code>, and the property <code>'size'</code> refers to the number <code>46</code>. The second statement gives the property named <code>size</code> a new value, which is done in the same way as modifying a variable.</p>
<p>The keyword <code>delete</code><a href="#index-delete"></a> cuts off properties. Trying to read a non-existent property gives the value <code>undefined</code>.</p>
<p>If a property that does not yet exist is set with the <code>=</code><a href="#index-="></a> operator, it is added to the object.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">empty <span class="kw">=</span> <span class="kw">{}</span><br />empty<span class="kw">.</span>notReally <span class="kw">=</span> <span class="dv">1000</span><br />show empty<span class="kw">.</span>notReally</code></pre>
<p>Properties whose names are not valid variable names have to be quoted when creating the object, and approached using brackets:</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">thing <span class="kw">=</span> <span class="kw">{</span><span class="st">'gabba gabba'</span><span class="kw">:</span> <span class="st">'hey'</span><span class="kw">,</span> <span class="st">'5'</span><span class="kw">:</span> <span class="dv">10</span><span class="kw">}</span><br />show thing<span class="kw">[</span><span class="st">'5'</span><span class="kw">]</span><br />thing<span class="kw">[</span><span class="st">'5'</span><span class="kw">]</span> <span class="kw">=</span> <span class="dv">20</span><br />show thing<span class="kw">[</span><span class="dv">2</span> <span class="kw">+</span> <span class="dv">3</span><span class="kw">]</span><br /><span class="kw">delete</span> thing<span class="kw">[</span><span class="st">'gabba gabba'</span><span class="kw">]</span><br />show thing</code></pre>
<p>As you can see, the part between the brackets can be any expression. It is converted to a string to determine the property name it refers to. One can even use variables to name properties:</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">propertyName <span class="kw">=</span> <span class="st">'length'</span><br />text <span class="kw">=</span> <span class="st">'mainline'</span><br />show text<span class="kw">[</span>propertyName<span class="kw">]</span></code></pre>
<p>The operator <code>of</code><a href="#index-of"></a> can be used to test whether an object has a certain property. It produces a boolean.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">chineseBox <span class="kw">=</span> <span class="kw">{}</span><br />chineseBox<span class="kw">.</span>content <span class="kw">=</span> chineseBox<br />show <span class="st">'content'</span> <span class="kw">of</span> chineseBox<br />show <span class="st">'content'</span> <span class="kw">of</span> chineseBox<span class="kw">.</span>content<br />show chineseBox</code></pre>
</section>
<section id="section-78">
<h5>○•○</h5>
<p>When object values are shown in the interactive environment, all layers of properties are shown. You can give an extra boolean argument, <code>shallow</code>, to <code>show</code> to only its <code>own</code> top-most properties. This is also used to limit the display of objects with circular references such as for the <code>chineseBox</code> above.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">abyss <span class="kw">=</span> <span class="kw">{</span>lets<span class="kw">:</span><span class="dv">1</span><span class="kw">,</span> go<span class="kw">:</span>deep<span class="kw">:</span>down<span class="kw">:</span>into<span class="kw">:</span>the<span class="kw">:</span>abyss<span class="kw">:</span><span class="dv">7</span><span class="kw">}</span><br />show abyss<br />show abyss<span class="kw">,</span> <span class="ot">on</span></code></pre>
</section>
<section id="exercise-10">
<h4><em>Exercise 10</em></h4>
<p>The solution for the cat problem talks about a ‘set’ of names. A set<a href="#index-set"></a> is a collection of values in which no value may occur more than once. If names are strings, can you think of a way to use an object to represent a set of names?</p>
<p>Show how a name can be added to this set, how one can be removed, and how you can check whether a name occurs in it.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false"><span class="co"># Compose a solution here</span></code></pre>
<section id="view-solution-14" onclick="reveal(this)" >
<h5>View Solution</h5>
<section id="section-79" style="display:none" >
<h6></h6>
<p>This can be done by storing the content of the set as the properties of an object. Adding a name is done by setting a property by that name to a value, any value. Removing a name is done by deleting this property. The <code>of</code> operator can be used to determine whether a certain name is part of the set. There are a few subtle problems with this approach, which will be discussed and solved in <a href="#object-oriented-programming">Object Orientation↓</a>. For this chapter, it works well enough.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">set <span class="kw">=</span> <span class="kw">{</span><span class="st">'Spot'</span><span class="kw">:</span> <span class="ot">true</span><span class="kw">}</span><br /><span class="co"># Add 'White Fang' to the set</span><br />set<span class="kw">[</span><span class="st">'White Fang'</span><span class="kw">]</span> <span class="kw">=</span> <span class="ot">true</span><br /><span class="co"># Remove 'Spot'</span><br /><span class="kw">delete</span> set<span class="kw">[</span><span class="st">'Spot'</span><span class="kw">]</span><br /><span class="co"># See if 'Asoka' is in the set</span><br />show <span class="st">'Asoka'</span> <span class="kw">of</span> set</code></pre>
</section>
</section>
</section>
<section id="section-80">
<h4></h4>
<p><a href="#index-mutability"></a>Object values, apparently, can change. The types of values discussed in <a href="#basic-coffeescript">Basic CoffeeScript↑</a> are all immutable, it is impossible to change an existing value of those types. You can combine them and derive new values from them, but when you take a specific string value, the text inside it can not change. With objects, on the other hand, the content of a value can be modified by changing its properties.</p>
<p>When we have two numbers, <code>120</code> and <code>120</code>, they can for all practical purposes be considered the precise same number. With objects, there is a difference between having two references to the same object and having two different objects that contain the same properties. Consider the following code:</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">object1 <span class="kw">=</span> <span class="kw">{</span>value<span class="kw">:</span> <span class="dv">10</span><span class="kw">}</span><br />object2 <span class="kw">=</span> object1<br />object3 <span class="kw">=</span> <span class="kw">{</span>value<span class="kw">:</span> <span class="dv">10</span><span class="kw">}</span><br /><br />show object1 <span class="kw">is</span> object2<br />show object1 <span class="kw">is</span> object3<br /><br />object1<span class="kw">.</span>value <span class="kw">=</span> <span class="dv">15</span><br />show object2<span class="kw">.</span>value<br />show object3<span class="kw">.</span>value</code></pre>
<p><code>object1</code> and <code>object2</code> are two variables grasping the <em>same</em> value. There is only one actual object, which is why changing <code>object1</code> also changes the value of <code>object2</code>. The variable <code>object3</code> points to another object, which initially contains the same properties as <code>object1</code>, but lives a separate life.</p>
<p>CoffeeScript’s <code>is</code>/<code>==</code><a href="#index-=="></a> operator, when comparing objects, will only return <code>true</code> if both values given to it are the precise same value. Comparing different object with identical contents will give <code>false</code>. This is useful in some situations, but unpractical in others<sup><a href="#fn19" class="footnoteRef" id="fnref19">19</a></sup>.</p>
<section id="section-81">
<h5>○•○</h5>
<p>Object values can play a lot of different roles. Behaving like a set is only one of those. We will see a few other roles in this chapter, and <a href="#object-oriented-programming">Object Orientation↓</a> shows another important way of using objects.</p>
<p>In the plan for the cat problem — in fact, call it an <em>algorithm</em>, not a plan, that makes it sound like we know what we are talking about — in the algorithm, it talks about going over all the e-mails in an archive. What does this archive look like? And where does it come from?</p>
<p>Do not worry about the second question for now. <a href="#modularity">Modularity↓</a> talks about some ways to import data into your programs, but for now you will find that the e-mails are just magically there. Some magic is really easy, inside computers.</p>
</section>
<section id="section-82">
<h5>○•○</h5>
<p>The way in which the archive is stored is still an interesting question. It contains a number of e-mails. An e-mail can be a string, that should be obvious. The whole archive could be put into one huge string, but that is hardly practical. What we want is a collection of separate strings.</p>
<p>Collections of things are what objects are used for. One could make an object like this:</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">mailArchive <span class="kw">=</span> <span class="kw">{</span><br />  <span class="st">'the first e-mail'</span><span class="kw">:</span> <span class="st">'Dear nephew, ...'</span><br />  <span class="st">'the second e-mail'</span><span class="kw">:</span> <span class="st">'...'</span><br />  <span class="co"># and so on ...</span><br /><span class="kw">}</span></code></pre>
<p>But that makes it hard to go over the e-mails from start to end — how does the program guess the name of these properties? This can be solved by more predictable property names:</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">mailArchive <span class="kw">=</span> <span class="kw">{</span><br />  <span class="dv">0</span><span class="kw">:</span> <span class="st">'Dear nephew, ... (mail number 1)'</span><br />  <span class="dv">1</span><span class="kw">:</span> <span class="st">'(mail number 2)'</span><br />  <span class="dv">2</span><span class="kw">:</span> <span class="st">'(mail number 3)'</span><br /><span class="kw">}</span><br /><br /><span class="kw">for</span> current <span class="kw">of</span> mailArchive<br />  show <span class="st">'Processing e-mail #'</span> <span class="kw">+</span> current <span class="kw">+</span><br />       <span class="st">': '</span> <span class="kw">+</span> mailArchive<span class="kw">[</span>current<span class="kw">]</span></code></pre>
<p>Luck has it that there is a special kind of objects specifically for this kind of use. They are called arrays<a href="#index-array"></a>, and they provide some conveniences, such as a <code>length</code><a href="#index-length"></a> property that contains the amount of values in the array, and a number of operations useful for this kind of collections.</p>
<p><a href="#index-[]"></a>New arrays can be created using brackets (<code>[</code> and <code>]</code>). As with properties, the commas between elements are optional when they are placed on separate lines. Ranges and for comprehensions also create arrays.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">mailArchive <span class="kw">=</span> <span class="kw">[</span><span class="st">'mail one'</span><span class="kw">,</span> <span class="st">'mail two'</span><span class="kw">,</span> <span class="st">'mail three'</span><span class="kw">]</span><br /><br /><span class="kw">for</span> current <span class="kw">in</span> <span class="kw">[</span><span class="dv">0</span><span class="kw">...</span>mailArchive<span class="kw">.</span>length<span class="kw">]</span><br />  show <span class="st">'Processing e-mail #'</span> <span class="kw">+</span> current <span class="kw">+</span><br />       <span class="st">': '</span> <span class="kw">+</span> mailArchive<span class="kw">[</span>current<span class="kw">]</span></code></pre>
<p>In this example, the numbers of the elements are not specified explicitly anymore. The first one automatically gets the number 0, the second the number 1, and so on.</p>
<p>Why start at 0? People tend to start counting from 1. As unintuitive as it seems, numbering the elements in a collection from 0 is often more practical. Just go with it for now, it will grow on you.</p>
<p>Starting at element 0 also means that in a collection with <code>X</code> elements, the last element can be found at position <code>X - 1</code>. This is why the <code>for</code> loop in the example uses an exclusive range <code>0...mailArchive.length</code>. There is no element at position <code>mailArchive.length</code>, so as soon as <code>current</code> has that value, we stop looping.</p>
</section>
</section>
<section id="exercise-11">
<h4><em>Exercise 11</em></h4>
<p>Write a function <code>range</code> that takes one argument, a positive number, and returns an array containing all numbers from 0 up to and including the given number.</p>
<p>An empty array can be created by simply typing <code>[]</code>. Also remember that adding properties to an object, and thus also to an array, can be done by assigning them a value with the <code>=</code> operator. The <code>length</code> property is automatically updated when elements are added.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false"><span class="co"># Compose a solution here</span></code></pre>
<section id="view-solution-15" onclick="reveal(this)" >
<h5>View Solution</h5>
<section id="section-83" style="display:none" >
<h6></h6>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">range <span class="kw">=</span> <span class="fu">(upto) -&gt;</span><br />  result <span class="kw">=</span> <span class="kw">[]</span><br />  i <span class="kw">=</span> <span class="dv">0</span><br />  <span class="kw">while</span> i <span class="kw">&lt;=</span> upto<br />    result<span class="kw">[</span>i<span class="kw">]</span> <span class="kw">=</span> i<br />    i<span class="kw">++</span><br />  result<br />show range <span class="dv">4</span></code></pre>
<p>Instead of naming the loop variable <code>counter</code> or <code>current</code>, as I have been doing so far, it is now called simply <code>i</code>. Using single letters, usually <code>i</code>, <code>j</code>, or <code>k</code> for loop variables is a widely spread habit among programmers. It has its origin mostly in laziness: We’d rather type one character than seven, and names like <code>counter</code> and <code>current</code> do not really clarify the meaning of the variable much.</p>
<p>If a program uses too many meaningless single-letter variables, it can become unbelievably confusing. In my own programs, I try to only do this in a few common cases. Small loops are one of these cases. If the loop contains another loop, and that one also uses a variable named <code>i</code>, the inner loop will modify the variable that the outer loop is using, and everything will break. One could use <code>j</code> for the inner loop, but in general, when the body of a loop is big, you should come up with a variable name that has some clear meaning.</p>
<p>In CoffeeScript the solution can be written in much shorter forms using a for expression that collects the results or by using the built-in range.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">range <span class="kw">=</span> <span class="fu">(upto) -&gt;</span> i <span class="kw">for</span> i <span class="kw">in</span> <span class="kw">[</span><span class="dv">0</span><span class="kw">..</span>upto<span class="kw">]</span><br />show range <span class="dv">4</span><br />range <span class="kw">=</span> <span class="fu">(upto) -&gt;</span> <span class="kw">[</span><span class="dv">0</span><span class="kw">..</span>upto<span class="kw">]</span><br />show range <span class="dv">4</span></code></pre>
</section>
</section>
</section>
<section id="section-84">
<h4></h4>
<p>In CoffeeScript most statements can also be used as expressions. That means for example that the values from a for comprehension can be collected in a variable and used later.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">numbers <span class="kw">=</span> <span class="kw">(</span>number <span class="kw">for</span> number <span class="kw">in</span> <span class="kw">[</span><span class="dv">0</span><span class="kw">..</span><span class="dv">12</span><span class="kw">]</span> <span class="kw">by</span> <span class="dv">2</span><span class="kw">)</span><br />show numbers</code></pre>
<section id="section-85">
<h5>○•○</h5>
<p>Both string and array objects contain, in addition to the <code>length</code> property, a number of properties that refer to function values.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">doh <span class="kw">=</span> <span class="st">'Doh'</span><br />show <span class="kw">typeof</span> doh<span class="kw">.</span>toUpperCase<br />show doh<span class="kw">.</span>toUpperCase<span class="kw">()</span></code></pre>
<p>Every string has a <code>toUpperCase</code><a href="#index-toUpperCase"></a> property. When called, it will return a copy of the string, in which all letters have been converted to uppercase. There is also <code>toLowerCase</code><a href="#index-toLowerCase"></a>. Guess what that does.</p>
<p>Notice that, even though the call to <code>toUpperCase</code> does not pass any arguments, the function does somehow have access to the string <code>'Doh'</code>, the value of which it is a property. How this works precisely is described in <a href="#object-oriented-programming">Object Orientation↓</a>.</p>
<p>Properties that contain functions are generally called methods<a href="#index-method"></a>, for example ‘<code>toUpperCase</code> is a method of a string object’.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">mack <span class="kw">=</span> <span class="kw">[]</span><br />mack<span class="kw">.</span>push <span class="st">'Mack'</span><br />mack<span class="kw">.</span>push <span class="st">'the'</span><br />mack<span class="kw">.</span>push <span class="st">'Knife'</span><br />show mack<span class="kw">.</span>join <span class="st">' '</span><br />show mack<span class="kw">.</span>pop<span class="kw">()</span><br />show mack</code></pre>
<p>The method <code>push</code><a href="#index-push"></a>, which is associated with arrays, can be used to add values to it. It could have been used in the last exercise, as an alternative to <code>result[i] = i</code>. Then there is <code>pop</code><a href="#index-pop"></a>, the opposite of <code>push</code>: it takes off and returns the last value in the array. <code>join</code><a href="#index-join"></a> builds a single big string from an array of strings. The parameter it is given is pasted between the values in the array.</p>
</section>
<section id="section-86">
<h5>○•○</h5>
<p>Coming back to those cats, we now know that an array would be a good way to store the archive of e-mails. In this book, the <code>retrieveMails</code> after the <code>require</code> can be used to (magically) get hold of this array. The magic will be dispelled in <a href="#modularity">Modularity↓</a>.</p>
<p><strong>Mail Archive</strong></p>
</section>
<section id="view-solution-16" onclick="reveal(this)" >
<h5>View Solution</h5>
<section id="section-87" style="display:none" >
<h6></h6>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">retrieveMails <span class="kw">=</span> <span class="fu">-&gt;</span> <span class="kw">[</span><br />  <span class="st">&quot;Nephew,\n\nI bought a computer as soon as I received your letter. It took me two days to make it do 'internet', but I just kept calling the nice man at the computer shop, and in the end he came down to help personally. Send me something back if you receive this, so I know whether it actually works.\n\nLove,\nAunt Emily&quot;</span><br />  <span class="st">&quot;Dear Nephew,\n\nVery good! I feel quite proud about being so technologically minded, having a computer and all. I bet Mrs. Goor down the street wouldn't even know how to plug it in, that witch.\n\nAnyway, thanks for sending me that game, it was great fun. After three days, I beat it. My friend Mrs. Johnson was quite worried when I didn't come outside or answer the phone for three days, but I explained to her that I was working with my computer.\n\nMy cat had two kittens yesterday! I didn't even realize the thing was pregnant. I've listed the names at the bottom of my letter, so that you will know how to greet them the next time you come over.\n\nSincerely,\nAunt Emily\n\nborn 15/02/1999 (mother Spot): Clementine, Fireball&quot;</span><br />  <span class="st">&quot;[... and so on ...]\n\nborn 21/09/2000 (mother Spot): Yellow Emperor, Black Lecl&#232;re&quot;</span><br />  <span class="st">&quot;...\n\nborn 02/04/2001 (mother Clementine): Bugeye, Wolverine, Miss Bushtail&quot;</span><br />  <span class="st">&quot;...\n\ndied 12/12/2002: Clementine\n\ndied 15/12/2002: Wolverine&quot;</span><br />  <span class="st">&quot;...\n\nborn 15/11/2003 (mother Spot): White Fang&quot;</span><br />  <span class="st">&quot;...\n\nborn 10/04/2003 (mother Miss Bushtail): Yellow Bess&quot;</span><br />  <span class="st">&quot;...\n\ndied 30/05/2004: Yellow Emperor&quot;</span><br />  <span class="st">&quot;...\n\nborn 01/06/2004 (mother Miss Bushtail): Catharina, Fat Igor&quot;</span><br />  <span class="st">&quot;...\n\nborn 20/09/2004 (mother Yellow Bess): Doctor Hobbles the 2nd, Noog&quot;</span><br />  <span class="st">&quot;...\n\nborn 15/01/2005 (mother Yellow Bess): The Moose, Liger\n\ndied 17/01/2005: Liger&quot;</span><br />  <span class="st">&quot;Dear nephew,\n\nYour mother told me you have taken up skydiving. Is this true? You watch yourself, young man! Remember what happened to my husband? And that was only from the second floor!\n\nAnyway, things are very exciting here. I have spent all week trying to get the attention of Mr. Drake, the nice gentleman who moved in next\ndoor, but I think he is afraid of cats. Or allergic to them? I am\ngoing to try putting Fat Igor on his shoulder next time I see him, very curious what will happen.\n\nAlso, the scam I told you about is going better than expected. I have already gotten back five 'payments', and only one complaint. It is starting to make me feel a bit bad though. And you are right that it is probably illegal in some way.\n\n(... etc ...)\n\nMuch love,\nAunt Emily\n\ndied 27/04/2006: Black Lecl&#232;re\n\nborn 05/04/2006 (mother Lady Penelope): Red Lion, Doctor Hobbles the 3rd, Little Iroquois&quot;</span><br />  <span class="st">&quot;...\n\nborn 22/07/2006 (mother Noog): Goblin, Reginald, Little Maggie&quot;</span><br />  <span class="st">&quot;...\n\ndied 13/02/2007: Spot\n\ndied 21/02/2007: Fireball&quot;</span><br />  <span class="st">&quot;...\n\nborn 05/02/2007 (mother Noog): Long-ear Johnson&quot;</span><br />  <span class="st">&quot;...\n\nborn 03/03/2007 (mother Catharina): Asoka, Dark Empress, Rabbitface&quot;</span><br /><span class="kw">]</span></code></pre>
</section>
</section>
<section id="section-88">
<h5></h5>
<p>Going over them to process them one after another is no rocket science anymore either:</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">mailArchive <span class="kw">=</span> retrieveMails<span class="kw">()</span><br /><br /><span class="kw">for</span> email<span class="kw">,</span> i <span class="kw">in</span> mailArchive<br />  show <span class="st">&quot;Processing e-mail #</span><span class="ch">#{</span>i<span class="ch">}</span><span class="st"> </span><span class="ch">#{</span>email[0..15]<span class="ch">}</span><span class="st">...&quot;</span><br />  <span class="co"># Do more things...</span></code></pre>
<p>In a <code>for ... in</code> statement we can get both the value and its index in the array. The <code>email[0..15]</code> gets the first snippet of each email. We have also decided on a way to represent the set of cats that are alive. The next problem, then, is to find the paragraphs in an e-mail that start with <code>'born'</code> or <code>'died'</code>.</p>
</section>
<section id="section-89">
<h5>○•○</h5>
<p>The first question that comes up is what exactly a paragraph is. In this case, the string value itself can not help us much: CoffeeScript’s concept of text does not go any deeper than the ‘sequence of characters’ idea, so we must define paragraphs in those terms.</p>
<p>Earlier, we saw that there is such a thing as a newline character. These are what most people use to split paragraphs. We consider a paragraph, then, to be a part of an e-mail that starts at a newline character or at the start of the content, and ends at the next newline character or at the end of the content.</p>
<p>And we do not even have to write the algorithm for splitting a string into paragraphs ourselves. Strings already have a method named <code>split</code><a href="#index-split"></a>, which is (almost) the opposite of the <code>join</code> method of arrays. It splits a string into an array, using the string given as its argument to determine in which places to cut.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">words <span class="kw">=</span> <span class="st">'Cities of the Interior'</span><br />show words<span class="kw">.</span>split <span class="st">' '</span></code></pre>
<p>Thus, cutting on newlines (<code>'\n'</code>), can be used to split an e-mail into paragraphs.</p>
</section>
</section>
<section id="exercise-12">
<h4><em>Exercise 12</em></h4>
<p><code>split</code> and <code>join</code> are not precisely each other’s inverse. <code>string.split(x).join(x)</code> always produces the original value, but <code>array.join(x).split(x)</code> does not. Can you give an example of an array where <code>.join(' ').split(' ')</code> produces a different value?</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false"><span class="co"># Compose a solution here</span></code></pre>
<section id="view-solution-17" onclick="reveal(this)" >
<h5>View Solution</h5>
<section id="section-90" style="display:none" >
<h6></h6>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">array <span class="kw">=</span> <span class="kw">[</span><span class="st">'a'</span><span class="kw">,</span> <span class="st">'b'</span><span class="kw">,</span> <span class="st">'c d'</span><span class="kw">]</span><br />show array<span class="kw">.</span>join<span class="kw">(</span><span class="st">' '</span><span class="kw">).</span>split<span class="kw">(</span><span class="st">' '</span><span class="kw">)</span></code></pre>
</section>
</section>
</section>
<section id="section-91">
<h4></h4>
<p>Paragraphs that do not start with either “born” or “died” can be ignored by the program. How do we test whether a string starts with a certain word? The method <code>charAt</code><a href="#index-charAt"></a> can be used to get a specific character from a string. <code>x.charAt(0)</code> gives the first character, <code>1</code> is the second one, and so on. One way to check whether a string starts with “born” is:</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">paragraph <span class="kw">=</span> <span class="st">'born 15-11-2003 (mother Spot): White Fang'</span><br />show paragraph<span class="kw">.</span>charAt<span class="kw">(</span><span class="dv">0</span><span class="kw">)</span> <span class="kw">is</span> <span class="st">'b'</span> <span class="kw">and</span><br />     paragraph<span class="kw">.</span>charAt<span class="kw">(</span><span class="dv">1</span><span class="kw">)</span> <span class="kw">is</span> <span class="st">'o'</span> <span class="kw">and</span><br />     paragraph<span class="kw">.</span>charAt<span class="kw">(</span><span class="dv">2</span><span class="kw">)</span> <span class="kw">is</span> <span class="st">'r'</span> <span class="kw">and</span><br />     paragraph<span class="kw">.</span>charAt<span class="kw">(</span><span class="dv">3</span><span class="kw">)</span> <span class="kw">is</span> <span class="st">'n'</span></code></pre>
<p>But that gets a bit clumsy — imagine checking for a word of ten characters. There is something to be learned here though: when a line gets ridiculously long, it can be spread over multiple lines. The result can be made easier to read by lining up the start of the new line with the first element on the original line that plays a similar role. You can also end a line with <code>\</code> to indicate that it continues on the next line.</p>
<p>Strings also have a method called <code>slice</code><a href="#index-slice"></a>. It copies out a piece of the string, starting from the character at the position given by the first argument, and ending before (not including) the character at the position given by the second one. It is the same as using a range as an index. This allows the check to be written in a shorter way.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">show paragraph<span class="kw">.</span>slice<span class="kw">(</span><span class="dv">0</span><span class="kw">,</span> <span class="dv">4</span><span class="kw">)</span> <span class="kw">is</span> <span class="st">'born'</span><br />show paragraph<span class="kw">[</span><span class="dv">0</span><span class="kw">...</span><span class="dv">4</span><span class="kw">]</span> <span class="kw">is</span> <span class="st">'born'</span></code></pre>
</section>
<section id="exercise-13">
<h4><em>Exercise 13</em></h4>
<p>Write a function called <code>startsWith</code> that takes two arguments, both strings. It returns <code>true</code> when the first argument starts with the characters in the second argument, and <code>false</code> otherwise.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false"><span class="co"># Compose a solution here</span></code></pre>
<section id="view-solution-18" onclick="reveal(this)" >
<h5>View Solution</h5>
<section id="section-92" style="display:none" >
<h6></h6>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">startsWith <span class="kw">=</span> <span class="fu">(string, pattern) -&gt;</span><br />  string<span class="kw">.</span>slice<span class="kw">(</span><span class="dv">0</span><span class="kw">,</span> pattern<span class="kw">.</span>length<span class="kw">)</span> <span class="kw">is</span> pattern<br /><span class="co"># or</span><br />startsWith <span class="kw">=</span> <span class="fu">(string, pattern) -&gt;</span><br />  string<span class="kw">[</span><span class="dv">0</span><span class="kw">...</span>pattern<span class="kw">.</span>length<span class="kw">]</span> <span class="kw">is</span> pattern<br />show startsWith <span class="st">'rotation'</span><span class="kw">,</span> <span class="st">'rot'</span></code></pre>
</section>
</section>
</section>
<section id="section-93">
<h4></h4>
<p>What happens when <code>charAt</code>, <code>slice</code> or a range are used to take a piece of a string that does not exist? Will the <code>startsWith</code> still work when the pattern is longer than the string it is matched against?</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">show <span class="st">'Pip'</span><span class="kw">.</span>charAt <span class="dv">250</span><br />show <span class="st">'Nop'</span><span class="kw">.</span>slice <span class="dv">1</span><span class="kw">,</span> <span class="dv">10</span><br />show <span class="st">'Pin'</span><span class="kw">[</span><span class="dv">1</span><span class="kw">...</span><span class="dv">10</span><span class="kw">]</span></code></pre>
<p><code>charAt</code> will return <code>''</code> when there is no character at the given position, and <code>slice</code> or the range will simply leave out the part of the new string that does not exist.</p>
<p>So yes, <code>startsWith</code> should work. When <code>startsWith('Idiots', 'Most honoured colleagues')</code> is called, the call to <code>slice</code> will, because <code>string</code> does not have enough characters, always return a string that is shorter than <code>pattern</code>. Because of that, the comparison with <code>is</code> will return <code>false</code>, which is correct.</p>
<p>It helps to always take a moment to consider abnormal (but valid) inputs for a program. These are usually called corner cases<a href="#index-corner-case"></a>, and it is very common for programs that work perfectly on all the ‘normal’ inputs to screw up on corner cases<sup><a href="#fn20" class="footnoteRef" id="fnref20">20</a></sup>.</p>
<section id="section-94">
<h5>○•○</h5>
<p>The only part of the cat-problem that is still unsolved is the extraction of names from a paragraph. The algorithm was this:</p>
<ol type="1">
<li>Find the colon in the paragraph.</li>
<li>Take the part after this colon.</li>
<li>Split this part into separate names by looking for commas.</li>
</ol>
<p>This has to happen both for paragraphs that start with <code>'died'</code>, and paragraphs that start with <code>'born'</code>. It would be a good idea to put it into a function, so that the two pieces of code that handle these different kinds of paragraphs can both use it.</p>
</section>
</section>
<section id="exercise-14">
<h4><em>Exercise 14</em></h4>
<p>Can you write a function <code>catNames</code> that takes a paragraph as an argument and returns an array of names?</p>
<p>Strings have an <code>indexOf</code><a href="#index-indexOf"></a> method that can be used to find the (first) position of a character or sub-string within that string. Also, when <code>slice</code> is given only one argument, it will return the part of the string from the given position all the way to the end. With a range either the start or end can be left out: <code>'shorthand'[...5]</code> ⇒ <code>'short'</code> and <code>'shorthand'[5...]</code> ⇒ <code>'hand'</code>.</p>
<p>It can be helpful to use CoffeeScript interactively to ‘explore’ functions. Try <code>'foo: bar'.indexOf(':')</code> and see what you get.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false"><span class="co"># Compose a solution here</span></code></pre>
<section id="view-solution-19" onclick="reveal(this)" >
<h5>View Solution</h5>
<section id="section-95" style="display:none" >
<h6></h6>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">catNames <span class="kw">=</span> <span class="fu">(paragraph) -&gt;</span><br />  colon <span class="kw">=</span> paragraph<span class="kw">.</span>indexOf <span class="st">':'</span><br />  paragraph<span class="kw">[</span>colon<span class="dv">+2</span><span class="kw">...].</span>split <span class="st">', '</span><br /><br />show catNames <span class="st">'born 20/09/2004 (mother Yellow Bess): '</span> <span class="kw">+</span><br />              <span class="st">'Doctor Hobbles the 2nd, Noog'</span></code></pre>
<p>The tricky part, which the original description of the algorithm ignored, is dealing with spaces after the colon and the commas. The <code>+ 2</code> used when slicing the string is needed to leave out the colon itself and the space after it. The argument to <code>split</code> contains both a comma and a space, because that is what the names are really separated by, rather than just a comma.</p>
<p>This function does not do any checking for problems. We assume, in this case, that the input is always correct.</p>
</section>
</section>
</section>
<section id="section-96">
<h4></h4>
<p>All that remains now is putting the pieces together. One way to do that looks like this:</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">mailArchive <span class="kw">=</span> retrieveMails<span class="kw">()</span><br />livingCats <span class="kw">=</span> <span class="st">'Spot'</span><span class="kw">:</span> <span class="ot">true</span><br /><br /><span class="kw">for</span> email<span class="kw">,</span> i <span class="kw">in</span> mailArchive<br />  paragraphs <span class="kw">=</span> email<span class="kw">.</span>split <span class="st">'\n'</span><br />  <span class="kw">for</span> paragraph <span class="kw">in</span> paragraphs<br />    <span class="kw">if</span> startsWith paragraph<span class="kw">,</span> <span class="st">'born'</span><br />      names <span class="kw">=</span> catNames paragraph<br />      <span class="kw">for</span> name <span class="kw">in</span> names<br />        livingCats<span class="kw">[</span>name<span class="kw">]</span> <span class="kw">=</span> <span class="ot">true</span><br />    <span class="kw">else</span> <span class="kw">if</span> startsWith paragraph<span class="kw">,</span> <span class="st">'died'</span><br />      names <span class="kw">=</span> catNames paragraph<br />      <span class="kw">for</span> name <span class="kw">in</span> names<br />        <span class="kw">delete</span> livingCats<span class="kw">[</span>name<span class="kw">]</span><br /><br />show livingCats<span class="kw">,</span> <span class="ot">on</span></code></pre>
<p>That is quite a big dense chunk of code. We will look into making it a bit lighter in a moment. But first let us look at our results. We know how to check whether a specific cat survives:</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false"><span class="kw">if</span> <span class="st">'Spot'</span> <span class="kw">in</span> livingCats<br />  show <span class="st">'Spot lives!'</span><br /><span class="kw">else</span><br />  show <span class="st">'Good old Spot, may she rest in peace.'</span></code></pre>
<p>But how do we list all the cats that are alive? The <code>of</code><a href="#index-of"></a> keyword is somewhat similar to the <code>in</code> keyword when it is used together with <code>for</code>:</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false"><span class="kw">for</span> cat <span class="kw">of</span> livingCats<br />  show cat</code></pre>
<p>A loop like that will go over the names of the properties in an object, which allows us to enumerate all the names in our set.</p>
<section id="section-97">
<h5>○•○</h5>
<p>Some pieces of code look like an impenetrable jungle. The example solution to the cat problem suffers from this. One way to make some light shine through it is to just add some strategic blank lines. This makes it look better, but does not really solve the problem.</p>
<p>What is needed here is to break the code up. We already wrote two helper functions, <code>startsWith</code> and <code>catNames</code>, which both take care of a small, understandable part of the problem. Let us continue doing this.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">addToSet <span class="kw">=</span> <span class="fu">(set, values) -&gt;</span><br />  <span class="kw">for</span> i <span class="kw">in</span> <span class="kw">[</span><span class="dv">0</span><span class="kw">..</span>values<span class="kw">.</span>length<span class="kw">]</span><br />    set<span class="kw">[</span>values<span class="kw">[</span>i<span class="kw">]]</span> <span class="kw">=</span> <span class="ot">true</span><br /><br />removeFromSet <span class="kw">=</span> <span class="fu">(set, values) -&gt;</span><br />  <span class="kw">for</span> i <span class="kw">in</span> <span class="kw">[</span><span class="dv">0</span><span class="kw">..</span>values<span class="kw">.</span>length<span class="kw">]</span><br />    <span class="kw">delete</span> set<span class="kw">[</span>values<span class="kw">[</span>i<span class="kw">]]</span></code></pre>
<p>These two functions take care of the adding and removing of names from the set. That already cuts out the two most inner loops from the solution:</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">livingCats <span class="kw">=</span> <span class="st">'Spot'</span><span class="kw">:</span> <span class="ot">true</span><br /><br /><span class="kw">for</span> email <span class="kw">in</span> mailArchive<br />  paragraphs <span class="kw">=</span> email<span class="kw">.</span>split <span class="st">'\n'</span><br />  <span class="kw">for</span> paragraph <span class="kw">in</span> paragraphs<br />    <span class="kw">if</span> startsWith paragraph<span class="kw">,</span> <span class="st">'born'</span><br />      addToSet livingCats<span class="kw">,</span> catNames paragraph<br />    <span class="kw">else</span> <span class="kw">if</span> startsWith paragraph<span class="kw">,</span> <span class="st">'died'</span><br />      removeFromSet livingCats<span class="kw">,</span> catNames paragraph<br /><br />show livingCats<span class="kw">,</span> <span class="ot">on</span></code></pre>
<p>Quite an improvement, if I may say so myself.</p>
<p>Why do <code>addToSet</code> and <code>removeFromSet</code> take the set as an argument? They could use the variable <code>livingCats</code> directly, if they wanted to. The reason is that this way they are not completely tied to our current problem. If <code>addToSet</code> directly changed <code>livingCats</code>, it would have to be called <code>addCatsToCatSet</code>, or something similar. The way it is now, it is a more generally useful tool.</p>
<p>Even if we are never going to use these functions for anything else, which is quite probable, it is useful to write them like this. Because they are ‘self sufficient’, they can be read and understood on their own, without needing to know about some external variable called <code>livingCats</code>.</p>
<p>The functions are not pure: They change the object passed as their <code>set</code> argument. This makes them slightly trickier than real pure functions, but still a lot less confusing than functions that run amok and change any value or variable they please.</p>
</section>
<section id="section-98">
<h5>○•○</h5>
<p>We continue breaking the algorithm into pieces:</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">findLivingCats <span class="kw">=</span> <span class="fu">-&gt;</span><br />  mailArchive <span class="kw">=</span> retrieveMails<span class="kw">()</span><br />  livingCats <span class="kw">=</span> <span class="st">'Spot'</span><span class="kw">:</span> <span class="ot">true</span><br /><br />  handleParagraph <span class="kw">=</span> <span class="fu">(paragraph) -&gt;</span><br />    <span class="kw">if</span> startsWith paragraph<span class="kw">,</span> <span class="st">'born'</span><br />      addToSet livingCats<span class="kw">,</span> catNames paragraph<br />    <span class="kw">else</span> <span class="kw">if</span> startsWith paragraph<span class="kw">,</span> <span class="st">'died'</span><br />      removeFromSet livingCats<span class="kw">,</span> catNames paragraph<br /><br />  <span class="kw">for</span> email <span class="kw">in</span> mailArchive<br />    paragraphs <span class="kw">=</span> email<span class="kw">.</span>split <span class="st">'\n'</span><br />    <span class="kw">for</span> paragraph <span class="kw">in</span> paragraphs<br />      handleParagraph paragraph<br /><br />  livingCats<br /><br />howMany <span class="kw">=</span> <span class="dv">0</span><br /><span class="kw">for</span> cat <span class="kw">of</span> findLivingCats<span class="kw">()</span><br />  howMany<span class="kw">++</span><br />show <span class="st">'There are '</span> <span class="kw">+</span> howMany <span class="kw">+</span> <span class="st">' cats.'</span></code></pre>
<p>The whole algorithm is now encapsulated by a function. This means that it does not leave a mess after it runs: <code>livingCats</code> is now a local variable in the function, instead of a top-level one, so it only exists while the function runs. The code that needs this set can call <code>findLivingCats</code> and use the value it returns.</p>
<p>It seemed to me that making <code>handleParagraph</code> a separate function also cleared things up. But this one is so closely tied to the cat-algorithm that it is meaningless in any other situation. On top of that, it needs access to the <code>livingCats</code> variable. Thus, it is a perfect candidate to be a function-inside-a-function. When it lives inside <code>findLivingCats</code>, it is clear that it is only relevant there, and it has access to the variables of its parent function.</p>
<p>This solution is actually <em>bigger</em> than the previous one. Still, it is tidier and I hope you will agree that it is easier to read.</p>
</section>
<section id="section-99">
<h5>○•○</h5>
<p>The program still ignores a lot of the information that is contained in the e-mails. There are birth-dates, dates of death, and the names of mothers in there.</p>
<p>To start with the dates: What would be a good way to store a date? We could make an object with three properties, <code>year</code>, <code>month</code>, and <code>day</code>, and store numbers in them.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">whenWasIt <span class="kw">=</span> year<span class="kw">:</span> <span class="dv">1980</span><span class="kw">,</span> month<span class="kw">:</span> <span class="dv">2</span><span class="kw">,</span> day<span class="kw">:</span> <span class="dv">1</span></code></pre>
<p>But CoffeeScript already provides a kind of object for this purpose. Such an object can be created by using the keyword <code>new</code><a href="#index-new"></a>:</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">whenWasIt <span class="kw">=</span> <span class="kw">new</span> <span class="dt">Date</span> <span class="dv">1980</span><span class="kw">,</span> <span class="dv">1</span><span class="kw">,</span> <span class="dv">1</span><br />show whenWasIt</code></pre>
<p>Just like the notation with colons and optional braces we have already seen, <code>new</code> is a way to create object values. Instead of specifying all the property names and values, a function is used to build up the object. This makes it possible to define a kind of standard procedure for creating objects. Functions like this are called constructors<a href="#index-constructor"></a>, and in <a href="#object-oriented-programming">Object Orientation↓</a> we will see how to write them.</p>
<p>The <code>Date</code><a href="#index-Date"></a> constructor can be used in different ways.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">show <span class="kw">new</span> <span class="dt">Date</span><br />show <span class="kw">new</span> <span class="dt">Date</span> <span class="dv">1980</span><span class="kw">,</span> <span class="dv">1</span><span class="kw">,</span> <span class="dv">1</span><br />show <span class="kw">new</span> <span class="dt">Date</span> <span class="dv">2007</span><span class="kw">,</span> <span class="dv">2</span><span class="kw">,</span> <span class="dv">30</span><span class="kw">,</span> <span class="dv">8</span><span class="kw">,</span> <span class="dv">20</span><span class="kw">,</span> <span class="dv">30</span></code></pre>
<p>As you can see, these objects can store a time of day as well as a date. When not given any arguments, an object representing the current time and date is created. Arguments can be given to ask for a specific date and time. The order of the arguments is year, month, day, hour, minute, second, milliseconds. These last four are optional, they become 0 when not given.</p>
<p>The month numbers these objects use go from 0 to 11, which can be confusing. Especially since day numbers <em>do</em> start from 1.</p>
</section>
<section id="section-100">
<h5>○•○</h5>
<p>The content of a <code>Date</code> object can be inspected with a number of <code>get...</code> methods.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">today <span class="kw">=</span> <span class="kw">new</span> <span class="dt">Date</span><span class="kw">();</span><br />show <span class="st">&quot;Year: </span><span class="ch">#{</span>today.getFullYear()<span class="ch">}</span><br /><span class="st"> month: </span><span class="ch">#{</span>today.getMonth()<span class="ch">}</span><br /><span class="st"> day: </span><span class="ch">#{</span>today.getDate()<span class="ch">}</span><span class="st">&quot;</span><br />show <span class="st">&quot;Hour: </span><span class="ch">#{</span>today.getHours()<span class="ch">}</span><br /><span class="st"> minutes: </span><span class="ch">#{</span>today.getMinutes()<span class="ch">}</span><br /><span class="st"> seconds: </span><span class="ch">#{</span>today.getSeconds()<span class="ch">}</span><span class="st">&quot;</span><br />show <span class="st">&quot;Day of week: </span><span class="ch">#{</span>today.getDay()<span class="ch">}</span><span class="st">&quot;</span></code></pre>
<p>All of these, except for <code>getDay</code>, also have a <code>set...</code> variant that can be used to change the value of the date object.</p>
<p>Inside the object, a date is represented by the amount of milliseconds it is away from January 1st 1970. You can imagine this is quite a large number.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">today <span class="kw">=</span> <span class="kw">new</span> <span class="dt">Date</span><span class="kw">()</span><br />show today<span class="kw">.</span>getTime<span class="kw">()</span></code></pre>
<p>A very useful thing to do with dates is comparing them.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">wallFall <span class="kw">=</span> <span class="kw">new</span> <span class="dt">Date</span> <span class="dv">1989</span><span class="kw">,</span> <span class="dv">10</span><span class="kw">,</span> <span class="dv">9</span><br />gulfWarOne <span class="kw">=</span> <span class="kw">new</span> <span class="dt">Date</span> <span class="dv">1990</span><span class="kw">,</span> <span class="dv">6</span><span class="kw">,</span> <span class="dv">2</span><br />show wallFall <span class="kw">&lt;</span> gulfWarOne<br />show wallFall <span class="kw">is</span> wallFall<br /><span class="co"># but</span><br />show wallFall <span class="kw">is</span> <span class="kw">new</span> <span class="dt">Date</span> <span class="dv">1989</span><span class="kw">,</span> <span class="dv">10</span><span class="kw">,</span> <span class="dv">9</span></code></pre>
<p>Comparing dates with <code>&lt;</code>, <code>&gt;</code>, <code>&lt;=</code>, and <code>&gt;=</code> does exactly what you would expect. When a date object is compared to itself with <code>is</code> the result is <code>true</code>, which is also good. But when <code>is</code><a href="#index-=="></a> is used to compare a date object to a different, equal date object, we get <code>false</code>. Huh?</p>
<p>As mentioned earlier, <code>is</code> will return <code>false</code> when comparing two different objects, even if they contain the same properties. This is a bit clumsy and error-prone here, since one would expect <code>&gt;=</code> and <code>is</code> to behave in a more or less similar way. Testing whether two dates are equal can be done like this:</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">wallFall1 <span class="kw">=</span> <span class="kw">new</span> <span class="dt">Date</span> <span class="dv">1989</span><span class="kw">,</span> <span class="dv">10</span><span class="kw">,</span> <span class="dv">9</span><br />wallFall2 <span class="kw">=</span> <span class="kw">new</span> <span class="dt">Date</span> <span class="dv">1989</span><span class="kw">,</span> <span class="dv">10</span><span class="kw">,</span> <span class="dv">9</span><br />show wallFall1<span class="kw">.</span>getTime<span class="kw">()</span> <span class="kw">is</span> wallFall2<span class="kw">.</span>getTime<span class="kw">()</span></code></pre>
</section>
<section id="section-101">
<h5>○•○</h5>
<p>In addition to a date and time, <code>Date</code> objects also contain information about a timezone<a href="#index-timezone"></a>. When it is one o’clock in Amsterdam, it can, depending on the time of year, be noon in London, and seven in the morning in New York. Such times can only be compared when you take their time zones into account. The <code>getTimezoneOffset</code><a href="#index-getTimezoneOffset"></a> function of a <code>Date</code> can be used to find out how many minutes it differs from GMT (Greenwich Mean Time).</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">now <span class="kw">=</span> <span class="kw">new</span> <span class="dt">Date</span><span class="kw">()</span><br />show now<span class="kw">.</span>getTimezoneOffset<span class="kw">()</span></code></pre>
</section>
</section>
<section id="exercise-15">
<h4><em>Exercise 15</em></h4>
<p><code>'died 27/04/2006: Black Leclère'</code></p>
<p>The date part is always in the exact same place of a paragraph. How convenient. Write a function <code>extractDate</code> that takes such a paragraph as its argument, extracts the date, and returns it as a date object.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false"><span class="co"># Compose a solution here</span></code></pre>
<section id="view-solution-20" onclick="reveal(this)" >
<h5>View Solution</h5>
<section id="section-102" style="display:none" >
<h6></h6>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">extractDate <span class="kw">=</span> <span class="fu">(paragraph) -&gt;</span><br />  numberAt <span class="kw">=</span> <span class="fu">(start, length) -&gt;</span><br />    <span class="ot">Number</span> paragraph<span class="kw">[</span>start<span class="kw">...</span>start <span class="kw">+</span> length<span class="kw">]</span><br />  <span class="kw">new</span> <span class="dt">Date</span> numberAt<span class="kw">(</span><span class="dv">11</span><span class="kw">,</span> <span class="dv">4</span><span class="kw">),</span>     <span class="co"># Year</span><br />           numberAt<span class="kw">(</span> <span class="dv">8</span><span class="kw">,</span> <span class="dv">2</span><span class="kw">)</span> <span class="kw">-</span> <span class="dv">1</span><span class="kw">,</span> <span class="co"># Month</span><br />           numberAt<span class="kw">(</span> <span class="dv">5</span><span class="kw">,</span> <span class="dv">2</span><span class="kw">)</span>      <span class="co"># Day</span><br /><br />show extractDate <span class="st">'died 27-04-2006: Black Lecl&#232;re'</span></code></pre>
<p>It would work without the calls to <code>Number</code>, but as mentioned earlier, I prefer not to use strings as if they are numbers. The inner function was introduced to prevent having to repeat the <code>Number</code> and <code>slice</code> part three times.</p>
<p>Note the <code>-1</code> for the month number. Like most people, Aunt Emily counts her months from 1, so we have to adjust the value before giving it to the <code>Date</code> constructor. (The day number does not have this problem, since <code>Date</code> objects count days in the usual human way.)</p>
<p>In <a href="#regular-expressions">Regular Expressions↓</a> we will see a more practical and robust way of extracting pieces from strings that have a fixed structure.</p>
</section>
</section>
</section>
<section id="section-103">
<h4></h4>
<p>Storing cats will work differently from now on. Instead of just putting the value <code>true</code> into the set, we store an object with information about the cat. When a cat dies, we do not remove it from the set, we just add a property <code>death</code> to the object to store the date on which the creature died.</p>
<p>This means our <code>addToSet</code> and <code>removeFromSet</code> functions have become useless. Something similar is needed, but it must also store birth-dates and, later, the mother’s name.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">catRecord <span class="kw">=</span> <span class="fu">(name, birthdate, mother) -&gt;</span><br />  name<span class="kw">:</span>   name<br />  birth<span class="kw">:</span>  birthdate<br />  mother<span class="kw">:</span> mother<br /><br />addCats <span class="kw">=</span> <span class="fu">(set, names, birthdate, mother) -&gt;</span><br />  <span class="kw">for</span> name <span class="kw">in</span> names<br />    set<span class="kw">[</span>name<span class="kw">]</span> <span class="kw">=</span> catRecord name<span class="kw">,</span> birthdate<span class="kw">,</span> mother<br /><br />deadCats <span class="kw">=</span> <span class="fu">(set, names, deathdate) -&gt;</span><br />  <span class="kw">for</span> name <span class="kw">in</span> names<br />    set<span class="kw">[</span>name<span class="kw">].</span>death <span class="kw">=</span> deathdate</code></pre>
<p><code>catRecord</code> is a separate function for creating these storage objects. It might be useful in other situations, such as creating the object for Spot. ‘Record’ is a term often used for objects like this, which are used to group a limited number of values.</p>
<section id="section-104">
<h5>○•○</h5>
<p>So let us try to extract the names of the mother cats from the paragraphs.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false"><span class="st">'born 15/11/2003 (mother Spot): White Fang'</span></code></pre>
<p>One way to do this would be…</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">extractMother <span class="kw">=</span> <span class="fu">(paragraph) -&gt;</span><br />  start <span class="kw">=</span> paragraph<span class="kw">.</span>indexOf <span class="st">'(mother '</span><br />  start <span class="kw">+=</span> <span class="st">'(mother '</span><span class="kw">.</span>length<br />  end <span class="kw">=</span> paragraph<span class="kw">.</span>indexOf <span class="st">')'</span><br />  paragraph<span class="kw">[</span>start<span class="kw">...</span>end<span class="kw">]</span><br /><br />show extractMother \<br />  <span class="st">'born 15/11/2003 (mother Spot): White Fang'</span></code></pre>
<p>Notice how the start position has to be adjusted for the length of the string <code>'(mother '</code>, because <code>indexOf</code> returns the position of the start of the pattern, not its end.</p>
</section>
</section>
<section id="exercise-16">
<h4><em>Exercise 16</em></h4>
<p>The thing that <code>extractMother</code> does can be expressed in a more general way. Write a function <code>between</code> that takes three arguments, all of which are strings. It will return the part of the first argument that occurs between the patterns given by the second and the third arguments. That is:</p>
<pre class="sourceCode"><code class="sourceCode COFFEESCRIPT">between <span class="st">'born 15/11/2003 (mother Spot): White Fang'</span><span class="kw">,</span><br />        <span class="st">'(mother '</span><span class="kw">,</span> <span class="st">')'</span> &#8658; <span class="st">'Spot'</span><br />between <span class="st">'bu ] boo [ bah ] gzz'</span><span class="kw">,</span> <span class="st">'[ '</span><span class="kw">,</span> <span class="st">' ]'</span> &#8658; <span class="st">'bah'</span></code></pre>
<p>To make that second test work, it can be useful to know that <code>indexOf</code> can be given a second, optional parameter that specifies at which point it should start searching.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false"><span class="co"># Compose a solution here</span></code></pre>
<section id="view-solution-21" onclick="reveal(this)" >
<h5>View Solution</h5>
<section id="section-105" style="display:none" >
<h6></h6>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">between <span class="kw">=</span> <span class="fu">(string, start, end) -&gt;</span><br />  startAt <span class="kw">=</span> string<span class="kw">.</span>indexOf start<br />  startAt <span class="kw">+=</span> start<span class="kw">.</span>length<br />  endAt <span class="kw">=</span> string<span class="kw">.</span>indexOf end<span class="kw">,</span> startAt<br />  string<span class="kw">[</span>startAt<span class="kw">...</span>endAt<span class="kw">]</span><br />show between <span class="st">'bu ] boo [ bah ] gzz'</span><span class="kw">,</span> <span class="st">'[ '</span><span class="kw">,</span> <span class="st">' ]'</span></code></pre>
</section>
</section>
</section>
<section id="section-106">
<h4></h4>
<p>Having <code>between</code> makes it possible to express extractMother in a simpler way:</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">extractMother <span class="kw">=</span> <span class="fu">(paragraph) -&gt;</span><br />  between paragraph<span class="kw">,</span> <span class="st">'(mother '</span><span class="kw">,</span> <span class="st">')'</span></code></pre>
<section id="section-107">
<h5>○•○</h5>
<p>The new, improved cat-algorithm looks like this:</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">findCats <span class="kw">=</span> <span class="fu">-&gt;</span><br />  mailArchive <span class="kw">=</span> retrieveMails<span class="kw">()</span><br />  cats <span class="kw">=</span> <span class="kw">{</span><span class="st">'Spot'</span><span class="kw">:</span> catRecord <span class="st">'Spot'</span><span class="kw">,</span><br />    <span class="kw">new</span> <span class="dt">Date</span><span class="kw">(</span><span class="dv">1997</span><span class="kw">,</span> <span class="dv">2</span><span class="kw">,</span> <span class="dv">5</span><span class="kw">),</span> <span class="st">'unknown'</span><span class="kw">}</span><br /><br />  handleParagraph <span class="kw">=</span> <span class="fu">(paragraph) -&gt;</span><br />    <span class="kw">if</span> startsWith paragraph<span class="kw">,</span> <span class="st">'born'</span><br />      addCats cats<span class="kw">,</span> catNames<span class="kw">(</span>paragraph<span class="kw">),</span><br />              extractDate<span class="kw">(</span>paragraph<span class="kw">),</span><br />              extractMother<span class="kw">(</span>paragraph<span class="kw">)</span><br />    <span class="kw">else</span> <span class="kw">if</span> startsWith paragraph<span class="kw">,</span> <span class="st">'died'</span><br />      deadCats cats<span class="kw">,</span> catNames<span class="kw">(</span>paragraph<span class="kw">),</span><br />               extractDate<span class="kw">(</span>paragraph<span class="kw">)</span><br /><br />  <span class="kw">for</span> email <span class="kw">in</span> mailArchive<br />    paragraphs <span class="kw">=</span> email<span class="kw">.</span>split <span class="st">'\n'</span><br />    <span class="kw">for</span> paragraph <span class="kw">in</span> paragraphs<br />      handleParagraph paragraph<br />  cats<br /><br />catData <span class="kw">=</span> findCats<span class="kw">()</span><br /><br />show catData<span class="kw">[</span><span class="st">'Clementine'</span><span class="kw">],</span> <span class="ot">on</span><br />show catData<span class="kw">[</span>catData<span class="kw">[</span><span class="st">'Clementine'</span><span class="kw">].</span>mother<span class="kw">],</span> <span class="ot">on</span></code></pre>
<p>Having that extra data allows us to finally have a clue about the cats aunt Emily talks about. A function like this could be useful:</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">formatDate <span class="kw">=</span> <span class="fu">(date) -&gt;</span> <span class="st">&quot;</span><span class="ch">#{</span>date.getDate()<span class="ch">}</span><span class="st">/&quot;</span> <span class="kw">+</span><br />                       <span class="st">&quot;</span><span class="ch">#{</span>date.getMonth() + 1<span class="ch">}</span><span class="st">/&quot;</span> <span class="kw">+</span><br />                       <span class="st">&quot;</span><span class="ch">#{</span>date.getFullYear()<span class="ch">}</span><span class="st">&quot;</span><br />catInfo <span class="kw">=</span> <span class="fu">(data, name) -&gt;</span><br />  <span class="kw">unless</span> name <span class="kw">of</span> data<br />    <span class="kw">return</span> <span class="st">&quot;No cat by the name of </span><span class="ch">#{</span>name<span class="ch">}</span><span class="st"> is known.&quot;</span><br />  cat <span class="kw">=</span> data<span class="kw">[</span>name<span class="kw">]</span><br />  message <span class="kw">=</span> <span class="st">&quot;</span><span class="ch">#{</span>name<span class="ch">}</span><span class="st">,&quot;</span> <span class="kw">+</span><br />            <span class="st">&quot; born </span><span class="ch">#{</span>formatDate cat.birth<span class="ch">}</span><span class="st">&quot;</span> <span class="kw">+</span><br />            <span class="st">&quot; from mother </span><span class="ch">#{</span>cat.mother<span class="ch">}</span><span class="st">&quot;</span><br />  <span class="kw">if</span> <span class="st">&quot;death&quot;</span> <span class="kw">of</span> cat<br />    message <span class="kw">+=</span> <span class="st">&quot;, died </span><span class="ch">#{</span>formatDate cat.death<span class="ch">}</span><span class="st">&quot;</span><br />  <span class="st">&quot;</span><span class="ch">#{</span>message<span class="ch">}</span><span class="st">.&quot;</span><br /><br />show catInfo catData<span class="kw">,</span> <span class="st">&quot;Fat Igor&quot;</span></code></pre>
<p>The <code>return</code> statement in <code>catInfo</code> is used as an escape hatch. If there is no data about the given cat, the rest of the function is meaningless, so we immediately return a value, which prevents the rest of the code from running.</p>
<p>In the past, certain groups of programmers considered functions that contain multiple <code>return</code> statements sinful. The idea was that this made it hard to see which code was executed and which code was not. Other techniques, which will be discussed in <a href="#error-handling">Error Handling↓</a>, have made the reasons behind this idea more or less obsolete, but you might still occasionally come across someone who will criticise the use of ‘shortcut’ return statements.</p>
</section>
</section>
<section id="exercise-17">
<h4><em>Exercise 17</em></h4>
<p>The <code>formatDate</code> function used by <code>catInfo</code> does not add a zero before the month and the day part when these are only one digit long. Write a new version that does this.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false"><span class="co"># Compose a solution here</span></code></pre>
<section id="view-solution-22" onclick="reveal(this)" >
<h5>View Solution</h5>
<section id="section-108" style="display:none" >
<h6></h6>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">formatDate <span class="kw">=</span> <span class="fu">(date) -&gt;</span><br />  pad <span class="kw">=</span> <span class="fu">(number) -&gt;</span><br />    <span class="kw">if</span> number <span class="kw">&lt;</span> <span class="dv">10</span><br />      <span class="st">&quot;0&quot;</span> <span class="kw">+</span> number<br />    <span class="kw">else</span><br />      number<br />  <span class="st">&quot;</span><span class="ch">#{</span>pad date.getDate()<span class="ch">}</span><span class="st">/&quot;</span> <span class="kw">+</span><br />  <span class="st">&quot;</span><span class="ch">#{</span>pad date.getMonth() + 1<span class="ch">}</span><span class="st">/&quot;</span> <span class="kw">+</span><br />  <span class="st">&quot;</span><span class="ch">#{</span>date.getFullYear()<span class="ch">}</span><span class="st">&quot;</span><br /><br />show formatDate <span class="kw">new</span> <span class="dt">Date</span> <span class="dv">2000</span><span class="kw">,</span> <span class="dv">0</span><span class="kw">,</span> <span class="dv">1</span></code></pre>
</section>
</section>
</section>
<section id="section-109">
<h4></h4>
<p><a href="#index-existential-accessor"></a><a href="#index-?."></a>The property ‘dot’ accessor that we have been using comes in a handy form combined with the existential operator. Instead of <code>object.element</code> we can write <code>object?.element</code> if <code>object</code> is defined then we get the value as before. But if it is <code>null</code> then we get <code>undefined</code> instead of an error.</p>
</section>
<section id="exercise-18">
<h4><em>Exercise 18</em></h4>
<p>Write a function <code>oldestCat</code> which, given an object containing cats as its argument, returns the name of the oldest living cat.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false"><span class="co"># Compose a solution here</span></code></pre>
<section id="view-solution-23" onclick="reveal(this)" >
<h5>View Solution</h5>
<section id="section-110" style="display:none" >
<h6></h6>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">oldestCat <span class="kw">=</span> <span class="fu">(data) -&gt;</span><br />  oldest <span class="kw">=</span> <span class="ot">null</span><br />  <span class="kw">for</span> name <span class="kw">of</span> data<br />    cat <span class="kw">=</span> data<span class="kw">[</span>name<span class="kw">]</span><br />    <span class="kw">unless</span> <span class="st">'death'</span> <span class="kw">of</span> cat<br />      <span class="kw">if</span> oldest <span class="kw">is</span> <span class="ot">null</span> <span class="kw">or</span> oldest<span class="kw">.</span>birth <span class="kw">&gt;</span> cat<span class="kw">.</span>birth<br />        oldest <span class="kw">=</span> cat<br />  oldest<span class="kw">?.</span>name<br />show oldestCat catData</code></pre>
<p>The conditions in the <code>unless/if</code> statements might seem a little intimidating. It can be read as ‘only store the current cat in the variable <code>oldest</code> if it is not dead, and <code>oldest</code> is either <code>null</code> or a cat that was born after the current cat’.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false"><span class="kw">for</span> cat<span class="kw">,</span> info <span class="kw">of</span> catData <span class="co"># Test with dead cats</span><br />  <span class="kw">delete</span> catData<span class="kw">[</span>cat<span class="kw">]</span> <span class="kw">unless</span> <span class="st">'death'</span> <span class="kw">of</span> info<br />show oldestCat catData</code></pre>
<p>Note that this function returns <code>undefined</code> when there are no living cats in <code>data</code>. What does your solution do in that case?</p>
</section>
</section>
</section>
<section id="section-111">
<h4></h4>
<p>Now that we are familiar with arrays, I can show you something related. Whenever a function is called, a special variable named <code>arguments</code><a href="#index-arguments"></a> is added to the environment in which the function body runs. This variable refers to an object that resembles an array. It has a property <code>0</code> for the first argument, <code>1</code> for the second, and so on for every argument the function was given. It also has a <code>length</code><a href="#index-length"></a> property.</p>
<p>This object is not a real array though, it does not have methods like <code>push</code>, and it does not automatically update its <code>length</code> property when you add something to it. Why not, I never really found out, but this is something one needs to be aware of.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">argumentCounter <span class="kw">=</span> <span class="fu">-&gt;</span><br />  show <span class="st">&quot;You gave me </span><span class="ch">#{</span>arguments.length<span class="ch">}</span><span class="st"> arguments.&quot;</span><br /><br />argumentCounter <span class="st">&quot;Death&quot;</span><span class="kw">,</span> <span class="st">&quot;Famine&quot;</span><span class="kw">,</span> <span class="st">&quot;Pestilence&quot;</span></code></pre>
<p>Some functions can take any number of arguments. These typically loop over the values in the <code>arguments</code> object to do something with them. We can create a <code>print</code> function that uses <code>show</code> to print each of its arguments.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">print <span class="kw">=</span> <span class="fu">-&gt;</span><br />  show arg <span class="kw">for</span> arg <span class="kw">in</span> arguments<br />  <span class="kw">return</span><br /><br />print <span class="st">'From here to'</span><span class="kw">,</span> <span class="dv">1</span><span class="kw">/</span><span class="dv">0</span></code></pre>
<p>Others can take optional arguments which, when not given by the caller, get some sensible default value.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">add <span class="kw">=</span> <span class="fu">(number, howmuch) -&gt;</span><br />  <span class="kw">if</span>  arguments<span class="kw">.</span>length <span class="kw">&lt;</span> <span class="dv">2</span><br />    howmuch <span class="kw">=</span> <span class="dv">1</span><br />  number <span class="kw">+</span> howmuch<br /><br />show add <span class="dv">6</span><br />show add <span class="dv">6</span><span class="kw">,</span> <span class="dv">4</span></code></pre>
</section>
<section id="exercise-19">
<h4><em>Exercise 19</em></h4>
<p>Extend the <code>range</code> function from <a href="#exercise-11">Exercise 11↑</a> to take a second, optional argument. If only one argument is given, it behaves as earlier and produces a range from 0 to the given number. If two arguments are given, the first indicates the start of the range, the second the end.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false"><span class="co"># Compose a solution here</span></code></pre>
<section id="view-solution-24" onclick="reveal(this)" >
<h5>View Solution</h5>
<section id="section-112" style="display:none" >
<h6></h6>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">range <span class="kw">=</span> <span class="fu">(start, end) -&gt;</span><br />  <span class="kw">if</span> arguments<span class="kw">.</span>length <span class="kw">&lt;</span> <span class="dv">2</span><br />    end <span class="kw">=</span> start<br />    start <span class="kw">=</span> <span class="dv">0</span><br />  result <span class="kw">=</span> <span class="kw">[]</span><br />  <span class="kw">for</span> i <span class="kw">in</span> <span class="kw">[</span>start<span class="kw">..</span>end<span class="kw">]</span><br />    result<span class="kw">.</span>push i<br />  result<br /><br />show range <span class="dv">4</span><br />show range <span class="dv">2</span><span class="kw">,</span> <span class="dv">4</span></code></pre>
<p>The optional argument does not work precisely like the one in the <code>add</code> example above. When it is not given, the first argument takes the role of <code>end</code> , and <code>start</code> becomes <code>0</code>.</p>
</section>
</section>
</section>
<section id="section-113">
<h4></h4>
<p>CoffeeScript has a few of features that can make it simpler to work with arguments. You can set default values directly in the argument list. The <code>show</code> function is defined like:</p>
<pre class="sourceCode"><code class="sourceCode COFFEESCRIPT">show <span class="kw">=</span> <span class="fu">(obj, shallow = off, symbol = '&amp;rarr;') -&gt;</span><br />  showHere currentTag<span class="kw">,</span> obj<span class="kw">,</span> shallow<span class="kw">,</span> symbol<br />  <span class="kw">return</span> <span class="co"># Suppress display of the return value</span></code></pre>
<p>When the arguments starting from <code>shallow</code> are not present in a call, they get the value after the <code>=</code>. No checks are needed in the body where the arguments are used.</p>
<p>For variable arguments you can use <code>...</code> commonly called splats. The ellipsis can indicate extra arguments in a function definition or a call. Do you remember the testPure function? It was used with both <code>absolute</code> which takes one argument and <code>power</code> which takes two. In its definition <code>(c, a...)</code> says that <code>a...</code> is a variable argument list. The variable arguments are used two times, in the call to <code>func</code> and in the call to <code>property</code>.</p>
<pre class="sourceCode"><code class="sourceCode COFFEESCRIPT">testPure <span class="kw">=</span> <span class="fu">(func, types, name, property) -&gt;</span><br />  declare name<span class="kw">,</span> types<span class="kw">,</span> <span class="fu">(c, a...) -&gt;</span><br />    c<span class="kw">.</span>assert property c<span class="kw">,</span> a<span class="kw">...,</span> c<span class="kw">.</span>note func a<span class="kw">...</span></code></pre>
<p>Finally the <code>or=</code> operator can be used in <code>options or= defaults</code> as shorthand for <code>options or (options = defaults)</code>.</p>
</section>
<section id="exercise-20">
<h4><em>Exercise 20</em></h4>
<p>You may remember this line of code from the introduction:</p>
<pre class="sourceCode"><code class="sourceCode COFFEESCRIPT">sum <span class="kw">[</span><span class="dv">1</span><span class="kw">..</span><span class="dv">10</span><span class="kw">]</span></code></pre>
<p>All we need to make this line work is a <code>sum</code> function. This function takes an array of numbers, and returns their sum. Write it, it should be easy. Check that it also works with <code>range</code>.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false"><span class="co"># Compose a solution here</span></code></pre>
<section id="view-solution-25" onclick="reveal(this)" >
<h5>View Solution</h5>
<section id="section-114" style="display:none" >
<h6></h6>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">sum <span class="kw">=</span> <span class="fu">(numbers) -&gt;</span><br />  total <span class="kw">=</span> <span class="dv">0</span><br />  <span class="kw">for</span> num <span class="kw">in</span> numbers<br />    total <span class="kw">+=</span> num<br />  total<br /><br />show sum <span class="kw">[</span><span class="dv">1</span><span class="kw">..</span><span class="dv">10</span><span class="kw">]</span><br />show sum range <span class="dv">1</span><span class="kw">,</span> <span class="dv">10</span></code></pre>
</section>
</section>
</section>
<section id="section-115">
<h4></h4>
<p>The previous chapter showed the functions <code>Math.max</code> and <code>Math.min</code>. With what you know now, you will notice that these are really the properties <code>max</code> and <code>min</code> of the object stored under the name <code>Math</code><a href="#index-Math"></a>. This is another role that objects can play: A warehouse holding a number of related values.</p>
<p>There are quite a lot of values inside <code>Math</code>, if they would all have been placed directly into the global environment they would, as it is called, pollute it. The more names have been taken, the more likely one is to accidentally overwrite the value of some variable. For example, it is not a far shot to want to name something <code>max</code>.</p>
<p>Most languages will stop you, or at least warn you, when you are defining a variable with a name that is already taken. Not JavaScript.</p>
<p>In any case, one can find a whole outfit of mathematical functions and constants inside <code>Math</code>. All the trigonometric functions are there — <code>cos</code>, <code>sin</code>, <code>tan</code>, <code>acos</code>, <code>asin</code>, <code>atan</code>. <em>π</em> and e, which are written with all capital letters (<code>PI</code> and <code>E</code>), which was, at one time, a fashionable way to indicate something is a constant. <code>pow</code> is a good replacement for the <code>power</code> functions we have been writing, it also accepts negative and fractional exponents. <code>sqrt</code> takes square roots. <code>max</code> and <code>min</code> can give the maximum or minimum of two values. <code>round</code><a href="#index-Math.round"></a>, <code>floor</code><a href="#index-Math.floor"></a>, and <code>ceil</code><a href="#index-Math.ceil"></a> will round numbers to the closest whole number, the whole number below it, and the whole number above it respectively.</p>
<p>There are a number of other values in <code>Math</code>, but this text is an introduction, not a reference<a href="#index-reference"></a>. References are what you look at when you suspect something exists in the language, but need to find out what it is called or how it worked exactly. A useful <a href="https://developer.mozilla.org/en/JavaScript/Reference#Standard_global_objects_(by_category)">reference for predefined global objects</a> like the <code>Math</code> object exist at the <a href="https://developer.mozilla.org/en/Javascript">Mozilla Developer Network</a>.</p>
<p>An interesting object is <code>Array</code> when you look through its <a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Array">reference</a> notice that many definitions for example <code>forEach</code> are marked <code>Requires JavaScript 1.6</code> or another version number. JavaScript 1.5 corresponds to ECMA–262 3<sup>rd</sup> Edition from December 1999.</p>
<p>More than a decade later this is still the standard that most JavaScript engines implement — including V8, the engine that via JavaScript compiles CoffeeScript to native machine code. It is fair to say that JavaScript is evolving at a glacial pace. Fortunately CoffeeScript and Underscore leapfrogs the JavaScript process and gives you language and library advances that you can use without waiting for existing browsers and engines to be upgraded.</p>
<section id="section-116">
<h5>○•○</h5>
<p>Maybe you already thought of a way to find out what is available in the <code>Math</code> object:</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false"><span class="kw">for</span> name <span class="kw">of</span> <span class="ot">Math</span><br />  show name</code></pre>
<p>But alas, nothing appears. Similarly, when you do this:</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false"><span class="kw">for</span> name <span class="kw">of</span> <span class="kw">[</span><span class="st">'Huey'</span><span class="kw">,</span> <span class="st">'Dewey'</span><span class="kw">,</span> <span class="st">'Loui'</span><span class="kw">]</span><br />  show name</code></pre>
<p>You only see <code>0</code>, <code>1</code>, and <code>2</code>, not <code>length</code>, or <code>push</code>, or <code>join</code>, which are definitely also in there. Apparently, some properties of objects are hidden<a href="#index-hidden-properties"></a>. There is a good reason for this: All objects have a few methods, for example <code>toString</code><a href="#index-toString"></a>, which converts the object into some kind of relevant string, and you do not want to see those when you are, for example, looking for the cats that you stored in the object.</p>
<p>Why the properties of <code>Math</code> are hidden is unclear to me. Someone probably wanted it to be a mysterious kind of object. But you can peek under the hood in the standalone REPL; type <code>Math.</code> followed by →∣ / ‘Tab’.</p>
<p>All properties your programs add to objects are visible. There is no way to make them hidden, which is unfortunate because, as we will see in <a href="#object-oriented-programming">Object Orientation↓</a>, it would be nice to be able to add methods to objects without having them show up in our <code>for</code> / <code>of</code> loops.</p>
</section>
<section id="section-117">
<h5>○•○</h5>
<p><a href="#index-read-only-properties"></a>Some properties are read-only, you can get their value but not change it. For example, the properties of a string value are all read-only.</p>
<p><a href="#index-watched-properties"></a>Other properties can be ‘watched’. Changing them causes <em>things</em> to happen. For example, lowering the length of an array causes excess elements to be discarded:</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">array <span class="kw">=</span> <span class="kw">[</span><span class="st">'Heaven'</span><span class="kw">,</span> <span class="st">'Earth'</span><span class="kw">,</span> <span class="st">'Man'</span><span class="kw">]</span><br />array<span class="kw">.</span>length <span class="kw">=</span> <span class="dv">2</span><br />show array</code></pre>
<hr />
</section>
</section>
</section>
<section id="error-handling">
<h3>Error Handling</h3>
<hr />
<p>Writing programs that work when everything goes as expected is a good start. Making your programs behave properly when encountering unexpected conditions is where it really gets challenging.</p>
<p>The problematic situations that a program can encounter fall into two categories: Programmer mistakes and genuine problems. If someone forgets to pass a required argument to a function, that is an example of the first kind of problem. On the other hand, if a program asks the user to enter a name and it gets back an empty string, that is something the programmer can not prevent.</p>
<p>In general, one deals with programmer errors by finding and fixing them, and with genuine errors by having the code check for them and perform some suitable action to remedy them (for example, asking for the name again), or at least fail in a well-defined and clean way.</p>
<section id="section-118">
<h5>○•○</h5>
<p>It is important to decide into which of these categories a certain problem falls. For example, consider our old <code>power</code> function:</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">power <span class="kw">=</span> <span class="fu">(base, exponent) -&gt;</span><br />  result <span class="kw">=</span> <span class="dv">1</span><br />  <span class="kw">for</span> count <span class="kw">in</span> <span class="kw">[</span><span class="dv">0</span><span class="kw">...</span>exponent<span class="kw">]</span><br />    result <span class="kw">*=</span> base<br />  result</code></pre>
<p>When some geek tries to call <code>power 'Rabbit', 4</code>, that is quite obviously a programmer error, but how about <code>power 9, 0.5</code>? The function can not handle fractional exponents, but, mathematically speaking, raising a number to the ½ power is perfectly reasonable ( <code>Math.pow</code><a href="#index-Math.pow"></a> can handle it). In situations where it is not entirely clear what kind of input a function accepts, it is often a good idea to explicitly state the kind of arguments that are acceptable in a comment.</p>
</section>
<section id="section-119">
<h5>○•○</h5>
<p>If a function encounters a problem that it can not solve itself, what should it do? In <a href="#data-structures-objects-and-arrays">Data Structures↑</a> we wrote the function <code>between</code>:</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">between <span class="kw">=</span> <span class="fu">(string, start, end) -&gt;</span><br />  startAt <span class="kw">=</span> string<span class="kw">.</span>indexOf start<br />  startAt <span class="kw">+=</span> start<span class="kw">.</span>length <br />  endAt <span class="kw">=</span> string<span class="kw">.</span>indexOf end<span class="kw">,</span> startAt<br />  string<span class="kw">[</span>startAt<span class="kw">...</span>endAt<span class="kw">]</span></code></pre>
<p>If the given <code>start</code> and <code>end</code> do not occur in the string, <code>indexOf</code> will return <code>-1</code> and this version of <code>between</code> will return a lot of nonsense:</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">show between <span class="st">'Your mother!'</span><span class="kw">,</span> <span class="st">'{-'</span><span class="kw">,</span> <span class="st">'-}'</span></code></pre>
<p>When the program is running, and the function is called like that, the code that called it will get a string value, as it expected, and happily continue doing something with it. But the value is wrong, so whatever it ends up doing with it will also be wrong. And if you are unlucky, this wrongness only causes a problem after having passed through twenty other functions. In cases like that, it is extremely hard to find out where the problem started.</p>
<p>In some cases, you will be so unconcerned about these problems that you do not mind the function misbehaving when given incorrect input. For example, if you know for sure the function will only be called from a few places, and you can prove that these places give it decent input, it is generally not worth the trouble to make the function bigger and uglier so that it can handle problematic cases.</p>
<p>But most of the time, functions that fail ‘silently’ are hard to use, and even dangerous. What if the code calling <code>between</code> wants to know whether everything went well? At the moment, it can not tell, except by re-doing all the work that <code>between</code> did and checking the result of <code>between</code> with its own result. That is bad. One solution is to make <code>between</code> return a special value, such as <code>false</code> or <code>undefined</code>, when it fails.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">between <span class="kw">=</span> <span class="fu">(string, start, end) -&gt;</span><br />  startAt <span class="kw">=</span> string<span class="kw">.</span>indexOf start<br />  <span class="kw">if</span> startAt <span class="kw">is</span> <span class="kw">-</span><span class="dv">1</span> <span class="kw">then</span> <span class="kw">return</span><br />  startAt <span class="kw">+=</span> start<span class="kw">.</span>length<br />  endAt <span class="kw">=</span> string<span class="kw">.</span>indexOf end<span class="kw">,</span> startAt<br />  <span class="kw">if</span> endAt <span class="kw">is</span> <span class="kw">-</span><span class="dv">1</span> <span class="kw">then</span> <span class="kw">return</span><br />  string<span class="kw">[</span>startAt<span class="kw">...</span>endAt<span class="kw">]</span><br /><br />show between <span class="st">'bu ] boo [ bah ] gzz'</span><span class="kw">,</span> <span class="st">'[ '</span><span class="kw">,</span> <span class="st">' ]'</span><br />show between <span class="st">'bu [ boo bah gzz'</span><span class="kw">,</span> <span class="st">'[ '</span><span class="kw">,</span> <span class="st">' ]'</span></code></pre>
<p>You can see that error checking does not generally make functions prettier. But now code that calls <code>between</code> can do something like:</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">prompt <span class="st">&quot;Tell me something&quot;</span><span class="kw">,</span> <span class="st">&quot;&quot;</span><span class="kw">,</span> <span class="fu">(answer) -&gt;</span><br />  parenthesized <span class="kw">=</span> between answer<span class="kw">,</span> <span class="st">&quot;(&quot;</span><span class="kw">,</span> <span class="st">&quot;)&quot;</span><br />  <span class="kw">if</span> parenthesized<span class="kw">?</span><br />    show <span class="st">&quot;You parenthesized '</span><span class="ch">#{</span>parenthesized<span class="ch">}</span><span class="st">'.&quot;</span></code></pre>
</section>
<section id="section-120">
<h5>○•○</h5>
<p>In many cases returning a special value is a perfectly fine way to indicate an error. It does, however, have its downsides. Firstly, what if the function can already return every possible kind of value? For example, consider this function that gets the last element from an array:</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">lastElement <span class="kw">=</span> <span class="fu">(array) -&gt;</span><br />  <span class="kw">if</span> array<span class="kw">.</span>length <span class="kw">&gt;</span> <span class="dv">0</span><br />    array<span class="kw">[</span>array<span class="kw">.</span>length <span class="kw">-</span> <span class="dv">1</span><span class="kw">]</span><br />  <span class="kw">else</span><br />    <span class="ot">undefined</span><br />show lastElement <span class="kw">[</span><span class="dv">1</span><span class="kw">,</span> <span class="dv">2</span><span class="kw">,</span> <span class="ot">undefined</span><span class="kw">]</span></code></pre>
<p>So did the array have a last element? Looking at the value <code>lastElement</code> returns, it is impossible to say.</p>
<p>The second issue with returning special values is that it can sometimes lead to a whole lot of clutter. If a piece of code calls <code>between</code> ten times, it has to check ten times whether <code>undefined</code> was returned. Also, if a function calls <code>between</code> but does not have a strategy to recover from a failure, it will have to check the return value of <code>between</code>, and if it is <code>undefined</code>, this function can then return <code>undefined</code> or some other special value to its caller, who in turn also checks for this value.</p>
<p>Sometimes, when something strange occurs, it would be practical to just stop doing what we are doing and immediately jump back to a place that knows how to handle the problem.</p>
<p>Well, we are in luck, a lot of programming languages provide such a thing. Usually, it is called exception handling<a href="#index-exception-handling"></a>.</p>
</section>
<section id="section-121">
<h5>○•○</h5>
<p>The theory behind exception handling goes like this: It is possible for code to raise<a href="#index-raise"></a> (or throw<a href="#index-throw"></a>) an exception<a href="#index-exception"></a>, which is a value. Raising an exception somewhat resembles a super-charged return from a function — it does not just jump out of the current function, but also out of its callers, all the way up to the top-level call that started the current execution. This is called unwinding the stack<a href="#index-unwinding-the-stack"></a>. You may remember the stack<a href="#index-stack"></a> of function calls that was mentioned in <a href="#functions">Functions↑</a>. An exception zooms down this stack, throwing away all the call contexts it encounters.</p>
<p>If they always zoomed right down to the base of the stack, exceptions would not be of much use, they would just provide a novel way to blow up your program. Fortunately, it is possible to set obstacles for exceptions along the stack. These ‘catch’<a href="#index-catch"></a> the exception as it is zooming down, and can do something with it, after which the program continues running at the point where the exception was caught. An example:</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">lastElement <span class="kw">=</span> <span class="fu">(array) -&gt;</span><br />  <span class="kw">if</span> array<span class="kw">.</span>length <span class="kw">&gt;</span> <span class="dv">0</span><br />    array<span class="kw">[</span>array<span class="kw">.</span>length <span class="kw">-</span> <span class="dv">1</span><span class="kw">]</span><br />  <span class="kw">else</span><br />    <span class="kw">throw</span> <span class="st">'Can not take the last element'</span> <span class="kw">+</span><br />          <span class="st">' of an empty array.'</span> <br /><br />lastElementPlusTen <span class="kw">=</span> <span class="fu">(array) -&gt;</span><br />  lastElement<span class="kw">(</span>array<span class="kw">)</span> <span class="kw">+</span> <span class="dv">10</span><br /><br /><span class="kw">try</span><br />  show lastElementPlusTen <span class="kw">[]</span><br /><span class="kw">catch</span> error<br />  show <span class="st">'Something went wrong: '</span> <span class="kw">+</span> error</code></pre>
<p><code>throw</code><a href="#index-throw"></a> is the keyword that is used to raise an exception. The keyword <code>try</code><a href="#index-try"></a> sets up an obstacle for exceptions: When the code in the block after it raises an exception, the <code>catch</code><a href="#index-catch"></a> block will be executed. The variable named in parentheses after the word <code>catch</code> is the name given to the exception value inside this block.</p>
<p>Note that the function <code>lastElementPlusTen</code> completely ignores the possibility that <code>lastElement</code> might go wrong. This is the big advantage of exceptions — error-handling code is only necessary at the point where the error occurs, and the point where it is handled. The functions in between can forget all about it. Well, almost.</p>
</section>
<section id="section-122">
<h5>○•○</h5>
<p>Consider the following: A function <code>processThing</code> wants to set a top-level variable <code>currentThing</code> to point to a specific thing while its body executes, so that other functions can have access to that thing too. Normally you would of course just pass the thing as an argument, but assume for a moment that that is not practical. When the function finishes, <code>currentThing</code> should be set back to <code>null</code>.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">currentThing <span class="kw">=</span> <span class="ot">null</span><br /><br />processThing <span class="kw">=</span> <span class="fu">(thing) -&gt;</span><br />  <span class="kw">if</span> currentThing <span class="kw">isnt</span> <span class="ot">null</span><br />    <span class="kw">throw</span> <span class="st">'Oh no! We are already processing a thing!'</span><br /><br />  currentThing <span class="kw">=</span> thing<br />  <span class="co"># do complicated processing...</span><br />  currentThing <span class="kw">=</span> <span class="ot">null</span></code></pre>
<p>But what if the complicated processing raises an exception? In that case the call to <code>processThing</code> will be thrown off the stack by the exception, and <code>currentThing</code> will never be reset to <code>null</code>. <code>try</code> statements can also be followed by a <code>finally</code><a href="#index-finally"></a> keyword, which means ‘no matter <em>what</em> happens, run this code after trying to run the code in the <code>try</code> block’. If a function has to clean something up, the cleanup code should usually be put into a <code>finally</code> block:</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">processThing <span class="kw">=</span> <span class="fu">(thing) -&gt;</span><br />  <span class="kw">if</span> currentThing <span class="kw">isnt</span> <span class="ot">null</span><br />    <span class="kw">throw</span> <span class="st">'Oh no! We are already processing a thing!'</span><br /><br />  currentThing <span class="kw">=</span> thing<br />  <span class="kw">try</span><br />    <span class="co"># do complicated processing...</span><br />  <span class="kw">finally</span><br />    currentThing <span class="kw">=</span> <span class="ot">null</span></code></pre>
</section>
<section id="section-123">
<h5>○•○</h5>
<p>A lot of errors in programs cause the CoffeeScript environment to raise an exception. For example:</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false"><span class="kw">try</span><br />  show Sasquatch<br /><span class="kw">catch</span> error<br />  show <span class="st">'Caught: '</span> <span class="kw">+</span> error<span class="kw">.</span>message</code></pre>
<p>In cases like this, special error objects are raised. These always have a <code>message</code> property containing a description of the problem. You can raise similar objects using the <code>new</code> keyword and the <code>Error</code><a href="#index-Error"></a> constructor:</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false"><span class="kw">try</span><br />  <span class="kw">throw</span> <span class="kw">new</span> <span class="dt">Error</span> <span class="st">'Fire!'</span><br /><span class="kw">catch</span> error<br />  show error<span class="kw">.</span>toString<span class="kw">()</span></code></pre>
</section>
<section id="section-124">
<h5>○•○</h5>
<p>When an exception goes all the way to the bottom of the stack without being caught, it gets handled by the environment. What this means differs between different browsers and engines, sometimes a description of the error is written to some kind of log, sometimes a window pops up describing the error.</p>
<p>The errors produced by entering code in the CoffeeScript REPL are caught by the console, and displayed along with a stack trace.</p>
</section>
<section id="section-125">
<h5>○•○</h5>
<p>Most programmers consider exceptions purely an error-handling mechanism. In essence, though, they are just another way of influencing the control flow of a program. For example, they can be used as a kind of <code>break</code> statement in a recursive function. Here is a slightly strange function which determines whether an object, and the objects stored inside it, contain at least seven <code>true</code> values:</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">FoundSeven <span class="kw">=</span> <span class="kw">{}</span><br />hasSevenTruths <span class="kw">=</span> <span class="fu">(object) -&gt;</span><br />  counted <span class="kw">=</span> <span class="dv">0</span><br />  count <span class="kw">=</span> <span class="fu">(object) -&gt;</span><br />    <span class="kw">for</span> name <span class="kw">of</span> object<br />      <span class="kw">if</span> object<span class="kw">[</span>name<span class="kw">]</span> <span class="kw">is</span> <span class="ot">true</span><br />        <span class="kw">if</span> <span class="kw">(++</span>counted<span class="kw">)</span> <span class="kw">is</span> <span class="dv">7</span><br />          <span class="kw">throw</span> FoundSeven<br />      <span class="kw">if</span> <span class="kw">typeof</span> object<span class="kw">[</span>name<span class="kw">]</span> <span class="kw">is</span> <span class="st">'object'</span><br />        count object<span class="kw">[</span>name<span class="kw">]</span><br />  <span class="kw">try</span><br />    count object<br />    <span class="kw">return</span> <span class="ot">false</span><br />  <span class="kw">catch</span> exception<br />    <span class="kw">if</span> exception <span class="kw">isnt</span> FoundSeven<br />      <span class="kw">throw</span> exception<br />    <span class="kw">return</span> <span class="ot">true</span></code></pre>
<p>The inner function <code>count</code> is recursively called for every object that is part of the argument. When the variable <code>counted</code> reaches seven, there is no point in continuing to count, but just returning from the current call to <code>count</code> will not necessarily stop the counting, since there might be more calls below it. So what we do is just throw a value, which will cause the control to jump right out of any calls to <code>count</code>, and land at the <code>catch</code> block.</p>
<p>But just returning <code>true</code> in case of an exception is not correct. Something else might be going wrong, so we first check whether the exception is the object <code>FoundSeven</code>, created specifically for this purpose. If it is not, this <code>catch</code> block does not know how to handle it, so it raises it again.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">testdata <span class="kw">=</span><br />  a<span class="kw">:</span> <span class="ot">true</span><br />  b<span class="kw">:</span> <span class="ot">true</span><br />  c<span class="kw">:</span> <span class="ot">false</span><br />  d<span class="kw">:</span><br />    a<span class="kw">:</span> <span class="ot">true</span><br />    b<span class="kw">:</span> <span class="ot">false</span><br />    c<span class="kw">:</span> <span class="ot">true</span><br />    d<span class="kw">:</span><br />      a<span class="kw">:</span> <span class="ot">true</span><br />      b<span class="kw">:</span><br />        a<span class="kw">:</span> <span class="ot">true</span><br />    e<span class="kw">:</span><br />      a<span class="kw">:</span> <span class="ot">false</span><br />      b<span class="kw">:</span> <span class="ot">true</span><br />      c<span class="kw">:</span> <span class="ot">true</span><br />show hasSevenTruths testdata</code></pre>
<p>This is a pattern that is also common when dealing with error conditions — you have to make sure that your <code>catch</code> block only handles exceptions that it knows how to handle. Throwing string values, as some of the examples in this chapter do, is rarely a good idea, because it makes it hard to recognise the type of the exception. A better idea is to use unique values, such as the <code>FoundSeven</code> object, or to introduce a new type of objects, as described in <a href="#object-oriented-programming">Object Orientation↓</a>.</p>
<hr />
</section>
</section>
</section>
<section id="part-iii.-paradigm">
<h2>Part III. Paradigm</h2>
<hr />
<section id="functional-programming">
<h3>Functional Programming</h3>
<hr />
<p>As programs get bigger, they also become more complex and harder to understand. We all think ourselves pretty clever, of course, but we are mere human beings, and even a moderate amount of chaos tends to baffle us. And then it all goes downhill. Working on something you do not really understand is a bit like cutting random wires on those time-activated bombs they always have in movies. If you are lucky, you might get the right one — especially if you are the hero of the movie and strike a suitably dramatic pose — but there is always the possibility of blowing everything up.</p>
<p>Admittedly, in most cases, breaking a program does not cause any large explosions. But when a program, by someone’s ignorant tinkering, has degenerated into a ramshackle mass of errors, reshaping it into something sensible is a terrible labour — sometimes you might just as well start over.</p>
<p><a href="#index-abstraction"></a>Thus, the programmer is always looking for ways to keep the complexity of his programs as low as possible. An important way to do this is to try and make code more abstract. When writing a program, it is easy to get sidetracked into small details at every point. You come across some little issue, and you deal with it, and then proceed to the next little problem, and so on. This makes the code read like a grandmother’s tale.</p>
<blockquote>
<p><em>Yes, dear, to make pea soup you will need split peas, the dry kind. And you have to soak them at least for a night, or you will have to cook them for hours and hours. I remember one time, when my dull son tried to make pea soup. Would you believe he hadn’t soaked the peas? We almost broke our teeth, all of us. Anyway, when you have soaked the peas, and you’ll want about a cup of them per person, and pay attention because they will expand a bit while they are soaking, so if you aren’t careful they will spill out of whatever you use to hold them, so also use plenty water to soak in, but as I said, about a cup of them, when they are dry, and after they are soaked you cook them in four cups of water per cup of dry peas. Let it simmer for two hours, which means you cover it and keep it barely cooking, and then add some diced onions, sliced celery stalk, and maybe a carrot or two and some ham. Let it all cook for a few minutes more, and it is ready to eat.</em></p>
</blockquote>
<p>Another way to describe this recipe:</p>
<blockquote>
<p><em>Per person: one cup dried split peas, half a chopped onion, half a carrot, a celery stalk, and optionally ham.</em><br /> <em>Soak peas overnight, simmer them for two hours in four cups of water (per person), add vegetables and ham, and cook for ten more minutes.</em></p>
</blockquote>
<p>This is shorter, but if you do not know how to soak peas you will surely screw up and put them in too little water. But how to soak peas can be looked up, and that is the trick. If you assume a certain basic knowledge in the audience, you can talk in a language that deals with bigger concepts, and express things in a much shorter and clearer way.</p>
<p>This, more or less, is what abstraction is.</p>
<p>How is this far-fetched recipe story relevant to programming? Well, obviously, the recipe is the program. Furthermore, the basic knowledge that the cook is supposed to have corresponds to the functions and other constructs that are available to the programmer. If you remember the introduction of this book, things like <code>while</code> make it easier to build loops, and in <a href="#data-structures-objects-and-arrays">Data Structures↑</a> we wrote some simple functions in order to make other functions shorter and more straightforward. Such tools, some of them made available by the language itself, others built by the programmer, are used to reduce the amount of uninteresting details in the rest of the program, and thus make that program easier to work with.</p>
<section id="section-126">
<h5>○•○</h5>
<p>Functional programming<a href="#index-functional-programming"></a>, which is the subject of this chapter, produces abstraction through clever ways of combining functions. A programmer armed with a repertoire of fundamental functions and, more importantly, the knowledge on how to use them, is much more effective than one who starts from scratch. Unfortunately, a standard CoffeeScript environment comes with deplorably few essential functions, so we have to write them ourselves or, which is often preferable, make use of somebody else’s code (more on that in <a href="#modularity">Modularity↓</a>).</p>
<p>In this chapter we write a set of useful functions to understand how they work and solve problems with them to understand how to use them. In later chapters we will use the larger set of functions in the Underscore library that comes with CoffeeScript.</p>
<p>There are other popular approaches to abstraction, most notably object-oriented programming, the subject of <a href="#object-oriented-programming">Object Orientation↓</a>.</p>
</section>
<section id="section-127">
<h5>○•○</h5>
<p>In programming a fundamental operation is performing an action on every element of an array. Many programming languages have borrowed their way of doing this from the C programming language:</p>
<pre class="sourceCode"><code class="sourceCode c">size_t i;<br />size_t N = <span class="kw">sizeof</span>(thing) / <span class="kw">sizeof</span>(thing[<span class="dv">0</span>]);<br /><span class="kw">for</span> (i = <span class="dv">0</span>; i &lt; N; ++i) {<br />  do_something(thing[i]);<br />}</code></pre>
<p>That is very ugly, an eyesore if you have any good taste at all. It has been improved somewhat in derived languages like C++ and JavaScript. Other programming languages can have very different approaches<sup><a href="#fn21" class="footnoteRef" id="fnref21">21</a></sup>. In CoffeeScript it becomes the reasonably pleasant:</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false"><span class="co"># Say we have:</span><br />thing <span class="kw">=</span> <span class="kw">[</span><span class="dv">5</span><span class="kw">..</span><span class="dv">7</span><span class="kw">]</span><br />doSomething <span class="kw">=</span> show<br /><br /><span class="co"># then</span><br /><span class="kw">for</span> i <span class="kw">in</span> <span class="kw">[</span><span class="dv">0</span><span class="kw">...</span>thing<span class="kw">.</span>length<span class="kw">]</span> <span class="kw">then</span> doSomething thing<span class="kw">[</span>i<span class="kw">]</span><br /><span class="co"># or better - you can see the generated code with: show -&gt; \</span><br /><span class="kw">for</span> element <span class="kw">in</span> thing <span class="kw">then</span> doSomething element</code></pre>
<p>Still do we have to do this over and over or can it be abstracted?</p>
<p>The problem is that, whereas most functions just take some values, combine them, and return something, such a loop contains a piece of code that it must execute. It is easy to write a function that goes over an array and prints out every element:</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">printArray <span class="kw">=</span> <span class="fu">(array) -&gt;</span><br />  <span class="kw">for</span> element <span class="kw">in</span> array<br />    show element<br />  <span class="kw">return</span><br /><br />printArray <span class="kw">[</span><span class="dv">7</span><span class="kw">..</span><span class="dv">9</span><span class="kw">]</span></code></pre>
<p>But what if we want to do something else than print? Since ‘doing something’ can be represented as a function, and functions are also values, we can pass our action as a function value:</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">forEach <span class="kw">=</span> <span class="fu">(array, action) -&gt;</span><br />  <span class="kw">for</span> element <span class="kw">in</span> array<br />    action element<br />  <span class="co">#return</span><br /><br />forEach <span class="kw">[</span><span class="st">'Wampeter'</span><span class="kw">,</span> <span class="st">'Foma'</span><span class="kw">,</span> <span class="st">'Granfalloon'</span><span class="kw">],</span> show<br />runOnDemand <span class="fu">-&gt;</span> show forEach <span class="co"># View generated code</span></code></pre>
<p>In CoffeeScript most statements are expressions that return a value, that is also the case with the <code>for</code> statement. A <code>return</code> statement at the end of <code>forEach</code> will make it return <code>undefined</code>. Here <code>forEach</code> is allowed to return its value, when we get to the <code>map</code> function you will see why.</p>
<p>By making use of an anonymous function, something just like a <code>for</code> loop can be written as:</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">sum <span class="kw">=</span> <span class="fu">(numbers) -&gt;</span><br />  total <span class="kw">=</span> <span class="dv">0</span><br />  forEach numbers<span class="kw">,</span> <span class="fu">(number) -&gt;</span> total <span class="kw">+=</span> number<br />  total<br />show sum <span class="kw">[</span><span class="dv">1</span><span class="kw">,</span> <span class="dv">10</span><span class="kw">,</span> <span class="dv">100</span><span class="kw">]</span></code></pre>
<p>Note that the variable <code>total</code> is visible inside the anonymous function because of the scoping rules. Also note that this version is hardly shorter than the <code>for</code> loop.</p>
<p>You do get a variable bound to the current element in the array, <code>number</code>, so there is no need to use <code>numbers[i]</code> anymore, and when this array is created by evaluating some expression, there is no need to store it in a variable, because it can be passed to <code>forEach</code> directly.</p>
<p>The cat-code in <a href="#data-structures-objects-and-arrays">Data Structures↑</a> contains a piece like this:</p>
<pre class="sourceCode"><code class="sourceCode COFFEESCRIPT">paragraphs <span class="kw">=</span> email<span class="kw">.</span>split <span class="st">'\n'</span><br /><span class="kw">for</span> paragraph <span class="kw">in</span> paragraphs<br />  handleParagraph paragraph</code></pre>
<p>This can now be written as…</p>
<pre class="sourceCode"><code class="sourceCode COFFEESCRIPT">forEach email<span class="kw">.</span>split<span class="kw">(</span><span class="st">'\n'</span><span class="kw">),</span> handleParagraph</code></pre>
<p>On the whole, using more abstract (or ‘higher level’) constructs results in more information and less noise: The code in <code>sum</code> reads <em>‘for each number in numbers add that number to the total’</em>, instead of… <em>‘there is this variable that starts at zero, and it counts upward to the length of the array called numbers, and for every value of this variable we look up the corresponding element in the array and add this to the total’</em>.</p>
</section>
<section id="section-128">
<h5>○•○</h5>
<p>What <code>forEach</code> does is take an algorithm, in this case ‘going over an array’, and abstract it. The ‘gaps’ in the algorithm, in this case, what to do for each of these elements, are filled by functions which are passed to the algorithm function.</p>
<p>Functions that operate on other functions are called higher-order function<a href="#index-higher-order-function"></a>s. By operating on functions, they can talk about actions on a whole new level. The <code>makeAddFunction</code> function from <a href="#functions">Functions↑</a> is also a higher-order function. Instead of taking a function value as an argument, it produces a new function.</p>
<p>Higher-order functions can be used to generalise many algorithms that regular functions can not easily describe. When you have a repertoire of these functions at your disposal, it can help you think about your code in a clearer way: Instead of a messy set of variables and loops, you can decompose algorithms into a combination of a few fundamental algorithms, which are invoked by name, and do not have to be typed out again and again.</p>
<p>Being able to write <em>what</em> we want to do instead of <em>how</em> we do it means we are working at a higher level of abstraction. In practice, this means shorter, clearer, and more pleasant code.</p>
</section>
<section id="section-129">
<h5>○•○</h5>
<p>Another useful type of higher-order function <em>modifies</em> the function value it is given:</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">negate <span class="kw">=</span> <span class="fu">(func) -&gt;</span><br />  <span class="fu">(x) -&gt;</span> <span class="kw">not</span> func x<br /><br />isNotNaN <span class="kw">=</span> negate <span class="ot">isNaN</span><br />show isNotNaN <span class="ot">NaN</span></code></pre>
<p>The function returned by <code>negate</code> feeds the argument it is given to the original function <code>func</code>, and then negates the result. But what if the function you want to negate takes more than one argument? You can get access to any arguments passed to a function with the <code>arguments</code> array, but how do you call a function when you do not know how many arguments you have?</p>
<p>Functions<sup><a href="#fn22" class="footnoteRef" id="fnref22">22</a></sup> have a method called <code>apply</code><a href="#index-apply"></a>, which is used for situations like this. It takes two arguments. The role of the first argument will be discussed in <a href="#object-oriented-programming">Object Orientation↓</a>, for now we just use <code>null</code> there. The second argument is an array containing the arguments that the function must be applied to.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">show <span class="ot">Math</span><span class="kw">.</span>min<span class="kw">.</span>apply <span class="ot">null</span><span class="kw">,</span> <span class="kw">[</span><span class="dv">5</span><span class="kw">,</span> <span class="dv">6</span><span class="kw">]</span><br /><br />negate <span class="kw">=</span> <span class="fu">(func) -&gt;</span><br />  <span class="fu">-&gt;</span> <span class="kw">not</span> func<span class="kw">.</span>apply <span class="ot">null</span><span class="kw">,</span> arguments<br /><br />morethan <span class="kw">=</span> <span class="fu">(x,y) -&gt;</span> x <span class="kw">&gt;</span> y<br />lessthan <span class="kw">=</span> negate morethan<br />show lessthan <span class="dv">5</span><span class="kw">,</span> <span class="dv">7</span></code></pre>
<p>Now you know the underlying <code>arguments</code> mechanism remember that you can also use splats…</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">show <span class="ot">Math</span><span class="kw">.</span>min <span class="kw">[</span><span class="dv">5</span><span class="kw">,</span> <span class="dv">6</span><span class="kw">]...</span><br /><br />negate <span class="kw">=</span> <span class="fu">(func) -&gt;</span><br />  <span class="fu">(args...) -&gt;</span> <span class="kw">not</span> func args<span class="kw">...</span><br /><br />morethan <span class="kw">=</span> <span class="fu">(x,y) -&gt;</span> x <span class="kw">&gt;</span> y<br />lessthan <span class="kw">=</span> negate morethan<br />show lessthan <span class="dv">5</span><span class="kw">,</span> <span class="dv">7</span></code></pre>
</section>
<section id="section-130">
<h5>○•○</h5>
<p>Let us look at a few more basic algorithms related to arrays. The <code>sum</code> function is really a variant of an algorithm which is usually called <code>reduce</code><a href="#index-reduce"></a> or <code>foldl</code>:</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">reduce <span class="kw">=</span> <span class="fu">(array, combine, base) -&gt;</span><br />  forEach array<span class="kw">,</span> <span class="fu">(element) -&gt;</span><br />    base <span class="kw">=</span> combine base<span class="kw">,</span> element<br />  base<br /><br />add <span class="kw">=</span> <span class="fu">(a, b) -&gt;</span> a <span class="kw">+</span> b<br />sum <span class="kw">=</span> <span class="fu">(numbers) -&gt;</span> reduce numbers<span class="kw">,</span> add<span class="kw">,</span> <span class="dv">0</span><br />show sum <span class="kw">[</span><span class="dv">1</span><span class="kw">,</span> <span class="dv">10</span><span class="kw">,</span> <span class="dv">100</span><span class="kw">]</span></code></pre>
<p><code>reduce</code> combines an array into a single value by repeatedly using a function that combines an element of the array with a base value. This is exactly what <code>sum</code> did, so it can be made shorter by using <code>reduce</code>… except that addition is an operator and not a function in CoffeeScript, so we first had to put it into a function.</p>
</section>
<section id="exercise-21">
<h4><em>Exercise 21</em></h4>
<p>Write a function <code>countZeroes</code>, which takes an array of numbers as its argument and returns the amount of zeroes that occur in it. Use <code>reduce</code>.</p>
<p>Then, write the higher-order function <code>count</code>, which takes an array and a test function as arguments, and returns the amount of elements in the array for which the test function returned <code>true</code>. Re-implement <code>countZeroes</code> using this function.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false"><span class="co"># Compose a solution here</span></code></pre>
<section id="view-solution-26" onclick="reveal(this)" >
<h5>View Solution</h5>
<section id="section-131" style="display:none" >
<h6></h6>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">countZeroes <span class="kw">=</span> <span class="fu">(array) -&gt;</span><br />  counter <span class="kw">=</span> <span class="fu">(total, element) -&gt;</span><br />    total<span class="kw">++</span> <span class="kw">if</span> element <span class="kw">is</span> <span class="dv">0</span><br />    total<br />  reduce array<span class="kw">,</span> counter<span class="kw">,</span> <span class="dv">0</span><br /><br />bits <span class="kw">=</span> <span class="kw">[</span><span class="dv">1</span><span class="kw">,</span> <span class="dv">0</span><span class="kw">,</span> <span class="dv">1</span><span class="kw">,</span> <span class="dv">0</span><span class="kw">,</span> <span class="dv">0</span><span class="kw">,</span> <span class="dv">1</span><span class="kw">,</span> <span class="dv">1</span><span class="kw">,</span> <span class="dv">1</span><span class="kw">,</span> <span class="dv">0</span><span class="kw">]</span><br />show countZeroes bits</code></pre>
<p>Here is the solution that uses a <code>count</code> function, with a function that produces equality-testers included to make the final <code>countZeroes</code> function even shorter:</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">count <span class="kw">=</span> <span class="fu">(test, array) -&gt;</span><br />  reduce array<span class="kw">,</span> <span class="kw">(</span><span class="fu">(total, element) -&gt;</span><br />    total <span class="kw">+</span> <span class="kw">if</span> test element <span class="kw">then</span> <span class="dv">1</span> <span class="kw">else</span> <span class="dv">0</span><span class="kw">),</span> <span class="dv">0</span><br /><br />equals <span class="kw">=</span> <span class="fu">(x) -&gt;</span><br />  <span class="fu">(element) -&gt;</span> x <span class="kw">is</span> element<br /><br />countZeroes <span class="kw">=</span> <span class="fu">(array) -&gt;</span><br />  count equals<span class="kw">(</span><span class="dv">0</span><span class="kw">),</span> array<br /><br />show countZeroes bits</code></pre>
</section>
</section>
</section>
<section id="section-132">
<h4></h4>
<p>One other generally useful ‘fundamental algorithm’ related to arrays is called <code>map</code><a href="#index-map"></a>. It goes over an array, applying a function to every element, just like <code>forEach</code>. But instead of discarding the values returned by function, it builds up a new array from these values.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">map <span class="kw">=</span> <span class="fu">(array, func) -&gt;</span><br />  result <span class="kw">=</span> <span class="kw">[]</span><br />  forEach array<span class="kw">,</span> <span class="fu">(element) -&gt;</span><br />    result<span class="kw">.</span>push func element<br />  result<br /><br />show map <span class="kw">[</span><span class="fl">0.01</span><span class="kw">,</span> <span class="dv">2</span><span class="kw">,</span> <span class="fl">9.89</span><span class="kw">,</span> <span class="ot">Math</span><span class="kw">.</span>PI<span class="kw">],</span> <span class="ot">Math</span><span class="kw">.</span>round</code></pre>
<p>Note that the last argument is called <code>func</code>, not <code>function</code>, this is because <code>function</code> is a keyword and thus not a valid variable name. And then:</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false"><span class="co"># Leave out result since forEach already returns it</span><br />map <span class="kw">=</span> <span class="fu">(array, func) -&gt;</span><br />  forEach array<span class="kw">,</span> <span class="fu">(element) -&gt;</span><br />    func element<br /><br /><span class="co"># Leave out func arguments</span><br />map <span class="kw">=</span> <span class="fu">(array, func) -&gt;</span><br />  forEach array<span class="kw">,</span> func<br /><br /><span class="co"># Leave out forEach arguments</span><br />map <span class="kw">=</span> forEach<br /><br />show map <span class="kw">[</span><span class="fl">0.01</span><span class="kw">,</span> <span class="dv">2</span><span class="kw">,</span> <span class="fl">9.89</span><span class="kw">,</span> <span class="ot">Math</span><span class="kw">.</span>PI<span class="kw">],</span> <span class="ot">Math</span><span class="kw">.</span>round</code></pre>
<p>The reduction shows how nicely functions and expressions can be used to shorten a function. If we were concerned with the performance of <code>forEach</code> then inserting a <code>return</code> at the end of its definition would prevent it from collecting the results of the <code>for</code> comprehension and we would have to provide an implementation in <code>map</code>.</p>
<section id="section-133">
<h5>○•○</h5>
<p>There once was, living in the deep mountain forests of Transylvania, a recluse. Most of the time, he just wandered around his mountain, talking to trees and laughing with birds. But now and then, when the pouring rain trapped him in his little hut, and the howling wind made him feel unbearably small, the recluse felt an urge to write something, wanted to pour some thoughts out onto paper, where they could maybe grow bigger than he himself was.</p>
<p>After failing miserably at poetry, fiction, and philosophy, the recluse finally decided to write a technical book. In his youth, he had done some computer programming, and he figured that if he could just write a good book about that, fame and recognition would surely follow.</p>
<p>So he wrote. At first he used fragments of tree bark, but that turned out not to be very practical. He went down to the nearest village and bought himself a laptop computer. After a few chapters, he realised he wanted to put the book in HTML format, in order to put it on his web-page…</p>
<p align=center><img src="../img/html-small.png" alt="figure ../img/html-small.png" /><br /></p>
<p>Are you familiar with HTML? It is the method used to add mark-up to pages on the web, and we will be using it a few times in this book, so it would be nice if you know how it works, at least generally. If you are a good student, you could go search the web for a good introduction to HTML now, and come back here when you have read it. Most of you probably are lousy students, so I will just give a short explanation and hope it is enough.</p>
<p>HTML<a href="#index-HTML"></a> stands for ‘HyperText Mark-up Language’. An HTML document is all text. Because it must be able to express the structure of this text, information about which text is a heading, which text is purple, and so on, a few characters have a special meaning, somewhat like backslashes in CoffeeScript strings. The ‘less than’ and ‘greater than’ characters are used to create ‘tag<a href="#index-tag"></a>s’. A tag gives extra information about the text in the document. It can stand on its own, for example to mark the place where a picture should appear in the page, or it can contain text and other tags, for example when it marks the start and end of a paragraph.</p>
<p>Some tags are compulsory, a whole HTML document must always be contained in between <code>html</code> tags. The HTML version is specified on the first line with the document type, <code>DOCTYPE</code>, so browsers can parse and render it correctly. Here is an example of an HTML<sub>5</sub> document:</p>
<pre class="sourceCode"><code class="sourceCode html"><span class="dt">&lt;!DOCTYPE </span>HTML<span class="dt">&gt;</span><br /><span class="kw">&lt;html&gt;</span><br />  <span class="kw">&lt;head&gt;</span><br />    <span class="kw">&lt;meta</span><span class="ot"> charset=</span><span class="st">&quot;utf-8&quot;</span><span class="kw">/&gt;</span><br />    <span class="kw">&lt;title&gt;</span>A quote<span class="kw">&lt;/title&gt;</span><br />  <span class="kw">&lt;/head&gt;</span><br />  <span class="kw">&lt;body&gt;</span><br />    <span class="kw">&lt;h1&gt;</span>A quote<span class="kw">&lt;/h1&gt;</span><br />    <span class="kw">&lt;blockquote&gt;</span><br />      <span class="kw">&lt;p&gt;</span>The connection between the language in which we<br />      think/program and the problems and solutions we can<br />      imagine is very close. For this reason restricting<br />      language features with the intent of eliminating<br />      programmer errors is at best dangerous.<span class="kw">&lt;/p&gt;</span><br />      <span class="kw">&lt;p&gt;</span>-- Bjarne Stroustrup<span class="kw">&lt;/p&gt;</span><br />    <span class="kw">&lt;/blockquote&gt;</span><br />    <span class="kw">&lt;p&gt;</span>Mr. Stroustrup is the inventor of the C++<br />    programming language, but quite an insightful<br />    person nevertheless.<span class="kw">&lt;/p&gt;</span><br />    <span class="kw">&lt;p&gt;</span>Also, here is a picture of an ostrich:<span class="kw">&lt;/p&gt;</span><br />    <span class="kw">&lt;img</span><span class="ot"> src=</span><span class="st">&quot;../img/ostrich.jpg&quot;</span><span class="kw">/&gt;</span><br />  <span class="kw">&lt;/body&gt;</span><br /><span class="kw">&lt;/html&gt;</span></code></pre>
<p>Elements that contain text or other tags are first opened with <code>&lt;tagname&gt;</code>, and afterwards finished with <code>&lt;/tagname&gt;</code>. The <code>html</code> element always contains two children: <code>head</code> and <code>body</code>. The first contains information <em>about</em> the document, the second contains the actual document.</p>
<p>Most tag names are cryptic abbreviations. <code>h1</code> stands for ‘heading 1’, the biggest kind of heading. There are also <code>h2</code> to <code>h6</code> for successively smaller headings. <code>p</code> means ‘paragraph’, and <code>img</code> stands for ‘image’. The <code>img</code> element does not contain any text or other tags, but it does have some extra information, <code>src=&quot;../img/ostrich.png&quot;</code>, which is called an ‘attribute’<a href="#index-attribute"></a>. In this case, it contains information about the image file that should be shown here.</p>
<p>Because <code>&lt;</code> and <code>&gt;</code> have a special meaning in HTML documents, they can not be written directly in the text of the document. If you want to say ‘<code>5 &lt; 10</code>’ in an HTML document, you have to write ‘<code>5 &amp;lt; 10</code>’, where ‘<code>lt</code>’ stands for ‘less than’. ‘<code>&amp;gt;</code>’ is used for ‘<code>&gt;</code>’, and because these codes also give the ampersand character a special meaning, a plain ‘<code>&amp;</code>’ is written as ‘<code>&amp;amp;</code>’.</p>
<p>Now, those are only the bare basics of HTML, but they should be enough to make it through this chapter, and later chapters that deal with HTML documents, without getting entirely confused.</p>
</section>
<section id="section-134">
<h5>○•○</h5>
<p>The interactive environment has a function <code>showDocument</code> that can be used to look at HTML documents. If you have a webpage in a string variable then you can display it with: <code>showDocument variableName, width, height</code>. You can also give it a document in a string directly.<sup><a href="#fn23" class="footnoteRef" id="fnref23">23</a></sup></p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false"><span class="co"># You could access a picture with its URL</span><br />imageSource <span class="kw">=</span> <span class="st">'http://autotelicum.github.com/Smooth-CoffeeScript'</span><br />linkOstrich <span class="kw">=</span> <span class="st">&quot;</span><span class="ch">#{</span>imageSource<span class="ch">}</span><span class="st">/img/ostrich.jpg&quot;</span><br /><br /><span class="co"># But I will use a predefined image to avoid a server round-trip</span><br />showDocument <span class="st">&quot;&quot;&quot;</span><br /><span class="st">&lt;!DOCTYPE HTML&gt;</span><br /><span class="st">&lt;html&gt;</span><br /><span class="st">  &lt;head&gt;</span><br /><span class="st">    &lt;meta charset=&quot;utf-8&quot;/&gt;</span><br /><span class="st">    &lt;title&gt;A quote&lt;/title&gt;</span><br /><span class="st">  &lt;/head&gt;</span><br /><span class="st">  &lt;body&gt;</span><br /><span class="st">    &lt;h1&gt;A quote&lt;/h1&gt;</span><br /><span class="st">    &lt;blockquote&gt;</span><br /><span class="st">      &lt;p&gt;The connection between the language in which we</span><br /><span class="st">      think/program and the problems and solutions we can</span><br /><span class="st">      imagine is very close. For this reason restricting</span><br /><span class="st">      language features with the intent of eliminating</span><br /><span class="st">      programmer errors is at best dangerous.&lt;/p&gt;</span><br /><span class="st">      &lt;p&gt;-- Bjarne Stroustrup&lt;/p&gt;</span><br /><span class="st">    &lt;/blockquote&gt;</span><br /><span class="st">    &lt;p&gt;Mr. Stroustrup is the inventor of the C++</span><br /><span class="st">    programming language, but quite an insightful</span><br /><span class="st">    person nevertheless.&lt;/p&gt;</span><br /><span class="st">    &lt;p&gt;Also, here is a picture of an ostrich:&lt;/p&gt;</span><br /><span class="st">    &lt;img src=&quot;</span><span class="ch">#{</span>ostrich<span class="ch">}</span><span class="st">&quot;/&gt;</span><br /><span class="st">  &lt;/body&gt;</span><br /><span class="st">&lt;/html&gt;</span><br /><span class="st">&quot;&quot;&quot;</span><span class="kw">,</span> <span class="dv">565</span><span class="kw">,</span> <span class="dv">420</span></code></pre>
</section>
<section id="section-135">
<h5>○•○</h5>
<p>So, picking up the story again, the recluse wanted to have his book in HTML format. At first he just wrote all the tags directly into his manuscript, but typing all those less-than and greater-than signs made his fingers hurt, and he constantly forgot to write <code>&amp;amp;</code> when he needed an <code>&amp;</code>. This gave him a headache. Next, he tried to write the book in Microsoft Word, and then save it as HTML. But the HTML that came out of that was fifteen times bigger and more complicated than it had to be. And besides, Microsoft Word gave him a headache.</p>
<p>The solution that he eventually came up with was this: He would write the book as plain text, following some simple rules about the way paragraphs were separated and the way headings looked. Then, he would write a program to convert this text into precisely the HTML that he wanted.</p>
<p>The rules are this:</p>
<ol type="1">
<li>Paragraphs are separated by blank lines.</li>
<li>A paragraph that starts with a ‘%’ symbol is a header. The more ‘%’ symbols, the smaller the header.</li>
<li>Inside paragraphs, pieces of text can be emphasised by putting them between asterisks.</li>
<li>Footnotes are written between braces.</li>
</ol>
</section>
<section id="section-136">
<h5>○•○</h5>
<p>After he had struggled painfully with his book for six months, the recluse had still only finished a few paragraphs. At this point, his hut was struck by lightning, killing him, and forever putting his writing ambitions to rest. From the charred remains of his laptop, I could recover the following manuscript, that I have placed in a global string variable, <code>recluseFile</code>, so you can get it as a string value in the following.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">recluseFile <span class="kw">=</span> <span class="st">&quot;&quot;&quot;</span><br /><span class="st">% The Book of Programming</span><br /><br /><span class="st">%% The Two Aspects</span><br /><br /><span class="st">Below the surface of the machine, the program moves.</span><br /><span class="st">Without effort, it expands and contracts. In great harmony, </span><br /><span class="st">electrons scatter and regroup. The forms on the monitor</span><br /><span class="st">are but ripples on the water. The essence stays invisibly</span><br /><span class="st">below.</span><br /><br /><span class="st">When the creators built the machine, they put in the</span><br /><span class="st">processor and the memory. From these arise the two aspects</span><br /><span class="st">of the program.</span><br /><br /><span class="st">The aspect of the processor is the active substance. It is</span><br /><span class="st">called Control. The aspect of the memory is the passive </span><br /><span class="st">substance. It is called Data.</span><br /><br /><span class="st">Data is made of merely bits, yet it takes complex forms.</span><br /><span class="st">Control consists only of simple instructions, yet it</span><br /><span class="st">performs difficult tasks. From the small and trivial, the</span><br /><span class="st">large and complex arise.</span><br /><br /><span class="st">The program source is Data. Control arises from it. The</span><br /><span class="st">Control proceeds to create new Data. The one is born from</span><br /><span class="st">the other, the other is useless without the one. This is</span><br /><span class="st">the harmonious cycle of Data and Control.</span><br /><br /><span class="st">Of themselves, Data and Control are without structure. The</span><br /><span class="st">programmers of old moulded their programs out of this raw</span><br /><span class="st">substance. Over time, the amorphous Data has crystallised</span><br /><span class="st">into data types, and the chaotic Control was restricted</span><br /><span class="st">into control structures and functions.</span><br /><br /><span class="st">%% Short Sayings</span><br /><br /><span class="st">When a student asked Fu-Tzu about the nature of the cycle</span><br /><span class="st">of Data and Control, Fu-Tzu replied 'Think of a compiler,</span><br /><span class="st">compiling itself.'</span><br /><br /><span class="st">A student asked 'The programmers of old used only simple</span><br /><span class="st">machines and no programming languages, yet they made</span><br /><span class="st">beautiful programs. Why do we use complicated machines</span><br /><span class="st">and programming languages?'. Fu-Tzu replied 'The builders</span><br /><span class="st">of old used only sticks and clay, yet they made beautiful</span><br /><span class="st">huts.'</span><br /><br /><span class="st">A hermit spent ten years writing a program. 'My program can</span><br /><span class="st">compute the motion of the stars on a 286-computer running</span><br /><span class="st">MS DOS', he proudly announced. 'Nobody owns a 286-computer</span><br /><span class="st">or uses MS DOS anymore.', Fu-Tzu responded.</span><br /><br /><span class="st">Fu-Tzu had written a small program that was full of global</span><br /><span class="st">state and dubious shortcuts. Reading it, a student asked</span><br /><span class="st">'You warned us against these techniques, yet I find them in</span><br /><span class="st">your program. How can this be?' Fu-Tzu said 'There is no</span><br /><span class="st">need to fetch a water hose when the house is not on fire.'</span><br /><span class="st">{This is not to be read as an encouragement of sloppy</span><br /><span class="st">programming, but rather as a warning against neurotic</span><br /><span class="st">adherence to rules of thumb.}</span><br /><br /><span class="st">%% Wisdom</span><br /><br /><span class="st">A student was complaining about digital numbers. 'When I</span><br /><span class="st">take the root of two and then square it again, the result</span><br /><span class="st">is already inaccurate!'. Overhearing him, Fu-Tzu laughed.</span><br /><span class="st">'Here is a sheet of paper. Write down the precise value of</span><br /><span class="st">the square root of two for me.'</span><br /><br /><span class="st">Fu-Tzu said 'When you cut against the grain of the wood,</span><br /><span class="st">much strength is needed. When you program against the grain</span><br /><span class="st">of a problem, much code is needed.'</span><br /><br /><span class="st">Tzu-li and Tzu-ssu were boasting about the size of their</span><br /><span class="st">latest programs. 'Two-hundred thousand lines', said Tzu-li,</span><br /><span class="st">'not counting comments!'. 'Psah', said Tzu-ssu, 'mine is</span><br /><span class="st">almost a *million* lines already.' Fu-Tzu said 'My best</span><br /><span class="st">program has five hundred lines.' Hearing this, Tzu-li and</span><br /><span class="st">Tzu-ssu were enlightened.</span><br /><br /><span class="st">A student had been sitting motionless behind his computer</span><br /><span class="st">for hours, frowning darkly. He was trying to write a</span><br /><span class="st">beautiful solution to a difficult problem, but could not</span><br /><span class="st">find the right approach. Fu-Tzu hit him on the back of his</span><br /><span class="st">head and shouted '*Type something!*' The student started</span><br /><span class="st">writing an ugly solution. After he had finished, he</span><br /><span class="st">suddenly understood the beautiful solution.</span><br /><br /><span class="st">%% Progression</span><br /><br /><span class="st">A beginning programmer writes his programs like an ant</span><br /><span class="st">builds her hill, one piece at a time, without thought for</span><br /><span class="st">the bigger structure. His programs will be like loose sand.</span><br /><span class="st">They may stand for a while, but growing too big they fall</span><br /><span class="st">apart{Referring to the danger of internal inconsistency</span><br /><span class="st">and duplicated structure in unorganised code.}.</span><br /><br /><span class="st">Realising this problem, the programmer will start to spend</span><br /><span class="st">a lot of time thinking about structure. His programs will</span><br /><span class="st">be rigidly structured, like rock sculptures. They are solid,</span><br /><span class="st">but when they must change, violence must be done to them</span><br /><span class="st">{Referring to the fact that structure tends to put</span><br /><span class="st">restrictions on the evolution of a program.}.</span><br /><br /><span class="st">The master programmer knows when to apply structure and</span><br /><span class="st">when to leave things in their simple form. His programs</span><br /><span class="st">are like clay, solid yet malleable.</span><br /><br /><span class="st">%% Language</span><br /><br /><span class="st">When a programming language is created, it is given</span><br /><span class="st">syntax and semantics. The syntax describes the form of</span><br /><span class="st">the program, the semantics describe the function. When the</span><br /><span class="st">syntax is beautiful and the semantics are clear, the</span><br /><span class="st">program will be like a stately tree. When the syntax is</span><br /><span class="st">clumsy and the semantics confusing, the program will be</span><br /><span class="st">like a bramble bush.</span><br /><br /><span class="st">Tzu-ssu was asked to write a program in the language</span><br /><span class="st">called  Java, which takes a very primitive approach to</span><br /><span class="st">functions. Every morning, as he sat down in front of his</span><br /><span class="st">computer, he started complaining. All day he cursed,</span><br /><span class="st">blaming the language for all that went wrong. Fu-Tzu</span><br /><span class="st">listened for a while, and then reproached him, saying</span><br /><span class="st">'Every language has its own way. Follow its form, do not</span><br /><span class="st">try to program as if you were using another language.'</span><br /><span class="st">&quot;&quot;&quot;</span><br />show <span class="co"># 'The End'</span></code></pre>
</section>
<section id="section-137">
<h5>○•○</h5>
<p>To honour the memory of our good recluse, I would like to finish his HTML-generating program for him. A good approach to this problem goes like this:</p>
<ol type="1">
<li>Split the file into paragraphs by cutting it at every empty line.</li>
<li>Remove the ‘%’ characters from header paragraphs and mark them as headers.</li>
<li>Process the text of the paragraphs themselves, splitting them into normal parts, emphasised parts, and footnotes.</li>
<li>Move all the footnotes to the bottom of the document, leaving numbers<sup><a href="#fn24" class="footnoteRef" id="fnref24">24</a></sup> in their place.</li>
<li>Wrap each piece into the correct HTML tags.</li>
<li>Combine everything into a single HTML document.</li>
</ol>
<p>This approach does not allow footnotes inside emphasised text, or vice versa. This is kind of arbitrary, but helps keep the example code simple. If, at the end of the chapter, you feel like an extra challenge, you can try to revise the program to support ‘nested’ mark-up.</p>
</section>
<section id="section-138">
<h5>○•○</h5>
<p>Step 1 of the algorithm is trivial. A blank line is what you get when you have two newlines in a row, and if you remember the <code>split</code> method that strings have, which we saw in <a href="#data-structures-objects-and-arrays">Data Structures↑</a>, you will realise that this will do the trick:</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">paragraphs <span class="kw">=</span> recluseFile<span class="kw">.</span>split <span class="st">&quot;\n\n&quot;</span><br />show <span class="st">&quot;Found </span><span class="ch">#{</span>paragraphs.length<span class="ch">}</span><span class="st"> paragraphs.&quot;</span></code></pre>
</section>
</section>
<section id="exercise-22">
<h4><em>Exercise 22</em></h4>
<p>Write a function <code>processParagraph</code> that, when given a paragraph string as its argument, checks whether this paragraph is a header. If it is, it strips of the ‘%’ characters and counts their number. Then, it returns an object with two properties, <code>content</code>, which contains the text inside the paragraph, and <code>type</code>, which contains the tag that this paragraph must be wrapped in, <code>'p'</code> for regular paragraphs, <code>'h1'</code> for headers with one ‘%’, and <code>'hX'</code> for headers with <code>X</code> ‘%’ characters.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false"><span class="co"># Compose a solution here</span></code></pre>
<section id="view-solution-27" onclick="reveal(this)" >
<h5>View Solution</h5>
<section id="section-139" style="display:none" >
<h6></h6>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">processParagraph <span class="kw">=</span> <span class="fu">(paragraph) -&gt;</span><br />  header <span class="kw">=</span> <span class="dv">0</span><br />  <span class="kw">while</span> paragraph<span class="kw">[</span><span class="dv">0</span><span class="kw">]</span> <span class="kw">is</span> <span class="st">'%'</span><br />    paragraph <span class="kw">=</span> paragraph<span class="kw">.</span>slice <span class="dv">1</span><br />    header<span class="kw">++</span><br />  type<span class="kw">:</span> <span class="kw">if</span> header <span class="kw">is</span> <span class="dv">0</span> <span class="kw">then</span> <span class="st">'p'</span> <span class="kw">else</span> <span class="st">'h'</span> <span class="kw">+</span> header<span class="kw">,</span><br />  content<span class="kw">:</span> paragraph<br /><br />show processParagraph paragraphs<span class="kw">[</span><span class="dv">0</span><span class="kw">]</span></code></pre>
</section>
</section>
</section>
<section id="section-140">
<h4></h4>
<p>This is where we can try out the <code>map</code> function we saw earlier.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">paragraphs <span class="kw">=</span> map recluseFile<span class="kw">.</span>split<span class="kw">(</span><span class="st">'\n\n'</span><span class="kw">),</span><br />                 processParagraph<br />show paragraph <span class="kw">for</span> paragraph <span class="kw">in</span> paragraphs<span class="kw">[</span><span class="dv">0</span><span class="kw">..</span><span class="dv">2</span><span class="kw">]</span></code></pre>
<p>And <em>bang</em>, we have an array of nicely categorised paragraph objects. We are getting ahead of ourselves though, we forgot step 3 of the algorithm:</p>
<blockquote>
<p><em>Process the text of the paragraphs themselves, splitting them into normal parts, emphasised parts, and footnotes.</em></p>
</blockquote>
<p>Which can be decomposed into:</p>
<ol type="1">
<li>If the paragraph starts with an asterisk, take off the emphasised part and store it.</li>
<li>If the paragraph starts with an opening brace, take off the footnote and store it.</li>
<li>Otherwise, take off the part until the first emphasised part or footnote, or until the end of the string, and store it as normal text.</li>
<li>If there is anything left in the paragraph, start at 1 again.</li>
</ol>
</section>
<section id="exercise-23">
<h4><em>Exercise 23</em></h4>
<p>Build a function <code>splitParagraph</code> which, given a paragraph string, returns an array of paragraph fragments. Think of a good way to represent the fragments, they need <code>type</code> and <code>content</code> properties.</p>
<p>The method <code>indexOf</code>, which searches for a character or sub-string in a string and returns its position, or <code>-1</code> if not found, will probably be useful in some way here.</p>
<p>This is a tricky algorithm, and there are many not-quite-correct or way-too-long ways to describe it. If you run into problems, just think about it for a minute. Try to write inner functions that perform the smaller actions that make up the algorithm.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false"><span class="co"># Compose a solution here</span></code></pre>
<section id="view-solution-28" onclick="reveal(this)" >
<h5>View Solution</h5>
<section id="section-141" style="display:none" >
<h6></h6>
<p>Here is one possible solution:</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">splitParagraph <span class="kw">=</span> <span class="fu">(text) -&gt;</span><br />  <span class="co"># Find character position or end of text</span><br />  indexOrEnd <span class="kw">=</span> <span class="fu">(character) -&gt;</span><br />    index <span class="kw">=</span> text<span class="kw">.</span>indexOf character<br />    <span class="kw">if</span> index <span class="kw">is</span> <span class="kw">-</span><span class="dv">1</span> <span class="kw">then</span> text<span class="kw">.</span>length <span class="kw">else</span> index<br /><br />  <span class="co"># Return and remove text upto next special</span><br />  <span class="co"># character or end of text</span><br />  takeNormal <span class="kw">=</span> <span class="fu">-&gt;</span><br />    end <span class="kw">=</span> reduce map<span class="kw">([</span><span class="st">'*'</span><span class="kw">,</span> <span class="st">'{'</span><span class="kw">],</span> indexOrEnd<span class="kw">),</span><br />                 <span class="ot">Math</span><span class="kw">.</span>min<span class="kw">,</span> text<span class="kw">.</span>length<br />    part <span class="kw">=</span> text<span class="kw">.</span>slice <span class="dv">0</span><span class="kw">,</span> end<br />    text <span class="kw">=</span> text<span class="kw">.</span>slice end<br />    part<br /><br />  <span class="co"># Return and remove text upto character</span><br />  takeUpTo <span class="kw">=</span> <span class="fu">(character) -&gt;</span><br />    end <span class="kw">=</span> text<span class="kw">.</span>indexOf character<span class="kw">,</span> <span class="dv">1</span><br />    <span class="kw">if</span> end <span class="kw">is</span> <span class="kw">-</span><span class="dv">1</span><br />      <span class="kw">throw</span> <span class="kw">new</span> <span class="dt">Error</span> <span class="st">'Missing closing '</span> <span class="kw">+</span><br />                      <span class="st">'&quot;'</span> <span class="kw">+</span> character <span class="kw">+</span> <span class="st">'&quot;'</span><br />    part <span class="kw">=</span> text<span class="kw">.</span>slice <span class="dv">1</span><span class="kw">,</span> end<br />    text <span class="kw">=</span> text<span class="kw">.</span>slice end <span class="kw">+</span> <span class="dv">1</span><br />    part<br /><br />  fragments <span class="kw">=</span> <span class="kw">[];</span><br /><br />  <span class="kw">while</span> text <span class="kw">isnt</span> <span class="st">''</span><br />    <span class="kw">if</span> text<span class="kw">[</span><span class="dv">0</span><span class="kw">]</span> <span class="kw">is</span> <span class="st">'*'</span><br />      fragments<span class="kw">.</span>push<br />        type<span class="kw">:</span> <span class="st">'emphasised'</span><span class="kw">,</span><br />        content<span class="kw">:</span> takeUpTo <span class="st">'*'</span><br />    <span class="kw">else</span> <span class="kw">if</span> text<span class="kw">[</span><span class="dv">0</span><span class="kw">]</span> <span class="kw">is</span> <span class="st">'{'</span><br />      fragments<span class="kw">.</span>push<br />        type<span class="kw">:</span> <span class="st">'footnote'</span><span class="kw">,</span><br />        content<span class="kw">:</span> takeUpTo <span class="st">'}'</span><br />    <span class="kw">else</span><br />      fragments<span class="kw">.</span>push<br />        type<span class="kw">:</span> <span class="st">'normal'</span><span class="kw">,</span><br />        content<span class="kw">:</span> takeNormal<span class="kw">()</span><br />  fragments</code></pre>
<p>Note the over-eager use of <code>map</code> and <code>reduce</code> in the <code>takeNormal</code> function. This is a chapter about functional programming, so program functionally we will! Can you see how this works? The <code>map</code> produces an array of positions where the given characters were found, or the end of the string if they were not found, and the <code>reduce</code> takes the minimum of them, which is the next point in the string that we have to look at.</p>
<p>If you’d write that out without mapping and reducing you’d get something like this:</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">takeNormalAlternative <span class="kw">=</span> <span class="fu">-&gt;</span><br />  nextAsterisk <span class="kw">=</span> text<span class="kw">.</span>indexOf <span class="st">'*'</span><br />  nextBrace <span class="kw">=</span> text<span class="kw">.</span>indexOf <span class="st">'{'</span><br />  end <span class="kw">=</span> text<span class="kw">.</span>length<br />  <span class="kw">if</span> nextAsterisk <span class="kw">isnt</span> <span class="kw">-</span><span class="dv">1</span><br />    end <span class="kw">=</span> nextAsterisk<br />  <span class="kw">if</span> nextBrace <span class="kw">isnt</span> <span class="kw">-</span><span class="dv">1</span> <span class="kw">and</span> nextBrace <span class="kw">&lt;</span> end<br />    end <span class="kw">=</span> nextBrace<br />  part <span class="kw">=</span> text<span class="kw">.</span>slice <span class="dv">0</span><span class="kw">,</span> end<br />  text <span class="kw">=</span> text<span class="kw">.</span>slice end<br />  part</code></pre>
<p>Which is even more hideous. Most of the time, when a decision has to be made based on a series of things, even if there are only two of them, writing it as array operations is nicer than handling every value in a separate <code>if</code> statement. (Fortunately, <a href="#regular-expressions">Regular Expressions↓</a> describes an easier way to ask for the first occurrence of ‘this or that character’ in a string.)</p>
<p>If you wrote a <code>splitParagraph</code> that stored fragments in a different way than the solution above, you might want to adjust it, because the functions in the rest of the chapter assume that fragments are objects with <code>type</code> and <code>content</code> properties.</p>
</section>
</section>
</section>
<section id="section-142">
<h4></h4>
<p>We can now wire <code>processParagraph</code> to also split the text inside the paragraphs, my version can be modified like this:</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">processParagraph <span class="kw">=</span> <span class="fu">(paragraph) -&gt;</span><br />  header <span class="kw">=</span> <span class="dv">0</span><br />  <span class="kw">while</span> paragraph<span class="kw">[</span><span class="dv">0</span><span class="kw">]</span> <span class="kw">is</span> <span class="st">'%'</span><br />    paragraph <span class="kw">=</span> paragraph<span class="kw">.</span>slice <span class="dv">1</span><br />    header<span class="kw">++</span><br />  type<span class="kw">:</span> <span class="kw">if</span> header <span class="kw">is</span> <span class="dv">0</span> <span class="kw">then</span> <span class="st">'p'</span> <span class="kw">else</span> <span class="st">'h'</span> <span class="kw">+</span> header<span class="kw">,</span><br />  content<span class="kw">:</span> splitParagraph paragraph<br /><br /><span class="co"># Adhoc test</span><br />paragraphs <span class="kw">=</span> map recluseFile<span class="kw">.</span>split<span class="kw">(</span><span class="st">'\n\n'</span><span class="kw">),</span><br />                 processParagraph<br />show paragraph <span class="kw">for</span> paragraph <span class="kw">in</span> paragraphs<span class="kw">[</span><span class="dv">0</span><span class="kw">..</span><span class="dv">2</span><span class="kw">]</span></code></pre>
<p>Mapping that over the array of paragraphs gives us an array of paragraph objects, which in turn contain arrays of fragment objects. The next thing to do is to take out the footnotes, and put references to them in their place. Something like this:</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">extractFootnotes <span class="kw">=</span> <span class="fu">(paragraphs) -&gt;</span><br />  footnotes <span class="kw">=</span> <span class="kw">[]</span><br />  currentNote <span class="kw">=</span> <span class="dv">0</span><br />  replaceFootnote <span class="kw">=</span> <span class="fu">(fragment) -&gt;</span><br />    <span class="kw">if</span> fragment<span class="kw">.</span>type <span class="kw">is</span> <span class="st">'footnote'</span><br />      <span class="kw">++</span>currentNote<br />      footnotes<span class="kw">.</span>push fragment<br />      fragment<span class="kw">.</span>number <span class="kw">=</span> currentNote<br />      type<span class="kw">:</span> <span class="st">'reference'</span><span class="kw">,</span> number<span class="kw">:</span> currentNote<br />    <span class="kw">else</span><br />      fragment<br /><br />  forEach paragraphs<span class="kw">,</span> <span class="fu">(paragraph) -&gt;</span><br />    paragraph<span class="kw">.</span>content <span class="kw">=</span> map paragraph<span class="kw">.</span>content<span class="kw">,</span><br />                            replaceFootnote<br />  footnotes<br /><br />show <span class="st">'Footnotes from the recluse:'</span><br />show extractFootnotes paragraphs<br />show paragraphs<span class="kw">[</span><span class="dv">20</span><span class="kw">]</span></code></pre>
<p>The <code>replaceFootnote</code> function is called on every fragment. When it gets a fragment that should stay where it is, it just returns it, but when it gets a footnote, it stores this footnote in the <code>footnotes</code> array, and returns a reference to it instead. In the process, every footnote and reference is also numbered.</p>
<section id="section-143">
<h5>○•○</h5>
<p>That gives us enough tools to extract the information we need from the file. All that is left now is generating the correct HTML.</p>
<p>A lot of people think that concatenating strings is a great way to produce HTML. When they need a link to, for example, a site where you can play the game of Go, they will do:</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">url <span class="kw">=</span> <span class="st">&quot;http://www.gokgs.com/&quot;</span><br />text <span class="kw">=</span> <span class="st">&quot;Play Go!&quot;</span><br />linkText <span class="kw">=</span> <span class="st">&quot;&lt;a href=\&quot;</span><span class="ch">#{</span>url<span class="ch">}</span><span class="st">\&quot;&gt;</span><span class="ch">#{</span>text<span class="ch">}</span><span class="st">&lt;/a&gt;&quot;</span><br />show _<span class="kw">.</span><span class="ot">escape</span> linkText<br /><span class="co"># Without the _.escape it becomes a link</span><br />show linkText</code></pre>
<p>(Where <code>a</code> is the tag used to create links in HTML documents.) … Not only is this clumsy, but when the string <code>text</code> happens to include an angular bracket or an ampersand, it is also wrong. Weird things will happen on your website, and you will look embarrassingly amateurish. We would not want that to happen. A few simple HTML-generating functions are easy to write. So let us write them.</p>
</section>
<section id="section-144">
<h5>○•○</h5>
<p>The secret to successful HTML generation is to treat your HTML document as a data structure instead of a flat piece of text. CoffeeScript’s objects provide a very easy way to model this:</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">linkObject <span class="kw">=</span><br />  name<span class="kw">:</span> <span class="st">'a'</span><br />  attributes<span class="kw">:</span><br />    href<span class="kw">:</span> <span class="st">'http://www.gokgs.com/'</span><br />  content<span class="kw">:</span> <span class="kw">[</span><span class="st">'Play Go!'</span><span class="kw">]</span></code></pre>
<p>Each HTML element contains a <code>name</code> property, giving the name of the tag it represents. When it has attributes, it also contains an <code>attributes</code> property, which contains an object in which the attributes are stored. When it has content, there is a <code>content</code> property, containing an array of other elements contained in this element. Strings play the role of pieces of text in our HTML document, so the array <code>['Play Go!']</code> means that this link has only one element inside it, which is a simple piece of text.</p>
<p>Typing in these objects directly is clumsy, but we do not have to do that. We provide a shortcut function to do this for us:</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">tag <span class="kw">=</span> <span class="fu">(name, content, attributes) -&gt;</span><br />  name<span class="kw">:</span> name<br />  attributes<span class="kw">:</span> attributes<br />  content<span class="kw">:</span> content</code></pre>
<p>Note that, since we allow the <code>attributes</code> and <code>content</code> of an element to be undefined if they are not applicable, the second and third argument to this function can be left off when they are not needed. <code>tag</code> is still rather primitive, so we write shortcuts for common types of elements, such as links, or the outer structure of a simple document:</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">link <span class="kw">=</span> <span class="fu">(target, text) -&gt;</span><br />  tag <span class="st">&quot;a&quot;</span><span class="kw">,</span> <span class="kw">[</span>text<span class="kw">],</span> href<span class="kw">:</span> target<br /><br />show link <span class="st">&quot;http://www.gokgs.com/&quot;</span><span class="kw">,</span> <span class="st">&quot;Play Go!&quot;</span><br /><br />htmlDoc <span class="kw">=</span> <span class="fu">(title, bodyContent) -&gt;</span><br />  tag <span class="st">&quot;html&quot;</span><span class="kw">,</span> <span class="kw">[</span>tag<span class="kw">(</span><span class="st">&quot;head&quot;</span><span class="kw">,</span> <span class="kw">[</span>tag <span class="st">&quot;title&quot;</span><span class="kw">,</span> <span class="kw">[</span>title<span class="kw">]]),</span><br />               tag <span class="st">&quot;body&quot;</span><span class="kw">,</span> bodyContent<span class="kw">]</span><br /><br />show htmlDoc <span class="st">&quot;Quote&quot;</span><span class="kw">,</span> <span class="st">&quot;In his house at R'lyeh &quot;</span> <span class="kw">+</span><br />                      <span class="st">&quot;dead Cthulu waits dreaming.&quot;</span></code></pre>
</section>
</section>
<section id="exercise-24">
<h4><em>Exercise 24</em></h4>
<p>Looking back at the example HTML document if necessary, write an <code>image</code> function which, when given the location of an image file, will create an <code>img</code> HTML element.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false"><span class="co"># Compose a solution here</span></code></pre>
<section id="view-solution-29" onclick="reveal(this)" >
<h5>View Solution</h5>
<section id="section-145" style="display:none" >
<h6></h6>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">image <span class="kw">=</span> <span class="fu">(src) -&gt;</span><br />  tag <span class="st">'img'</span><span class="kw">,</span> <span class="kw">[],</span> src<span class="kw">:</span> src<br /><br />show image linkOstrich</code></pre>
</section>
</section>
</section>
<section id="section-146">
<h4></h4>
<p>When we have created a document, it will have to be reduced to a string. But building this string from the data structures we have been producing is very straightforward. The important thing is to remember to transform the special characters in the text of our document…</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">escapeHTML <span class="kw">=</span> <span class="fu">(text) -&gt;</span><br />  replacements <span class="kw">=</span> <span class="kw">[[</span><span class="st">/&amp;/g</span><span class="kw">,</span> <span class="st">'&amp;amp;'</span><span class="kw">]</span><br />                  <span class="kw">[</span><span class="st">/&quot;/g</span><span class="kw">,</span> <span class="st">'&amp;quot;'</span><span class="kw">]</span><br />                  <span class="kw">[</span><span class="st">/&lt;/g</span><span class="kw">,</span> <span class="st">'&amp;lt;'</span><span class="kw">]</span><br />                  <span class="kw">[</span><span class="st">/&gt;/g</span><span class="kw">,</span> <span class="st">'&amp;gt;'</span><span class="kw">]]</span><br />  forEach replacements<span class="kw">,</span> <span class="fu">(replace) -&gt;</span><br />    text <span class="kw">=</span> text<span class="kw">?.</span>replace replace<span class="kw">[</span><span class="dv">0</span><span class="kw">],</span> replace<span class="kw">[</span><span class="dv">1</span><span class="kw">]</span><br />  text<br /><br />show escapeHTML <span class="st">'&lt; &quot; &amp; &quot; &gt;'</span></code></pre>
<p>The <code>replace</code> method of strings creates a new string in which all occurrences of the pattern in the first argument are replaced by the second argument, so <code>'Borobudur'.replace(/r/g, 'k')</code> gives <code>'Bokobuduk'</code>. Do not worry about the pattern syntax here — we will get to that in <a href="#regular-expressions">Regular Expressions↓</a>. The <code>escapeHTML</code> function puts the different replacements that have to be made into an array, so that it can loop over them and apply them to the argument one by one.</p>
<p>Double quotes are also replaced, because we will also be using this function for the text inside the attributes of HTML tags. Those will be surrounded by double quotes, and thus must not have any double quotes inside of them.</p>
<p>Calling replace four times means the computer has to go over the whole string four times to check and replace its content. This is not very efficient. If we cared enough, we could write a more complex version of this function, something that resembles the <code>splitParagraph</code> function we saw earlier, to go over it only once. For now, we are too lazy for this. Again, <a href="#regular-expressions">Regular Expressions↓</a> shows a much better way to do this.</p>
<section id="section-147">
<h5>○•○</h5>
<p>To turn an HTML element object into a string, we can use a recursive function like this:</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">renderHTML <span class="kw">=</span> <span class="fu">(element) -&gt;</span><br />  pieces <span class="kw">=</span> <span class="kw">[]</span><br /><br />  renderAttributes <span class="kw">=</span> <span class="fu">(attributes) -&gt;</span><br />    result <span class="kw">=</span> <span class="kw">[]</span><br />    <span class="kw">if</span> attributes<br />      <span class="kw">for</span> name <span class="kw">of</span> attributes <br />        result<span class="kw">.</span>push <span class="st">' '</span> <span class="kw">+</span> name <span class="kw">+</span> <span class="st">'=&quot;'</span> <span class="kw">+</span><br />          escapeHTML<span class="kw">(</span>attributes<span class="kw">[</span>name<span class="kw">])</span> <span class="kw">+</span> <span class="st">'&quot;'</span><br />    result<span class="kw">.</span>join <span class="st">''</span><br /><br />  render <span class="kw">=</span> <span class="fu">(element) -&gt;</span><br />    <span class="co"># Text node</span><br />    <span class="kw">if</span> <span class="kw">typeof</span> element <span class="kw">is</span> <span class="st">'string'</span><br />      pieces<span class="kw">.</span>push escapeHTML element<br />    <span class="co"># Empty tag</span><br />    <span class="kw">else</span> <span class="kw">if</span> <span class="kw">not</span> element<span class="kw">.</span>content <span class="kw">or</span><br />                element<span class="kw">.</span>content<span class="kw">.</span>length <span class="kw">is</span> <span class="dv">0</span><br />      pieces<span class="kw">.</span>push <span class="st">'&lt;'</span> <span class="kw">+</span> element<span class="kw">.</span>name <span class="kw">+</span><br />        renderAttributes<span class="kw">(</span>element<span class="kw">.</span>attributes<span class="kw">)</span> <span class="kw">+</span> <span class="st">'/&gt;'</span><br />    <span class="co"># Tag with content</span><br />    <span class="kw">else</span><br />      pieces<span class="kw">.</span>push <span class="st">'&lt;'</span> <span class="kw">+</span> element<span class="kw">.</span>name <span class="kw">+</span><br />        renderAttributes<span class="kw">(</span>element<span class="kw">.</span>attributes<span class="kw">)</span> <span class="kw">+</span> <span class="st">'&gt;'</span><br />      forEach element<span class="kw">.</span>content<span class="kw">,</span> render<br />      pieces<span class="kw">.</span>push <span class="st">'&lt;/'</span> <span class="kw">+</span> element<span class="kw">.</span>name <span class="kw">+</span> <span class="st">'&gt;'</span><br /><br />  render element<br />  pieces<span class="kw">.</span>join <span class="st">''</span></code></pre>
<p>Note the <code>of</code> loop that extracts the properties from a CoffeeScript object in order to make HTML tag attributes out of them. Also note that in two places, arrays are being used to accumulate strings, which are then joined into a single result string. Why did I not just start with an empty string and then add the content to it with the <code>+=</code> operator?</p>
<p>It turns out that creating new strings, especially big strings, is quite a lot of work. Remember that CoffeeScript string values never change. If you concatenate something to them, a new string is created, the old ones stay intact. If we build up a big string by concatenating lots of little strings, new strings have to be created at every step, only to be thrown away when the next piece is concatenated to them. If, on the other hand, we store all the little strings in an array and then join them, only <em>one</em> big string has to be created.</p>
</section>
<section id="section-148">
<h5>○•○</h5>
<p>So, let us try out this HTML generating system…</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">show renderHTML link <span class="st">'http://www.nedroid.com'</span><span class="kw">,</span> <span class="st">'Drawings!'</span></code></pre>
<p>That seems to work.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">body <span class="kw">=</span> <span class="kw">[</span>tag<span class="kw">(</span><span class="st">'h1'</span><span class="kw">,</span> <span class="kw">[</span><span class="st">'The Test'</span><span class="kw">]),</span><br />        tag<span class="kw">(</span><span class="st">'p'</span><span class="kw">,</span> <span class="kw">[</span><span class="st">'Here is a paragraph '</span> <span class="kw">+</span><br />                  <span class="st">'and an image...'</span><span class="kw">]),</span><br />        image<span class="kw">(</span>ostrich<span class="kw">)]</span><br />doc <span class="kw">=</span> htmlDoc <span class="st">'The Test'</span><span class="kw">,</span> body<br />show renderHTML doc</code></pre>
<p>Now, I should probably warn you that this approach is not perfect. What it actually renders is XML<a href="#index-XML"></a>, which is similar to HTML, but more structured. In simple cases, such as the above, this does not cause any problems. However, there are some things, which are correct XML, but not proper HTML, and these might confuse a browser that is trying to show the documents we create. For example, if you have an empty <code>script</code> tag (used to put JavaScript into a page) in your document, browsers will not realise that it is empty and think that everything after it is JavaScript. (In this case, the problem can be fixed by putting a single space inside of the tag, so that it is no longer empty, and gets a proper closing tag.)</p>
</section>
</section>
<section id="exercise-25">
<h4><em>Exercise 25</em></h4>
<p>Write a function <code>renderFragment</code>, and use that to implement another function <code>renderParagraph</code>, which takes a paragraph object (with the footnotes already filtered out), and produces the correct HTML element (which might be a paragraph or a header, depending on the <code>type</code> property of the paragraph object).</p>
<p>This function might come in useful for rendering the footnote references:</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">footnote <span class="kw">=</span> <span class="fu">(number) -&gt;</span><br />  tag <span class="st">'sup'</span><span class="kw">,</span><br />    <span class="kw">[</span>link <span class="st">'#footnote'</span> <span class="kw">+</span> number<span class="kw">,</span> <span class="ot">String</span> number<span class="kw">]</span><br /><br />show footnote<span class="kw">(</span><span class="dv">42</span><span class="kw">),</span> <span class="dv">3</span></code></pre>
<p>A <code>sup</code> tag will show its content as ‘superscript’, which means it will be smaller and a little higher than other text. The target of the link will be something like <code>'#footnote1'</code>. Links that contain a ‘#’ character refer to ‘anchors’ within a page, and in this case we will use them to make it so that clicking on the footnote link will take the reader to the bottom of the page, where the footnotes live.</p>
<p>The tag to render emphasised fragments with is <code>em</code>, and normal text can be rendered without any extra tags.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false"><span class="co"># Compose a solution here</span></code></pre>
<section id="view-solution-30" onclick="reveal(this)" >
<h5>View Solution</h5>
<section id="section-149" style="display:none" >
<h6></h6>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">renderFragment <span class="kw">=</span> <span class="fu">(fragment) -&gt;</span><br />  <span class="kw">if</span> fragment<span class="kw">.</span>type <span class="kw">is</span> <span class="st">'reference'</span><br />    footnote fragment<span class="kw">.</span>number<br />  <span class="kw">else</span> <span class="kw">if</span> fragment<span class="kw">.</span>type <span class="kw">is</span> <span class="st">'emphasised'</span><br />    tag <span class="st">'em'</span><span class="kw">,</span> <span class="kw">[</span>fragment<span class="kw">.</span>content<span class="kw">]</span><br />  <span class="kw">else</span> <span class="kw">if</span> fragment<span class="kw">.</span>type <span class="kw">is</span> <span class="st">'normal'</span><br />    fragment<span class="kw">.</span>content<br /><br />renderParagraph <span class="kw">=</span> <span class="fu">(paragraph) -&gt;</span><br />  tag paragraph<span class="kw">.</span>type<span class="kw">,</span><br />    map paragraph<span class="kw">.</span>content<span class="kw">,</span> renderFragment<br /><br />show renderParagraph paragraphs<span class="kw">[</span><span class="dv">7</span><span class="kw">]</span></code></pre>
</section>
</section>
</section>
<section id="section-150">
<h4></h4>
<p>We are almost finished. The only thing that we do not have a rendering function for yet are the footnotes. To make the <code>'#footnote1'</code> links work, an anchor must be included with every footnote. In HTML, an anchor is specified with an <code>a</code> element, which is also used for links. In this case, it needs a <code>name</code> attribute, instead of an <code>href</code>.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">renderFootnote <span class="kw">=</span> <span class="fu">(footnote) -&gt;</span><br />  anchor <span class="kw">=</span> tag <span class="st">&quot;a&quot;</span><span class="kw">,</span> <span class="kw">[],</span><br />    name<span class="kw">:</span> <span class="st">&quot;footnote&quot;</span> <span class="kw">+</span> footnote<span class="kw">.</span>number<br />  number <span class="kw">=</span> <span class="st">&quot;[</span><span class="ch">#{</span>footnote.number<span class="ch">}</span><span class="st">] &quot;</span><br />  tag <span class="st">&quot;p&quot;</span><span class="kw">,</span> <span class="kw">[</span>tag<span class="kw">(</span><span class="st">&quot;small&quot;</span><span class="kw">,</span><br />    <span class="kw">[</span>anchor<span class="kw">,</span> number<span class="kw">,</span> footnote<span class="kw">.</span>content<span class="kw">])]</span></code></pre>
<p>Here, then, is the function which, when given a file in the correct format and a document title, returns an HTML document:</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">renderFile <span class="kw">=</span> <span class="fu">(file, title) -&gt;</span><br />  paragraphs <span class="kw">=</span> map file<span class="kw">.</span>split<span class="kw">(</span><span class="st">'\n\n'</span><span class="kw">),</span><br />                   processParagraph<br />  footnotes <span class="kw">=</span> map extractFootnotes<span class="kw">(</span>paragraphs<span class="kw">),</span><br />                  renderFootnote<br />  body <span class="kw">=</span> map paragraphs<span class="kw">,</span><br />             renderParagraph<br />  body <span class="kw">=</span> body<span class="kw">.</span>concat footnotes<br />  renderHTML htmlDoc title<span class="kw">,</span> body<br /><br />runOnDemand <span class="fu">-&gt;</span><br />  page <span class="kw">=</span> renderFile recluseFile<span class="kw">,</span> <span class="st">'The Book of Programming'</span><br />  showDocument page<span class="kw">,</span> <span class="dv">565</span><span class="kw">,</span> <span class="dv">500</span></code></pre>
<p>The <code>concat</code><a href="#index-concat"></a> method of an array can be used to concatenate another array to it, similar to what the <code>+</code> operator does with strings.</p>
<section id="section-151">
<h5>○•○</h5>
<p>In the chapters after this one, elementary higher-order functions like <code>map</code> and <code>reduce</code> will always be available from the Underscore library and will be used by code examples. Now and then, a new useful tool is explained and added to this. In <a href="#modularity">Modularity↓</a>, we develop a more structured approach to this set of ‘basic’ functions.</p>
</section>
<section id="section-152">
<h5>○•○</h5>
<p>In some functional programming languages operators are functions, for example in Pure you can write <code>foldl (+) 0 (1..10);</code> the same in CoffeeScript is <code>reduce [1..10], ((a, b) -&gt; a + b), 0</code>. A way to shorten this is by defining an object that is indexed by an operator in a string:</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">op <span class="kw">=</span> <span class="kw">{</span><br />       <span class="st">'+'</span><span class="kw">:</span>   <span class="fu">(a, b) -&gt;</span> a <span class="kw">+</span> b<br />       <span class="st">'=='</span><span class="kw">:</span>  <span class="fu">(a, b) -&gt;</span> a <span class="kw">==</span> b<br />       <span class="st">'!'</span><span class="kw">:</span>   <span class="fu">(a)    -&gt;</span> <span class="kw">!</span>a<br />       <span class="co"># and so on</span><br />     <span class="kw">}</span><br />show reduce <span class="kw">[</span><span class="dv">1</span><span class="kw">..</span><span class="dv">10</span><span class="kw">],</span> op<span class="kw">[</span><span class="st">'+'</span><span class="kw">],</span> <span class="dv">0</span></code></pre>
<p>The list of operators is quite long, so it is questionable whether such a data structure improves readability compared to:</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">add <span class="kw">=</span> <span class="fu">(a, b) -&gt;</span> a <span class="kw">+</span> b<br />show reduce <span class="kw">[</span><span class="dv">1</span><span class="kw">..</span><span class="dv">10</span><span class="kw">],</span> add<span class="kw">,</span> <span class="dv">0</span></code></pre>
<p>And what if we need something like <code>equals</code> or <code>makeAddFunction</code>, in which one of the arguments already has a value? In that case we are back to writing a new function again.</p>
<p>For cases like that, something called ‘partial application’<a href="#index-partial-application"></a> is useful. You want to create a new function that already knows some of its arguments, and treats any additional arguments it is passed as coming after these fixed arguments. A simple version<sup><a href="#fn25" class="footnoteRef" id="fnref25">25</a></sup> of this could be:</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">partial <span class="kw">=</span> <span class="fu">(func, a...) -&gt;</span><br />  <span class="fu">(b...) -&gt;</span> func a<span class="kw">...,</span> b<span class="kw">...</span><br /><br />f <span class="kw">=</span> <span class="fu">(a,b,c,d) -&gt;</span> show <span class="st">&quot;</span><span class="ch">#{</span>a<span class="ch">}</span><span class="st"> </span><span class="ch">#{</span>b<span class="ch">}</span><span class="st"> </span><span class="ch">#{</span>c<span class="ch">}</span><span class="st"> </span><span class="ch">#{</span>d<span class="ch">}</span><span class="st">&quot;</span><br />g <span class="kw">=</span> partial f<span class="kw">,</span> <span class="dv">1</span><span class="kw">,</span> <span class="dv">2</span><br />g <span class="dv">3</span><span class="kw">,</span> <span class="dv">4</span></code></pre>
<p>The return value of <code>partial</code> is a function where the <code>a...</code> arguments have been applied. When the returned function is called the <code>b...</code> arguments are appended to the arguments of <code>func</code>.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">equals10 <span class="kw">=</span> partial op<span class="kw">[</span><span class="st">'=='</span><span class="kw">],</span> <span class="dv">10</span><br />show map <span class="kw">[</span><span class="dv">1</span><span class="kw">,</span> <span class="dv">10</span><span class="kw">,</span> <span class="dv">100</span><span class="kw">],</span> equals10</code></pre>
<p>Unlike traditional functional definitions, Underscore defines the order of its arguments as array before action. That means we can not simply say:</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">square <span class="kw">=</span> <span class="fu">(x) -&gt;</span> x <span class="kw">*</span> x<br /><span class="kw">try</span><br />  show map <span class="kw">[[</span><span class="dv">10</span><span class="kw">,</span> <span class="dv">100</span><span class="kw">],</span> <span class="kw">[</span><span class="dv">12</span><span class="kw">,</span> <span class="dv">16</span><span class="kw">],</span> <span class="kw">[</span><span class="dv">0</span><span class="kw">,</span> <span class="dv">1</span><span class="kw">]],</span><br />           partial map<span class="kw">,</span> square <span class="co"># Incorrect</span><br /><span class="kw">catch</span> error<br />  show <span class="st">&quot;Error: </span><span class="ch">#{</span>error.message<span class="ch">}</span><span class="st">&quot;</span></code></pre>
<p>Since the square function needs to be the second argument of the inner map. But we can define another partial function that reverses its arguments:</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">partialReverse <span class="kw">=</span> <span class="fu">(func, a) -&gt;</span> <span class="fu">(b) -&gt;</span> func b<span class="kw">,</span> a<br /><br />mapSquared <span class="kw">=</span> partialReverse map<span class="kw">,</span> square<br />show map <span class="kw">[[</span><span class="dv">10</span><span class="kw">,</span> <span class="dv">100</span><span class="kw">],</span> <span class="kw">[</span><span class="dv">12</span><span class="kw">,</span> <span class="dv">16</span><span class="kw">],</span> <span class="kw">[</span><span class="dv">0</span><span class="kw">,</span> <span class="dv">1</span><span class="kw">]],</span> mapSquared</code></pre>
<p>However it is again worthwhile to consider whether the intent of the program is clearer when the functions are defined directly:</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">show map <span class="kw">[[</span><span class="dv">10</span><span class="kw">,</span> <span class="dv">100</span><span class="kw">],</span> <span class="kw">[</span><span class="dv">12</span><span class="kw">,</span> <span class="dv">16</span><span class="kw">],</span> <span class="kw">[</span><span class="dv">0</span><span class="kw">,</span> <span class="dv">1</span><span class="kw">]],</span><br />  <span class="fu">(sublist) -&gt;</span> map sublist<span class="kw">,</span> <span class="fu">(x) -&gt;</span> x <span class="kw">*</span> x</code></pre>
</section>
<section id="section-153">
<h5>○•○</h5>
<p>A trick that can be useful when you want to combine functions is function composition<a href="#index-function-composition"></a>. At the start of this chapter I showed a function <code>negate</code>, which applies the boolean <em>not</em> operator to the result of calling a function:</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">negate <span class="kw">=</span> <span class="fu">(func) -&gt;</span><br />  <span class="fu">(args...) -&gt;</span> <span class="kw">not</span> func args<span class="kw">...</span></code></pre>
<p>This is a special case of a general pattern: call function A, and then apply function B to the result. Composition is a common concept in mathematics. <a href="#index-compose"></a>It can be caught in a higher-order function like this:</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">compose <span class="kw">=</span> <span class="fu">(func1, func2) -&gt;</span><br />  <span class="fu">(args...) -&gt;</span> func1 func2 args<span class="kw">...</span><br /><br />isUndefined <span class="kw">=</span> <span class="fu">(value) -&gt;</span> value <span class="kw">is</span> <span class="ot">undefined</span><br />isDefined <span class="kw">=</span> compose <span class="kw">(</span><span class="fu">(v) -&gt;</span> <span class="kw">not</span> v<span class="kw">),</span> isUndefined<br />show <span class="st">'isDefined Math.PI  = '</span> <span class="kw">+</span> isDefined <span class="ot">Math</span><span class="kw">.</span>PI<br />show <span class="st">'isDefined Math.PIE = '</span> <span class="kw">+</span> isDefined <span class="ot">Math</span><span class="kw">.</span>PIE</code></pre>
<p>In <code>isDefined</code> we are defining a new function without naming it. This can be useful when you need to create a simple function to give to, for example, <code>map</code> or <code>reduce</code>. However, when a function becomes more complex than this example, it is usually shorter and clearer to define it by itself and name it.</p>
<hr />
</section>
</section>
</section>
<section id="searching">
<h3>Searching</h3>
<hr />
<p>This chapter introduces new functional programming concepts and their use in problem solving. We will go through the solution of two problems, discussing some interesting algorithms and techniques along the way.</p>
<p>The Underscore library is used to make it pleasant to work with the functional abstractions. Its functions are not directly available, they need to be written with a <code>_.</code> in front of them. See the <a href="http://autotelicum.github.com/Smooth-CoffeeScript/literate/underscore.html">interactive Underscore reference</a> for details and examples on all the functions.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false"><span class="co"># List functions in Underscore</span><br />runOnDemand <span class="fu">-&gt;</span> show _<span class="kw">.</span>functions _</code></pre>
<p>The functions in Underscore could be made available as global functions, then they would be more convenient to use. This was done in the static editions of this book and works fine in isolated environments. However as is explained in <a href="#modularity">Modularity↓</a> many global functions can lead to interference between them. So in this edition Underscore has to be qualified in the same way as when you use it to build reusable libraries or when you work in a shared project.</p>
<section id="section-154">
<h5>○•○</h5>
<p>Let me introduce our first problem. Take a look at this map. It shows Hiva Oa, a small tropical island in the Pacific Ocean.</p>
<p align=center><img src="../img/Hiva%20Oa-small.png" alt="figure ../img/Hiva Oa-small.png" /><br /></p>
<p>The black lines are roads, and the numbers next to them are the lengths of these roads. Imagine we need a program that finds the shortest route between two points on Hiva Oa. How could we approach that? Think about this for a moment.</p>
<p>No really. Do not just steamroll on to the next paragraph. Try to seriously think of some ways you could do this, and consider the issues you would come up against. When reading a technical book, it is way too easy to just zoom over the text, nod solemnly, and promptly forget what you have read. If you make a sincere effort to solve a problem, it becomes <em>your</em> problem, and its solution will be more meaningful.</p>
</section>
<section id="section-155">
<h5>○•○</h5>
<p>The first aspect of this problem is, again, representing our data. The information in the picture does not mean much to our computer. We could try writing a program that looks at the map and extracts the information in it… but that can get complicated. If we had twenty-thousand maps to interpret, this would be a good idea, in this case we will do the interpretation ourself and transcribe the map into a more computer-friendly format.</p>
<p>What does our program need to know? It has to be able to look up which locations are connected, and how long the roads between them are. The places and roads on the island form a graph<a href="#index-graph"></a>, as mathematicians call it. There are many ways to store graphs. A simple possibility is to just store an array of road objects, each of which contains properties naming its two endpoints and its length…</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">show roads <span class="kw">=</span> <span class="kw">[</span><br />  <span class="kw">{</span> point1<span class="kw">:</span> <span class="st">'Point Kiukiu'</span><span class="kw">,</span> point2<span class="kw">:</span> <span class="st">'Hanaiapa'</span><span class="kw">,</span> length<span class="kw">:</span> <span class="dv">19</span> <span class="kw">}</span><br />  <span class="kw">{</span> point1<span class="kw">:</span> <span class="st">'Point Kiukiu'</span><span class="kw">,</span> point2<span class="kw">:</span> <span class="st">'Mt Feani'</span><span class="kw">,</span> length<span class="kw">:</span> <span class="dv">15</span> <span class="kw">}</span><br /><span class="kw">]</span> <span class="co"># and so on</span></code></pre>
<p>However, it turns out that the program, as it is working out a route, will very often need to get a list of all the roads that start at a certain location, like a person standing on a crossroads will look at a signpost and read “Hanaiapa: 19km, Mount Feani: 15km”. It would be nice if this was easy (and quick) to do.</p>
<p>With the representation given above, we have to sift through the whole list of roads, picking out the relevant ones, every time we want this signpost list. A better approach would be to store this list directly. For example, use an object that associates place-names with signpost lists:</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">show roads <span class="kw">=</span><br />  <span class="st">'Point Kiukiu'</span><span class="kw">:</span> <span class="kw">[</span> <span class="kw">{</span>to<span class="kw">:</span> <span class="st">'Hanaiapa'</span><span class="kw">,</span> distance<span class="kw">:</span> <span class="dv">19</span><span class="kw">}</span><br />                    <span class="kw">{</span>to<span class="kw">:</span> <span class="st">'Mt Feani'</span><span class="kw">,</span> distance<span class="kw">:</span> <span class="dv">15</span><span class="kw">}</span><br />                    <span class="kw">{</span>to<span class="kw">:</span> <span class="st">'Taaoa'</span><span class="kw">,</span> distance<span class="kw">:</span> <span class="dv">15</span><span class="kw">}</span> <span class="kw">]</span><br />  <span class="st">'Taaoa'</span><span class="kw">:</span>        <span class="kw">[</span> <span class="kw">]</span> <span class="co"># et cetera</span></code></pre>
<p>When we have this object, getting the roads that leave from Point Kiukiu is just a matter of looking at <code>roads['Point Kiukiu']</code>.</p>
</section>
<section id="section-156">
<h5>○•○</h5>
<p>However, this new representation does contain duplicate information: The road between A and B is listed both under A and under B. The first representation was already a lot of work to type in, this one is even worse.</p>
<p>Fortunately, we have at our command the computer’s talent for repetitive work. We can specify the roads once, and have the correct data structure be generated by the computer. First, initialise an empty object called <code>roads</code>, and write a function <code>makeRoad</code>:</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false"><span class="dt">@roads</span> <span class="kw">=</span> <span class="kw">{}</span><br />makeRoad <span class="kw">=</span> <span class="fu">(from, to, length) -&gt;</span><br />  addRoad <span class="kw">=</span> <span class="fu">(from, to) -&gt;</span><br />    roads<span class="kw">[</span>from<span class="kw">]</span> <span class="kw">=</span> <span class="kw">[]</span> <span class="kw">if</span> <span class="kw">not</span> <span class="kw">(</span>from <span class="kw">of</span> roads<span class="kw">)</span><br />    roads<span class="kw">[</span>from<span class="kw">].</span>push to<span class="kw">:</span> to<span class="kw">,</span> distance<span class="kw">:</span> length<br />  addRoad from<span class="kw">,</span> to<br />  addRoad to<span class="kw">,</span> from</code></pre>
<p>Nice, huh? Notice how the inner function, <code>addRoad</code>, uses the same names (<code>from</code>, <code>to</code>) for its parameters as the outer function. These will not interfere: inside <code>addRoad</code> they refer to <code>addRoad</code>’s parameters, and outside it they refer to <code>makeRoad</code>’s parameters.</p>
<p>The <code>if</code> statement in <code>addRoad</code> makes sure that there is an array of destinations associated with the location named by <code>from</code>, if there is not one it puts in an empty array. This way, the next line can assume there is such an array and safely push the new road onto it.</p>
<p>Now the map information looks like this:</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">makeRoad <span class="st">'Point Kiukiu'</span><span class="kw">,</span> <span class="st">'Hanaiapa'</span><span class="kw">,</span> <span class="dv">19</span><br />makeRoad <span class="st">'Point Kiukiu'</span><span class="kw">,</span> <span class="st">'Mt Feani'</span><span class="kw">,</span> <span class="dv">15</span><br />makeRoad <span class="st">'Point Kiukiu'</span><span class="kw">,</span> <span class="st">'Taaoa'</span><span class="kw">,</span> <span class="dv">15</span><br />show roads</code></pre>
</section>
<section id="exercise-26">
<h4><em>Exercise 26</em></h4>
<p>In the above description, the string <code>'Point Kiukiu'</code> still occurs three times in a row. We could make our description even more succinct by allowing multiple roads to be specified in one line.</p>
<p>Write a function <code>makeRoads</code> that takes any uneven number of arguments. The first argument is always the starting point of the roads, and every pair of arguments after that gives an ending point and a distance.</p>
<p>Do not duplicate the functionality of <code>makeRoad</code>, but have <code>makeRoads</code> call <code>makeRoad</code> to do the actual road-making.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false"><span class="co"># Compose a solution here</span></code></pre>
<section id="view-solution-31" onclick="reveal(this)" >
<h5>View Solution</h5>
<section id="section-157" style="display:none" >
<h6></h6>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">makeRoads <span class="kw">=</span> <span class="fu">(start) -&gt;</span><br />  <span class="kw">for</span> i <span class="kw">in</span> <span class="kw">[</span><span class="dv">1</span><span class="kw">...</span>arguments<span class="kw">.</span>length<span class="kw">]</span> <span class="kw">by</span> <span class="dv">2</span><br />    makeRoad start<span class="kw">,</span> arguments<span class="kw">[</span>i<span class="kw">],</span> arguments<span class="kw">[</span>i <span class="kw">+</span> <span class="dv">1</span><span class="kw">]</span></code></pre>
<p>This function uses one named parameter, <code>start</code>, and gets the other parameters from the <code>arguments</code> (quasi-) array. <code>i</code> starts at <code>1</code> because it has to skip this first parameter. <code>by 2</code> skips the distances.</p>
</section>
</section>
</section>
<section id="section-158">
<h4></h4>
<p>You can verify the solution with this code that builds a data structure matching the map of Hiva Oa.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false"><span class="dt">@roads</span> <span class="kw">=</span> <span class="kw">{}</span><br />makeRoads <span class="st">'Point Kiukiu'</span><span class="kw">,</span><br />  <span class="st">'Hanaiapa'</span><span class="kw">,</span> <span class="dv">19</span><span class="kw">,</span> <span class="st">'Mt Feani'</span><span class="kw">,</span> <span class="dv">15</span><span class="kw">,</span> <span class="st">'Taaoa'</span><span class="kw">,</span> <span class="dv">15</span><br />makeRoads <span class="st">'Airport'</span><span class="kw">,</span><br />  <span class="st">'Hanaiapa'</span><span class="kw">,</span> <span class="dv">6</span><span class="kw">,</span> <span class="st">'Mt Feani'</span><span class="kw">,</span> <span class="dv">5</span><span class="kw">,</span><br />  <span class="st">'Atuona'</span><span class="kw">,</span> <span class="dv">4</span><span class="kw">,</span> <span class="st">'Mt Ootua'</span><span class="kw">,</span> <span class="dv">11</span><br />makeRoads <span class="st">'Mt Temetiu'</span><span class="kw">,</span><br />  <span class="st">'Mt Feani'</span><span class="kw">,</span> <span class="dv">8</span><span class="kw">,</span> <span class="st">'Taaoa'</span><span class="kw">,</span> <span class="dv">4</span><br />makeRoads <span class="st">'Atuona'</span><span class="kw">,</span><br />  <span class="st">'Taaoa'</span><span class="kw">,</span> <span class="dv">3</span><span class="kw">,</span> <span class="st">'Hanakee pearl lodge'</span><span class="kw">,</span> <span class="dv">1</span><br />makeRoads <span class="st">'Cemetery'</span><span class="kw">,</span><br />  <span class="st">'Hanakee pearl lodge'</span><span class="kw">,</span> <span class="dv">6</span><span class="kw">,</span> <span class="st">'Mt Ootua'</span><span class="kw">,</span> <span class="dv">5</span><br />makeRoads <span class="st">'Hanapaoa'</span><span class="kw">,</span><br />  <span class="st">'Mt Ootua'</span><span class="kw">,</span> <span class="dv">3</span><br />makeRoads <span class="st">'Puamua'</span><span class="kw">,</span><br />  <span class="st">'Mt Ootua'</span><span class="kw">,</span> <span class="dv">13</span><span class="kw">,</span> <span class="st">'Point Teohotepapapa'</span><span class="kw">,</span> <span class="dv">14</span><br />show <span class="st">'Roads from the Airport:'</span><br />show roads<span class="kw">[</span><span class="st">'Airport'</span><span class="kw">]</span></code></pre>
<p>We managed to considerably shorten our description of the road information by defining some convenient operations. You could say we expressed the information more succinctly by expanding our vocabulary. <a href="#index-domain-specific-language"></a>Defining a ‘little language’ like this is often a very powerful technique — when, at any time, you find yourself writing repetitive or redundant code, stop and try to come up with a vocabulary that makes it shorter and denser.</p>
<p>Redundant code is not only a bore to write, it is also error-prone, people pay less attention when doing something that does not require them to think. On top of that, repetitive code is hard to change, because structure that is repeated a hundred times has to be changed a hundred times when it turns out to be incorrect or suboptimal.</p>
<section id="section-159">
<h5>○•○</h5>
<p>If you ran all the pieces of code above, you should now have a variable named <code>roads</code> that contains all the roads on the island. When we need the roads starting from a certain place, we could just do <code>roads[place]</code>. But then, when someone makes a typo in a place name, which is not unlikely with these names, he will get <code>undefined</code> instead of the array he expects, and strange errors will follow. Instead, we will use a function that retrieves the road arrays, and yells at us when we give it an unknown place name:</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">roadsFrom <span class="kw">=</span> <span class="fu">(place) -&gt;</span><br />  found <span class="kw">=</span> roads<span class="kw">[</span>place<span class="kw">]</span><br />  <span class="kw">return</span> found <span class="kw">if</span> found<span class="kw">?</span><br />  <span class="kw">throw</span> <span class="kw">new</span> <span class="dt">Error</span> <span class="st">&quot;No place named '</span><span class="ch">#{</span>place<span class="ch">}</span><span class="st">' found.&quot;</span><br /><br /><span class="kw">try</span><br />  show roadsFrom <span class="st">&quot;Hanaiapa&quot;</span><br />  show roadsFrom <span class="st">&quot;Hanalapa&quot;</span><br /><span class="kw">catch</span> error<br />  show <span class="st">&quot;Oops </span><span class="ch">#{</span>error<span class="ch">}</span><span class="st">&quot;</span></code></pre>
</section>
<section id="section-160">
<h5>○•○</h5>
<p>Here is a first stab at a path-finding algorithm, the gambler’s method:</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">gamblerPath <span class="kw">=</span> <span class="fu">(from, to) -&gt;</span><br /><br />  randomInteger <span class="kw">=</span> <span class="fu">(below) -&gt;</span><br />    <span class="ot">Math</span><span class="kw">.</span>floor <span class="ot">Math</span><span class="kw">.</span>random<span class="kw">()</span> <span class="kw">*</span> below<br /><br />  randomDirection <span class="kw">=</span> <span class="fu">(from) -&gt;</span><br />    options <span class="kw">=</span> roadsFrom from<br />    options<span class="kw">[</span>randomInteger<span class="kw">(</span>options<span class="kw">.</span>length<span class="kw">)].</span>to<br /><br />  path <span class="kw">=</span> <span class="kw">[]</span><br />  <span class="kw">loop</span><br />    path<span class="kw">.</span>push from<br />    <span class="kw">break</span> <span class="kw">if</span> from <span class="kw">is</span> to<br />    from <span class="kw">=</span> randomDirection from<br />  path<br /><br />show gamblerPath <span class="st">'Hanaiapa'</span><span class="kw">,</span> <span class="st">'Mt Feani'</span></code></pre>
<p>At every split in the road, the gambler rolls his dice to decide which road he shall take. If the dice sends him back the way he came, so be it. Sooner or later, he will arrive at his destination, since all places on the island are connected by roads.</p>
<p>The most confusing line is probably the one containing <code>Math.random</code><a href="#index-Math.random"></a>. This function returns a pseudo-random<sup><a href="#fn26" class="footnoteRef" id="fnref26">26</a></sup> number between 0 and 1. Try calling it a few times from the console, it will (most likely) give you a different number every time. The function <code>randomInteger</code> multiplies this number by the argument it is given, and rounds the result down with <code>Math.floor</code>. Thus, for example, <code>randomInteger 3</code> will produce the number <code>0</code>, <code>1</code>, or <code>2</code>.</p>
</section>
<section id="section-161">
<h5>○•○</h5>
<p>The gambler’s method is the way to go for those who abhor structure and planning, who desperately search for adventure. We set out to write a program that could find the <em>shortest</em> route between places though, so something else will be needed.</p>
<p>A very straightforward approach to solving such a problem is called ‘generate and test’<a href="#index-generate-and-test"></a>. It goes like this:</p>
<ol type="1">
<li>Generate all possible routes.</li>
<li>In this set, find the shortest one that actually connects the start point to the end point.</li>
</ol>
<p>Step two is not hard. Step one is a little problematic. If you allow routes with circles in them, there is an infinite amount of routes. Of course, routes with circles in them are unlikely to be the shortest route to anywhere, and routes that do not start at the start point do not have to be considered either. For a small graph like Hiva Oa, it should be possible to generate all non-cyclic (circle-free) routes starting from a certain point.</p>
</section>
<section id="section-162">
<h5>○•○</h5>
<p>But first, we will need to expand our vocabulary so we can deal with the problem in a natural way. The words we need exist in CoffeeScript and in the Underscore library, but we will go through how they can be implemented, so it is clear how they function and what they do. The example implementations will be named with an underscore in front of their names to show they are internal and not used in the rest of the book. You can compare with the implementations in the <a href="https://github.com/jashkenas/coffee-script/blob/master/examples/underscore.coffee">CoffeeScript Underscore example</a> and try all the Underscore functions in the <a href="http://autotelicum.github.com/Smooth-CoffeeScript/literate/underscore.html">interactive Underscore reference</a>.</p>
<p>The first is a function named <code>_member</code>, which is used to determine whether an element is found within an array. The route will be kept as an array of names, and when arriving at a new place, the algorithm could logically call <code>_member</code> to check whether we have been at that place already. It could look like this:</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">_member <span class="kw">=</span> <span class="fu">(array, value) -&gt;</span><br />  found <span class="kw">=</span> <span class="ot">false</span><br />  array<span class="kw">.</span>forEach <span class="fu">(element) -&gt;</span><br />    <span class="kw">if</span> element <span class="kw">is</span> value<br />      found <span class="kw">=</span> <span class="ot">true</span><br />  found<br />show _member <span class="kw">[</span><span class="dv">6</span><span class="kw">,</span> <span class="dv">7</span><span class="kw">,</span> <span class="st">&quot;Bordeaux&quot;</span><span class="kw">],</span> <span class="dv">7</span></code></pre>
<p>However, this will go over the whole array, even if the value is found immediately at the first position. What wastefulness. When using a <code>for</code> loop, you can use the <code>break</code> statement to jump out of it, but in a <code>forEach</code> construct this will not work, because the body of the loop is a function, and <code>break</code> statements do not jump out of functions. One solution could be to adjust <code>forEach</code> to recognise a certain kind of exceptions as signalling a break. Something like <code>_forEach</code> here:</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">_break <span class="kw">=</span> toString<span class="kw">:</span> <span class="fu">-&gt;</span> <span class="st">&quot;Break&quot;</span><br />_forEach <span class="kw">=</span> <span class="fu">(array, action) -&gt;</span><br />  <span class="kw">try</span><br />    <span class="kw">for</span> element <span class="kw">in</span> array<br />      action element<br />  <span class="kw">catch</span> exception<br />    <span class="kw">if</span> exception <span class="kw">isnt</span> _break<br />      <span class="kw">throw</span> exception<br />show _forEach <span class="kw">[</span><span class="dv">1</span><span class="kw">..</span><span class="dv">3</span><span class="kw">],</span> <span class="fu">(n) -&gt;</span> n<span class="kw">*</span>n<br /><span class="co"># Which btw could in CoffeeScript be written as</span><br />show <span class="kw">(</span>i<span class="kw">*</span>i <span class="kw">for</span> i <span class="kw">in</span> <span class="kw">[</span><span class="dv">1</span><span class="kw">..</span><span class="dv">3</span><span class="kw">])</span></code></pre>
<p>Now, if the <code>action</code> function throws <code>_break</code>, <code>_forEach</code> will absorb the exception and stop looping. The object stored in the variable <code>_break</code> is used purely as a thing to compare with. The only reason I gave it a <code>toString</code> property is that this might be useful to figure out what kind of strange value you are dealing with if you somehow end up with a <code>_break</code> exception outside of a <code>_forEach</code>. Now <code>_member</code> can be defined as:</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">_member <span class="kw">=</span> <span class="fu">(array, value) -&gt;</span><br />  found <span class="kw">=</span> <span class="ot">false</span><br />  _forEach array<span class="kw">,</span> <span class="fu">(element) -&gt;</span><br />    <span class="kw">if</span> element <span class="kw">is</span> value<br />      found <span class="kw">=</span> <span class="ot">true</span><br />      <span class="kw">throw</span> _break<br />  found<br />show _member <span class="kw">[</span><span class="dv">6</span><span class="kw">,</span> <span class="dv">7</span><span class="kw">,</span> <span class="st">&quot;Bordeaux&quot;</span><span class="kw">],</span> <span class="dv">7</span></code></pre>
<p>Of course we could also have defined <code>_member</code> without using the <code>_forEach</code>:</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">_member <span class="kw">=</span> <span class="fu">(array, value) -&gt;</span><br />  found <span class="kw">=</span> <span class="ot">false</span><br />  <span class="kw">for</span> element <span class="kw">in</span> array<br />    <span class="kw">if</span> element <span class="kw">is</span> value<br />      found <span class="kw">=</span> <span class="ot">true</span><br />      <span class="kw">break</span><br />  found<br />show _member <span class="kw">[</span><span class="dv">6</span><span class="kw">,</span> <span class="dv">7</span><span class="kw">,</span> <span class="st">&quot;Bordeaux&quot;</span><span class="kw">],</span> <span class="dv">7</span></code></pre>
<p>This function exists in Underscore as <code>include</code> aka <code>contains</code>. But it is such a common operation that it is in fact built into CoffeeScript with the <code>in</code> operator (outside of a <code>for</code> … <code>in</code>). Using <code>in</code> is the preferred way to test for array membership.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">show <span class="dv">7</span> <span class="kw">in</span> <span class="kw">[</span><span class="dv">6</span><span class="kw">,</span> <span class="dv">7</span><span class="kw">,</span> <span class="st">&quot;Bordeaux&quot;</span><span class="kw">]</span></code></pre>
</section>
<section id="section-163">
<h5>○•○</h5>
<p>Having a way to break out of <code>_forEach</code> loops can be very useful, but in the case of the <code>_member</code> function the result is still rather ugly, because you need to specifically store the result and later return it. We could add yet another kind of exception, <code>_return</code>, which can be given a <code>value</code> property, and have <code>_forEach</code> return this value when such an exception is thrown, but this would be terribly ad-hoc and messy. What we really need is a whole new higher-order function, called <code>any</code><a href="#index-any"></a> (or sometimes <code>some</code>). It exists in Underscore under both names. A definition more or less looks like this:</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">_any <span class="kw">=</span> <span class="fu">(array, test) -&gt;</span><br />  <span class="kw">for</span> element <span class="kw">in</span> array<br />    <span class="kw">if</span> test element<br />      <span class="kw">return</span> <span class="ot">true</span><br />  <span class="ot">false</span><br /><br />show _any <span class="kw">[</span><span class="dv">3</span><span class="kw">,</span> <span class="dv">4</span><span class="kw">,</span> <span class="dv">0</span><span class="kw">,</span> <span class="kw">-</span><span class="dv">3</span><span class="kw">,</span> <span class="dv">2</span><span class="kw">,</span> <span class="dv">1</span><span class="kw">],</span> <span class="fu">(n) -&gt;</span> n <span class="kw">&lt;</span> <span class="dv">0</span><br />show _any <span class="kw">[</span><span class="dv">3</span><span class="kw">,</span> <span class="dv">4</span><span class="kw">,</span> <span class="dv">0</span><span class="kw">,</span> <span class="dv">2</span><span class="kw">,</span> <span class="dv">1</span><span class="kw">],</span> <span class="fu">(n) -&gt;</span> n <span class="kw">&lt;</span> <span class="dv">0</span><br /><span class="co"># Using Underscore</span><br />show _<span class="kw">.</span>any <span class="kw">[</span><span class="dv">3</span><span class="kw">,</span> <span class="dv">4</span><span class="kw">,</span> <span class="dv">0</span><span class="kw">,</span> <span class="kw">-</span><span class="dv">3</span><span class="kw">,</span> <span class="dv">2</span><span class="kw">,</span> <span class="dv">1</span><span class="kw">],</span> <span class="fu">(n) -&gt;</span> n <span class="kw">&lt;</span> <span class="dv">0</span></code></pre>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false"><span class="co"># Redefining member with any</span><br />_member <span class="kw">=</span> <span class="fu">(array, value) -&gt;</span><br />  partial <span class="kw">=</span> <span class="fu">(func, a...) -&gt;</span> <span class="fu">(b...) -&gt;</span> func a<span class="kw">...,</span> b<span class="kw">...</span><br />  _<span class="kw">.</span>any array<span class="kw">,</span> partial <span class="kw">(</span><span class="fu">(a,b) -&gt;</span> a <span class="kw">is</span> b<span class="kw">),</span> value<br />show _member <span class="kw">[</span><span class="st">&quot;Fear&quot;</span><span class="kw">,</span> <span class="st">&quot;Loathing&quot;</span><span class="kw">],</span> <span class="st">&quot;Denial&quot;</span><br />show _member <span class="kw">[</span><span class="st">&quot;Fear&quot;</span><span class="kw">,</span> <span class="st">&quot;Loathing&quot;</span><span class="kw">],</span> <span class="st">&quot;Loathing&quot;</span></code></pre>
<p><code>any</code> goes over the elements in an array, from left to right, and applies the test function to them. The first time this returns a true-ish value, it returns that value. If no true-ish value is found, <code>false</code> is returned. Calling <code>any test, array</code> is more or less equivalent to doing <code>test(array[0]) or test(array[1]) or ...</code> etcetera.</p>
</section>
<section id="section-164">
<h5>○•○</h5>
<p>Just like <code>&amp;&amp;</code> is the companion of <code>||</code>, <code>any</code> has a companion called <code>every</code><a href="#index-every"></a>:</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">_every <span class="kw">=</span> <span class="fu">(array, test) -&gt;</span><br />  <span class="kw">for</span> element <span class="kw">in</span> array<br />    <span class="kw">if</span> <span class="kw">not</span> test element<br />      <span class="kw">return</span> <span class="ot">false</span><br />  <span class="ot">true</span><br />show _every <span class="kw">[</span><span class="dv">1</span><span class="kw">,</span> <span class="dv">2</span><span class="kw">,</span> <span class="dv">0</span><span class="kw">,</span> <span class="kw">-</span><span class="dv">1</span><span class="kw">],</span> <span class="fu">(n) -&gt;</span> n <span class="kw">isnt</span> <span class="dv">0</span><br />show _every <span class="kw">[</span><span class="dv">1</span><span class="kw">,</span> <span class="dv">2</span><span class="kw">,</span> <span class="kw">-</span><span class="dv">1</span><span class="kw">],</span> <span class="fu">(n) -&gt;</span> n <span class="kw">isnt</span> <span class="dv">0</span><br />show _<span class="kw">.</span>every <span class="kw">[</span><span class="dv">1</span><span class="kw">,</span> <span class="dv">2</span><span class="kw">,</span> <span class="kw">-</span><span class="dv">1</span><span class="kw">],</span> <span class="fu">(n) -&gt;</span> n <span class="kw">isnt</span> <span class="dv">0</span> <span class="co"># Using Underscore</span></code></pre>
</section>
<section id="section-165">
<h5>○•○</h5>
<p>Another function we will need is <code>flatten</code>. This function takes an array of arrays, and puts the elements of the arrays together in one big array.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">_flatten <span class="kw">=</span> <span class="fu">(array) -&gt;</span><br />  result <span class="kw">=</span> <span class="kw">[]</span><br />  <span class="kw">for</span> element <span class="kw">in</span> array<br />    <span class="kw">if</span> _<span class="kw">.</span>isArray element<br />      result <span class="kw">=</span> result<span class="kw">.</span>concat _flatten element<br />    <span class="kw">else</span><br />      result<span class="kw">.</span>push element<br />  result<br /><br />show _flatten <span class="kw">[[</span><span class="dv">1</span><span class="kw">],</span> <span class="kw">[</span><span class="dv">2</span><span class="kw">,</span> <span class="kw">[</span><span class="dv">3</span><span class="kw">,</span> <span class="dv">4</span><span class="kw">]],</span> <span class="kw">[</span><span class="dv">5</span><span class="kw">,</span> <span class="dv">6</span><span class="kw">]]</span><br /><span class="co"># Using Underscore</span><br />show _<span class="kw">.</span>flatten <span class="kw">[[</span><span class="dv">1</span><span class="kw">],</span> <span class="kw">[</span><span class="dv">2</span><span class="kw">,</span> <span class="kw">[</span><span class="dv">3</span><span class="kw">,</span> <span class="dv">4</span><span class="kw">]],</span> <span class="kw">[</span><span class="dv">5</span><span class="kw">,</span> <span class="dv">6</span><span class="kw">]]</span></code></pre>
</section>
</section>
<section id="exercise-27">
<h4><em>Exercise 27</em></h4>
<p>Before starting to generate routes, we need one more higher-order function. This one is called <code>filter</code><a href="#index-filter"></a> (in Underscore it is also named <code>select</code>). Like <code>map</code>, it takes a function and an array as arguments, and produces a new array, but instead of putting the results of calling the function in the new array, it produces an array with only those values from the old array for which the given function returns a true-like value. Write a <code>_filter</code> function that shows how it works.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false"><span class="co"># Compose a solution here</span></code></pre>
<section id="view-solution-32" onclick="reveal(this)" >
<h5>View Solution</h5>
<section id="section-166" style="display:none" >
<h6></h6>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">_filter <span class="kw">=</span> <span class="fu">(array, test) -&gt;</span><br />  result <span class="kw">=</span> <span class="kw">[]</span><br />  <span class="kw">for</span> element <span class="kw">in</span> array<br />    <span class="kw">if</span> test element<br />      result<span class="kw">.</span>push element<br />  result<br /><br />show _filter <span class="kw">[</span><span class="dv">0</span><span class="kw">,</span> <span class="dv">4</span><span class="kw">,</span> <span class="dv">8</span><span class="kw">,</span> <span class="dv">12</span><span class="kw">],</span> <span class="fu">(n) -&gt;</span> n <span class="kw">&lt;</span> <span class="dv">5</span><br /><br />isOdd <span class="kw">=</span> <span class="fu">(n) -&gt;</span> n <span class="kw">%</span> <span class="dv">2</span> <span class="kw">isnt</span> <span class="dv">0</span><br />show _<span class="kw">.</span>filter <span class="kw">[</span><span class="dv">0</span><span class="kw">..</span><span class="dv">6</span><span class="kw">],</span> isOdd <span class="co"># Using Underscore</span></code></pre>
</section>
</section>
</section>
<section id="section-167">
<h4></h4>
<p>Imagine what an algorithm to generate routes would look like — it starts at the starting location, and starts to generate a route for every road leaving there. At the end of each of these roads it continues to generate more routes. It does not run along one road, it branches out. Because of this, recursion<a href="#index-recursion"></a> is a natural way to model it.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">possibleRoutes <span class="kw">=</span> <span class="fu">(from, to) -&gt;</span><br />  findRoutes <span class="kw">=</span> <span class="fu">(route) -&gt;</span><br />    notVisited <span class="kw">=</span> <span class="fu">(road) -&gt;</span><br />      <span class="kw">not</span> <span class="kw">(</span>road<span class="kw">.</span>to <span class="kw">in</span> route<span class="kw">.</span>places<span class="kw">)</span><br />    continueRoute <span class="kw">=</span> <span class="fu">(road) -&gt;</span><br />      findRoutes <br />        places<span class="kw">:</span> route<span class="kw">.</span>places<span class="kw">.</span>concat<span class="kw">([</span>road<span class="kw">.</span>to<span class="kw">]),</span><br />        length<span class="kw">:</span> route<span class="kw">.</span>length <span class="kw">+</span> road<span class="kw">.</span>distance<br />    end <span class="kw">=</span> route<span class="kw">.</span>places<span class="kw">[</span>route<span class="kw">.</span>places<span class="kw">.</span>length <span class="kw">-</span> <span class="dv">1</span><span class="kw">]</span><br />    <span class="kw">if</span> end <span class="kw">is</span> to<br />      <span class="kw">[</span>route<span class="kw">]</span><br />    <span class="kw">else</span><br />      _<span class="kw">.</span>flatten _<span class="kw">.</span>map _<span class="kw">.</span>filter<span class="kw">(</span>roadsFrom<span class="kw">(</span>end<span class="kw">),</span> notVisited<span class="kw">),</span><br />                  continueRoute<br />  findRoutes <span class="kw">{</span>places<span class="kw">:</span> <span class="kw">[</span>from<span class="kw">],</span> length<span class="kw">:</span> <span class="dv">0</span><span class="kw">}</span><br /><br />show <span class="kw">(</span>possibleRoutes <span class="st">'Point Teohotepapapa'</span><span class="kw">,</span> <span class="st">'Point Kiukiu'</span><span class="kw">).</span>length<br />show possibleRoutes <span class="st">'Hanapaoa'</span><span class="kw">,</span> <span class="st">'Mt Ootua'</span> </code></pre>
<p>The function returns an array of route objects, each of which contains an array of places that the route passes, and a length. <code>findRoutes</code> recursively continues a route, returning an array with every possible extension of that route. When the end of a route is the place where we want to go, it just returns that route, since continuing past that place would be pointless. If it is another place, we must go on. The <code>flatten</code>/<code>map</code>/<code>filter</code> line is probably the hardest to read. This is what it says: ‘Take all the roads going from the current location, discard the ones that go to places that this route has already visited. Continue each of these roads, which will give an array of finished routes for each of them, then put all these routes into a single big array that we return.’</p>
<p>That line does a lot. This is why good abstractions help: They allow you to say complicated things without typing pages of code.</p>
<p>Does this not recurse forever, seeing how it calls itself (via <code>continueRoute</code>)? No, at some point, all outgoing roads will go to places that a route has already passed, and the result of <code>filter</code> will be an empty array. Mapping over an empty array produces an empty array, and flattening that still gives an empty array. So calling <code>findRoutes</code> on a dead end produces an empty array, meaning ‘there are no ways to continue this route’.</p>
<p>Notice that places are appended to routes by using <code>concat</code><a href="#index-concat"></a>, not <code>push</code><a href="#index-push"></a>. The <code>concat</code> method creates a new array, while <code>push</code> modifies the existing array. Because the function might branch off several routes from a single partial route, we must not modify the array that represents the original route, because it must be used several times.</p>
</section>
<section id="exercise-28">
<h4><em>Exercise 28</em></h4>
<p>Now that we have all possible routes, let us try to find the shortest one. Write a function <code>shortestRoute</code> that, like <code>possibleRoutes</code>, takes the names of a starting and ending location as arguments. It returns a single route object, of the type that <code>possibleRoutes</code> produces.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false"><span class="co"># Compose a solution here</span></code></pre>
<section id="view-solution-33" onclick="reveal(this)" >
<h5>View Solution</h5>
<section id="section-168" style="display:none" >
<h6></h6>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">shortestRoute <span class="kw">=</span> <span class="fu">(from, to) -&gt;</span><br />  currentShortest <span class="kw">=</span> <span class="ot">null</span><br />  _<span class="kw">.</span>each possibleRoutes<span class="kw">(</span>from<span class="kw">,</span> to<span class="kw">),</span> <span class="fu">(route) -&gt;</span><br />    <span class="kw">if</span> <span class="kw">not</span> currentShortest <span class="kw">or</span><br />       currentShortest<span class="kw">.</span>length <span class="kw">&gt;</span> route<span class="kw">.</span>length<br />      currentShortest <span class="kw">=</span> route <br />  currentShortest</code></pre>
<p>The tricky thing in ‘minimising’ or ‘maximising’ algorithms is to not screw up when given an empty array. In this case, we happen to know that there is at least one road between every two places, so we could just ignore it. But that would be a bit lame. What if the road from Puamua to Mount Ootua, which is steep and muddy, is washed away by a rainstorm? It would be a shame if this caused our function to break as well, so it takes care to return <code>null</code> when no routes are found.</p>
<p>Then, the very functional, abstract-everything-we-can approach:</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">minimise <span class="kw">=</span> <span class="fu">(func, array) -&gt;</span><br />  minScore <span class="kw">=</span> <span class="ot">null</span><br />  found <span class="kw">=</span> <span class="ot">null</span><br />  _<span class="kw">.</span>each array<span class="kw">,</span> <span class="fu">(element) -&gt;</span><br />    score <span class="kw">=</span> func element<br />    <span class="kw">if</span> minScore <span class="kw">is</span> <span class="ot">null</span> <span class="kw">or</span> score <span class="kw">&lt;</span> minScore<br />      minScore <span class="kw">=</span> score<br />      found <span class="kw">=</span> element<br />  found<br /><br />getProperty <span class="kw">=</span> <span class="fu">(propName) -&gt;</span><br />  <span class="fu">(object) -&gt;</span> object<span class="kw">[</span>propName<span class="kw">]</span><br /><br />shortestRouteAbstract <span class="kw">=</span> <span class="fu">(from, to) -&gt;</span><br />  minimise getProperty<span class="kw">(</span><span class="st">'length'</span><span class="kw">),</span><br />           possibleRoutes<span class="kw">(</span>from<span class="kw">,</span> to<span class="kw">)</span></code></pre>
<p>Unfortunately, it is two times longer than the other version. In programs where you need to minimise several things it might be a good idea to write the generic algorithm like this, so you can re-use it. In most cases the first version is probably good enough.</p>
<p>Note the <code>getProperty</code><a href="#index-getProperty"></a> function though, it is often useful when doing functional programming with objects.</p>
</section>
</section>
</section>
<section id="section-169">
<h4></h4>
<p>Let us see what route our algorithm comes up with between Point Kiukiu and Point Teohotepapapa…</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">show <span class="kw">(</span>shortestRoute <span class="st">'Point Kiukiu'</span><span class="kw">,</span>  <span class="st">'Point Teohotepapapa'</span><span class="kw">).</span>places<br />show <span class="kw">(</span>shortestRouteAbstract <span class="st">'Point Kiukiu'</span><span class="kw">,</span>  <span class="st">'Point Teohotepapapa'</span><span class="kw">).</span>places</code></pre>
<section id="section-170">
<h5>○•○</h5>
<p>On a small island like Hiva Oa, it is not too much work to generate all possible routes. If you try to do that on a reasonably detailed map of, say, Belgium, it is going to take an absurdly long time, not to mention an absurd amount of memory. Still, you have probably seen those online route-planners. These give you a more or less optimal route through a gigantic maze of roads in just a few seconds. How do they do it?</p>
<p>If you are paying attention, you may have noticed that it is not necessary to generate all routes all the way to the end. If we start comparing routes <em>while</em> we are building them, we can avoid building this big set of routes, and, as soon as we have found a single route to our destination, we can stop extending routes that are already longer than that route.</p>
</section>
<section id="section-171">
<h5>○•○</h5>
<p>To try this out, we will use a 20 by 20 grid as our map:</p>
<p align=center><img src="../img/height-small.png" alt="figure ../img/height-small.png" /><br /></p>
</section>
<section id="view-solution-34" onclick="reveal(this)" >
<h5>View Solution</h5>
<section id="section-172" style="display:none" >
<h6></h6>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">heightAt <span class="kw">=</span> <span class="fu">(point) -&gt;</span><br />  heights <span class="kw">=</span> <span class="kw">[[</span><span class="dv">111</span><span class="kw">,</span><span class="dv">111</span><span class="kw">,</span><span class="dv">122</span><span class="kw">,</span><span class="dv">137</span><span class="kw">,</span><span class="dv">226</span><span class="kw">,</span><span class="dv">192</span><span class="kw">,</span><span class="dv">246</span><span class="kw">,</span><span class="dv">275</span><span class="kw">,</span><span class="dv">285</span><span class="kw">,</span><span class="dv">333</span><span class="kw">,</span><span class="dv">328</span><span class="kw">,</span><span class="dv">264</span><span class="kw">,</span><span class="dv">202</span><span class="kw">,</span><span class="dv">175</span><span class="kw">,</span><span class="dv">151</span><span class="kw">,</span><span class="dv">222</span><span class="kw">,</span><span class="dv">250</span><span class="kw">,</span><span class="dv">222</span><span class="kw">,</span><span class="dv">219</span><span class="kw">,</span><span class="dv">146</span><span class="kw">]</span><br />  <span class="kw">[</span><span class="dv">205</span><span class="kw">,</span><span class="dv">186</span><span class="kw">,</span><span class="dv">160</span><span class="kw">,</span><span class="dv">218</span><span class="kw">,</span><span class="dv">217</span><span class="kw">,</span><span class="dv">233</span><span class="kw">,</span><span class="dv">268</span><span class="kw">,</span><span class="dv">300</span><span class="kw">,</span><span class="dv">316</span><span class="kw">,</span><span class="dv">357</span><span class="kw">,</span><span class="dv">276</span><span class="kw">,</span><span class="dv">240</span><span class="kw">,</span><span class="dv">240</span><span class="kw">,</span><span class="dv">253</span><span class="kw">,</span><span class="dv">215</span><span class="kw">,</span><span class="dv">201</span><span class="kw">,</span><span class="dv">256</span><span class="kw">,</span><span class="dv">312</span><span class="kw">,</span><span class="dv">224</span><span class="kw">,</span><span class="dv">200</span><span class="kw">]</span><br />  <span class="kw">[</span><span class="dv">228</span><span class="kw">,</span><span class="dv">176</span><span class="kw">,</span><span class="dv">232</span><span class="kw">,</span><span class="dv">258</span><span class="kw">,</span><span class="dv">246</span><span class="kw">,</span><span class="dv">289</span><span class="kw">,</span><span class="dv">306</span><span class="kw">,</span><span class="dv">351</span><span class="kw">,</span><span class="dv">374</span><span class="kw">,</span><span class="dv">388</span><span class="kw">,</span><span class="dv">319</span><span class="kw">,</span><span class="dv">333</span><span class="kw">,</span><span class="dv">299</span><span class="kw">,</span><span class="dv">307</span><span class="kw">,</span><span class="dv">261</span><span class="kw">,</span><span class="dv">286</span><span class="kw">,</span><span class="dv">291</span><span class="kw">,</span><span class="dv">355</span><span class="kw">,</span><span class="dv">277</span><span class="kw">,</span><span class="dv">258</span><span class="kw">]</span><br />  <span class="kw">[</span><span class="dv">228</span><span class="kw">,</span><span class="dv">207</span><span class="kw">,</span><span class="dv">263</span><span class="kw">,</span><span class="dv">264</span><span class="kw">,</span><span class="dv">284</span><span class="kw">,</span><span class="dv">348</span><span class="kw">,</span><span class="dv">368</span><span class="kw">,</span><span class="dv">358</span><span class="kw">,</span><span class="dv">391</span><span class="kw">,</span><span class="dv">387</span><span class="kw">,</span><span class="dv">320</span><span class="kw">,</span><span class="dv">344</span><span class="kw">,</span><span class="dv">366</span><span class="kw">,</span><span class="dv">382</span><span class="kw">,</span><span class="dv">372</span><span class="kw">,</span><span class="dv">394</span><span class="kw">,</span><span class="dv">360</span><span class="kw">,</span><span class="dv">314</span><span class="kw">,</span><span class="dv">259</span><span class="kw">,</span><span class="dv">207</span><span class="kw">]</span><br />  <span class="kw">[</span><span class="dv">238</span><span class="kw">,</span><span class="dv">237</span><span class="kw">,</span><span class="dv">275</span><span class="kw">,</span><span class="dv">315</span><span class="kw">,</span><span class="dv">353</span><span class="kw">,</span><span class="dv">355</span><span class="kw">,</span><span class="dv">341</span><span class="kw">,</span><span class="dv">332</span><span class="kw">,</span><span class="dv">350</span><span class="kw">,</span><span class="dv">315</span><span class="kw">,</span><span class="dv">283</span><span class="kw">,</span><span class="dv">310</span><span class="kw">,</span><span class="dv">355</span><span class="kw">,</span><span class="dv">350</span><span class="kw">,</span><span class="dv">336</span><span class="kw">,</span><span class="dv">405</span><span class="kw">,</span><span class="dv">361</span><span class="kw">,</span><span class="dv">273</span><span class="kw">,</span><span class="dv">264</span><span class="kw">,</span><span class="dv">228</span><span class="kw">]</span><br />  <span class="kw">[</span><span class="dv">245</span><span class="kw">,</span><span class="dv">264</span><span class="kw">,</span><span class="dv">289</span><span class="kw">,</span><span class="dv">340</span><span class="kw">,</span><span class="dv">359</span><span class="kw">,</span><span class="dv">349</span><span class="kw">,</span><span class="dv">336</span><span class="kw">,</span><span class="dv">303</span><span class="kw">,</span><span class="dv">267</span><span class="kw">,</span><span class="dv">259</span><span class="kw">,</span><span class="dv">285</span><span class="kw">,</span><span class="dv">340</span><span class="kw">,</span><span class="dv">315</span><span class="kw">,</span><span class="dv">290</span><span class="kw">,</span><span class="dv">333</span><span class="kw">,</span><span class="dv">372</span><span class="kw">,</span><span class="dv">306</span><span class="kw">,</span><span class="dv">254</span><span class="kw">,</span><span class="dv">220</span><span class="kw">,</span><span class="dv">220</span><span class="kw">]</span><br />  <span class="kw">[</span><span class="dv">264</span><span class="kw">,</span><span class="dv">287</span><span class="kw">,</span><span class="dv">331</span><span class="kw">,</span><span class="dv">365</span><span class="kw">,</span><span class="dv">382</span><span class="kw">,</span><span class="dv">381</span><span class="kw">,</span><span class="dv">386</span><span class="kw">,</span><span class="dv">360</span><span class="kw">,</span><span class="dv">299</span><span class="kw">,</span><span class="dv">258</span><span class="kw">,</span><span class="dv">254</span><span class="kw">,</span><span class="dv">284</span><span class="kw">,</span><span class="dv">264</span><span class="kw">,</span><span class="dv">276</span><span class="kw">,</span><span class="dv">295</span><span class="kw">,</span><span class="dv">323</span><span class="kw">,</span><span class="dv">281</span><span class="kw">,</span><span class="dv">233</span><span class="kw">,</span><span class="dv">202</span><span class="kw">,</span><span class="dv">160</span><span class="kw">]</span><br />  <span class="kw">[</span><span class="dv">300</span><span class="kw">,</span><span class="dv">327</span><span class="kw">,</span><span class="dv">360</span><span class="kw">,</span><span class="dv">355</span><span class="kw">,</span><span class="dv">365</span><span class="kw">,</span><span class="dv">402</span><span class="kw">,</span><span class="dv">393</span><span class="kw">,</span><span class="dv">343</span><span class="kw">,</span><span class="dv">307</span><span class="kw">,</span><span class="dv">274</span><span class="kw">,</span><span class="dv">232</span><span class="kw">,</span><span class="dv">226</span><span class="kw">,</span><span class="dv">221</span><span class="kw">,</span><span class="dv">262</span><span class="kw">,</span><span class="dv">289</span><span class="kw">,</span><span class="dv">250</span><span class="kw">,</span><span class="dv">252</span><span class="kw">,</span><span class="dv">228</span><span class="kw">,</span><span class="dv">160</span><span class="kw">,</span><span class="dv">160</span><span class="kw">]</span><br />  <span class="kw">[</span><span class="dv">343</span><span class="kw">,</span><span class="dv">379</span><span class="kw">,</span><span class="dv">373</span><span class="kw">,</span><span class="dv">337</span><span class="kw">,</span><span class="dv">309</span><span class="kw">,</span><span class="dv">336</span><span class="kw">,</span><span class="dv">378</span><span class="kw">,</span><span class="dv">352</span><span class="kw">,</span><span class="dv">303</span><span class="kw">,</span><span class="dv">290</span><span class="kw">,</span><span class="dv">294</span><span class="kw">,</span><span class="dv">241</span><span class="kw">,</span><span class="dv">176</span><span class="kw">,</span><span class="dv">204</span><span class="kw">,</span><span class="dv">235</span><span class="kw">,</span><span class="dv">205</span><span class="kw">,</span><span class="dv">203</span><span class="kw">,</span><span class="dv">206</span><span class="kw">,</span><span class="dv">169</span><span class="kw">,</span><span class="dv">132</span><span class="kw">]</span><br />  <span class="kw">[</span><span class="dv">348</span><span class="kw">,</span><span class="dv">348</span><span class="kw">,</span><span class="dv">364</span><span class="kw">,</span><span class="dv">369</span><span class="kw">,</span><span class="dv">337</span><span class="kw">,</span><span class="dv">276</span><span class="kw">,</span><span class="dv">321</span><span class="kw">,</span><span class="dv">390</span><span class="kw">,</span><span class="dv">347</span><span class="kw">,</span><span class="dv">354</span><span class="kw">,</span><span class="dv">309</span><span class="kw">,</span><span class="dv">259</span><span class="kw">,</span><span class="dv">208</span><span class="kw">,</span><span class="dv">147</span><span class="kw">,</span><span class="dv">158</span><span class="kw">,</span><span class="dv">165</span><span class="kw">,</span><span class="dv">169</span><span class="kw">,</span><span class="dv">169</span><span class="kw">,</span><span class="dv">200</span><span class="kw">,</span><span class="dv">147</span><span class="kw">]</span><br />  <span class="kw">[</span><span class="dv">320</span><span class="kw">,</span><span class="dv">328</span><span class="kw">,</span><span class="dv">334</span><span class="kw">,</span><span class="dv">348</span><span class="kw">,</span><span class="dv">354</span><span class="kw">,</span><span class="dv">316</span><span class="kw">,</span><span class="dv">254</span><span class="kw">,</span><span class="dv">315</span><span class="kw">,</span><span class="dv">303</span><span class="kw">,</span><span class="dv">297</span><span class="kw">,</span><span class="dv">283</span><span class="kw">,</span><span class="dv">238</span><span class="kw">,</span><span class="dv">229</span><span class="kw">,</span><span class="dv">207</span><span class="kw">,</span><span class="dv">156</span><span class="kw">,</span><span class="dv">129</span><span class="kw">,</span><span class="dv">128</span><span class="kw">,</span><span class="dv">161</span><span class="kw">,</span><span class="dv">174</span><span class="kw">,</span><span class="dv">165</span><span class="kw">]</span><br />  <span class="kw">[</span><span class="dv">297</span><span class="kw">,</span><span class="dv">331</span><span class="kw">,</span><span class="dv">304</span><span class="kw">,</span><span class="dv">283</span><span class="kw">,</span><span class="dv">283</span><span class="kw">,</span><span class="dv">279</span><span class="kw">,</span><span class="dv">250</span><span class="kw">,</span><span class="dv">243</span><span class="kw">,</span><span class="dv">264</span><span class="kw">,</span><span class="dv">251</span><span class="kw">,</span><span class="dv">226</span><span class="kw">,</span><span class="dv">204</span><span class="kw">,</span><span class="dv">155</span><span class="kw">,</span><span class="dv">144</span><span class="kw">,</span><span class="dv">154</span><span class="kw">,</span><span class="dv">147</span><span class="kw">,</span><span class="dv">120</span><span class="kw">,</span><span class="dv">111</span><span class="kw">,</span><span class="dv">129</span><span class="kw">,</span><span class="dv">138</span><span class="kw">]</span><br />  <span class="kw">[</span><span class="dv">302</span><span class="kw">,</span><span class="dv">347</span><span class="kw">,</span><span class="dv">332</span><span class="kw">,</span><span class="dv">326</span><span class="kw">,</span><span class="dv">314</span><span class="kw">,</span><span class="dv">286</span><span class="kw">,</span><span class="dv">223</span><span class="kw">,</span><span class="dv">205</span><span class="kw">,</span><span class="dv">202</span><span class="kw">,</span><span class="dv">178</span><span class="kw">,</span><span class="dv">160</span><span class="kw">,</span><span class="dv">172</span><span class="kw">,</span><span class="dv">171</span><span class="kw">,</span><span class="dv">132</span><span class="kw">,</span><span class="dv">118</span><span class="kw">,</span><span class="dv">116</span><span class="kw">,</span><span class="dv">114</span><span class="kw">,</span> <span class="dv">96</span><span class="kw">,</span> <span class="dv">80</span><span class="kw">,</span> <span class="dv">75</span><span class="kw">]</span><br />  <span class="kw">[</span><span class="dv">287</span><span class="kw">,</span><span class="dv">317</span><span class="kw">,</span><span class="dv">310</span><span class="kw">,</span><span class="dv">293</span><span class="kw">,</span><span class="dv">284</span><span class="kw">,</span><span class="dv">235</span><span class="kw">,</span><span class="dv">217</span><span class="kw">,</span><span class="dv">305</span><span class="kw">,</span><span class="dv">286</span><span class="kw">,</span><span class="dv">229</span><span class="kw">,</span><span class="dv">211</span><span class="kw">,</span><span class="dv">234</span><span class="kw">,</span><span class="dv">227</span><span class="kw">,</span><span class="dv">243</span><span class="kw">,</span><span class="dv">188</span><span class="kw">,</span><span class="dv">160</span><span class="kw">,</span><span class="dv">152</span><span class="kw">,</span><span class="dv">129</span><span class="kw">,</span><span class="dv">138</span><span class="kw">,</span><span class="dv">101</span><span class="kw">]</span><br />  <span class="kw">[</span><span class="dv">260</span><span class="kw">,</span><span class="dv">277</span><span class="kw">,</span><span class="dv">269</span><span class="kw">,</span><span class="dv">243</span><span class="kw">,</span><span class="dv">236</span><span class="kw">,</span><span class="dv">255</span><span class="kw">,</span><span class="dv">343</span><span class="kw">,</span><span class="dv">312</span><span class="kw">,</span><span class="dv">280</span><span class="kw">,</span><span class="dv">220</span><span class="kw">,</span><span class="dv">252</span><span class="kw">,</span><span class="dv">280</span><span class="kw">,</span><span class="dv">298</span><span class="kw">,</span><span class="dv">288</span><span class="kw">,</span><span class="dv">252</span><span class="kw">,</span><span class="dv">210</span><span class="kw">,</span><span class="dv">176</span><span class="kw">,</span><span class="dv">163</span><span class="kw">,</span><span class="dv">133</span><span class="kw">,</span><span class="dv">112</span><span class="kw">]</span><br />  <span class="kw">[</span><span class="dv">266</span><span class="kw">,</span><span class="dv">255</span><span class="kw">,</span><span class="dv">254</span><span class="kw">,</span><span class="dv">254</span><span class="kw">,</span><span class="dv">265</span><span class="kw">,</span><span class="dv">307</span><span class="kw">,</span><span class="dv">350</span><span class="kw">,</span><span class="dv">311</span><span class="kw">,</span><span class="dv">267</span><span class="kw">,</span><span class="dv">276</span><span class="kw">,</span><span class="dv">292</span><span class="kw">,</span><span class="dv">355</span><span class="kw">,</span><span class="dv">305</span><span class="kw">,</span><span class="dv">250</span><span class="kw">,</span><span class="dv">223</span><span class="kw">,</span><span class="dv">200</span><span class="kw">,</span><span class="dv">197</span><span class="kw">,</span><span class="dv">193</span><span class="kw">,</span><span class="dv">166</span><span class="kw">,</span><span class="dv">158</span><span class="kw">]</span><br />  <span class="kw">[</span><span class="dv">306</span><span class="kw">,</span><span class="dv">312</span><span class="kw">,</span><span class="dv">328</span><span class="kw">,</span><span class="dv">279</span><span class="kw">,</span><span class="dv">287</span><span class="kw">,</span><span class="dv">320</span><span class="kw">,</span><span class="dv">377</span><span class="kw">,</span><span class="dv">359</span><span class="kw">,</span><span class="dv">289</span><span class="kw">,</span><span class="dv">328</span><span class="kw">,</span><span class="dv">367</span><span class="kw">,</span><span class="dv">355</span><span class="kw">,</span><span class="dv">271</span><span class="kw">,</span><span class="dv">250</span><span class="kw">,</span><span class="dv">198</span><span class="kw">,</span><span class="dv">163</span><span class="kw">,</span><span class="dv">139</span><span class="kw">,</span><span class="dv">155</span><span class="kw">,</span><span class="dv">153</span><span class="kw">,</span><span class="dv">190</span><span class="kw">]</span><br />  <span class="kw">[</span><span class="dv">367</span><span class="kw">,</span><span class="dv">357</span><span class="kw">,</span><span class="dv">339</span><span class="kw">,</span><span class="dv">330</span><span class="kw">,</span><span class="dv">290</span><span class="kw">,</span><span class="dv">323</span><span class="kw">,</span><span class="dv">363</span><span class="kw">,</span><span class="dv">374</span><span class="kw">,</span><span class="dv">330</span><span class="kw">,</span><span class="dv">331</span><span class="kw">,</span><span class="dv">415</span><span class="kw">,</span><span class="dv">446</span><span class="kw">,</span><span class="dv">385</span><span class="kw">,</span><span class="dv">308</span><span class="kw">,</span><span class="dv">241</span><span class="kw">,</span><span class="dv">190</span><span class="kw">,</span><span class="dv">145</span><span class="kw">,</span> <span class="dv">99</span><span class="kw">,</span> <span class="dv">88</span><span class="kw">,</span><span class="dv">145</span><span class="kw">]</span><br />  <span class="kw">[</span><span class="dv">342</span><span class="kw">,</span><span class="dv">362</span><span class="kw">,</span><span class="dv">381</span><span class="kw">,</span><span class="dv">359</span><span class="kw">,</span><span class="dv">353</span><span class="kw">,</span><span class="dv">353</span><span class="kw">,</span><span class="dv">369</span><span class="kw">,</span><span class="dv">391</span><span class="kw">,</span><span class="dv">384</span><span class="kw">,</span><span class="dv">372</span><span class="kw">,</span><span class="dv">408</span><span class="kw">,</span><span class="dv">448</span><span class="kw">,</span><span class="dv">382</span><span class="kw">,</span><span class="dv">358</span><span class="kw">,</span><span class="dv">256</span><span class="kw">,</span><span class="dv">178</span><span class="kw">,</span><span class="dv">143</span><span class="kw">,</span><span class="dv">125</span><span class="kw">,</span> <span class="dv">85</span><span class="kw">,</span><span class="dv">109</span><span class="kw">]</span><br />  <span class="kw">[</span><span class="dv">311</span><span class="kw">,</span><span class="dv">337</span><span class="kw">,</span><span class="dv">358</span><span class="kw">,</span><span class="dv">376</span><span class="kw">,</span><span class="dv">330</span><span class="kw">,</span><span class="dv">341</span><span class="kw">,</span><span class="dv">342</span><span class="kw">,</span><span class="dv">374</span><span class="kw">,</span><span class="dv">411</span><span class="kw">,</span><span class="dv">408</span><span class="kw">,</span><span class="dv">421</span><span class="kw">,</span><span class="dv">382</span><span class="kw">,</span><span class="dv">271</span><span class="kw">,</span><span class="dv">311</span><span class="kw">,</span><span class="dv">246</span><span class="kw">,</span><span class="dv">166</span><span class="kw">,</span><span class="dv">132</span><span class="kw">,</span><span class="dv">116</span><span class="kw">,</span><span class="dv">108</span><span class="kw">,</span> <span class="dv">72</span><span class="kw">]]</span><br />  heights<span class="kw">[</span>point<span class="kw">.</span>y<span class="kw">][</span>point<span class="kw">.</span>x<span class="kw">]</span></code></pre>
</section>
</section>
</section>
<section id="section-173">
<h4></h4>
<p>What you see here is an elevation map of a mountain landscape. The yellowish spots are the peaks, and the dark spots the valleys. The area is divided into squares with a size of a hundred meters. We have at our disposal a function <code>heightAt</code>, which can give us the height, in meters, of any square on that map, where squares are represented by objects with <code>x</code> and <code>y</code> properties.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">show heightAt x<span class="kw">:</span>  <span class="dv">0</span><span class="kw">,</span> y<span class="kw">:</span>  <span class="dv">0</span><br />show heightAt x<span class="kw">:</span> <span class="dv">11</span><span class="kw">,</span> y<span class="kw">:</span> <span class="dv">18</span></code></pre>
<section id="section-174">
<h5>○•○</h5>
<p>We want to cross this landscape, on foot, from the top left to the bottom right. A grid can be approached like a graph. Every square is a node, which is connected to the squares around it.</p>
<p>We do not like wasting energy, so we would prefer to take the easiest route possible. Going uphill is heavier than going downhill, and going downhill is heavier than going level<sup><a href="#fn27" class="footnoteRef" id="fnref27">27</a></sup>. This function calculates the amount of ‘weighted meters’, between two adjacent squares, which represents how tired you get from walking (or climbing) between them. Going uphill is counted as twice as heavy as going downhill.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">weightedDistance <span class="kw">=</span> <span class="fu">(pointA, pointB) -&gt;</span><br />  heightDifference <span class="kw">=</span><br />    heightAt<span class="kw">(</span>pointB<span class="kw">)</span> <span class="kw">-</span> heightAt<span class="kw">(</span>pointA<span class="kw">)</span><br />  climbFactor <span class="kw">=</span> <span class="kw">if</span> heightDifference <span class="kw">&lt;</span> <span class="dv">0</span> <span class="kw">then</span> <span class="dv">1</span> <span class="kw">else</span> <span class="dv">2</span><br />  flatDistance <span class="kw">=</span><br />    <span class="kw">if</span> pointA<span class="kw">.</span>x <span class="kw">is</span> pointB<span class="kw">.</span>x <span class="kw">or</span> pointA<span class="kw">.</span>y <span class="kw">is</span> pointB<span class="kw">.</span>y<br />      <span class="dv">100</span><br />    <span class="kw">else</span><br />      <span class="dv">141</span><br />  flatDistance <span class="kw">+</span> climbFactor <span class="kw">*</span> <span class="ot">Math</span><span class="kw">.</span>abs heightDifference<br />show weightedDistance <span class="kw">(</span>x<span class="kw">:</span> <span class="dv">0</span><span class="kw">,</span> y<span class="kw">:</span> <span class="dv">0</span><span class="kw">),</span> <span class="kw">(</span>x<span class="kw">:</span> <span class="dv">1</span><span class="kw">,</span> y<span class="kw">:</span> <span class="dv">1</span><span class="kw">)</span></code></pre>
<p>Note the <code>flatDistance</code> calculation. If the two points are on the same row or column, they are right next to each other, and the distance between them is a hundred meters. Otherwise, they are assumed to be diagonally adjacent, and the diagonal distance between two squares of this size is a hundred times the square root of two, which is approximately <code>141</code>. One is not allowed to call this function for squares that are further than one step apart. (It could double-check this… but it is too lazy.)</p>
</section>
<section id="section-175">
<h5>○•○</h5>
<p>Points on the map are represented by objects containing <code>x</code> and <code>y</code> properties. These three functions are useful when working with such objects:</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">point <span class="kw">=</span> <span class="fu">(x, y) -&gt;</span> <span class="kw">{</span>x<span class="kw">,</span> y<span class="kw">}</span> <span class="co"># Same as {x: x, y: y}</span><br />addPoints <span class="kw">=</span> <span class="fu">(a, b) -&gt;</span> point a<span class="kw">.</span>x <span class="kw">+</span> b<span class="kw">.</span>x<span class="kw">,</span> a<span class="kw">.</span>y <span class="kw">+</span> b<span class="kw">.</span>y<br />samePoint <span class="kw">=</span> <span class="fu">(a, b) -&gt;</span> a<span class="kw">.</span>x <span class="kw">is</span> b<span class="kw">.</span>x <span class="kw">and</span> a<span class="kw">.</span>y <span class="kw">is</span> b<span class="kw">.</span>y<br /><br />show samePoint addPoints<span class="kw">(</span>point<span class="kw">(</span><span class="dv">10</span><span class="kw">,</span> <span class="dv">10</span><span class="kw">),</span> point<span class="kw">(</span><span class="dv">4</span><span class="kw">,</span> <span class="kw">-</span><span class="dv">2</span><span class="kw">)),</span><br />                         point<span class="kw">(</span><span class="dv">14</span><span class="kw">,</span> <span class="dv">8</span><span class="kw">)</span></code></pre>
</section>
</section>
<section id="exercise-29">
<h4><em>Exercise 29</em></h4>
<p>If we are going to find routes through this map, we will again need a function to create ‘signposts’, lists of directions that can be taken from a given point. Write a function <code>possibleDirections</code>, which takes a point object as argument and returns an array of nearby points. We can only move to adjacent points, both straight and diagonally, so squares have a maximum of eight neighbours. Take care not to return squares that lie outside of the map. For all we know the edge of the map might be the edge of the world.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false"><span class="co"># Compose a solution here</span></code></pre>
<section id="view-solution-35" onclick="reveal(this)" >
<h5>View Solution</h5>
<section id="section-176" style="display:none" >
<h6></h6>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">possibleDirections <span class="kw">=</span> <span class="fu">(from) -&gt;</span><br />  mapSize <span class="kw">=</span> <span class="dv">20</span><br />  insideMap <span class="kw">=</span> <span class="fu">(point) -&gt;</span><br />    point<span class="kw">.</span>x <span class="kw">&gt;=</span> <span class="dv">0</span> <span class="kw">and</span> point<span class="kw">.</span>x <span class="kw">&lt;</span> mapSize <span class="kw">and</span><br />    point<span class="kw">.</span>y <span class="kw">&gt;=</span> <span class="dv">0</span> <span class="kw">and</span> point<span class="kw">.</span>y <span class="kw">&lt;</span> mapSize<br />  directions <span class="kw">=</span> <span class="kw">[</span> point<span class="kw">(-</span><span class="dv">1</span><span class="kw">,</span>  <span class="dv">0</span><span class="kw">),</span> point<span class="kw">(</span> <span class="dv">1</span><span class="kw">,</span>  <span class="dv">0</span><span class="kw">)</span><br />                 point<span class="kw">(</span> <span class="dv">0</span><span class="kw">,</span> <span class="kw">-</span><span class="dv">1</span><span class="kw">),</span> point<span class="kw">(</span> <span class="dv">0</span><span class="kw">,</span>  <span class="dv">1</span><span class="kw">)</span><br />                 point<span class="kw">(-</span><span class="dv">1</span><span class="kw">,</span> <span class="kw">-</span><span class="dv">1</span><span class="kw">),</span> point<span class="kw">(-</span><span class="dv">1</span><span class="kw">,</span>  <span class="dv">1</span><span class="kw">)</span><br />                 point<span class="kw">(</span> <span class="dv">1</span><span class="kw">,</span>  <span class="dv">1</span><span class="kw">),</span> point<span class="kw">(</span> <span class="dv">1</span><span class="kw">,</span> <span class="kw">-</span><span class="dv">1</span><span class="kw">)]</span><br />  partial <span class="kw">=</span> <span class="fu">(func, a...) -&gt;</span> <span class="fu">(b...) -&gt;</span> func a<span class="kw">...,</span> b<span class="kw">...</span><br />  _<span class="kw">.</span>filter <span class="kw">(</span>_<span class="kw">.</span>map directions<span class="kw">,</span><br />              partial addPoints<span class="kw">,</span> from<span class="kw">),</span> insideMap<br /><br />show possibleDirections point <span class="dv">0</span><span class="kw">,</span> <span class="dv">0</span></code></pre>
<p>I created a variable <code>mapSize</code>, for the sole purpose of not having to write <code>20</code> two times. If, at some other time, we want to use this same function for another map, it would be clumsy if the code was full of <code>20</code>s, which all have to be changed. We could even go as far as making the <code>mapSize</code> an argument to <code>possibleDirections</code>, so we can use the function for different maps without changing it. I judged that that was not necessary in this case, such things can be changed when the need arises. Then why did I not add a variable to hold the <code>0</code>, which also occurs two times? I assumed that maps always start at <code>0</code>, so this one is unlikely to ever change, and using a variable for it only adds noise.</p>
</section>
</section>
</section>
<section id="section-177">
<h4></h4>
<p>To find a route on this map without having our browser cut off the program because it takes too long to finish, we have to stop our amateurish attempts and implement a serious algorithm. A lot of work has gone into problems like this in the past, and many solutions have been designed (some brilliant, others useless). A very popular and efficient one is called A*<a href="#index-A*"></a> (pronounced A-star). We will spend the rest of the chapter implementing an A* route-finding function for our map.</p>
<p>Before I get to the algorithm itself, let me tell you a bit more about the problem it solves. The trouble with searching routes through graphs is that, in big graphs, there are an awful lot of them. Our Hiva Oa path-finder showed that, when the graph is small, all we needed to do was to make sure our paths did not revisit points they had already passed. On our new map, this is not enough anymore.</p>
<p>The fundamental problem is that there is too much room for going in the wrong direction. Unless we somehow manage to steer our exploration of paths towards the goal, a choice we make for continuing a given path is more likely to go in the wrong direction than in the right direction. If you keep generating paths like that, you end up with an enormous amount of paths, and even if one of them accidentally reaches the end point, you do not know whether that is the shortest path.</p>
<p>So what you want to do is explore directions that are likely to get you to the end point first. On a grid like our map, you can get a rough estimate of how good a path is by checking how long it is and how close its end is to the end point. By adding path length and an estimate of the distance it still has to go, you can get a rough idea of which paths are promising. If you extend promising paths first, you are less likely to waste time on useless ones.</p>
<section id="section-178">
<h5>○•○</h5>
<p>But that still is not enough. If our map was of a perfectly flat plane, the path that looked promising would almost always be the best one, and we could use the above method to walk right to our goal. But we have valleys and hillsides blocking our paths, so it is hard to tell in advance which direction will be the most efficient path. Because of this, we still end up having to explore way too many paths.</p>
<p>To correct this, we can make clever use of the fact that we are constantly exploring the most promising path first. Once we have determined that path A is the best way to get to point X, we can remember that. When, later on, path B also gets to point X, we know that it is not the best route, so we do not have to explore it further. This can prevent our program from building a lot of pointless paths.</p>
</section>
<section id="section-179">
<h5>○•○</h5>
<p>The algorithm, then, goes something like this…</p>
<p>There are two pieces of data to keep track of. The first one is called the open list, it contains the partial routes that must still be explored. Each route has a score, which is calculated by adding its length to its estimated distance from the goal. This estimate must always be optimistic, it should never overestimate the distance. The second is a set of nodes that we have seen, together with the shortest partial route that got us there. This one we will call the reached list. We start by adding a route that contains only the starting node to the open list, and recording it in the reached list.</p>
<p>Then, as long as there are any nodes in the open list, we take out the one that has the lowest (best) score, and find the ways in which it can be continued (by calling <code>possibleDirections</code>). For each of the nodes this returns, we create a new route by appending it to our original route, and adjusting the length of the route using <code>weightedDistance</code>. The endpoint of each of these new routes is then looked up in the reached list.</p>
<p>If the node is not in the reached list yet, it means we have not seen it before, and we add the new route to the open list and record it in the reached list. If we <em>had</em> seen it before, we compare the score of the new route to the score of the route in the reached list. If the new route is shorter, we replace the existing route with the new one. Otherwise, we discard the new route, since we have already seen a better way to get to that point.</p>
<p>We continue doing this until the route we fetch from the open list ends at the goal node, in which case we have found our route, or until the open list is empty, in which case we have found out that there is no route. In our case the map contains no unsurmountable obstacles, so there is always a route.</p>
<p>How do we know that the first full route that we get from the open list is also the shortest one? This is a result of the fact that we only look at a route when it has the lowest score. The score of a route is its actual length plus an <em>optimistic</em> estimate of the remaining length. This means that if a route has the lowest score in the open list, it is always the best route to its current endpoint — it is impossible for another route to later find a better way to that point, because if it were better, its score would have been lower.</p>
</section>
<section id="section-180">
<h5>○•○</h5>
<p>Try not to get frustrated when the fine points of why this works are still eluding you. When thinking about algorithms like this, having seen ‘something like it’ before helps a lot, it gives you a point of reference to compare the approach to. Beginning programmers have to do without such a point of reference, which makes it rather easy to get lost. Just realise that this is advanced stuff, globally read over the rest of the chapter, and come back to it later when you feel like a challenge.</p>
</section>
<section id="section-181">
<h5>○•○</h5>
<p>I am afraid that, for one aspect of the algorithm, I am going to have to invoke magic again. The open list needs to be able to hold a large amount of routes, and to quickly find the route with the lowest score among them. Storing them in a normal array, and searching through this array every time, is way too slow, so I give you a data structure called a binary heap<a href="#index-binary-heap"></a>. You create them with <code>new</code>, just like <code>Date</code> objects, giving them a function that is used to ‘score’ its elements as argument. The resulting object has the methods <code>push</code> and <code>pop</code>, just like an array, but <code>pop</code> always gives you the element with the lowest score, instead of the one that was <code>push</code>ed last.</p>
</section>
<section id="view-solution-36" onclick="reveal(this)" >
<h5>View Solution</h5>
<section id="section-182" style="display:none" >
<h6></h6>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false"><span class="dt">@BinaryHeap</span> <span class="kw">=</span> <span class="kw">class</span> <span class="dt">BinaryHeap</span><br /><br />  <span class="co"># Public</span><br />  <span class="co">#--------</span><br />  <span class="kw">constructor</span><span class="kw">:</span> <span class="kw">(</span><span class="dt">@scoreFunction</span> <span class="kw">=</span> <span class="fu">(x) -&gt;</span> x<span class="kw">)</span> <span class="fu">-&gt;</span><br />    <span class="dt">@content</span> <span class="kw">=</span> <span class="kw">[]</span><br /><br />  push<span class="kw">:</span> <span class="fu">(element) -&gt;</span><br />    <span class="co"># Add the new element to the end of the array.</span><br />    <span class="dt">@content</span><span class="kw">.</span>push element<br />    <span class="co"># Allow it to bubble up.</span><br />    <span class="dt">@_bubbleUp</span> <span class="dt">@content</span><span class="kw">.</span>length <span class="kw">-</span> <span class="dv">1</span><br /><br />  pop<span class="kw">:</span> <span class="fu">-&gt;</span><br />    <span class="co"># Store the first element so we can return it later.</span><br />    result <span class="kw">=</span> <span class="dt">@content</span><span class="kw">[</span><span class="dv">0</span><span class="kw">]</span><br />    <span class="co"># Get the element at the end of the array.</span><br />    end <span class="kw">=</span> <span class="dt">@content</span><span class="kw">.</span>pop<span class="kw">()</span><br />    <span class="co"># If there are any elements left, put the end</span><br />    <span class="co"># element at the start, and let it sink down.</span><br />    <span class="kw">if</span> <span class="dt">@content</span><span class="kw">.</span>length <span class="kw">&gt;</span> <span class="dv">0</span><br />      <span class="dt">@content</span><span class="kw">[</span><span class="dv">0</span><span class="kw">]</span> <span class="kw">=</span> end<br />      <span class="dt">@_sinkDown</span> <span class="dv">0</span><br />    result<br /><br />  size<span class="kw">:</span> <span class="fu">-&gt;</span> <span class="dt">@content</span><span class="kw">.</span>length<br /><br />  remove<span class="kw">:</span> <span class="fu">(node) -&gt;</span><br />    len <span class="kw">=</span> <span class="dt">@content</span><span class="kw">.</span>length<br />    <span class="co"># To remove a value, we must search through the</span><br />    <span class="co"># array to find it.</span><br />    <span class="kw">for</span> i <span class="kw">in</span> <span class="kw">[</span><span class="dv">0</span><span class="kw">...</span>len<span class="kw">]</span><br />      <span class="kw">if</span> <span class="dt">@content</span><span class="kw">[</span>i<span class="kw">]</span> <span class="kw">is</span> node<br />        <span class="co"># When it is found, the process seen in 'pop'</span><br />        <span class="co"># is repeated to fill up the hole.</span><br />        end <span class="kw">=</span> <span class="dt">@content</span><span class="kw">.</span>pop<span class="kw">()</span><br />        <span class="kw">if</span> i <span class="kw">isnt</span> len <span class="kw">-</span> <span class="dv">1</span><br />          <span class="dt">@content</span><span class="kw">[</span>i<span class="kw">]</span> <span class="kw">=</span> end<br />          <span class="kw">if</span> <span class="dt">@scoreFunction</span><span class="kw">(</span>end<span class="kw">)</span> <span class="kw">&lt;</span> <span class="dt">@scoreFunction</span><span class="kw">(</span>node<span class="kw">)</span><br />            <span class="dt">@_bubbleUp</span> i<br />          <span class="kw">else</span><br />            <span class="dt">@_sinkDown</span> i<br />        <span class="kw">return</span><br />    <span class="kw">throw</span> <span class="kw">new</span> <span class="dt">Error</span> <span class="st">'Node not found.'</span><br /><br />  <span class="co"># Private</span><br />  <span class="co">#---------</span><br />  _bubbleUp<span class="kw">:</span> <span class="fu">(n) -&gt;</span><br />    <span class="co"># Fetch the element that has to be moved.</span><br />    element <span class="kw">=</span> <span class="dt">@content</span><span class="kw">[</span>n<span class="kw">]</span><br />    <span class="co"># When at 0, an element can not go up any further.</span><br />    <span class="kw">while</span> n <span class="kw">&gt;</span> <span class="dv">0</span><br />      <span class="co"># Compute the parent element index, and fetch it.</span><br />      parentN <span class="kw">=</span> <span class="ot">Math</span><span class="kw">.</span>floor<span class="kw">((</span>n <span class="kw">+</span> <span class="dv">1</span><span class="kw">)</span> <span class="kw">/</span> <span class="dv">2</span><span class="kw">)</span> <span class="kw">-</span> <span class="dv">1</span><br />      parent <span class="kw">=</span> <span class="dt">@content</span><span class="kw">[</span>parentN<span class="kw">]</span><br />      <span class="co"># Swap the elements if the parent is greater.</span><br />      <span class="kw">if</span> <span class="dt">@scoreFunction</span><span class="kw">(</span>element<span class="kw">)</span> <span class="kw">&lt;</span> <span class="dt">@scoreFunction</span><span class="kw">(</span>parent<span class="kw">)</span><br />        <span class="dt">@content</span><span class="kw">[</span>parentN<span class="kw">]</span> <span class="kw">=</span> element<br />        <span class="dt">@content</span><span class="kw">[</span>n<span class="kw">]</span> <span class="kw">=</span> parent<br />        <span class="co"># Update 'n' to continue at the new position.</span><br />        n <span class="kw">=</span> parentN<br />      <span class="co"># Found a parent that is less,</span><br />      <span class="co"># no need to move it further.</span><br />      <span class="kw">else</span><br />        <span class="kw">break</span><br />    <span class="kw">return</span><br /><br />  _sinkDown<span class="kw">:</span> <span class="fu">(n) -&gt;</span><br />    <span class="co"># Look up the target element and its score.</span><br />    length <span class="kw">=</span> <span class="dt">@content</span><span class="kw">.</span>length<br />    element <span class="kw">=</span> <span class="dt">@content</span><span class="kw">[</span>n<span class="kw">]</span><br />    elemScore <span class="kw">=</span> <span class="dt">@scoreFunction</span> element<br />    <span class="kw">loop</span><br />      <span class="co"># Compute the indices of the child elements.</span><br />      child2N <span class="kw">=</span> <span class="kw">(</span>n <span class="kw">+</span> <span class="dv">1</span><span class="kw">)</span> <span class="kw">*</span> <span class="dv">2</span><br />      child1N <span class="kw">=</span> child2N <span class="kw">-</span> <span class="dv">1</span><br />      <span class="co"># This is used to store the new position of</span><br />      <span class="co"># the element, if any.</span><br />      swap <span class="kw">=</span> <span class="ot">null</span><br />      <span class="co"># If the first child exists (is inside the array)...</span><br />      <span class="kw">if</span> child1N <span class="kw">&lt;</span> length<br />        <span class="co"># Look it up and compute its score.</span><br />        child1 <span class="kw">=</span> <span class="dt">@content</span><span class="kw">[</span>child1N<span class="kw">]</span><br />        child1Score <span class="kw">=</span> <span class="dt">this</span><span class="kw">.</span>scoreFunction child1<br />        <span class="co"># If the score is less than our elements,</span><br />        <span class="co"># we need to swap.</span><br />        <span class="kw">if</span> child1Score <span class="kw">&lt;</span> elemScore<br />          swap <span class="kw">=</span> child1N<br />      <span class="co"># Do the same checks for the other child.</span><br />      <span class="kw">if</span> child2N <span class="kw">&lt;</span> length<br />        child2 <span class="kw">=</span> <span class="dt">@content</span><span class="kw">[</span>child2N<span class="kw">]</span><br />        child2Score <span class="kw">=</span> <span class="dt">@scoreFunction</span> child2<br />        compScore <span class="kw">=</span> <span class="kw">if</span> swap <span class="kw">is</span> <span class="ot">null</span><br />            elemScore<br />          <span class="kw">else</span><br />            child1Score<br />        <span class="kw">if</span> child2Score <span class="kw">&lt;</span> compScore<br />          swap <span class="kw">=</span> child2N<br />      <span class="co"># If the element needs to be moved,</span><br />      <span class="co"># swap it, and continue.</span><br />      <span class="kw">if</span> swap <span class="kw">isnt</span> <span class="ot">null</span><br />        <span class="dt">@content</span><span class="kw">[</span>n<span class="kw">]</span> <span class="kw">=</span> <span class="dt">@content</span><span class="kw">[</span>swap<span class="kw">]</span><br />        <span class="dt">@content</span><span class="kw">[</span>swap<span class="kw">]</span> <span class="kw">=</span> element<br />        n <span class="kw">=</span> swap<br />      <span class="co"># Otherwise, we are done.</span><br />      <span class="kw">else</span><br />        <span class="kw">break</span><br />    <span class="kw">return</span></code></pre>
</section>
</section>
</section>
<section id="section-183">
<h4></h4>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">heap <span class="kw">=</span> <span class="kw">new</span> <span class="dt">BinaryHeap</span><span class="kw">()</span><br />_<span class="kw">.</span>each <span class="kw">[</span><span class="dv">2</span><span class="kw">,</span> <span class="dv">4</span><span class="kw">,</span> <span class="dv">5</span><span class="kw">,</span> <span class="dv">1</span><span class="kw">,</span> <span class="dv">6</span><span class="kw">,</span> <span class="dv">3</span><span class="kw">],</span> <span class="fu">(number) -&gt;</span><br />  heap<span class="kw">.</span>push number<br /><br /><span class="kw">while</span> heap<span class="kw">.</span>size<span class="kw">()</span> <span class="kw">&gt;</span> <span class="dv">0</span><br />  show heap<span class="kw">.</span>pop<span class="kw">()</span></code></pre>
<p><a href="#binary-heaps">Binary Heaps↓</a> discusses the implementation of this data structure, which is quite interesting. After you have read <a href="#object-oriented-programming">Object Orientation↓</a>, you might want to take a look at it.</p>
<section id="section-184">
<h5>○•○</h5>
<p>The need to squeeze out as much efficiency as we can has another effect. The Hiva Oa algorithm used arrays of locations to store routes, and copied them with the <code>concat</code> method when it extended them. This time, we can not afford to copy arrays, since we will be exploring lots and lots of routes. Instead, we use a ‘chain’ of objects to store a route. Every object in the chain has some properties, such as a point on the map, and the length of the route so far, and it also has a property that points at the previous object in the chain. Something like this:</p>
<p align=center><img src="../img/objectchain-small.png" alt="figure ../img/objectchain-small.png" /><br /></p>
<p>Where the blue circles are the relevant objects, and the lines represent properties — the end points are the values of the property. Object <code>A</code> is the start of a route here. Object <code>B</code> is used to build a new route, which continues from <code>A</code>. It has a property, which we will call <code>from</code>, pointing at the route it is based on. When we need to reconstruct a route later, we can follow these properties to find all the points that the route passed. Note that object <code>B</code> is part of two routes, one that ends in <code>D</code> and one that ends in <code>E</code>. When there are a lot of routes, this can save us much storage space — every new route only needs one new object for itself, the rest is shared with other routes that started the same way.</p>
</section>
</section>
<section id="exercise-30">
<h4><em>Exercise 30</em></h4>
<p>Write a function <code>estimatedDistance</code> that gives an optimistic estimate of the distance between two points. It does not have to look at the height data, but can assume a flat map. Remember that we are only travelling straight and diagonally, and that we are counting the diagonal distance between two squares as <code>141</code>.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false"><span class="co"># Compose a solution here</span></code></pre>
<section id="view-solution-37" onclick="reveal(this)" >
<h5>View Solution</h5>
<section id="section-185" style="display:none" >
<h6></h6>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">estimatedDistance <span class="kw">=</span> <span class="fu">(pointA, pointB) -&gt;</span><br />  dx <span class="kw">=</span> <span class="ot">Math</span><span class="kw">.</span>abs pointA<span class="kw">.</span>x <span class="kw">-</span> pointB<span class="kw">.</span>x<br />  dy <span class="kw">=</span> <span class="ot">Math</span><span class="kw">.</span>abs pointA<span class="kw">.</span>y <span class="kw">-</span> pointB<span class="kw">.</span>y<br />  <span class="kw">if</span> dx <span class="kw">&gt;</span> dy<br />    <span class="kw">(</span>dx <span class="kw">-</span> dy<span class="kw">)</span> <span class="kw">*</span> <span class="dv">100</span> <span class="kw">+</span> dy <span class="kw">*</span> <span class="dv">141</span><br />  <span class="kw">else</span><br />    <span class="kw">(</span>dy <span class="kw">-</span> dx<span class="kw">)</span> <span class="kw">*</span> <span class="dv">100</span> <span class="kw">+</span> dx <span class="kw">*</span> <span class="dv">141</span><br /><br />show estimatedDistance point<span class="kw">(</span><span class="dv">3</span><span class="kw">,</span><span class="dv">3</span><span class="kw">),</span> point<span class="kw">(</span><span class="dv">9</span><span class="kw">,</span><span class="dv">6</span><span class="kw">)</span></code></pre>
<p>The strange formulae are used to decompose the path into a straight and a diagonal part. If you have a path like this…</p>
<p align=center><img src="../img/diagonalpath-small.png" alt="figure ../img/diagonalpath-small.png" /><br /></p>
<p>… the path is <code>6</code> squares wide and <code>3</code> high, so you get <code>6 - 3 = 3</code> straight moves, and <code>3</code> diagonal ones.</p>
<p>If you wrote a function that just computes the straight ‘Pythagorean’ distance between the points, that would also work. What we need is an optimistic estimate, and assuming you can go straight to the goal is certainly optimistic. However, the closer the estimate is to the real distance, the less useless paths our program has to try out.</p>
</section>
</section>
</section>
<section id="section-186">
<h4></h4>
</section>
<section id="exercise-31">
<h4><em>Exercise 31</em></h4>
<p>We will use a binary heap for the open list. What would be a good data structure for the reached list? This one will be used to look up routes, given a pair of <code>x</code>, <code>y</code> coordinates. Preferably in a way that is fast. Write three functions named <code>makeReachedList</code>, <code>storeReached</code>, and <code>findReached</code>. The first one creates your data structure, the second one, given a reached list, a point, and a route, stores a route in it, and the last one, given a reached list and point, retrieves a route or returns <code>undefined</code> to indicate that no route was found for that point.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false"><span class="co"># Compose a solution here</span></code></pre>
<section id="view-solution-38" onclick="reveal(this)" >
<h5>View Solution</h5>
<section id="section-187" style="display:none" >
<h6></h6>
<p>One reasonable idea would be to use an object with objects in it. One of the coordinates in the points, say <code>x</code>, is used as a property name for the outer object, and the other, <code>y</code>, for the inner object. This does require some bookkeeping to handle the fact that, sometimes, the inner object we are looking for is not there (yet).</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">makeReachedList <span class="kw">=</span> <span class="fu">-&gt;</span> <span class="kw">{}</span><br /><br />storeReached <span class="kw">=</span> <span class="fu">(list, point, route) -&gt;</span><br />  inner <span class="kw">=</span> list<span class="kw">[</span>point<span class="kw">.</span>x<span class="kw">]</span><br />  <span class="kw">if</span> inner <span class="kw">is</span> <span class="ot">undefined</span><br />    inner <span class="kw">=</span> <span class="kw">{}</span><br />    list<span class="kw">[</span>point<span class="kw">.</span>x<span class="kw">]</span> <span class="kw">=</span> inner<br />  inner<span class="kw">[</span>point<span class="kw">.</span>y<span class="kw">]</span> <span class="kw">=</span> route<br /><br />findReached <span class="kw">=</span> <span class="fu">(list, point) -&gt;</span><br />  inner <span class="kw">=</span> list<span class="kw">[</span>point<span class="kw">.</span>x<span class="kw">]</span><br />  <span class="kw">if</span> inner <span class="kw">is</span> <span class="ot">undefined</span><br />    <span class="ot">undefined</span><br />  <span class="kw">else</span><br />    inner<span class="kw">[</span>point<span class="kw">.</span>y<span class="kw">]</span></code></pre>
<p>Another possibility is to merge the <code>x</code> and <code>y</code> of the point into a single property name, and use that to store routes in a single object.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">pointID <span class="kw">=</span> <span class="fu">(point) -&gt;</span><br />  point<span class="kw">.</span>x <span class="kw">+</span> <span class="st">'-'</span> <span class="kw">+</span> point<span class="kw">.</span>y<br /><br />makeReachedList <span class="kw">=</span> <span class="fu">-&gt;</span> <span class="kw">{}</span><br />storeReached <span class="kw">=</span> <span class="fu">(list, point, route) -&gt;</span><br />  list<span class="kw">[</span>pointID<span class="kw">(</span>point<span class="kw">)]</span> <span class="kw">=</span> route<br />findReached <span class="kw">=</span> <span class="fu">(list, point) -&gt;</span><br />  list<span class="kw">[</span>pointID<span class="kw">(</span>point<span class="kw">)]</span></code></pre>
</section>
</section>
</section>
<section id="section-188">
<h4></h4>
<p><a href="#index-encapsulation"></a>Defining a type of data structure by providing a set of functions to create and manipulate such structures is a useful technique. It makes it possible to ‘isolate’ the code that makes use of the structure from the details of the structure itself. Note that, no matter which of the above two implementations is used, code that needs a reached list works in exactly the same way. It does not care what kind of objects are used, as long as it gets the results it expected.</p>
<p>This will be discussed in much more detail in <a href="#object-oriented-programming">Object Orientation↓</a>, where we will learn to make object types like <code>BinaryHeap</code>, which are created using <code>new</code> and have methods to manipulate them.</p>
<section id="section-189">
<h5>○•○</h5>
<p>Here we finally have the actual path-finding function:</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">findRoute <span class="kw">=</span> <span class="fu">(from, to) -&gt;</span><br /><br />  routeScore <span class="kw">=</span> <span class="fu">(route) -&gt;</span><br />    <span class="kw">if</span> route<span class="kw">.</span>score <span class="kw">is</span> <span class="ot">undefined</span><br />      route<span class="kw">.</span>score <span class="kw">=</span> route<span class="kw">.</span>length <span class="kw">+</span><br />        estimatedDistance route<span class="kw">.</span>point<span class="kw">,</span> to<br />    route<span class="kw">.</span>score<br /><br />  addOpenRoute <span class="kw">=</span> <span class="fu">(route) -&gt;</span><br />    open<span class="kw">.</span>push route<br />    storeReached reached<span class="kw">,</span> route<span class="kw">.</span>point<span class="kw">,</span> route<br /><br />  open <span class="kw">=</span> <span class="kw">new</span> <span class="dt">BinaryHeap</span> routeScore<br />  reached <span class="kw">=</span> makeReachedList<span class="kw">()</span><br />  addOpenRoute point<span class="kw">:</span> from<span class="kw">,</span> length<span class="kw">:</span> <span class="dv">0</span><br /><br />  <span class="kw">while</span> open<span class="kw">.</span>size<span class="kw">()</span> <span class="kw">&gt;</span> <span class="dv">0</span><br />    route <span class="kw">=</span> open<span class="kw">.</span>pop<span class="kw">()</span><br />    <span class="kw">if</span> samePoint route<span class="kw">.</span>point<span class="kw">,</span> to<br />      <span class="kw">return</span> route<br /><br />    _<span class="kw">.</span>each possibleDirections<span class="kw">(</span>route<span class="kw">.</span>point<span class="kw">),</span><br />      <span class="fu">(direction) -&gt;</span><br />        known <span class="kw">=</span> findReached reached<span class="kw">,</span> direction<br />        newLength <span class="kw">=</span> route<span class="kw">.</span>length <span class="kw">+</span><br />          weightedDistance route<span class="kw">.</span>point<span class="kw">,</span> direction<br />        <span class="kw">if</span> <span class="kw">not</span> known <span class="kw">or</span> known<span class="kw">.</span>length <span class="kw">&gt;</span> newLength<br />          <span class="kw">if</span> known<br />            open<span class="kw">.</span>remove known<br />          addOpenRoute<br />            point<span class="kw">:</span>  direction<span class="kw">,</span><br />            from<span class="kw">:</span>   route<span class="kw">,</span><br />            length<span class="kw">:</span> newLength<br />  <span class="kw">return</span> <span class="ot">null</span></code></pre>
<p>First, it creates the data structures it needs, one open list and one reached list. <code>routeScore</code> is the scoring function given to the binary heap. Note how it stores its result in the route object, to prevent having to re-calculate it multiple times. <code>addOpenRoute</code> is a convenience function that adds a new route to both the open list and the reached list. It is immediately used to add the start of the route. Note that route objects always have the properties <code>point</code>, which holds the point at the end of the route, and <code>length</code>, which holds the current length of the route. Routes which are more than one square long also have a <code>from</code> property, which points at their predecessors.</p>
<p>The <code>while</code> loop, as was described in the algorithm, keeps taking the lowest-scoring route from the open list and checks whether this gets us to the goal point. If it does not, we must continue by expanding it. This is what the <code>_.each</code> takes care of. It looks up this new point in the reached list. If it is not found there, or the node found has a longer length that the new route, a new route object is created and added to the open list and reached list, and the existing route (if any) is removed from the open list.</p>
<p>What if the route in <code>known</code> is not on the open list? It has to be, because routes are only removed from the open list when they have been found to be the most optimal route to their endpoint. If we try to remove a value from a binary heap that is not on it, it will throw an exception, so if my reasoning is wrong, we will probably see an exception when running the function.</p>
<p>When code gets complex enough to make you doubt certain things about it, it is a good idea to add some checks that raise exceptions when something goes wrong. That way, you know that there are no weird things happening ‘silently’, and when you break something, you immediately see what you broke.</p>
</section>
<section id="section-190">
<h5>○•○</h5>
<p>Note that this algorithm does not use recursion, but still manages to explore all those branches. The open list more or less takes over the role that the function call stack played in the recursive solution to the Hiva Oa problem — it keeps track of the paths that still have to be explored. Every recursive algorithm can be rewritten in a non-recursive way by using a data structure to store the ‘things that must still be done’.</p>
</section>
<section id="section-191">
<h5>○•○</h5>
<p>Well, let us try our path-finder:</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">route <span class="kw">=</span> findRoute point<span class="kw">(</span><span class="dv">0</span><span class="kw">,</span> <span class="dv">0</span><span class="kw">),</span> point<span class="kw">(</span><span class="dv">19</span><span class="kw">,</span> <span class="dv">19</span><span class="kw">)</span><br />runOnDemand <span class="fu">-&gt;</span> show route</code></pre>
<p>If you ran all the code above, and did not introduce any errors, that call, though it might take an instant to run, should give us a route object. This object is rather hard to read. That can be helped by using the <code>showRoute</code> function which will show a route as a list of coordinates.</p>
<p>You can also pass multiple routes to <code>showRoute</code>, which can be useful when you are, for example, trying to plan a scenic route, which must include the beautiful viewpoint at (<code>11</code>, <code>17</code>).</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">traverseRoute <span class="kw">=</span> <span class="fu">(routes..., func) -&gt;</span><br />  _<span class="kw">.</span>each <span class="kw">[</span>routes<span class="kw">...],</span> <span class="fu">(route) -&gt;</span><br />    <span class="kw">while</span> route<br />      func<br />        x<span class="kw">:</span> route<span class="kw">.</span>point<span class="kw">.</span>x<br />        y<span class="kw">:</span> route<span class="kw">.</span>point<span class="kw">.</span>y<br />      route <span class="kw">=</span> route<span class="kw">.</span>from<br /><br />showRoute <span class="kw">=</span> <span class="fu">(routes...) -&gt;</span><br />  traverseRoute routes<span class="kw">...,</span> show<br /><br />runOnDemand <span class="fu">-&gt;</span><br />  show <span class="st">'\n   Easy route'</span><br />  showRoute route<br />  show <span class="st">'\n   Sightseeing'</span><br />  showRoute findRoute<span class="kw">(</span>point<span class="kw">(</span> <span class="dv">0</span><span class="kw">,</span>  <span class="dv">0</span><span class="kw">),</span> point<span class="kw">(</span><span class="dv">11</span><span class="kw">,</span> <span class="dv">17</span><span class="kw">)),</span><br />            findRoute<span class="kw">(</span>point<span class="kw">(</span><span class="dv">11</span><span class="kw">,</span> <span class="dv">17</span><span class="kw">),</span> point<span class="kw">(</span><span class="dv">19</span><span class="kw">,</span> <span class="dv">19</span><span class="kw">))</span></code></pre>
<p>If the order the points were listed in were difficult to follow then the list can be refined. Sorting it and removing duplicates can help.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">showSortedRoute <span class="kw">=</span> <span class="fu">(routes...) -&gt;</span><br />  points <span class="kw">=</span> <span class="kw">[]</span><br />  traverseRoute routes<span class="kw">...,</span> <span class="fu">(point) -&gt;</span> points<span class="kw">.</span>push point<br />  <span class="co"># A sort needs a function that compares two points </span><br />  <span class="co"># Pattern matching can decompose them into unique names</span><br />  points<span class="kw">.</span>sort <span class="fu">({x:x1, y:y1}, {x:x2, y:y2}) -&gt;</span><br />    <span class="kw">return</span> dx <span class="kw">if</span> dx <span class="kw">=</span> x1 <span class="kw">-</span> x2<br />    <span class="kw">return</span> dy <span class="kw">if</span> dy <span class="kw">=</span> y1 <span class="kw">-</span> y2<br />    <span class="dv">0</span><br />  <span class="co"># The Underscore uniq function can get rid of doublets with</span><br />  <span class="co"># help from a function that serializes the relevant properties</span><br />  points <span class="kw">=</span> _<span class="kw">.</span>uniq points<span class="kw">,</span> <span class="ot">true</span><span class="kw">,</span> <span class="fu">({x, y}) -&gt;</span> <span class="st">&quot;</span><span class="ch">#{</span>x<span class="ch">}</span><span class="st"> </span><span class="ch">#{</span>y<span class="ch">}</span><span class="st">&quot;</span><br />  show point <span class="kw">for</span> point <span class="kw">in</span> points<br /><br />runOnDemand <span class="fu">-&gt;</span><br />  showSortedRoute findRoute<span class="kw">(</span>point<span class="kw">(</span> <span class="dv">0</span><span class="kw">,</span>  <span class="dv">0</span><span class="kw">),</span> point<span class="kw">(</span><span class="dv">11</span><span class="kw">,</span> <span class="dv">17</span><span class="kw">)),</span><br />                  findRoute<span class="kw">(</span>point<span class="kw">(</span><span class="dv">11</span><span class="kw">,</span> <span class="dv">17</span><span class="kw">),</span> point<span class="kw">(</span><span class="dv">19</span><span class="kw">,</span> <span class="dv">19</span><span class="kw">))</span></code></pre>
</section>
<section id="section-192">
<h5>○•○</h5>
<p>You can also display routes on a map with a function like <code>renderRoute</code>. A web page with a map is created and the route points are used to create and position a series of small images. You can return later to the techniques that are used in its implementation. They are presented in the next chapters: objects in <a href="#object-oriented-programming">Object Orientation↓</a>, CoffeeKup in <a href="#modularity">Modularity↓</a> and pattern matching in <a href="#language-extras">Language Extras↓</a>.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">renderRoute <span class="kw">=</span> <span class="fu">(routes...) -&gt;</span><br />  kup <span class="kw">=</span> <span class="kw">if</span> exports<span class="kw">?</span> <span class="kw">then</span> require <span class="st">'coffeekup'</span> <span class="kw">else</span> window<span class="kw">.</span>CoffeeKup<br /><br />  webdesign <span class="kw">=</span> <span class="fu">-&gt;</span><br />    doctype <span class="dv">5</span><br />    html <span class="fu">-&gt;</span><br />      head <span class="fu">-&gt;</span><br />        style <span class="st">'.map {position: absolute; left: 33px; top: 80px}'</span><br />      body <span class="fu">-&gt;</span><br />        header <span class="fu">-&gt;</span> h1 <span class="st">'Route'</span><br />        div <span class="kw">class</span><span class="dt">:</span> <span class="st">'map'</span><span class="kw">,</span> <span class="fu">-&gt;</span><br />          img src<span class="kw">:</span> <span class="st">'http://autotelicum.github.com/'</span> <span class="kw">+</span><br />                   <span class="st">'Smooth-CoffeeScript/img/height-small.png'</span><br />          img <span class="kw">class</span><span class="dt">:</span> <span class="st">'map'</span><span class="kw">,</span> src<span class="kw">:</span> <span class="st">&quot;</span><span class="ch">#{</span>ostrich<span class="ch">}</span><span class="st">&quot;</span><span class="kw">,</span>  width<span class="kw">:</span> size<span class="kw">,</span> height<span class="kw">:</span> size<span class="kw">,</span> \<br />              style<span class="kw">:</span> <span class="st">&quot;left: </span><span class="ch">#{</span>x*size<span class="ch">}</span><span class="st">px; top: </span><span class="ch">#{</span>y*size<span class="ch">}</span><span class="st">px&quot;</span> <span class="kw">for</span> <span class="kw">{</span>x<span class="kw">,</span> y<span class="kw">}</span> <span class="kw">in</span> points<br /><br />  points <span class="kw">=</span> <span class="kw">[]</span><br />  traverseRoute routes<span class="kw">...,</span> <span class="fu">(point) -&gt;</span> points<span class="kw">.</span>push point<br />  routePage <span class="kw">=</span> kup<span class="kw">.</span>render webdesign<span class="kw">,</span><br />    locals<span class="kw">:</span><br />      size<span class="kw">:</span> <span class="dv">500</span> <span class="kw">/</span> <span class="dv">20</span> <span class="co"># Square map: size divided by fields</span><br />      points<span class="kw">:</span> points<br />  showDocument routePage<span class="kw">,</span> <span class="dv">565</span><span class="kw">,</span> <span class="dv">600</span><br />  <span class="kw">return</span><br /><br />runOnDemand <span class="fu">-&gt;</span><br />  renderRoute findRoute<span class="kw">(</span>point<span class="kw">(</span> <span class="dv">0</span><span class="kw">,</span>  <span class="dv">0</span><span class="kw">),</span> point<span class="kw">(</span><span class="dv">11</span><span class="kw">,</span> <span class="dv">17</span><span class="kw">)),</span><br />              findRoute<span class="kw">(</span>point<span class="kw">(</span><span class="dv">11</span><span class="kw">,</span> <span class="dv">17</span><span class="kw">),</span> point<span class="kw">(</span><span class="dv">19</span><span class="kw">,</span> <span class="dv">19</span><span class="kw">))</span><br />  renderRoute findRoute<span class="kw">(</span>point<span class="kw">(</span> <span class="dv">0</span><span class="kw">,</span>  <span class="dv">0</span><span class="kw">),</span> point<span class="kw">(</span><span class="dv">15</span><span class="kw">,</span>  <span class="dv">3</span><span class="kw">)),</span><br />              findRoute<span class="kw">(</span>point<span class="kw">(</span><span class="dv">15</span><span class="kw">,</span>  <span class="dv">3</span><span class="kw">),</span> point<span class="kw">(</span><span class="dv">19</span><span class="kw">,</span> <span class="dv">19</span><span class="kw">))</span></code></pre>
<p>There is a different implementation in the source download: A web page with the map is served to your browser, then the route points are transferred via WebSockets to a snippet of CoffeeScript on the page that uses a canvas to draw the points on top of the map. There is more on that kind of thing in <a href="#modularity">Modularity↓</a>. The map looks like this:</p>
<p align=center><img src="../img/scenic-small.png" alt="figure ../img/scenic-small.png" /><br /></p>
</section>
<section id="view-solution-39" onclick="reveal(this)" >
<h5>View Solution</h5>
<section id="section-193" style="display:none" >
<h6></h6>
<p>A route canvas client that connects to a <code>WebSocket</code>. It draws a red disc when it receives a string message. It assumes the message has two numbers with a space in-between and uses those numbers to position the disc.</p>
<pre class="sourceCode"><code class="sourceCode COFFEESCRIPT">webpage <span class="kw">=</span> kup<span class="kw">.</span>render <span class="fu">-&gt;</span><br />  doctype <span class="dv">5</span><br />  html <span class="fu">-&gt;</span><br />    head <span class="fu">-&gt;</span><br />      meta charset<span class="kw">:</span> <span class="st">'utf-8'</span><br />      title <span class="st">'Route'</span><br />      style <span class="st">'''</span><br /><span class="st">        body {font-family: sans-serif}</span><br /><span class="st">        header, nav, section, footer {display: block}</span><br /><span class="st">        #background {position: absolute; top: 80px; left: 20px}</span><br /><span class="st">        #drawCanvas {position: absolute; top: 0px; left: 0px}</span><br /><span class="st">      '''</span><br />      coffeescript <span class="fu">-&gt;</span><br />        wsUri <span class="kw">=</span> <span class="st">'ws://localhost:8080/'</span><br />        show <span class="kw">=</span> <span class="fu">(msg) -&gt;</span> <span class="ot">console</span><span class="kw">.</span>log msg<br />        circle <span class="kw">=</span> <span class="fu">(ctx, x, y) -&gt;</span><br />          ctx<span class="kw">.</span>strokeStyle <span class="kw">=</span> <span class="st">'rgba(255,40,20,1)'</span><br />          ctx<span class="kw">.</span>fillStyle <span class="kw">=</span> <span class="st">'rgba(255,40,20,0.7)'</span><br />          ctx<span class="kw">.</span>shadowOffsetX <span class="kw">=</span> <span class="dv">5</span><br />          ctx<span class="kw">.</span>shadowOffsetY <span class="kw">=</span> <span class="dv">5</span><br />          ctx<span class="kw">.</span>shadowBlur <span class="kw">=</span> <span class="dv">10</span><br />          ctx<span class="kw">.</span>shadowColor <span class="kw">=</span> <span class="st">'black'</span><br />          ctx<span class="kw">.</span>beginPath<span class="kw">()</span><br />          ctx<span class="kw">.</span>arc x<span class="kw">*</span><span class="dv">30+15</span><span class="kw">,</span> y<span class="kw">*</span><span class="dv">30+15</span><span class="kw">,</span> <span class="dv">10</span><span class="kw">,</span> <span class="dv">0</span><span class="kw">,</span> <span class="dv">2</span><span class="kw">*</span><span class="ot">Math</span><span class="kw">.</span>PI<span class="kw">,</span> <span class="ot">false</span><br />          ctx<span class="kw">.</span>stroke<span class="kw">()</span><br />          ctx<span class="kw">.</span>fill<span class="kw">()</span><br />        window<span class="kw">.</span>onload <span class="kw">=</span> <span class="fu">-&gt;</span><br />          canvas <span class="kw">=</span> document<span class="kw">.</span>getElementById <span class="st">'drawCanvas'</span><br />          context <span class="kw">=</span> canvas<span class="kw">.</span>getContext <span class="st">'2d'</span><br />          websocket <span class="kw">=</span> <span class="kw">new</span> <span class="dt">WebSocket</span> wsUri<br />          websocket<span class="kw">.</span>onopen <span class="kw">=</span> <span class="fu">(evt) -&gt;</span> show evt<br />          websocket<span class="kw">.</span>onclose <span class="kw">=</span> <span class="fu">(evt) -&gt;</span> show evt<br />          websocket<span class="kw">.</span>onerror <span class="kw">=</span> <span class="fu">(evt) -&gt;</span> show evt<br />          websocket<span class="kw">.</span>onmessage <span class="kw">=</span> <span class="fu">(evt) -&gt;</span><br />            show evt<br />            vals <span class="kw">=</span> evt<span class="kw">.</span>data<span class="kw">.</span>split <span class="st">' '</span><br />            x <span class="kw">=</span> <span class="ot">parseInt</span> vals<span class="kw">[</span><span class="dv">0</span><span class="kw">],</span> <span class="dv">10</span><br />            y <span class="kw">=</span> <span class="ot">parseInt</span> vals<span class="kw">[</span><span class="dv">1</span><span class="kw">],</span> <span class="dv">10</span><br />            circle context<span class="kw">,</span> x<span class="kw">,</span> y<br />            <span class="kw">return</span><br />          <span class="kw">return</span><br />    body <span class="fu">-&gt;</span><br />      header <span class="fu">-&gt;</span> h1 <span class="st">'Route'</span><br />      div id<span class="kw">:</span> <span class="st">'background'</span><span class="kw">,</span> <span class="fu">-&gt;</span><br />        img src<span class="kw">:</span> <span class="st">'../img/height.png'</span><br />        canvas id<span class="kw">:</span> <span class="st">'drawCanvas'</span><span class="kw">,</span> width<span class="kw">:</span> <span class="dv">600</span><span class="kw">,</span> height<span class="kw">:</span> <span class="dv">600</span></code></pre>
<p>A route canvas server; it uses <code>createServer</code> and <code>listen</code> to create a minimal <code>WebSocket</code> server. A route canvas client is then created with <code>viewServer</code>. The <code>routes</code> are traversed when the client connects and the visited points are sent.</p>
<pre class="sourceCode"><code class="sourceCode COFFEESCRIPT">renderRoute <span class="kw">=</span> <span class="fu">(routes...) -&gt;</span><br />  wsHandler <span class="kw">=</span> <span class="fu">(websocket) -&gt;</span><br />    websocket<span class="kw">.</span><span class="ot">on</span> <span class="st">'connect'</span><span class="kw">,</span> <span class="fu">(resource) -&gt;</span><br />      traverseRoute routes<span class="kw">...,</span> <span class="fu">(point) -&gt;</span><br />        websocket<span class="kw">.</span>write <span class="st">&quot;</span><span class="ch">#{</span>point.x<span class="ch">}</span><span class="st"> </span><span class="ch">#{</span>point.y<span class="ch">}</span><span class="st">&quot;</span><br />  wsServer <span class="kw">=</span> ws<span class="kw">.</span>createServer wsHandler<br />  wsServer<span class="kw">.</span>listen <span class="dv">8080</span><br />  viewServer webpage<br /><br />renderRoute findRoute<span class="kw">(</span>point<span class="kw">(</span> <span class="dv">0</span><span class="kw">,</span>  <span class="dv">0</span><span class="kw">),</span> point<span class="kw">(</span><span class="dv">11</span><span class="kw">,</span> <span class="dv">17</span><span class="kw">)),</span><br />            findRoute<span class="kw">(</span>point<span class="kw">(</span><span class="dv">11</span><span class="kw">,</span> <span class="dv">17</span><span class="kw">),</span> point<span class="kw">(</span><span class="dv">19</span><span class="kw">,</span> <span class="dv">19</span><span class="kw">))</span></code></pre>
</section>
</section>
</section>
<section id="section-194">
<h4></h4>
<section id="section-195">
<h5>○•○</h5>
<p>Variations on the theme of search<a href="#index-search"></a>ing an optimal route through a graph can be applied to many problems, many of which are not at all related to finding a physical path. For example, a program that needs to solve a puzzle of fitting a number of blocks into a limited space could do this by exploring the various ‘paths’ it gets by trying to put a certain block in a certain place. The paths that ends up with insufficient room for the last blocks are dead ends, and the path that manages to fit in all blocks is the solution.</p>
<hr />
</section>
</section>
</section>
<section id="object-oriented-programming">
<h3>Object-oriented Programming</h3>
<hr />
<p>In the early nineties, a thing called object-oriented programming<a href="#index-object-oriented-programming"></a> stirred up the software industry. Most of the ideas behind it were not really new at the time, but they had finally gained enough momentum to start rolling, to become fashionable. Books were being written, courses given, programming languages developed. All of a sudden, everybody was extolling the virtues of object-orientation, enthusiastically applying it to every problem, convincing themselves they had finally found the <em>right way to write programs</em>.</p>
<p>These things happen a lot. When a process is hard and confusing, people are always on the lookout for a magic solution. When something looking like such a solution presents itself, they are prepared to become devoted followers. For many programmers — even today — object-orientation (or their view of it) is the gospel. When a program is not ‘truly object-oriented’, whatever that means, it is considered decidedly inferior.</p>
<p>Few fads have managed to stay popular for as long as this one, though. Object-orientation’s longevity can largely be explained by the fact that the ideas at its core are very solid and useful. In this chapter, we will discuss these ideas, along with CoffeeScript’s (rather succinct) take on them. The above paragraphs are by no means meant to discredit these ideas. What I want to do is warn the reader against developing an unhealthy attachment to them.</p>
<section id="section-196">
<h5>○•○</h5>
<p>As the name suggests, object-oriented programming is related to objects. The central ideas are encapsulation, inheritance, and higher-order programming (using the same names in different types aka polymorphism). So far, we have used objects as loose aggregations of values, adding and altering their properties whenever we saw fit. In an object-oriented approach, objects are viewed as little worlds of their own, and the outside world may touch them only through a limited and well-defined interface<a href="#index-interface"></a>, a number of specific methods and properties. The ‘reached list’ we used at the end of <a href="#searching">Searching↑</a> is an example of this: We used only three functions, <code>makeReachedList</code>, <code>storeReached</code>, and <code>findReached</code> to interact with it. These three functions form an interface for such objects.</p>
<p>The <code>Date</code>, <code>Error</code>, and <code>BinaryHeap</code> objects we have seen also work like this. Instead of providing regular functions for working with the objects, they provide a way to create such objects, using the <code>new</code> keyword, and a number of methods and properties that provide the rest of the interface.</p>
</section>
<section id="section-197">
<h5>○•○</h5>
<p>One way to give an object methods is to attach function values to it.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">rabbit <span class="kw">=</span> <span class="kw">{}</span><br />rabbit<span class="kw">.</span>speak <span class="kw">=</span> <span class="fu">(line) -&gt;</span><br />  show <span class="st">&quot;The rabbit says '</span><span class="ch">#{</span>line<span class="ch">}</span><span class="st">'&quot;</span><br />rabbit<span class="kw">.</span>speak <span class="st">&quot;Well, now you're asking me.&quot;</span></code></pre>
<p>In most cases, the method will need to know <em>who</em> it should act on. For example, if there are different rabbits, the <code>speak</code> method must indicate which rabbit is speaking. For this purpose, there is a special variable called <code>this</code><a href="#index-this"></a>, which is always present when a function is called, and which points at the relevant object when the function is called as a method. A function is called as a method when it is looked up as a property, and immediately called, as in <code>object.method()</code>. Since it is very common to use <code>this</code> inside an object, it can be abbreviated from <code>this.property</code> or <code>this.method()</code> to <code>@property</code> or <code>@method()</code>.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">speak <span class="kw">=</span> <span class="fu">(line) -&gt;</span><br />  show <span class="st">&quot;The </span><span class="ch">#{</span>this.adjective<span class="ch">}</span><span class="st"> rabbit says '</span><span class="ch">#{</span>line<span class="ch">}</span><span class="st">'&quot;</span><br /><br />whiteRabbit <span class="kw">=</span> adjective<span class="kw">:</span> <span class="st">&quot;white&quot;</span><span class="kw">,</span> speak<span class="kw">:</span> speak<br />fatRabbit <span class="kw">=</span> adjective<span class="kw">:</span> <span class="st">&quot;fat&quot;</span><span class="kw">,</span> speak<span class="kw">:</span> speak<br /><br />whiteRabbit<span class="kw">.</span>speak <span class="st">&quot;Oh my ears and whiskers, &quot;</span> <span class="kw">+</span><br />                  <span class="st">&quot;how late it's getting!&quot;</span><br />fatRabbit<span class="kw">.</span>speak <span class="st">&quot;I could sure use a carrot right now.&quot;</span></code></pre>
</section>
<section id="section-198">
<h5>○•○</h5>
<p>I can now clarify the mysterious first argument to the <code>apply</code><a href="#index-apply"></a> method, for which we always used <code>null</code> in <a href="#functional-programming">Functional Programming↑</a>. This argument can be used to specify the object that the function must be applied to. For non-method functions, this is irrelevant, hence the <code>null</code>.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">speak<span class="kw">.</span>apply fatRabbit<span class="kw">,</span> <span class="kw">[</span><span class="st">'Yum.'</span><span class="kw">]</span></code></pre>
<p>Functions also have a <code>call</code><a href="#index-call"></a> method, which is similar to <code>apply</code>, but you can give the arguments for the function separately instead of as an array:</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">speak<span class="kw">.</span>call fatRabbit<span class="kw">,</span> <span class="st">'Burp.'</span></code></pre>
</section>
<section id="section-199">
<h5>○•○</h5>
<p>It is common in object oriented terminology to refer to instances of something as an object. The <code>whiteRabbit</code> and <code>fatRabbit</code> can be seen as different instances of a more general <code>Rabbit</code> concept. In CoffeeScript such concepts are termed a <code>class</code><a href="#index-class"></a>.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false"><span class="kw">class</span> <span class="dt">Rabbit</span><br />  <span class="kw">constructor</span><span class="kw">:</span> <span class="fu">(@adjective) -&gt;</span><br />  speak<span class="kw">:</span> <span class="fu">(line) -&gt;</span><br />    show <span class="st">&quot;The </span><span class="ch">#{</span>@adjective<span class="ch">}</span><span class="st"> rabbit says '</span><span class="ch">#{</span>line<span class="ch">}</span><span class="st">'&quot;</span><br /><br />whiteRabbit <span class="kw">=</span> <span class="kw">new</span> <span class="dt">Rabbit</span> <span class="st">&quot;white&quot;</span><br />fatRabbit <span class="kw">=</span> <span class="kw">new</span> <span class="dt">Rabbit</span> <span class="st">&quot;fat&quot;</span><br /><br />whiteRabbit<span class="kw">.</span>speak <span class="st">&quot;Hurry!&quot;</span><br />fatRabbit<span class="kw">.</span>speak <span class="st">&quot;Tasty!&quot;</span></code></pre>
<p>It is a convention, among CoffeeScript programmers, to start the names of classes with a capital letter. This makes it easy to distinguish them from object instances and functions.</p>
</section>
<section id="section-200">
<h5>○•○</h5>
<p>The <code>new</code><a href="#index-new"></a> keyword provides a convenient way of creating new objects. When a function is called with the word <code>new</code> in front of it, its <code>this</code><a href="#index-this"></a> variable will point at a <em>new</em> object, which it will automatically return (unless it explicitly returns something else). Functions used to create new objects like this are called constructor<a href="#index-constructor"></a>s.</p>
<p>The constructor for the <code>Rabbit</code> class is <code>constructor: (@adjective) -&gt;</code>. The <code>@adjective</code> argument to the constructor does two things: It declares <code>adjective</code> as a property on <code>this</code> and it uses ‘pattern matching’ i.e. the same name to assign the argument named <code>adjective</code> to a property on <code>this</code> that is also named <code>adjective</code>. It could have been written in full form as <code>constructor: (adjective) -&gt; this.adjective = adjective</code>.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">killerRabbit <span class="kw">=</span> <span class="kw">new</span> <span class="dt">Rabbit</span> <span class="st">'killer'</span><br />killerRabbit<span class="kw">.</span>speak <span class="st">'GRAAAAAAAAAH!'</span><br />show killerRabbit</code></pre>
<p>When <code>new Rabbit</code> is called with the <code>'killer'</code> argument, the argument is assigned to a property named <code>adjective</code>. So <code>show killerRabbit</code> ⇒ <code>{adjective: 'killer'}</code>.</p>
<p>Why is the <code>new</code> keyword even necessary? After all, we could have simply written this:</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">makeRabbit <span class="kw">=</span> <span class="fu">(adjective) -&gt;</span><br />  adjective<span class="kw">:</span> adjective<br />  speak<span class="kw">:</span> <span class="fu">(line) -&gt;</span> show adjective <span class="kw">+</span> <span class="st">': '</span> <span class="kw">+</span> line<br />blackRabbit <span class="kw">=</span> makeRabbit <span class="st">'black'</span></code></pre>
<p>But that is not entirely the same. <code>new</code> does a few things behind the scenes. For one thing, our <code>killerRabbit</code> has a property called <code>constructor</code><a href="#index-constructor"></a>, which points at the <code>Rabbit</code> function that created it. <code>blackRabbit</code> also has such a property, but it points at the <code>Object</code><a href="#index-Object"></a> function. They even have <code>name</code> properties so we can check them:</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">show killerRabbit<span class="kw">.</span><span class="kw">constructor</span><span class="kw">.</span>name</code></pre>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">show blackRabbit<span class="kw">.</span><span class="kw">constructor</span><span class="kw">.</span>name</code></pre>
</section>
<section id="section-201">
<h5>○•○</h5>
<p>The objects that are created, <code>whiteRabbit</code> and <code>fatRabbit</code>, are specific instances. The <code>whiteRabbit</code> is not all kinds of white rabbits just a single one that happen to have the name whiteRabbit. If you want to create a class of say weight conscious rabbits then the <code>extends</code><a href="#index-extends"></a> keyword can help you accomplish that.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false"><span class="kw">class</span> <span class="dt">WeightyRabbit</span> <span class="kw">extends</span> <span class="dt">Rabbit</span><br />  <span class="kw">constructor</span><span class="kw">:</span> <span class="fu">(adjective, @weight) -&gt;</span><br />    <span class="kw">super</span> adjective<br />  adjustedWeight<span class="kw">:</span> <span class="fu">(relativeGravity) -&gt;</span><br />    <span class="kw">(</span><span class="dt">@weight</span> <span class="kw">*</span> relativeGravity<span class="kw">).</span>toPrecision <span class="dv">2</span><br /><br />tinyRabbit <span class="kw">=</span> <span class="kw">new</span> <span class="dt">WeightyRabbit</span> <span class="st">&quot;tiny&quot;</span><span class="kw">,</span> <span class="fl">1.01</span><br />jumboRabbit <span class="kw">=</span> <span class="kw">new</span> <span class="dt">WeightyRabbit</span> <span class="st">&quot;jumbo&quot;</span><span class="kw">,</span> <span class="fl">7.47</span><br /><br />moonGravity <span class="kw">=</span> <span class="dv">1</span><span class="kw">/</span><span class="dv">6</span><br />jumboRabbit<span class="kw">.</span>speak <span class="st">&quot;Carry me, I weigh </span><br /><span class="ch">#{</span>jumboRabbit.adjustedWeight(moonGravity)<span class="ch">}</span><span class="st"> stones&quot;</span><br />tinyRabbit<span class="kw">.</span>speak <span class="st">&quot;He ain't heavy, he is my brother&quot;</span></code></pre>
<p>The call <code>super adjective</code> passes the argument on to the <code>Rabbit</code> constructor. A method in a derived class can with <code>super</code><a href="#index-super"></a> call upon a method of the same name in its parent class.</p>
</section>
<section id="section-202">
<h5>○•○</h5>
<p>Inheritance is useful because different types can share a single implementation of an algorithm. But it comes with a price-tag: the derived classes become tightly coupled to the parent class. Normally you make each part of a system as independent as possible, for example avoiding global variables and using arguments instead. That way you can read and understand each part in isolation and you can change them with little risk of breaking other parts of the system.</p>
<p>Due to the tight coupling that inheritance introduces it can be difficult to change a parent class without inadvertently risk breaking derived classes. This is called the fragile base class<a href="#index-fragile-base-class"></a> problem. A class that has no child classes and is only used through its published methods and properties can normally be changed quite freely — as long as the published methods and properties stay the same. When a class derives from it, then the child class may depend on the internal behaviour of the parent and it becomes problematic to change the base class.</p>
<p>To understand a derived class you will often have to understand the parent first. The implementation is distributed, instead of reading down through a function, you may have to look in different places where a class and its parent and their parent… implement each their part of the combined logic. Lets look at an example that matters — the balance on your bank account.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false"><span class="kw">class</span> <span class="dt">Account</span><br />  <span class="kw">constructor</span><span class="kw">:</span> <span class="fu">-&gt;</span> <span class="dt">@balance</span> <span class="kw">=</span> <span class="dv">0</span><br />  transfer<span class="kw">:</span> <span class="fu">(amount) -&gt;</span> <span class="dt">@balance</span> <span class="kw">+=</span> amount<br />  getBalance<span class="kw">:</span> <span class="fu">-&gt;</span> <span class="dt">@balance</span><br />  batchTransfer<span class="kw">:</span> <span class="fu">(amtList) -&gt;</span><br />    <span class="kw">for</span> amount <span class="kw">in</span> amtList<br />      <span class="dt">@transfer</span> amount<br /><br />yourAccount <span class="kw">=</span> <span class="kw">new</span> <span class="dt">Account</span><span class="kw">()</span><br />oldBalance <span class="kw">=</span> yourAccount<span class="kw">.</span>getBalance<span class="kw">()</span><br />yourAccount<span class="kw">.</span>transfer salary <span class="kw">=</span> <span class="dv">1000</span><br />newBalance <span class="kw">=</span> yourAccount<span class="kw">.</span>getBalance<span class="kw">()</span><br />show <span class="st">&quot;Books balance:</span><br /><span class="st"> </span><span class="ch">#{</span>salary is newBalance - oldBalance<span class="ch">}</span><span class="st">.&quot;</span></code></pre>
<p>Hopefully this only shows the principle of how your bank has implemented its accounts. An account starts out with a zero balance, money can be credited (positive transfer) and debited (negative transfer), the balance can be shown and multiple transfers can be handled.</p>
<p>Other parts of the system can balance the books by checking that transfers match the differences on the accounts. Those parts of the system were unfortunately not known to the developer of the <code>AccountWithFee</code> class.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false"><span class="kw">class</span> <span class="dt">AccountWithFee</span> <span class="kw">extends</span> <span class="dt">Account</span><br />  fee<span class="kw">:</span> <span class="dv">5</span><br />  transfer<span class="kw">:</span> <span class="fu">(amount) -&gt;</span><br />    <span class="kw">super</span> amount <span class="kw">-</span> <span class="dt">@fee</span><br />    <span class="co"># feeAccount.transfer @fee</span><br /><br />yourAccount <span class="kw">=</span> <span class="kw">new</span> <span class="dt">AccountWithFee</span><span class="kw">()</span><br />oldBalance <span class="kw">=</span> yourAccount<span class="kw">.</span>getBalance<span class="kw">()</span><br />yourAccount<span class="kw">.</span>transfer salary <span class="kw">=</span> <span class="dv">1000</span><br />newBalance <span class="kw">=</span> yourAccount<span class="kw">.</span>getBalance<span class="kw">()</span><br />show <span class="st">&quot;Books balance:</span><br /><span class="st"> </span><span class="ch">#{</span>salary is newBalance - oldBalance<span class="ch">}</span><span class="st">.&quot;</span></code></pre>
<p>The books no longer balance. The issue is that the <code>AccountWithFee</code> class has violated what is called the substitution principle<a href="#index-substitution-principle"></a>. It is a patch of the existing <code>Account</code> class and it breaks programs that assume that all account classes behave in a certain way. In a system with thousands of classes such patches can cause severe problems. To avoid this kind of problem it is up to the developer to ensure that inherited classes can fully substitute their parent classes.</p>
<p>To avoid excessive fraudulent transactions when a card is lost or stolen, the bank has implemented a system which checks that withdrawals do not exceed a daily limit. The <code>LimitedAccount</code> class checks each <code>transfer</code>, reduces the <code>@dailyLimit</code> and reports an error if it is exceeded.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false"><span class="kw">class</span> <span class="dt">LimitedAccount</span> <span class="kw">extends</span> <span class="dt">Account</span><br />  <span class="kw">constructor</span><span class="kw">:</span> <span class="fu">-&gt;</span> <span class="kw">super</span><span class="kw">;</span> <span class="dt">@resetLimit</span><span class="kw">()</span><br />  resetLimit<span class="kw">:</span> <span class="fu">-&gt;</span> <span class="dt">@dailyLimit</span> <span class="kw">=</span> <span class="dv">50</span><br />  transfer<span class="kw">:</span> <span class="fu">(amount) -&gt;</span><br />    <span class="kw">if</span> amount <span class="kw">&lt;</span> <span class="dv">0</span> <span class="kw">and</span> <span class="kw">(</span><span class="dt">@dailyLimit</span> <span class="kw">+=</span> amount<span class="kw">)</span> <span class="kw">&lt;</span> <span class="dv">0</span><br />      <span class="kw">throw</span> <span class="kw">new</span> <span class="dt">Error</span> <span class="st">&quot;You maxed out!&quot;</span><br />    <span class="kw">else</span><br />      <span class="kw">super</span> amount<br />lacc <span class="kw">=</span> <span class="kw">new</span> <span class="dt">LimitedAccount</span><span class="kw">()</span><br />lacc<span class="kw">.</span>transfer <span class="dv">50</span><br />show <span class="st">&quot;Start balance </span><span class="ch">#{</span>lacc.getBalance()<span class="ch">}</span><span class="st">&quot;</span><br /><br /><span class="kw">try</span> lacc<span class="kw">.</span>batchTransfer <span class="kw">[-</span><span class="dv">1</span><span class="kw">..-</span><span class="dv">10</span><span class="kw">]</span><br /><span class="kw">catch</span> error <span class="kw">then</span> show error<span class="kw">.</span>message<br />show <span class="st">&quot;After batch balance </span><span class="ch">#{</span>lacc.getBalance()<span class="ch">}</span><span class="st">&quot;</span></code></pre>
<p>Your bank is so successful that <code>batchTransfer</code> has to be speeded up (a real version would involve database updates). The developer, that got the task of making <code>batchTransfer</code> faster, had been on vacation when the <code>LimitedAccount</code> class was implemented and did not see it among the thousands of other classes in the system.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false"><span class="kw">class</span> <span class="dt">Account</span><br />  <span class="kw">constructor</span><span class="kw">:</span> <span class="fu">-&gt;</span> <span class="dt">@balance</span> <span class="kw">=</span> <span class="dv">0</span><br />  transfer<span class="kw">:</span> <span class="fu">(amount) -&gt;</span> <span class="dt">@balance</span> <span class="kw">+=</span> amount<br />  getBalance<span class="kw">:</span> <span class="fu">-&gt;</span> <span class="dt">@balance</span><br />  batchTransfer<span class="kw">:</span> <span class="fu">(amtList) -&gt;</span><br />    add <span class="kw">=</span> <span class="fu">(a,b) -&gt;</span> a<span class="kw">+</span>b<br />    sum <span class="kw">=</span> <span class="fu">(list) -&gt;</span> _<span class="kw">.</span>reduce list<span class="kw">,</span> add<span class="kw">,</span> <span class="dv">0</span><br />    <span class="dt">@balance</span> <span class="kw">+=</span> sum amtList<br /><br /><span class="kw">class</span> <span class="dt">LimitedAccount</span> <span class="kw">extends</span> <span class="dt">Account</span><br />  <span class="kw">constructor</span><span class="kw">:</span> <span class="fu">-&gt;</span> <span class="kw">super</span><span class="kw">;</span> <span class="dt">@resetLimit</span><span class="kw">()</span><br />  resetLimit<span class="kw">:</span> <span class="fu">-&gt;</span> <span class="dt">@dailyLimit</span> <span class="kw">=</span> <span class="dv">50</span><br />  transfer<span class="kw">:</span> <span class="fu">(amount) -&gt;</span><br />    <span class="kw">if</span> amount <span class="kw">&lt;</span> <span class="dv">0</span> <span class="kw">and</span> <span class="kw">(</span><span class="dt">@dailyLimit</span> <span class="kw">+=</span> amount<span class="kw">)</span> <span class="kw">&lt;</span> <span class="dv">0</span><br />      <span class="kw">throw</span> <span class="kw">new</span> <span class="dt">Error</span> <span class="st">&quot;You maxed out!&quot;</span><br />    <span class="kw">else</span><br />      <span class="kw">super</span> amount<br /><br />lacc <span class="kw">=</span> <span class="kw">new</span> <span class="dt">LimitedAccount</span><span class="kw">()</span><br />lacc<span class="kw">.</span>transfer <span class="dv">50</span><br />show <span class="st">&quot;Starting with </span><span class="ch">#{</span>lacc.getBalance()<span class="ch">}</span><span class="st">&quot;</span><br /><br /><span class="kw">try</span> lacc<span class="kw">.</span>batchTransfer <span class="kw">[-</span><span class="dv">1</span><span class="kw">..-</span><span class="dv">10</span><span class="kw">]</span><br /><span class="kw">catch</span> error <span class="kw">then</span> show error<span class="kw">.</span>message<br />show <span class="st">&quot;After batch balance </span><span class="ch">#{</span>lacc.getBalance()<span class="ch">}</span><span class="st">&quot;</span></code></pre>
<p>Instead of the previous implementation that called <code>transfer</code> each time, the whole batch is added together and the balance is directly updated. That made <code>batchTransfer</code> much faster, but it also broke the <code>LimitedAccount</code> class. It is an example of the fragile base class<a href="#index-fragile-base-class"></a> problem. In this limited example it is easy to spot the issue, in a large system it can cause considerable headache.</p>
<p>Using inheritance in the right way requires careful and thoughtful programming. If your child classes are type compatible with their parent then you are adhering to the substitution principle. Usually using ownership is more appropriate, that is when a class has an instance of another class inside it and uses its public interface.</p>
<p>It is a common convention in CoffeeScript to use an <code>_</code> in front of methods that are to be considered private.</p>
</section>
<section id="section-203">
<h5>○•○</h5>
<p>Where did the <code>constructor</code> property come from? It is part of the prototype<a href="#index-prototype"></a> of a rabbit. Prototypes are a powerful, if somewhat confusing, part of the way CoffeeScript objects work. Every object is based on a prototype, which gives it a set of inherent properties. Simple objects are based on the most basic prototype, which is associated with the <code>Object</code> constructor. In fact, typing <code>{}</code> is equivalent to typing <code>new Object()</code>.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">simpleObject <span class="kw">=</span> <span class="kw">{}</span><br />show simpleObject<span class="kw">.</span><span class="kw">constructor</span><span class="kw">.</span>name<br />show simpleObject<span class="kw">.</span>toString<span class="kw">()</span></code></pre>
<p><code>toString</code><a href="#index-toString"></a> is a method that is part of the <code>Object</code> prototype. This means that all simple objects have a <code>toString</code> method, which converts them to a string. Our rabbit objects are based on the prototype associated with the <code>Rabbit</code> constructor. You can use a constructor’s <code>prototype</code> property to get access to, well, their prototype:</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">show _<span class="kw">.</span>methods Rabbit<br />show _<span class="kw">.</span>methods Rabbit<span class="kw">.</span>prototype<br />show Rabbit<span class="kw">.</span>prototype<span class="kw">.</span><span class="kw">constructor</span><span class="kw">.</span>name<br />Rabbit<span class="kw">.</span>prototype<span class="kw">.</span>speak <span class="st">'I am generic'</span> <br />Rabbit<span class="kw">::</span>speak <span class="st">'I am not initialized'</span></code></pre>
<p>Instead of <code>Rabbit.prototype.speak</code> you can write <code>Rabbit::speak</code>.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">Rabbit<span class="kw">::</span>speak <span class="st">'I am not initialized'</span></code></pre>
<p>Every function automatically gets a <code>prototype</code> property, whose <code>constructor</code> property points back at the function. Because the rabbit prototype is itself an object, it is based on the <code>Object</code> prototype, and shares its <code>toString</code>.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">show killerRabbit<span class="kw">.</span>toString <span class="kw">is</span> simpleObject<span class="kw">.</span>toString</code></pre>
</section>
<section id="section-204">
<h5>○•○</h5>
<p>Even though objects seem to share the properties of their prototype, this sharing is one-way. The properties of the prototype influence the object based on it, but the properties of this object never change the prototype.</p>
<p>The precise rules are this: When looking up the value of a property, CoffeeScript first looks at the properties that the object <em>itself</em> has. If there is a property that has the name we are looking for, that is the value we get. If there is no such property, it continues searching the prototype of the object, and then the prototype of the prototype, and so on. If no property is found, the value <code>undefined</code> is given. On the other hand, when <em>setting</em> the value of a property, CoffeeScript never goes to the prototype, but always sets the property in the object itself.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">Rabbit<span class="kw">::</span>teeth <span class="kw">=</span> <span class="st">'small'</span><br />show killerRabbit<span class="kw">.</span>teeth<br /><br />killerRabbit<span class="kw">.</span>teeth <span class="kw">=</span> <span class="st">'long, sharp, and bloody'</span><br />show killerRabbit<span class="kw">.</span>teeth<br /><br />show Rabbit<span class="kw">::</span>teeth</code></pre>
<p>This does mean that the prototype can be be used at any time to add new properties and methods to all objects based on it. For example, it might become necessary for our rabbits to dance.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">Rabbit<span class="kw">::</span>dance <span class="kw">=</span> <span class="fu">-&gt;</span><br />  show <span class="st">&quot;The </span><span class="ch">#{</span>@adjective<span class="ch">}</span><span class="st"> rabbit dances a jig.&quot;</span><br />killerRabbit<span class="kw">.</span>dance<span class="kw">()</span></code></pre>
<p>And, as you might have guessed, the prototypical rabbit is the perfect place for values that all rabbits have in common, such as the <code>speak</code> method. Here is a new approach to the <code>Rabbit</code> constructor:</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">Rabbit <span class="kw">=</span> <span class="fu">(adjective) -&gt;</span><br />  <span class="dt">@adjective</span> <span class="kw">=</span> adjective<br /><br />Rabbit<span class="kw">::</span>speak <span class="kw">=</span> <span class="fu">(line) -&gt;</span><br />  show <span class="st">&quot;The </span><span class="ch">#{</span>@adjective<span class="ch">}</span><span class="st"> rabbit says '</span><span class="ch">#{</span>line<span class="ch">}</span><span class="st">'&quot;</span><br /><br />hazelRabbit <span class="kw">=</span> <span class="kw">new</span> <span class="dt">Rabbit</span> <span class="st">&quot;hazel&quot;</span><br />hazelRabbit<span class="kw">.</span>speak <span class="st">&quot;Good Frith!&quot;</span></code></pre>
</section>
<section id="section-205">
<h5>○•○</h5>
<p>The fact that all objects have a prototype and receive some properties from this prototype can be tricky. It means that using an object to store a set of things, such as the cats from <a href="#data-structures-objects-and-arrays">Data Structures↑</a>, can go wrong. If, for example, we wondered whether there is a cat called <code>'constructor'</code>, we would have checked it like this:</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">noCatsAtAll <span class="kw">=</span> <span class="kw">{}</span><br /><span class="kw">if</span> <span class="st">&quot;constructor&quot;</span> <span class="kw">of</span> noCatsAtAll<br />  show <span class="st">&quot;Yes, there is a cat called 'constructor'.&quot;</span></code></pre>
<p>This is problematic. A related problem is that it can often be practical to extend the prototypes of standard constructors such as <code>Object</code> and <code>Array</code> with new useful functions. For example, we could give all objects a method called <code>allProperties</code>, which returns an array with the names of the (non-hidden) properties that the object has:</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false"><span class="ot">Object</span><span class="kw">::</span>allProperties <span class="kw">=</span> <span class="fu">-&gt;</span><br />  <span class="kw">for</span> property <span class="kw">of</span> <span class="dt">this</span><br />    property<br /><br />test <span class="kw">=</span> x<span class="kw">:</span> <span class="dv">10</span><span class="kw">,</span> y<span class="kw">:</span> <span class="dv">3</span><br />show test<span class="kw">.</span>allProperties<span class="kw">()</span><br /><span class="kw">delete</span> <span class="ot">Object</span><span class="kw">::</span>allProperties</code></pre>
<p>And that immediately shows the problem. Now that the <code>Object</code> prototype has a property called <code>allProperties</code>, looping over the properties of any object, using <code>for</code> and <code>of</code><a href="#index-of"></a>, will also give us that shared property, which is generally not what we want. We are interested only in the properties that the object itself has.</p>
<p>Fortunately, there is a way to find out whether a property belongs to the object itself or to one of its prototypes. Every object has a method called <code>hasOwnProperty</code><a href="#index-hasOwnProperty"></a>, which tells us whether the object has a property with a given name. When looping over the properties of an object CoffeeScript provides a keyword <code>own</code> so we are saved from using a clumsy <code>if</code> test on each property. Using <code>own</code>, we can write an <code>ownProperties</code> method like this:</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false"><span class="ot">Object</span><span class="kw">::</span>ownProperties <span class="kw">=</span> <span class="fu">-&gt;</span><br />  <span class="kw">for</span> own property <span class="kw">of</span> <span class="dt">this</span><br />    property<br /><br />test <span class="kw">=</span> <span class="st">'Fat Igor'</span><span class="kw">:</span> <span class="ot">true</span><span class="kw">,</span> <span class="st">'Fireball'</span><span class="kw">:</span> <span class="ot">true</span><br />show test<span class="kw">.</span>ownProperties<span class="kw">()</span><br /><span class="kw">delete</span> <span class="ot">Object</span><span class="kw">::</span>ownProperties</code></pre>
<p><a href="#index-forEachOf"></a>And of course, we can abstract that into a higher-order function. Note that the <code>action</code> function is called with both the name of the property and the value it has in the object.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">forEachOf <span class="kw">=</span> <span class="fu">(object, action) -&gt;</span><br />  <span class="kw">for</span> own property<span class="kw">,</span> value <span class="kw">of</span> object<br />    action property<span class="kw">,</span> value<br /><br />chimera <span class="kw">=</span> head<span class="kw">:</span> <span class="st">&quot;lion&quot;</span><span class="kw">,</span> body<span class="kw">:</span> <span class="st">&quot;goat&quot;</span><span class="kw">,</span> tail<span class="kw">:</span> <span class="st">&quot;snake&quot;</span><br />forEachOf chimera<span class="kw">,</span> <span class="fu">(name, value) -&gt;</span><br />  view <span class="st">&quot;The </span><span class="ch">#{</span>name<span class="ch">}</span><span class="st"> of a </span><span class="ch">#{</span>value<span class="ch">}</span><span class="st">.&quot;</span></code></pre>
<p>But, what if we find a cat named <code>hasOwnProperty</code>? (You never know.) It will be stored in the object, and the next time we want to go over the collection of cats, calling <code>object.hasOwnProperty</code> will fail, because that property no longer points at a function value. This can be solved by doing something ugly:</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">forEachIn <span class="kw">=</span> <span class="fu">(object, action) -&gt;</span><br />  <span class="kw">for</span> property <span class="kw">of</span> object<br />    <span class="kw">if</span> <span class="ot">Object</span><span class="kw">::</span>hasOwnProperty<span class="kw">.</span>call object<span class="kw">,</span> property<br />      action property<span class="kw">,</span> object<span class="kw">[</span>property<span class="kw">]</span><br /><br />test <span class="kw">=</span> name<span class="kw">:</span> <span class="st">&quot;Mordecai&quot;</span><span class="kw">,</span> hasOwnProperty<span class="kw">:</span> <span class="st">&quot;Uh-oh&quot;</span><br />forEachIn test<span class="kw">,</span> <span class="fu">(name, value) -&gt;</span><br />  view <span class="st">&quot;Property </span><span class="ch">#{</span>name<span class="ch">}</span><span class="st"> = </span><span class="ch">#{</span>value<span class="ch">}</span><span class="st">&quot;</span></code></pre>
<p>Here, instead of using the method found in the object itself, we get the method from the <code>Object</code> prototype, and then use <code>call</code> to apply it to the right object. Unless someone actually messes with the <code>Object.prototype</code> method (do not do that), this should work correctly.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">test <span class="kw">=</span> name<span class="kw">:</span> <span class="st">&quot;Mordecai&quot;</span><span class="kw">,</span> hasOwnProperty<span class="kw">:</span> <span class="st">&quot;Uh-oh&quot;</span><br /><span class="kw">for</span> own property<span class="kw">,</span> value <span class="kw">of</span> test<br />  show <span class="st">&quot;Property </span><span class="ch">#{</span>property<span class="ch">}</span><span class="st"> = </span><span class="ch">#{</span>value<span class="ch">}</span><span class="st">&quot;</span></code></pre>
<p>Fortunately the <code>own</code> keyword saves the day even in this situation, so it is the right thing to use.</p>
</section>
<section id="section-206">
<h5>○•○</h5>
<p><code>hasOwnProperty</code> can also be used in those situations where we have been using the <code>of</code><a href="#index-of"></a> operator to see whether an object has a specific property. There is one more catch, however. We saw in <a href="#data-structures-objects-and-arrays">Data Structures↑</a> that some properties, such as <code>toString</code>, are ‘hidden’, and do not show up when going over properties with <code>for</code>/<code>of</code>. It turns out that browsers in the Gecko family (Firefox, most importantly) give every object a hidden property named <code>__proto__</code>, which points to the prototype of that object. <code>hasOwnProperty</code> will return <code>true</code> for this one, even though the program did not explicitly add it. Having access to the prototype of an object can be very convenient, but making it a property like that was not a very good idea. Still, Firefox is a widely used browser, so when you write a program for the web you have to be careful with this.</p>
<p>The advice here is <em>not</em> to name any of your own properties with double underscore since they then can clash with system specific details like <code>__proto__</code>. As mentioned before identifiers beginning with one underscore is fine and used to indicate something private to your implementation. There is a method <code>propertyIsEnumerable</code><a href="#index-propertyIsEnumerable"></a>, which returns <code>false</code> for hidden properties, and which can be used to filter out strange things like <code>__proto__</code>. An expression such as this one can be used to reliably work around this:</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">obj <span class="kw">=</span> foo<span class="kw">:</span> <span class="st">'bar'</span><br /><br /><span class="co"># This test is needed to avoid hidden properties ...</span><br />show <span class="ot">Object</span><span class="kw">::</span>hasOwnProperty<span class="kw">.</span>call<span class="kw">(</span>obj<span class="kw">,</span> <span class="st">'foo'</span><span class="kw">)</span> <span class="kw">and</span><br />     <span class="ot">Object</span><span class="kw">::</span>propertyIsEnumerable<span class="kw">.</span>call<span class="kw">(</span>obj<span class="kw">,</span> <span class="st">'foo'</span><span class="kw">)</span><br /><span class="co"># ... because this returns true ...</span><br />show <span class="ot">Object</span><span class="kw">::</span>hasOwnProperty<span class="kw">.</span>call<span class="kw">(</span>obj<span class="kw">,</span> <span class="st">'__proto__'</span><span class="kw">)</span><br /><span class="co"># ... this is required to get false.</span><br />show <span class="ot">Object</span><span class="kw">::</span>hasOwnProperty<span class="kw">.</span>call<span class="kw">(</span>obj<span class="kw">,</span> <span class="st">'__proto__'</span><span class="kw">)</span> <span class="kw">and</span><br />     <span class="ot">Object</span><span class="kw">::</span>propertyIsEnumerable<span class="kw">.</span>call<span class="kw">(</span>obj<span class="kw">,</span> <span class="st">'__proto__'</span><span class="kw">)</span></code></pre>
<p>Nice and simple, no? This is one of the not-so-well-designed aspects of the system underlying CoffeeScript (recondite JavaScript). Objects play both the role of ‘values with methods’, for which prototypes work great, and ‘sets of properties’, for which prototypes only get in the way.</p>
</section>
<section id="section-207">
<h5>○•○</h5>
<p>Writing the above kind of expression every time you need to check whether a property is present in an object is unworkable. We could put it into a function, but a better approach is to write a constructor and a prototype specifically for situations like this, where we want to approach an object as just a set of properties. Because you can use it to look things up by name, we will call it a <code>Dictionary</code><a href="#index-Dictionary"></a>.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false"><span class="kw">class</span> <span class="dt">Dictionary</span><br />  <span class="kw">constructor</span><span class="kw">:</span> <span class="fu">(@values = {}) -&gt;</span><br /><br />  store<span class="kw">:</span> <span class="fu">(name, value) -&gt;</span><br />    <span class="dt">@values</span><span class="kw">[</span>name<span class="kw">]</span> <span class="kw">=</span> value<br /><br />  lookup<span class="kw">:</span> <span class="fu">(name) -&gt;</span><br />    <span class="dt">@values</span><span class="kw">[</span>name<span class="kw">]</span><br /><br />  contains<span class="kw">:</span> <span class="fu">(name) -&gt;</span><br />    <span class="ot">Object</span><span class="kw">::</span>hasOwnProperty<span class="kw">.</span>call<span class="kw">(</span><span class="dt">@values</span><span class="kw">,</span> name<span class="kw">)</span> <span class="kw">and</span><br />    <span class="ot">Object</span><span class="kw">::</span>propertyIsEnumerable<span class="kw">.</span>call<span class="kw">(</span><span class="dt">@values</span><span class="kw">,</span> name<span class="kw">)</span><br /><br />  each<span class="kw">:</span> <span class="fu">(action) -&gt;</span><br />    <span class="kw">for</span> own property<span class="kw">,</span> value <span class="kw">of</span> <span class="dt">@values</span><br />      action property<span class="kw">,</span> value<br /><br />colours <span class="kw">=</span> <span class="kw">new</span> <span class="dt">Dictionary</span><br />  Grover<span class="kw">:</span> <span class="st">'blue'</span><br />  Elmo<span class="kw">:</span>   <span class="st">'orange'</span><br />  Bert<span class="kw">:</span>   <span class="st">'yellow'</span><br /><br />show colours<span class="kw">.</span>contains <span class="st">'Grover'</span><br />colours<span class="kw">.</span>each <span class="fu">(name, colour) -&gt;</span><br />  view name <span class="kw">+</span> <span class="st">' is '</span> <span class="kw">+</span> colour</code></pre>
<p>Now the whole mess related to approaching objects as plain sets of properties has been ‘encapsulated’ in a convenient interface: one constructor and four methods. Note that the <code>values</code> property of a <code>Dictionary</code> object is not part of this interface, it is an internal detail, and when you are using <code>Dictionary</code> objects you do not need to directly use it.</p>
</section>
<section id="section-208">
<h5>○•○</h5>
<p>Whenever you write an interface, it is a good idea to add a comment with a quick sketch of what it does and how it should be used. This way, when someone, possibly yourself three months after you wrote it, wants to work with the interface, they can quickly see how to use it, and do not have to study the whole program.</p>
<p align=center><img src="../img/sketch-small.png" alt="figure ../img/sketch-small.png" /><br /></p>
<p>Using a piece of paper, a whiteboard or as here a pen and tablet can be effective to sketch your designs. Using a notation roughly similar to UML (Unified Modeling Language) can help in communicating your design to others. Usually you do not need a tool<sup><a href="#fn28" class="footnoteRef" id="fnref28">28</a></sup> — unless you really want to or work in a large administrative setting. You can find a quick reference to UML notation via web search. The most useful diagram is the interaction or sequence diagram. Use it to specify how objects talk to each other — especially in distributed systems. The class diagram shown above presents a static view of the system so it is mostly for initial designs.</p>
<p>Most of the time, when you are designing an interface, you will soon find some limitations and problems in whatever you came up with, and change it. To prevent wasting your time, it is advisable to document your interfaces only <em>after</em> they have been used in a few real situations and proven themselves to be practical. — Of course, this might make it tempting to forget about documentation altogether. Personally, I treat writing documentation as a ‘finishing touch’ to add to a system. When it feels ready, it is time to write something about it, and to see if it sounds as good in English (or whatever language) as it does in CoffeeScript (or whatever programming language).</p>
</section>
<section id="section-209">
<h5>○•○</h5>
<p>The distinction between the external interface of an object and its internal details is important for two reasons. Firstly, having a small, clearly described interface makes an object easier to use. You only have to keep the interface in mind, and do not have to worry about the rest unless you are changing the object itself.</p>
<p>Secondly, it often turns out to be necessary or practical to change something about the internal implementation of a class, to make it more efficient, for example, or to fix some problem. When outside code is accessing every single property and detail in the object, you can not change any of them without also updating a lot of other code. If outside code only uses a small interface, you can do what you want, as long as you do not change the interface.</p>
<p>Some people go very far in this. They will, for example, never include properties in the interface of object, only methods — if their object type has a length, it will be accessible with the <code>getLength</code> method, not the <code>length</code> property. This way, if they ever want to change their object in such a way that it no longer has a <code>length</code> property, for example because it now has some internal array whose length it must return, they can update the function without changing the interface.</p>
<p>My own take is that in most cases this is not worth it. Adding a <code>getLength</code> method which only contains <code>return this.length</code> mostly just adds meaningless code, and, in most situations, I consider meaningless code a bigger problem than the risk of having to occasionally change the interface to my objects.</p>
</section>
<section id="section-210">
<h5>○•○</h5>
<p>Adding new methods to existing prototypes can be very convenient. Especially the <code>Array</code> and <code>String</code> prototypes in CoffeeScript could use a few more basic methods. We could, for example, replace <code>forEach</code> and <code>map</code> with methods on arrays, and make the <code>startsWith</code> function we wrote in <a href="#data-structures-objects-and-arrays">Data Structures↑</a> a method on strings.</p>
<p>However, if your code has to run as a library used by others or as a program on a web-page together with another program (either written by you or by someone else) which uses <code>for</code>/<code>of</code> naively — the way we have been using it so far — then adding things to prototypes, especially the <code>Object</code> and <code>Array</code> prototype, will definitely break something, because these loops will suddenly start seeing those new properties. For this reason, some people prefer not to touch these prototypes at all. Of course, if you are careful, and you do not expect your code to have to coexist with badly-written code, adding methods to standard prototypes is a perfectly good technique.</p>
<hr />
</section>
</section>
<section id="regular-expressions">
<h3>Regular Expressions</h3>
<hr />
<p>At various points in the previous chapters, we had to look for patterns in string values. In <a href="#data-structures-objects-and-arrays">Data Structures↑</a> we extracted date values from strings by writing out the precise positions at which the numbers that were part of the date could be found. Later, in <a href="#functional-programming">Functional Programming↑</a>, we saw some particularly ugly pieces of code for finding certain types of characters in a string, for example the characters that had to be escaped in HTML output.</p>
<p><a href="#index-regular-expression"></a>Regular expressions are a language for describing patterns in strings. They form a small, separate language, which is embedded inside CoffeeScript (and in various other programming languages, in one way or another). It is not a very readable language — big regular expressions tend to be quite unreadable. To make them more readable CoffeeScript has extended regular expressions where you can generously add comments to the different parts. Examples of these are shown later. Still regular expressions are difficult to read, but they are a useful tool that can really simplify string-processing programs.</p>
<section id="section-211">
<h5>○•○</h5>
<p>Just like strings get written between quotes, regular expression patterns get written between slashes ( <code>/</code><a href="#index-/"></a>). This means that slashes inside the expression have to be escaped.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">slash <span class="kw">=</span> <span class="st">/\//</span><span class="kw">;</span><br />show <span class="st">'AC/DC'</span><span class="kw">.</span>search slash</code></pre>
<p>The <code>search</code><a href="#index-search"></a> method resembles <code>indexOf</code>, but it searches for a regular expression instead of a string. Patterns specified by regular expressions can do a few things that strings can not do. For a start, they allow some of their elements to match more than a single character. In <a href="#functional-programming">Functional Programming↑</a>, when extracting mark-up from a document, we needed to find the first asterisk or opening brace in a string. That could be done like this:</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">asteriskOrBrace <span class="kw">=</span> <span class="st">/[\{\*]/</span><br />story <span class="kw">=</span> <span class="st">'We noticed the *giant sloth*, '</span> <span class="kw">+</span><br />        <span class="st">'hanging from a giant branch.'</span><span class="kw">;</span><br />show story<span class="kw">.</span>search asteriskOrBrace</code></pre>
<p>The <code>[</code> and <code>]</code> characters have a special meaning inside a regular expression. They can enclose a set of characters, and they mean ‘any of these characters’. Most non-alphanumeric characters have some special meaning inside a regular expression, so it is a good idea to always escape them with a backslash<sup><a href="#fn29" class="footnoteRef" id="fnref29">29</a></sup> when you use them to refer to the actual characters.</p>
</section>
<section id="section-212">
<h5>○•○</h5>
<p>There are a few shortcuts for sets of characters that are needed often. The dot (<code>.</code>) can be used to mean ‘any character that is not a newline’, an escaped ‘d’ (<code>\d</code>) means ‘any digit’, an escaped ‘w’ (<code>\w</code>) matches any alphanumeric character (including underscores, for some reason), and an escaped ’s’ (<code>\s</code>) matches any white-space (tab, newline, space) character.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">digitSurroundedBySpace <span class="kw">=</span> <span class="st">/\s\d\s/</span><br />show <span class="st">'1a 2 3d'</span><span class="kw">.</span>search digitSurroundedBySpace</code></pre>
<p>The escaped ‘d’, ‘w’, and ’s’ can be replaced by their capital letter to mean their opposite. For example, <code>\S</code> matches any character that is <em>not</em> white-space. When using <code>[</code> and <code>]</code>, a pattern can be inverted by starting with a <code>^</code> character:</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">notABC <span class="kw">=</span> <span class="st">/[^ABC]/</span><br />show <span class="st">'ABCBACCBBADABC'</span><span class="kw">.</span>search notABC</code></pre>
<p>As you can see, the way regular expressions use characters to express patterns makes them A) very short, and B) very hard to read.</p>
</section>
<section id="exercise-32">
<h4><em>Exercise 32</em></h4>
<p>Write a regular expression that matches a date in the format <code>'XX/XX/XXXX'</code>, where the <code>X</code>s are digits. Test it against the string <code>'born 15/11/2003 (mother Spot): White Fang'</code>.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false"><span class="co"># Compose a solution here</span></code></pre>
<section id="view-solution-40" onclick="reveal(this)" >
<h5>View Solution</h5>
<section id="section-213" style="display:none" >
<h6></h6>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">datePattern <span class="kw">=</span> <span class="st">/\d\d\/\d\d\/\d\d\d\d/</span><br />show <span class="st">'born 15/11/2003 (mother Spot): White Fang'</span>\<br /><span class="kw">.</span>search datePattern</code></pre>
<p>The backslash after the string continues the line after the line break.</p>
</section>
</section>
</section>
<section id="section-214">
<h4></h4>
<p>Sometimes you need to make sure a pattern starts at the beginning of a string, or ends at its end. For this, the special characters <code>^</code> and <code>$</code> can be used. The first matches the start of the string, the second the end.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">show <span class="st">/a+/</span><span class="kw">.</span>test <span class="st">'blah'</span><br />show <span class="st">/^a+$/</span><span class="kw">.</span>test <span class="st">'blah'</span></code></pre>
<p>The first regular expression matches any string that contains an <code>a</code> character, the second only those strings that consist entirely of <code>a</code> characters.</p>
<p>Note that regular expressions are objects, and have methods. Their <code>test</code><a href="#index-test"></a> method returns a boolean indicating whether the given string matches the expression.</p>
<p>The code <code>\b</code> matches a ‘word boundary’, which can be punctuation, white-space, or the start or end of the string.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">show <span class="st">/cat/</span><span class="kw">.</span>test <span class="st">'concatenate'</span><br />show <span class="st">/\bcat\b/</span><span class="kw">.</span>test <span class="st">'concatenate'</span></code></pre>
<section id="section-215">
<h5>○•○</h5>
<p>Parts of a pattern can be allowed to be repeated a number of times. Putting an asterisk ( <code>*</code> ) after an element allows it to be repeated any number of times, including zero. A plus (<code>+</code>) does the same, but requires the pattern to occur at least one time. A question mark (<code>?</code>) makes an element ‘optional’ — it can occur zero or one times.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">parenthesizedText <span class="kw">=</span> <span class="st">/\(.*\)/</span><br />show <span class="st">&quot;Its (the sloth's) claws were gigantic!&quot;</span>\<br /><span class="kw">.</span>search parenthesizedText</code></pre>
<p>When necessary, braces can be used to be more precise about the amount of times an element may occur. A number between braces (<code>{4}</code>) gives the exact amount of times it must occur. Two numbers with a comma between them (<code>{3,10}</code>) indicate that the pattern must occur at least as often as the first number, and at most as often as the second one. Similarly, <code>{2,}</code> means two or more occurrences, while <code>{,4}</code> means four or less.</p>
<p>To make big regular expressions more readable CoffeeScript has extended regular expressions. They are delimited by <code>///</code><a href="#index-///"></a> and allow comments to be added to the different parts. They ignore formatting, so they can be split over several lines and placed in a column.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">datePattern <span class="kw">=</span> <span class="st">/\d{1,2}\/\d\d?\/\d{4}/</span><br />show <span class="st">'born 15/11/2003 (mother Spot): White Fang'</span>\<br /><span class="kw">.</span>search datePattern<br /><br />datePattern <span class="kw">=</span> <span class="st">///</span><br /><span class="st">  \d{1,2}   </span><span class="co"># day</span><br /><span class="st">  /         </span><span class="co"># separator</span><br /><span class="st">  \d\d?     </span><span class="co"># month</span><br /><span class="st">  /         </span><span class="co"># separator</span><br /><span class="st">  \d{4}     </span><span class="co"># year</span><br /><span class="st">///</span><br />show <span class="st">'born 15/11/2003 (mother Spot): White Fang'</span>\<br /><span class="kw">.</span>search datePattern</code></pre>
<p>The pieces <code>/\d{1,2}/</code> and <code>/\d\d?/</code> both express ‘one or two digits’.</p>
</section>
</section>
<section id="exercise-33">
<h4><em>Exercise 33</em></h4>
<p>Write a pattern that matches e-mail addresses. For simplicity, assume that the parts before and after the <code>@</code> can contain only alphanumeric characters and the characters <code>.</code> and <code>-</code> (dot and dash), while the last part of the address, the country code or top level domain after the last dot, may only contain alphanumeric characters, and must be two or three characters long.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false"><span class="co"># Compose a solution here</span></code></pre>
<section id="view-solution-41" onclick="reveal(this)" >
<h5>View Solution</h5>
<section id="section-216" style="display:none" >
<h6></h6>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">mailAddress <span class="kw">=</span> <span class="st">/\b[\w\.-]+@[\w\.-]+\.\w{2,3}\b/</span><br /><br />mailAddress <span class="kw">=</span> <span class="st">///</span><br /><span class="st">  \b[\w\.-]+  </span><span class="co"># username</span><br /><span class="st">  @</span><br /><span class="st">  [\w\.-]+\   </span><span class="co"># provider</span><br /><span class="st">  .</span><br /><span class="st">  \w{2,3}\b   </span><span class="co"># domain</span><br /><span class="st">///</span><br /><br />show mailAddress<span class="kw">.</span>test <span class="st">'kenny@test.net'</span><br />show mailAddress<span class="kw">.</span>test <span class="st">'I mailt kenny@tets.nets, '</span> <span class="kw">+</span><br />                      <span class="st">'but it didn wrok!'</span><br />show mailAddress<span class="kw">.</span>test <span class="st">'the_giant_sloth@gmail.com'</span></code></pre>
<p>The <code>\b</code>s at the start and end of the pattern make sure that the second string does not match.</p>
</section>
</section>
</section>
<section id="section-217">
<h4></h4>
<p>Part of a regular expression can be grouped together with parentheses. This allows us to use <code>*</code> and such on more than one character. For example:</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">cartoonCrying <span class="kw">=</span> <span class="st">/boo(hoo+)+/i</span><br />show <span class="st">&quot;Then, he exclaimed 'Boohoooohoohooo'&quot;</span>\<br /><span class="kw">.</span>search cartoonCrying</code></pre>
<p>Where did the <code>i</code> at the end of that regular expression come from? After the closing slash, ‘options’ may be added to a regular expression. An <code>i</code>, here, means the expression is case-insensitive, which allows the lower-case B in the pattern to match the upper-case one in the string.</p>
<p>A pipe character (<code>|</code>) is used to allow a pattern to make a choice between two elements. For example:</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">holyCow <span class="kw">=</span> <span class="st">/(sacred|holy) (cow|bovine|bull|taurus)/i</span><br />show holyCow<span class="kw">.</span>test <span class="st">'Sacred bovine!'</span></code></pre>
<section id="section-218">
<h5>○•○</h5>
<p>Often, looking for a pattern is just a first step in extracting something from a string. In previous chapters, this extraction was done by calling a string’s <code>indexOf</code> and <code>slice</code> methods a lot. Now that we are aware of the existence of regular expressions, we can use the <code>match</code> method instead. When a string is matched against a regular expression, the result will be <code>null</code> if the match failed, or an array of matched strings if it succeeded.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">show <span class="st">'No'</span><span class="kw">.</span>match <span class="st">/Yes/</span><br />show <span class="st">'... yes'</span><span class="kw">.</span>match <span class="st">/yes/</span><br />show <span class="st">'Giant Ape'</span><span class="kw">.</span>match <span class="st">/giant (\w+)/i</span></code></pre>
<p>The first element in the returned array is always the part of the string that matched the pattern. As the last example shows, when there are parenthesized parts in the pattern, the parts they match are also added to the array. Often, this makes extracting pieces of a string very easy.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">quote <span class="kw">=</span> <span class="st">&quot;My mind is a swirling miasma &quot;</span> <span class="kw">+</span><br />        <span class="st">&quot;(a poisonous fog thought to &quot;</span> <span class="kw">+</span><br />        <span class="st">&quot;cause illness) of titilating &quot;</span> <span class="kw">+</span><br />        <span class="st">&quot;thoughts and turgid ideas.&quot;</span><br />parenthesized <span class="kw">=</span> quote<span class="kw">.</span>match <span class="st">///</span><br /><span class="st">  (\w+)    </span><span class="co"># Word</span><br /><span class="st">  \s*      </span><span class="co"># Whitespace</span><br /><span class="st">  \((.*)\) </span><span class="co"># Explanation</span><br /><span class="st">///</span><br /><span class="kw">if</span> parenthesized <span class="kw">isnt</span> <span class="ot">null</span><br />  show <span class="st">&quot;Word: </span><span class="ch">#{</span>parenthesized[1]<span class="ch">}</span><span class="st"> &quot;</span> <span class="kw">+</span><br />       <span class="st">&quot;Explanation: </span><span class="ch">#{</span>parenthesized[2]<span class="ch">}</span><span class="st">&quot;</span></code></pre>
<p>If you insert another set of parentheses in this example, then you will see that the match stretches from the first to the last parentheses. This is because the matching is greedy, it tries to match as long a string as possible. You can change the <code>.*</code> to <code>[^)]*</code> to prevent the match from stretching beyond the first closing parentheses.</p>
</section>
</section>
<section id="exercise-34">
<h4><em>Exercise 34</em></h4>
<p>Re-write the function <code>extractDate</code> that we wrote in <a href="#data-structures-objects-and-arrays">Data Structures↑</a>. When given a string, this function looks for something that follows the date format we saw earlier. If it can find such a date, it puts the values into a <code>Date</code> object. Otherwise, it throws an exception. Make it accept dates in which the day or month are written with only one digit.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false"><span class="co"># Compose a solution here</span></code></pre>
<section id="view-solution-42" onclick="reveal(this)" >
<h5>View Solution</h5>
<section id="section-219" style="display:none" >
<h6></h6>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">extractDate <span class="kw">=</span> <span class="fu">(string) -&gt;</span><br />  found <span class="kw">=</span> string<span class="kw">.</span>match <span class="st">/(\d\d?)\/(\d\d?)\/(\d{4})/</span><br />  <span class="kw">if</span> found <span class="kw">is</span> <span class="ot">null</span><br />    <span class="kw">throw</span> <span class="kw">new</span> <span class="dt">Error</span> <span class="st">&quot;No date found in '</span><span class="ch">#{</span>string<span class="ch">}</span><span class="st">'.&quot;</span><br />  <span class="kw">new</span> <span class="dt">Date</span> <span class="ot">Number</span><span class="kw">(</span>found<span class="kw">[</span><span class="dv">3</span><span class="kw">]),</span><br />           <span class="ot">Number</span><span class="kw">(</span>found<span class="kw">[</span><span class="dv">2</span><span class="kw">])</span> <span class="kw">-</span> <span class="dv">1</span><span class="kw">,</span><br />           <span class="ot">Number</span><span class="kw">(</span>found<span class="kw">[</span><span class="dv">1</span><span class="kw">])</span><br />show extractDate \<br />  <span class="st">&quot;born 5/2/2007 (mother Noog): Long-ear Johnson&quot;</span></code></pre>
<p>This version is slightly longer than the previous one, but it has the advantage of actually checking what it is doing, and shouting out when it is given nonsensical input. This was a lot harder without regular expressions — it would have taken a lot of calls to <code>indexOf</code> to find out whether the numbers had one or two digits, and whether the dashes were in the right places.</p>
</section>
</section>
</section>
<section id="section-220">
<h4></h4>
<p>The <code>replace</code><a href="#index-replace"></a> method of string values, which we saw in <a href="#functional-programming">Functional Programming↑</a>, can be given a regular expression as its first argument. <code>show 'Borobudur'.replace /[ou]/g, 'a'</code> Notice the <code>g</code> character after the regular expression. It stands for ‘global’, and means that every part of the string that matches the pattern should be replaced. When this <code>g</code> is omitted, only the first <code>'o'</code> would be replaced.</p>
<p>Sometimes it is necessary to keep parts of the replaced strings. For example, we have a big string containing the names of people, one name per line, in the format “Lastname, Firstname”. We want to swap these names, and remove the comma, to get a simple “Firstname Lastname” format.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">names <span class="kw">=</span> <span class="st">'''Picasso, Pablo</span><br /><span class="st">Gauguin, Paul</span><br /><span class="st">Van Gogh, Vincent'''</span><br /><br />show names<span class="kw">.</span>replace <span class="st">/([\w ]+), ([\w ]+)/g</span><span class="kw">,</span> <span class="st">'$2 $1'</span><br /><br /><span class="co"># Non-printable characters can be tricky in regular</span><br /><span class="co"># expressions, actually all non-ASCII characters can</span><br /><span class="co"># be, they can be represented with their numeric codes:</span><br /><span class="co"># unicode \u0020 = hexadecimal \x20 = ascii #32 = ' '</span><br />show names<span class="kw">.</span>replace <span class="st">///</span><br /><span class="st">  ([\w\x20]+)         </span><span class="co"># Lastname</span><br /><span class="st">  ,\u0020</span><br /><span class="st">  ([\w\x20]+)         </span><span class="co"># Firstname</span><br /><span class="st">///g</span><span class="kw">,</span> <span class="st">'$2 $1'</span></code></pre>
<p>The <code>$1</code> and <code>$2</code> in the replacement string refer to the parenthesized parts in the pattern. <code>$1</code> is replaced by the text that matched against the first pair of parentheses, <code>$2</code> by the second, and so on, up to <code>$9</code>.</p>
<p>If you have more than 9 parentheses parts in your pattern, this will no longer work. But there is one more way to replace pieces of a string, which can also be useful in some other tricky situations. When the second argument given to the <code>replace</code> method is a function value instead of a string, this function is called every time a match is found, and the matched text is replaced by whatever the function returns. The arguments given to the function are the matched elements, similar to the values found in the arrays returned by <code>match</code>: The first one is the whole match, and after that comes one argument for every parenthesized part of the pattern.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">eatOne <span class="kw">=</span> <span class="fu">(match, amount, unit) -&gt;</span><br />  amount <span class="kw">=</span> <span class="ot">Number</span><span class="kw">(</span>amount<span class="kw">)</span> <span class="kw">-</span> <span class="dv">1</span><br />  <span class="kw">if</span> amount <span class="kw">is</span> <span class="dv">1</span><br />    unit <span class="kw">=</span> unit<span class="kw">.</span>slice <span class="dv">0</span><span class="kw">,</span> unit<span class="kw">.</span>length <span class="kw">-</span> <span class="dv">1</span><br />  <span class="kw">else</span> <span class="kw">if</span> amount <span class="kw">is</span> <span class="dv">0</span><br />    unit <span class="kw">=</span> unit <span class="kw">+</span> <span class="st">'s'</span><br />    amount <span class="kw">=</span> <span class="st">'no'</span><br />  amount <span class="kw">+</span> <span class="st">' '</span> <span class="kw">+</span> unit<br /><br />stock <span class="kw">=</span> <span class="st">'1 lemon, 2 cabbages, and 101 eggs'</span><br />stock <span class="kw">=</span> stock<span class="kw">.</span>replace <span class="st">/(\d+) (\w+)/g</span><span class="kw">,</span> eatOne<br />show stock</code></pre>
</section>
<section id="exercise-35">
<h4><em>Exercise 35</em></h4>
<p>That last trick can be used to make the HTML-escaper from <a href="#functional-programming">Functional Programming↑</a> more efficient. You may remember that it looked like this:</p>
<pre class="sourceCode"><code class="sourceCode COFFEESCRIPT">escapeHTML <span class="kw">=</span> <span class="fu">(text) -&gt;</span><br />  replacements <span class="kw">=</span> <span class="kw">[[</span><span class="st">/&amp;/g</span><span class="kw">,</span> <span class="st">'&amp;amp;'</span><span class="kw">]</span><br />                  <span class="kw">[</span><span class="st">/&quot;/g</span><span class="kw">,</span> <span class="st">'&amp;quot;'</span><span class="kw">]</span><br />                  <span class="kw">[</span><span class="st">/&lt;/g</span><span class="kw">,</span> <span class="st">'&amp;lt;'</span><span class="kw">]</span><br />                  <span class="kw">[</span><span class="st">/&gt;/g</span><span class="kw">,</span> <span class="st">'&amp;gt;'</span><span class="kw">]]</span><br />  forEach replacements<span class="kw">,</span> <span class="fu">(replace) -&gt;</span><br />    text <span class="kw">=</span> text<span class="kw">.</span>replace replace<span class="kw">[</span><span class="dv">0</span><span class="kw">],</span> replace<span class="kw">[</span><span class="dv">1</span><span class="kw">]</span><br />  text<br />show escapeHTML <span class="st">'&lt; &quot; &amp; &quot; &gt;'</span></code></pre>
<p>Write a new function <code>escapeHTML</code>, which does the same thing, but only calls <code>replace</code> once.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false"><span class="co"># Compose a solution here</span></code></pre>
<section id="view-solution-43" onclick="reveal(this)" >
<h5>View Solution</h5>
<section id="section-221" style="display:none" >
<h6></h6>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">escapeHTML2 <span class="kw">=</span> <span class="fu">(text) -&gt;</span><br />  replacements <span class="kw">=</span><br />    <span class="st">&quot;&lt;&quot;</span><span class="kw">:</span>  <span class="st">&quot;&amp;lt;&quot;</span><br />    <span class="st">&quot;&gt;&quot;</span><span class="kw">:</span>  <span class="st">&quot;&amp;gt;&quot;</span><br />    <span class="st">&quot;&amp;&quot;</span><span class="kw">:</span>  <span class="st">&quot;&amp;amp;&quot;</span><br />    <span class="st">&quot;\&quot;&quot;</span><span class="kw">:</span> <span class="st">&quot;&amp;quot;&quot;</span><br />  text<span class="kw">.</span>replace <span class="st">/[&lt;&gt;&amp;&quot;]/g</span><span class="kw">,</span> <span class="fu">(character) -&gt;</span><br />    replacements<span class="kw">[</span>character<span class="kw">]</span> <span class="kw">?</span> character<br /><br />show escapeHTML2 <span class="st">&quot;The 'pre-formatted' tag &quot;</span> <span class="kw">+</span><br />                <span class="st">&quot;is written \&quot;&lt;pre&gt;\&quot;.&quot;</span></code></pre>
<p>The <code>replacements</code> object is a quick way to associate each character with its escaped version. Using it like this is safe (i.e. no <code>Dictionary</code> object is needed), because the only properties that will be used are those matched by the <code>/[&lt;&gt;&amp;&quot;]/</code> expression.</p>
</section>
</section>
</section>
<section id="section-222">
<h4></h4>
<p>There are cases where the pattern you need to match against is not known while you are writing the code. Say we are writing a (very simple-minded) obscenity filter for a message board. We only want to allow messages that do not contain obscene words. The administrator of the board can specify a list of words that he or she considers unacceptable.</p>
<p>The most efficient way to check a piece of text for a set of words is to use a regular expression. If we have our word list as an array, we can build the regular expression like this:</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">badWords <span class="kw">=</span> <span class="kw">[</span><span class="st">'ape'</span><span class="kw">,</span> <span class="st">'monkey'</span><span class="kw">,</span> <span class="st">'simian'</span><span class="kw">,</span> <span class="st">'gorilla'</span><span class="kw">,</span> <span class="st">'evolution'</span><span class="kw">]</span><br />pattern <span class="kw">=</span> <span class="kw">new</span> <span class="dt">RegExp</span> badWords<span class="kw">.</span>join<span class="kw">(</span><span class="st">'|'</span><span class="kw">),</span> <span class="st">'i'</span><br />isAcceptable <span class="kw">=</span> <span class="fu">(text) -&gt;</span><br />  <span class="kw">!</span>pattern<span class="kw">.</span>test text<br /><br />show isAcceptable <span class="st">'Mmmm, grapes.'</span><br />show isAcceptable <span class="st">'No more of that monkeybusiness, now.'</span></code></pre>
<p>We could add <code>\b</code> patterns around the words, so that the thing about grapes would not be classified as unacceptable. That would also make the second one acceptable, though, which is probably not correct. Obscenity filters are hard to get right (and usually way too annoying to be a good idea).</p>
<p>The first argument to the <code>RegExp</code> constructor is a string containing the pattern, the second argument can be used to add case-insensitivity or globalness. When building a string to hold the pattern, you have to be careful with backslashes. Because, normally, backslashes are removed when a string is interpreted, any backslashes that must end up in the regular expression itself have to be escaped:</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">digits <span class="kw">=</span> <span class="kw">new</span> <span class="dt">RegExp</span> <span class="st">'\\d+'</span><br />show digits<span class="kw">.</span>test <span class="st">'101'</span></code></pre>
<section id="section-223">
<h5>○•○</h5>
<p>The most important thing to know about regular expressions is that they exist, and can greatly enhance the power of your string-mangling code. They are so cryptic that you will probably have to look up the details on them the first ten times you want to make use of them. Persevere, and you will soon be off-handedly writing expressions that look like occult gibberish.</p>
<p>When your tasks become too complex for regular expressions then have a look at how CoffeeScript is implemented. It uses <a href="http://github.com/zaach/jison">Jison</a>, a parser generator. With it you define a grammar for the language you want your program to be able to read i.e. parse. Jison then generates a module that can read data in that format. You integrate the module in your program and can then perform appropriate actions when different parts of the data is read. It is an advanced tool, that begins where regular expressions leave off.</p>
<hr />
</section>
</section>
</section>
<section id="modularity">
<h3>Modularity</h3>
<hr />
<p>This chapter deals with the process of organising programs.<sup><a href="#fn30" class="footnoteRef" id="fnref30">30</a></sup> In small programs, organisation rarely becomes a problem. As a program grows, however, it can reach a size where its structure and interpretation become hard to keep track of. Easily enough, such a program starts to look like a bowl of spaghetti, an amorphous mass in which everything seems to be connected to everything else.</p>
<p>In top down design you look at the overall structure of your application and divide it into smaller parts. There are many ways to do this, one way is to distinguish between technical and application specific areas. For example instead of inserting statements that write application activity in files in various places, the technical part — writing in a file, checking for errors and handling daily log roll-overs — can be placed in a logging utility as a technical service.</p>
<p>A useful technique is to use a layered approach, where lower layers do not know of higher layers. For example when communicating between processes, lower level protocols can be encapsulated in a layer and when data arrives — instead of a lower layer directly calling a function to handle the data in a higher layer — the lower layer raises an event<sup><a href="#fn31" class="footnoteRef" id="fnref31">31</a></sup> that an interested higher layer can be listening to. It is analogue to what we saw in <a href="#error-handling">Error Handling↑</a> where a failing function does not have any knowledge of who or how an exception will be handled.</p>
<p>When structuring a program in CoffeeScript, we do two things. We separate it into smaller parts, called module<a href="#index-module"></a>s, each of which has a specific role, and we specify the relations between these parts.</p>
<p>In <a href="#searching">Searching↑</a>, while finding routes, we made use of a number of functions described in <a href="#functional-programming">Functional Programming↑</a>. The chapter also defined some concepts that had nothing in particular to do with route planning, such as <code>flatten</code>, <code>partial</code> and the <code>BinaryHeap</code> type. <code>BinaryHeap</code> was treated as a black box, we only had to know how to use it, we did not have to know how it internally works. That kind of encapsulation is the essence of modularity and of <a href="#object-oriented-programming">Object Orientation↑</a>.</p>
<p>The <code>flatten</code> function was reused from the Underscore library. We needed the <code>partial</code> function in a few places and haphazardly just added it to the environment where we needed it. It would have been easy to simply add <code>partial</code> to the Underscore library, but that would mean that we had to add it every time a new version of Underscore is released.</p>
<p>We could create our own module instead and place the missing parts there, then we would have to refer to two libraries whenever we are using fundamental functions. Or we could create a module with our functions that include Underscore and use the functions from it to build our own. Our module would then depend on Underscore. When a module depend<a href="#index-depend"></a>s on another module, it uses functions or variables from that module, and will only work when the module is loaded.</p>
<p>It is a good idea to make sure dependencies never form a circle. Not only do circular dependencies create a practical problem (if module <code>A</code> and <code>B</code> depend on each other, which one should be loaded first?), it also makes the relation between the modules less straightforward, and can result in a modularised version of the spaghetti I mentioned earlier.</p>
<section id="section-224">
<h5>○•○</h5>
<p>Most modern programming languages have some kind of module system built in. In CoffeeScript it sort of depends… In the standard CoffeeScript environment we have a module system based on CommonJS <code>require</code>. When using CoffeeScript in other environments, such as on a page in a web browser, then we do not have <code>require</code> and must rely on system specific services or once again invent something ourselves<sup><a href="#fn32" class="footnoteRef" id="fnref32">32</a></sup>.</p>
<p>The most obvious way to start is to put every module in a different file. This makes it clear which code belongs to which module. In this chapter we will return to the <em>Seed of Life</em> example you saw in the <a href="#foreword">Preface↑</a> and make a server controlled, animated version of it. For this purpose I have extracted the mathematical calculations behind the drawing and placed them in a file, <code>'10-MathFix.coffee'</code>. It contains a <code>CircularPosition</code> class we can use to get positions about a <sup>1</sup>⁄<sub>6</sub> apart on a unit circle and a fix for a floating point rounding error. It also uses the prelude and has a small print utility at the end. It is not a module yet, we will stepwise refine it so it can be used in both a server and a browser environment.</p>
<pre class="sourceCode"><code class="sourceCode COFFEESCRIPT">require <span class="st">&quot;./prelude&quot;</span><br /><br />Pi2 <span class="kw">=</span> <span class="ot">Math</span><span class="kw">.</span>PI<span class="kw">*</span><span class="dv">2</span><br /><span class="co"># Create an array with angles on the unit circle.</span><br />angles <span class="kw">=</span> <span class="kw">(</span>angle <span class="kw">for</span> angle <span class="kw">in</span> <span class="kw">[</span><span class="dv">0</span><span class="kw">...</span>Pi2<span class="kw">]</span> <span class="kw">by</span> <span class="dv">1</span><span class="kw">/</span><span class="dv">3</span><span class="kw">*</span><span class="ot">Math</span><span class="kw">.</span>PI<span class="kw">)</span><br /><span class="co"># Remove the last element if 2*PI were included</span><br /><span class="co"># due to floating point rounding on additions.</span><br />epsilon <span class="kw">=</span> <span class="fl">1e-14</span><br />lastAngle <span class="kw">=</span> angles<span class="kw">[</span>angles<span class="kw">.</span>length <span class="kw">-</span> <span class="dv">1</span><span class="kw">]</span><br /><span class="co"># Use an interval to test floating point value</span><br /><span class="kw">if</span> Pi2 <span class="kw">-</span> epsilon <span class="kw">&lt;</span> lastAngle <span class="kw">&lt;</span> Pi2 <span class="kw">+</span> epsilon<br />  angles<span class="kw">.</span>length <span class="kw">=</span> angles<span class="kw">.</span>length <span class="kw">-</span> <span class="dv">1</span><br /><br /><span class="co"># Encapsulation of a pair of (x, y) coordinates</span><br /><span class="kw">class</span> <span class="dt">Point</span><br />  <span class="kw">constructor</span><span class="kw">:</span> <span class="fu">(@x, @y) -&gt;</span><br />  toString<span class="kw">:</span> <span class="fu">-&gt;</span> <span class="st">&quot;{x:</span><span class="ch">#{</span>@x.toPrecision 4<span class="ch">}</span><span class="st">,&quot;</span> <span class="kw">+</span><br />               <span class="st">&quot; y:</span><span class="ch">#{</span>@y.toPrecision 4<span class="ch">}</span><span class="st">}&quot;</span><br /><br /><span class="co"># Math class that returns points on the unit</span><br /><span class="co"># circle, offset by step if given non-zero.</span><br /><span class="kw">class</span> <span class="dt">CircularPosition</span><br />  <span class="kw">constructor</span><span class="kw">:</span> <span class="fu">(@_step = 0) -&gt;</span> <span class="dt">@_count</span> <span class="kw">=</span> <span class="dv">0</span><br />  nextPoint<span class="kw">:</span> <span class="fu">-&gt;</span><br />    index <span class="kw">=</span> <span class="dt">@_count</span> <span class="kw">%</span> angles<span class="kw">.</span>length <br />    angle <span class="kw">=</span> angles<span class="kw">[</span>index<span class="kw">]</span> <span class="kw">+</span> <span class="dt">@_step</span> <span class="kw">*</span> <span class="dt">@_count</span><span class="kw">++</span><br />    <span class="kw">new</span> <span class="dt">Point</span> <span class="ot">Math</span><span class="kw">.</span>cos<span class="kw">(</span>angle<span class="kw">),</span> <span class="ot">Math</span><span class="kw">.</span>sin<span class="kw">(</span>angle<span class="kw">)</span><br /><br />circ <span class="kw">=</span> <span class="kw">new</span> <span class="dt">CircularPosition</span> <span class="fl">0.01</span><br /><span class="kw">for</span> i <span class="kw">in</span> <span class="kw">[</span><span class="dv">0</span><span class="kw">...</span><span class="dv">6</span><span class="kw">]</span><br />  show <span class="st">&quot;</span><span class="ch">#{</span>i<span class="ch">}</span><span class="st">: </span><span class="ch">#{</span>circ.nextPoint()<span class="ch">}</span><span class="st">&quot;</span></code></pre>
<p>The first thing is to remove the print utility at the end<sup><a href="#fn33" class="footnoteRef" id="fnref33">33</a></sup>. The next is the <code>require './prelude'</code>, while the prelude has served us well in the course of this book, it is not intended for modules. The prelude includes a variety of definitions so we have been free to focus on each aspect of CoffeeScript without distraction. However it pulls these definitions into a shared namespace either directly or via the <code>globalize</code> function (described later in this chapter). This namespace is shared between all modules that a program consists of and since the purpose of a module is for us to be able to reuse it in various projects, a module should not ‘pollute’ this scarce, shared resource. In other words, you can use the prelude, when you are experimenting with a new algorithm, but do not use it when you create a reusable module.</p>
</section>
<section id="section-225">
<h5>○•○</h5>
<p>When much code is loaded into an environment, it will use many top-level variable names. Once there is more code than you can really keep track of, it becomes very easy to accidentally use a name that was already used for something else. This will break the code that used the original value. The proliferation of top-level variables is called name-space pollution<a href="#index-name-space-pollution"></a>, and it has been a rather severe problem in JavaScript — the language will not warn you when you redefine an existing variable.</p>
<p>CoffeeScript greatly reduces this problem by automatically encapsulating modules. You only have to avoid directly using top-level variables. In particular modules should not use top-level variables for values that are not part of their external interface.</p>
</section>
<section id="section-226">
<h5>○•○</h5>
<p>In CoffeeScript, ‘top-level’ variables all live together in a single place. In browsers, this place is an object that can be found under the name <code>window</code>. The name is somewhat odd, <code>environment</code> or <code>top</code> would have made more sense, but since browsers associate an environment with a window or a ‘frame’, someone decided that <code>window</code> was a logical name. In the standard CoffeeScript environment it is called <code>global</code>.</p>
<pre class="sourceCode"><code class="sourceCode COFFEESCRIPT">show global<span class="kw">.</span>process<span class="kw">.</span>argv<span class="kw">[</span><span class="dv">0</span><span class="kw">]</span><br />show global<span class="kw">.</span><span class="ot">console</span><span class="kw">.</span>log <span class="kw">is</span> <span class="ot">console</span><span class="kw">.</span>log<br />show global<span class="kw">.</span>global<span class="kw">.</span>global<span class="kw">.</span>global<span class="kw">.</span>global<span class="kw">.</span><span class="ot">console</span></code></pre>
<p>As the third line shows, the name <code>global</code> is merely a property of this environment object, pointing at itself.</p>
</section>
<section id="section-227">
<h5>○•○</h5>
<p>Not being able to define any internal functions and variables at all in your modules is, of course, not very practical. Fortunately, there is a trick to get around this. We could write all the code for the module inside a function, and then add the variables that are part of the module’s interface to the top-level object. Because they were created in the same parent function, all the functions of the module can see each other, but code outside of the module can not. The wrapping in a function is done by CoffeeScript automatically. In the server environment, instead of assigning directly to the top-level environment our module will export its definitions. In the browser we have to assign to the top-level <code>window</code>, which when a module is loaded by a browser is the same as <code>this</code>. All we have to do is append this one line to our math module:</p>
<pre class="sourceCode"><code class="sourceCode COFFEESCRIPT"><span class="kw">(</span>exports <span class="kw">?</span> <span class="dt">this</span><span class="kw">).</span>CircularPosition <span class="kw">=</span> CircularPosition</code></pre>
<p>If <code>exports</code><a href="#index-exports"></a> is defined then <code>CircularPosition</code> is added to it otherwise it is added to the top-level environment object. This change has been done in <code>'10-Circular.coffee'</code> and the module is now usable from another module. The other definitions such as the <code>Point</code> class are not visible to other modules. Objects of <code>Point</code> type are of course visible as they are returned by <code>nextPoint</code>. You can use this modular information hiding when creating classes, if you want some definitions to be more private than simply naming them with an <code>'_'</code> in front. We can verify this in an ad-hoc test, this one is called <code>'10-CircularTest.coffee'</code>:</p>
<pre class="sourceCode"><code class="sourceCode COFFEESCRIPT">cp <span class="kw">=</span> require <span class="st">&quot;./10-Circular&quot;</span><br />show <span class="kw">=</span> <span class="ot">console</span><span class="kw">.</span>log<br /><br />circ <span class="kw">=</span> <span class="kw">new</span> <span class="dt">cp.CircularPosition</span> <span class="fl">0.01</span><br /><span class="kw">for</span> i <span class="kw">in</span> <span class="kw">[</span><span class="dv">0</span><span class="kw">...</span><span class="dv">6</span><span class="kw">]</span><br />  show <span class="st">&quot;</span><span class="ch">#{</span>i<span class="ch">}</span><span class="st">: </span><span class="ch">#{</span>circ.nextPoint()<span class="ch">}</span><span class="st">&quot;</span><br /><br /><span class="kw">try</span><br />  show <span class="st">&quot;Instantiating a new Point:&quot;</span><br />  p <span class="kw">=</span> <span class="kw">new</span> <span class="dt">cp.Point</span> <span class="dv">0</span><span class="kw">,</span> <span class="dv">0</span><br />  show <span class="st">&quot;Created a Point&quot;</span><br /><span class="kw">catch</span> e <span class="kw">then</span> show e<span class="kw">.</span>message<br /><br />show <span class="st">&quot;CircularPosition namespace:&quot;</span><br />show cp</code></pre>
<p>The show function was defined in the prelude, so we no longer have access to it. In the underlying environment there is a function <code>console.log</code> that can be used for output. Instead of using <code>console.log</code> directly, defining <code>show</code> as an alias for it makes it easy to copy such code into another environment, the browser were <code>console.log</code> does not exist. When we have many <code>show</code> calls, we only have to change in one place to redirect them to <code>alert</code> or debug output.</p>
<p>The process that we have been through — identifying a rounding error, extracting the implementation into a separate module where it is fixed — is called refactoring and it is an essential part of developing applications. Looking through code and finding places where it can be improved in functionality or in clarity results in a better overall system.</p>
</section>
<section id="section-228">
<h5>○•○</h5>
<p>Designing an interface for a module or an object type is one of the subtler aspects of programming. On the one hand, you do not want to expose too many details. They will only get in the way when using the module. On the other hand, you do not want to be <em>too</em> simple and general, because that might make it impossible to use the module in complex or specialised situations.</p>
<p>Sometimes the solution is to provide two interfaces, a detailed ‘low-level’ one for complicated things, and a simple ‘high-level’ one for straightforward situations. The second one can usually be built very easily using the tools provided by the first one.</p>
<p>In other cases, you just have to find the right idea around which to base your interface. The best way to learn the value of good interface design is, unfortunately, to use bad interfaces. Once you get fed up with them, you will figure out a way to improve them, and learn a lot in the process. Try not to assume that a lousy interface is ‘just the way it is’. Fix it, or wrap it in a new interface that is better.</p>
</section>
<section id="section-229">
<h5>○•○</h5>
<p>Just like an object type, a module has an interface. In collection-of-functions modules such as Underscore, the interface usually consists of all the functions that are defined in the module. In other cases, the interface of the module is only a small part of the functions defined inside it.</p>
<p>For example, our manuscript-to-HTML system from <a href="#functional-programming">Functional Programming↑</a> only needs an interface of a single function, <code>renderFile</code>. The sub-system for building HTML would be a separate module. For modules which only define a single type of object, such as <code>Dictionary</code>, the object’s interface is the same as the module’s interface.</p>
</section>
<section id="section-230">
<h5>○•○</h5>
<p>There are cases where a module will export so many variables that it is a bad idea to put them all into the top-level environment. In cases like this, you can do what the standard <code>Math</code> object does, and represent the module as a single object whose properties are the functions and values it exports. For example…</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">HTML <span class="kw">=</span><br />  tag<span class="kw">:</span> <span class="fu">(name, content, properties) -&gt;</span><br />    name<span class="kw">:</span> name<br />    properties<span class="kw">:</span> properties<br />    content<span class="kw">:</span> content<br />  link<span class="kw">:</span> <span class="fu">(target, text) -&gt;</span><br />    HTML<span class="kw">.</span>tag <span class="st">'a'</span><span class="kw">,</span> <span class="kw">[</span>text<span class="kw">],</span> <span class="kw">{</span>href<span class="kw">:</span> target<span class="kw">}</span><br />  <span class="co"># ... many more HTML-producing functions ...</span></code></pre>
<p>When you need the content of such a module so often that it becomes cumbersome to constantly type <code>HTML</code>, you can always move it into the top-level environment using a function like <code>globalize</code>.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false"><span class="co"># As defined in the prelude</span><br />globalize <span class="kw">=</span> <span class="fu">(ns, target = global) -&gt;</span><br />  target<span class="kw">[</span>name<span class="kw">]</span> <span class="kw">=</span> ns<span class="kw">[</span>name<span class="kw">]</span> <span class="kw">for</span> name <span class="kw">of</span> ns<br /><br />globalize HTML<span class="kw">,</span> window<span class="kw">?</span><br />show link <span class="st">'http://citeseerx.ist.psu.edu/viewdoc/'</span> <span class="kw">+</span><br />  <span class="st">'download?doi=10.1.1.102.244&amp;rep=rep1&amp;type=pdf'</span><span class="kw">,</span><br />  <span class="st">'What Every Computer Scientist Should Know '</span> <span class="kw">+</span><br />  <span class="st">'About Floating-Point Arithmetic'</span></code></pre>
<p>You can even combine the function and object approaches, by putting the internal variables of the module inside a function, and having this function return an object containing its external interface.</p>
</section>
<section id="section-231">
<h5>○•○</h5>
<p>When adding methods to standard prototypes, such as those of <code>Array</code> and <code>Object</code> a similar problem to name-space pollution occurs. If two modules decide to add a <code>map</code> method to <code>Array.prototype</code>, you might have a problem. If these two versions of <code>map</code> have the precise same effect, things will continue to work, but only by sheer luck.</p>
</section>
<section id="section-232">
<h5>○•○</h5>
<p>There are functions which require a lot of arguments. Sometimes this means they are just badly designed, and can easily be remedied by splitting them into a few more modest functions. But in other cases, there is no way around it. Typically, some of these arguments have a sensible ‘default’ value. We could, for example, write yet another extended version of <code>range</code>.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">range <span class="kw">=</span> <span class="fu">(start, end, stepSize, length) -&gt;</span><br />  <span class="kw">if</span> stepSize <span class="kw">is</span> <span class="ot">undefined</span><br />    stepSize <span class="kw">=</span> <span class="dv">1</span><br />  <span class="kw">if</span> end <span class="kw">is</span> <span class="ot">undefined</span><br />    end <span class="kw">=</span> start <span class="kw">+</span> stepSize <span class="kw">*</span> <span class="kw">(</span>length <span class="kw">-</span> <span class="dv">1</span><span class="kw">)</span><br />  result <span class="kw">=</span> <span class="kw">[]</span><br />  <span class="kw">while</span> start <span class="kw">&lt;=</span> end<br />    result<span class="kw">.</span>push start<br />    start <span class="kw">+=</span> stepSize<br />  result<br />show range <span class="dv">0</span><span class="kw">,</span> <span class="ot">undefined</span><span class="kw">,</span> <span class="dv">4</span><span class="kw">,</span> <span class="dv">5</span></code></pre>
<p>It can get hard to remember which argument goes where, not to mention the annoyance of having to pass <code>undefined</code> as a second argument when a <code>length</code> argument is used. We can make passing arguments to this unfriendly function more comprehensive by wrapping them in an object.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">defaultTo <span class="kw">=</span> <span class="fu">(object, values) -&gt;</span><br />  <span class="kw">for</span> name<span class="kw">,</span> value <span class="kw">of</span> values<br />    <span class="kw">if</span> <span class="kw">not</span> object<span class="kw">.</span>hasOwnProperty name<br />      object<span class="kw">[</span>name<span class="kw">]</span> <span class="kw">=</span> value<br /><br />range <span class="kw">=</span> <span class="fu">(args) -&gt;</span><br />  defaultTo args<span class="kw">,</span> <span class="kw">{</span>start<span class="kw">:</span> <span class="dv">0</span><span class="kw">,</span> stepSize<span class="kw">:</span> <span class="dv">1</span><span class="kw">}</span><br />  <span class="kw">if</span> args<span class="kw">.</span>end <span class="kw">is</span> <span class="ot">undefined</span><br />    args<span class="kw">.</span>end <span class="kw">=</span> args<span class="kw">.</span>start <span class="kw">+</span><br />               args<span class="kw">.</span>stepSize <span class="kw">*</span> <span class="kw">(</span>args<span class="kw">.</span>length <span class="kw">-</span> <span class="dv">1</span><span class="kw">)</span><br />  result <span class="kw">=</span> <span class="kw">[];</span><br />  <span class="kw">while</span> args<span class="kw">.</span>start <span class="kw">&lt;=</span> args<span class="kw">.</span>end<br />    result<span class="kw">.</span>push args<span class="kw">.</span>start<br />    args<span class="kw">.</span>start <span class="kw">+=</span> args<span class="kw">.</span>stepSize<br />  result<br />show range <span class="kw">{</span>stepSize<span class="kw">:</span> <span class="dv">4</span><span class="kw">,</span> length<span class="kw">:</span> <span class="dv">5</span><span class="kw">}</span></code></pre>
<p>The <code>defaultTo</code> function is useful for adding default values to an object. It copies the properties of its second argument into its first argument, skipping those that already have a value.</p>
</section>
<section id="section-233">
<h5>○•○</h5>
<p>For the <em>Seed of Life</em> from the <a href="#foreword">Preface↑</a>, to use the <code>'10-Circular.coffee'</code> module in the web application, we have a few things to do. First we can replace the first line with <code>kup = require './prelude/coffeekup'</code>. The source code assigned to <code>webpage</code> has a similar structure as the HTML we saw in <a href="#functional-programming">Functional Programming↑</a>, but instead of being object attributes or text, it is CoffeeScript function calls.</p>
<p>It is like we have HTML embedded as a language extension in CoffeeScript. The correspondence between HTML and Coffeekup is practically 1:1, so when you know which HTML tag you want to use it is straightforward to write it in Coffeekup. You can find more information on the <a href="http://coffeekup.org/">CoffeeKup website</a> or even better take the time to read the source code, it is only a few hundred lines of CoffeeScript and quite readable. There are examples in its standard distribution and <a href="https://github.com/mark-hahn/coffeekup-intro/raw/master/coffeekup-intro-pandoc/coffeekup-intro.pdf">A Beginner’s Introduction to CoffeeKup by Mark Hahn</a>.</p>
<p>In HTML5 there is a <code>canvas</code> tag with which you can create a drawing area. Then you can draw with vector graphics commands on the area. The commands are documented by W3C in <a href="http://www.w3.org/TR/2dcontext/">HTML Canvas 2D Context</a>. If you are already familiar with vector graphics then the <a href="http://www.nihilogic.dk/labs/canvas_sheet/HTML5_Canvas_Cheat_Sheet.pdf">HTML5 Canvas Cheat Sheet</a> may be all you need to create your own drawings. When you choose the technologies that you base your application on, then look for vendor independent, standardized technologies first. They tend to have a long lifespan, so you learn something you can bring with you from task to task. An alternative to the W3C <code>canvas</code> is Adobe Flash.</p>
<p><a href="#index-script"></a>Browsers load JavaScript files when they find a <code>&lt;script&gt;</code> tag with an <code>src</code> attribute in the HTML of a web page. The extension <code>.js</code> is usually used for files containing JavaScript code. We could let the <code>coffee</code> command line compiler produce JavaScript files for us. But then we have two files for every module and someone is bound to forget to compile a file someday, which could lead to strange behaviour and some difficult to find bugs. So instead let’s keep our CoffeeScript files and have the server compile them on the fly. That means we let the web page request a CoffeeScript file, but we will send the browser the corresponding JavaScript.</p>
<pre class="sourceCode"><code class="sourceCode COFFEESCRIPT">script src<span class="kw">:</span> <span class="st">'./10-Circular.coffee'</span></code></pre>
<p>Adding a <code>type: 'text/coffeescript'</code> attribute would tell the client to expect and compile CoffeeScript code (if the CoffeeScript compiler was loaded in the client). While that may sound like a good idea, it has some problems. The biggest one is that the code is only available after the code under the <code>coffeescript</code> function has run. And that function is were we want to use the class from the imported module. So forget about that possibility and compile on the server instead.</p>
<pre class="sourceCode"><code class="sourceCode COFFEESCRIPT">circ <span class="kw">=</span> <span class="kw">new</span> <span class="dt">CircularPosition</span><span class="kw">()</span><br /><span class="kw">for</span> i <span class="kw">in</span> <span class="kw">[</span><span class="dv">0</span><span class="kw">...</span><span class="dv">6</span><span class="kw">]</span><br />  pt <span class="kw">=</span> circ<span class="kw">.</span>nextPoint<span class="kw">()</span><br />  circle ctx<span class="kw">,</span> x<span class="dv">+100</span><span class="kw">*</span>pt<span class="kw">.</span>x<span class="kw">,</span> y<span class="dv">+100</span><span class="kw">*</span>pt<span class="kw">.</span>y</code></pre>
<p>Replacing the loop that used <em>π</em> and trigonometric functions with the one above is the last step for the client side. It is only a few visible changes but we got rid of the rounding error, that fix would have bloated the client with irrelevant details. Here is the client from <code>'10-SeedLife.coffee'</code>:</p>
<pre class="sourceCode"><code class="sourceCode COFFEESCRIPT">kup <span class="kw">=</span> require <span class="st">'./prelude/coffeekup'</span><br /><br /><span class="co"># Client-side web page with canvas</span><br />webpage <span class="kw">=</span> kup<span class="kw">.</span>render <span class="fu">-&gt;</span> <br />  doctype <span class="dv">5</span><br />  html <span class="fu">-&gt;</span><br />    head <span class="fu">-&gt;</span><br />      meta charset<span class="kw">:</span> <span class="st">'utf-8'</span><br />      title <span class="st">'My drawing | My awesome website'</span><br />      style <span class="st">'''</span><br /><span class="st">        body {font-family: sans-serif}</span><br /><span class="st">        header, nav, section, footer {display: block}</span><br /><span class="st">      '''</span><br />      <span class="co"># DO NOT USE: type: 'text/coffeescript'</span><br />      script src<span class="kw">:</span> <span class="st">'./10-Circular.coffee'</span><br /><br />      coffeescript <span class="fu">-&gt;</span><br />        draw <span class="kw">=</span> <span class="fu">(ctx, x, y) -&gt;</span><br />          circle <span class="kw">=</span> <span class="fu">(ctx, x, y) -&gt;</span><br />            ctx<span class="kw">.</span>beginPath<span class="kw">()</span><br />            ctx<span class="kw">.</span>arc x<span class="kw">,</span> y<span class="kw">,</span> <span class="dv">100</span><span class="kw">,</span> <span class="dv">0</span><span class="kw">,</span> <span class="dv">2</span><span class="kw">*</span><span class="ot">Math</span><span class="kw">.</span>PI<span class="kw">,</span> <span class="ot">false</span><br />            ctx<span class="kw">.</span>stroke<span class="kw">()</span><br />          ctx<span class="kw">.</span>strokeStyle <span class="kw">=</span> <span class="st">'rgba(255,40,20,0.7)'</span><br />          circle ctx<span class="kw">,</span> x<span class="kw">,</span> y<br />          circ <span class="kw">=</span> <span class="kw">new</span> <span class="dt">CircularPosition</span><span class="kw">()</span><br />          <span class="kw">for</span> i <span class="kw">in</span> <span class="kw">[</span><span class="dv">0</span><span class="kw">...</span><span class="dv">6</span><span class="kw">]</span><br />            pt <span class="kw">=</span> circ<span class="kw">.</span>nextPoint<span class="kw">()</span><br />            circle ctx<span class="kw">,</span> x<span class="dv">+100</span><span class="kw">*</span>pt<span class="kw">.</span>x<span class="kw">,</span> y<span class="dv">+100</span><span class="kw">*</span>pt<span class="kw">.</span>y<br />        window<span class="kw">.</span>onload <span class="kw">=</span> <span class="fu">-&gt;</span><br />          canvas <span class="kw">=</span> document<span class="kw">.</span>getElementById <span class="st">'drawCanvas'</span><br />          context <span class="kw">=</span> canvas<span class="kw">.</span>getContext <span class="st">'2d'</span><br />          draw context<span class="kw">,</span> <span class="dv">300</span><span class="kw">,</span> <span class="dv">200</span><br />    body <span class="fu">-&gt;</span><br />      header <span class="fu">-&gt;</span> h1 <span class="st">'Seed of Life'</span><br />      canvas id<span class="kw">:</span> <span class="st">'drawCanvas'</span><span class="kw">,</span> width<span class="kw">:</span> <span class="dv">600</span><span class="kw">,</span> height<span class="kw">:</span> <span class="dv">400</span></code></pre>
</section>
<section id="section-234">
<h5>○•○</h5>
<p>It is possible not use a <code>script</code> tag, but to fetch the content of a file directly, and then use the <code>eval</code> function to execute it. This makes script loading instantaneous, and thus easier to deal with. <code>eval</code><a href="#index-eval"></a>, short for ‘evaluate’, is an interesting function. You give it a string value, and it will execute the content of the string as code.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">runOnDemand <span class="fu">-&gt;</span><br />  <span class="ot">eval</span> <span class="st">'function IamJavaScript() {'</span> <span class="kw">+</span><br />       <span class="st">'  alert(\&quot;Repeat after me:'</span> <span class="kw">+</span><br />       <span class="st">' Give me more {();};.\&quot;);};'</span> <span class="kw">+</span><br />       <span class="st">' IamJavaScript();'</span></code></pre>
<p>The global function will however only accept JavaScript, to get a usable CoffeeScript <code>eval</code> function you need to refer to the <code>'coffee-script'</code> library. In a browser it can be like this:</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">runOnDemand <span class="fu">-&gt;</span><br />  CoffeeScript<span class="kw">.</span><span class="ot">eval</span> <span class="st">'alert ((a, b) -&gt; a + b) 3, 4'</span></code></pre>
<p>It is similar in the server environment. But notice the <code>require</code> statement — we are not interested in creating instances of the <code>CoffeeScript</code> class, only in calling its static <code>eval</code> method — so that line helps us avoid writing: <code>cs.CoffeeScript.eval</code>…</p>
<pre class="sourceCode"><code class="sourceCode COFFEESCRIPT">cs <span class="kw">=</span> <span class="kw">(</span>require <span class="st">'coffee-script'</span><span class="kw">).</span>CoffeeScript<br />cs<span class="kw">.</span><span class="ot">eval</span> <span class="st">'show ((a, b) -&gt; a + b) 3, 4'</span></code></pre>
<p>You can imagine that <code>eval</code> can be used to do some interesting things. Code can build new code, and run it. In most cases, however, problems that can be solved with creative uses of <code>eval</code> can also be solved with creative uses of anonymous functions, and the latter is less likely to cause strange problems and security nightmares. When <code>eval</code> is called inside a function, all new variables will become local to that function.</p>
</section>
<section id="section-235">
<h5>○•○</h5>
<p>A web server functions by responding to web browser (client) requests. The minimal implementation given in <em>Seed of Life</em> create a server that takes a function as an argument. Every time a request comes in, the function is called. Such a function is called an event handler or sometimes a callback. This function prints a message and creates a response by writing a header, describing the content of the response, and adding the web page as the response body. The server is started by giving it a port number to listen to. The server then goes to sleep, waiting for a client to request something of it. You can do that by typing <code>http://localhost:3389/</code> in your web browser<sup><a href="#fn34" class="footnoteRef" id="fnref34">34</a></sup>. To stop the server press <code>CTRL-C</code>. It’s similar to this:</p>
<pre class="sourceCode"><code class="sourceCode COFFEESCRIPT"><span class="co"># Server-side HTTP server</span><br />http <span class="kw">=</span> require <span class="st">&quot;http&quot;</span><br />server <span class="kw">=</span> http<span class="kw">.</span>createServer <span class="fu">(req, res) -&gt;</span><br />  show <span class="st">&quot;</span><span class="ch">#{</span>req.client.remoteAddress<span class="ch">}</span><span class="st"> &quot;</span> <span class="kw">+</span><br />       <span class="st">&quot;</span><span class="ch">#{</span>req.method<span class="ch">}</span><span class="st"> </span><span class="ch">#{</span>req.url<span class="ch">}</span><span class="st">&quot;</span><br />  res<span class="kw">.</span>writeHead <span class="dv">200</span><span class="kw">,</span> <span class="st">&quot;Content-Type&quot;</span><span class="kw">:</span> <span class="st">&quot;text/html&quot;</span><br />  res<span class="kw">.</span>write webpage<br />  res<span class="kw">.</span>end<span class="kw">()</span><br />server<span class="kw">.</span>listen <span class="dv">3389</span><br />show <span class="st">&quot;Server running at&quot;</span><br />show server<span class="kw">.</span>address<span class="kw">()</span></code></pre>
<p>That is a bit too minimal for our <em>Seed of Life</em> application because we have to send either the web page or our module depending on what the client will be asking for. We could replace our code with a web server framework but that is not very instructive, it only shows you that something can be done, not how it works internally.</p>
<p>Instead lets expand the server with the minimum of what is required to get it to work. You can reverse engineer the client/server communication by adding a <code>show req</code> to the minimal server. Using the new web page we can see that three items are requested by the client:</p>
<table>
<thead>
<tr class="header">
<th style="align: left">Path</th>
<th style="align: left">Content</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="align: left"><code>'/'</code></td>
<td style="align: left">the web page,</td>
</tr>
<tr class="even">
<td style="align: left"><code>'/10-Circular.coffee'</code></td>
<td style="align: left">the code module, and</td>
</tr>
<tr class="odd">
<td style="align: left"><code>'/favicon.ico'</code></td>
<td style="align: left">that we can ignore.</td>
</tr>
</tbody>
</table>
<p>That is enough information to add some if statements to it.</p>
<p>For the module request we have to read the file, compile it with CoffeeScript (using the same module as <code>eval</code>) and return the compiled code, that the browser can understand, in the response. When a request is made for anything else then a simple response is ‘not found’, that’s a <code>404</code> in HTTP.</p>
<p>If you looked in the prelude how it was reading a file, then that is <em>not</em> the way to read a file in a server. The prelude uses a synchronous function, that means that everything stops until the file has been read. In the world of servers hard disks are slow, and one request should not stop other requests. Using <code>readFile</code> solves this because its last argument is for a function that will only be run when the file has been read — the server can then process other requests in the meantime.</p>
<pre class="sourceCode"><code class="sourceCode COFFEESCRIPT"><span class="co"># Server-side HTTP server</span><br />show <span class="kw">=</span> <span class="ot">console</span><span class="kw">.</span>log<br />http <span class="kw">=</span> require <span class="st">&quot;http&quot;</span><br />fs <span class="kw">=</span> require <span class="st">&quot;fs&quot;</span><br />cs <span class="kw">=</span> require<span class="kw">(</span><span class="st">&quot;coffee-script&quot;</span><span class="kw">).</span>CoffeeScript<br /><br />server <span class="kw">=</span> http<span class="kw">.</span>createServer <span class="fu">(req, res) -&gt;</span><br />  show <span class="st">&quot;</span><span class="ch">#{</span>req.client.remoteAddress<span class="ch">}</span><span class="st"> &quot;</span> <span class="kw">+</span><br />       <span class="st">&quot;</span><span class="ch">#{</span>req.method<span class="ch">}</span><span class="st"> </span><span class="ch">#{</span>req.url<span class="ch">}</span><span class="st">&quot;</span><br />  <span class="kw">if</span> req<span class="kw">.</span>method <span class="kw">is</span> <span class="st">&quot;GET&quot;</span><br />    <span class="kw">if</span> req<span class="kw">.</span>url <span class="kw">is</span> <span class="st">&quot;/&quot;</span><br />      res<span class="kw">.</span>writeHead <span class="dv">200</span><span class="kw">,</span> <span class="st">&quot;Content-Type&quot;</span><span class="kw">:</span> <span class="st">&quot;text/html&quot;</span><br />      res<span class="kw">.</span>write webpage<br />      res<span class="kw">.</span>end<span class="kw">()</span><br />      <span class="kw">return</span><br />    <span class="kw">else</span> <span class="kw">if</span> req<span class="kw">.</span>url <span class="kw">is</span> <span class="st">&quot;/10-Circular.coffee&quot;</span><br />      fs<span class="kw">.</span>readFile <span class="st">&quot;.</span><span class="ch">#{</span>req.url<span class="ch">}</span><span class="st">&quot;</span><span class="kw">,</span> <span class="st">&quot;utf8&quot;</span><span class="kw">,</span> <span class="fu">(err, data) -&gt;</span><br />        <span class="kw">if</span> err <span class="kw">then</span> <span class="kw">throw</span> err<br />        compiledContent <span class="kw">=</span> cs<span class="kw">.</span>compile data<br />        res<span class="kw">.</span>writeHead <span class="dv">200</span><span class="kw">,</span><br />          <span class="st">&quot;Content-Type&quot;</span><span class="kw">:</span> <span class="st">&quot;application/javascript&quot;</span><br />        res<span class="kw">.</span>write compiledContent<br />        res<span class="kw">.</span>end<span class="kw">()</span><br />      <span class="kw">return</span><br />  res<span class="kw">.</span>writeHead <span class="dv">404</span><span class="kw">,</span> <span class="st">&quot;Content-Type&quot;</span><span class="kw">:</span> <span class="st">&quot;text/html&quot;</span><br />  res<span class="kw">.</span>write <span class="st">&quot;404 Not found&quot;</span><br />  res<span class="kw">.</span>end<span class="kw">()</span><br />server<span class="kw">.</span>listen <span class="dv">3389</span><br />show <span class="st">&quot;Server running at&quot;</span><br />show server<span class="kw">.</span>address<span class="kw">()</span></code></pre>
<p>I think you can see that this code practically begs to be abstracted and modularized. Instead of an <code>if</code> chain, we could have a function with an object as argument where each attribute is a request and each value a function to handle the request. Then there is error handling, if the file is not found then the server throws an error and stops. The purpose of <code>'10-SeedLife.coffee'</code> is to show how you can use a module on a web page, so refactoring and beautifying the server is up to you<sup><a href="#fn35" class="footnoteRef" id="fnref35">35</a></sup>.</p>
<p>Building a program as a set of nice, small modules often means the program will use a lot of different files. When programming for the web, having lots of small code files on a page tend to make the page slower to load. This does not have to be a problem though. You can write and test your program as a number of small files, and put them all into a single big file when ‘publishing’ the program to the web. The CoffeeScript compiler has a join feature for this.</p>
</section>
<section id="section-236">
<h5>○•○</h5>
<p>A module or group of modules that can be useful in more than one program is usually called a library<a href="#index-library"></a>. For many programming languages, there is a huge set of quality libraries available. This means programmers do not have to start from scratch all the time, which can make them a lot more productive.</p>
<p>For CoffeeScript, unfortunately, the number of available libraries is not very large. But you can use JavaScript libraries as a stopgap. Underscore is an example of a good library with its ‘basic’ tools, things like <code>map</code> and <code>clone</code>. Other languages tend to provide such obviously useful things as built-in standard features, but with CoffeeScript you will have to either build a collection of them for yourself or use a library.</p>
<p>Using a library is recommended: It is less work, and the code in a library has usually been tested more thoroughly than the things you write yourself. Some things to check when selecting a library is functionality, adequate documentation, and readable source code — and that the library is small enough that you can understand and fix bugs in it — if need be on your own.</p>
</section>
<section id="section-237">
<h5>○•○</h5>
<p>Beyond the concept of modules and programs is the world of distributed programming where processes running on different machines collaborate on solving a task or interact with each other in near real time. One protocol that enables distributed programming is <a href="http://dev.w3.org/html5/websockets/">WebSockets</a>.</p>
<p>A WebSocket is a bi-directional, full-duplex communications channel over a TCP socket. Possibly the same socket that a web server is using. With bi-directional, full-duplex support a server and its clients can send messages back and forth concurrently. It opens the door to many kinds of web applications that would have been difficult to implement over http.</p>
<p>Most of the latest web browsers have support for WebSockets. Some have it disabled by default because of potential security issues in the draft protocol, the prelude shows how to enable WebSocket support in Firefox and Opera. It is enabled in Chrome and Safari. To see if your web browser works with WebSockets you can run <code>'10-TestWebSocket.coffee'</code>.</p>
</section>
<section id="section-238">
<h5>○•○</h5>
<p>To connect a client to a WebSocket server, you create a <code>WebSocket</code> object with a server as its endpoint. Note the <code>ws</code> protocol instead of <code>http</code>:</p>
<pre class="sourceCode"><code class="sourceCode COFFEESCRIPT">websocket <span class="kw">=</span> <span class="kw">new</span> <span class="dt">WebSocket</span> <span class="st">'ws://localhost:8080/'</span></code></pre>
<p>You can attach functions to a <code>WebSocket</code> object, so your code can react when certain events occur. There are four of them:</p>
<ul>
<li><code>onopen</code></li>
<li><code>onclose</code></li>
<li><code>onmessage</code></li>
<li><code>onerror</code></li>
</ul>
<p>Sending a message to the server is done with <code>send</code>. For example:</p>
<pre class="sourceCode"><code class="sourceCode COFFEESCRIPT">websocket<span class="kw">.</span>onopen <span class="kw">=</span> <span class="fu">(evt) -&gt;</span><br />  writeToScreen <span class="st">'CONNECTED'</span><br />  websocket<span class="kw">.</span>send <span class="st">'WebSocket works!'</span></code></pre>
<p>That is how simple it is with a client on a web page. In CoffeeScript’s server-side environment there is not yet support for WebSockets, but that is easily fixed with the <code>ws</code> library from Jacek Becela. It is less than 200 lines when translated into CoffeeScript. It is present in the prelude or you can use it directly from <code>prelude/ws.coffee</code>.</p>
<p>To create a server you pass a function to its <code>createServer</code> method and get a <code>websocket</code> object as an argument where you can attach methods to listen for events. To send a message to a client, call its <code>write</code> method with a string. Here is an abbreviated use of it:</p>
<pre class="sourceCode"><code class="sourceCode COFFEESCRIPT">wsHandler <span class="kw">=</span> <span class="fu">(websocket) -&gt;</span><br />  websocket<span class="kw">.</span><span class="ot">on</span> <span class="st">'connect'</span><span class="kw">,</span> <span class="fu">(resource) -&gt;</span><br />    show <span class="st">'connect: '</span> <span class="kw">+</span> resource<br />    <span class="co"># ...</span><br />  websocket<span class="kw">.</span><span class="ot">on</span> <span class="st">'data'</span><span class="kw">,</span> <span class="fu">(data) -&gt;</span><br />    show data                    <span class="co"># process data</span><br />    websocket<span class="kw">.</span>write <span class="st">'Cowabunga!'</span> <span class="co"># respond</span><br />  <span class="co"># ...</span><br /><br />wsServer <span class="kw">=</span> ws<span class="kw">.</span>createServer wsHandler<br />wsServer<span class="kw">.</span>listen <span class="dv">8080</span></code></pre>
</section>
<section id="section-239">
<h5>○•○</h5>
<p>So without further ado here follows an animated version of <em>Seed of Life</em>… Find it in <code>'10-WebSocketLife.coffee'</code> and change it any way you like.</p>
<pre class="sourceCode"><code class="sourceCode COFFEESCRIPT">kup <span class="kw">=</span> require <span class="st">'./prelude/coffeekup'</span><br /><br /><span class="co"># Web page with canvas and client-side WebSocket</span><br />webpage <span class="kw">=</span> kup<span class="kw">.</span>render <span class="fu">-&gt;</span> <br />  doctype <span class="dv">5</span><br />  html <span class="fu">-&gt;</span><br />    head <span class="fu">-&gt;</span><br />      meta charset<span class="kw">:</span> <span class="st">'utf-8'</span><br />      title <span class="st">'My animation | My awesome website'</span><br />      style <span class="st">'''</span><br /><span class="st">        body {font-family: sans-serif}</span><br /><span class="st">        header, nav, section, footer {display: block}</span><br /><span class="st">      '''</span><br />      coffeescript <span class="fu">-&gt;</span><br />        show <span class="kw">=</span> <span class="fu">(msg) -&gt;</span> <span class="ot">console</span><span class="kw">.</span>log msg<br />        color <span class="kw">=</span> <span class="st">'rgba(255,40,20,0.7)'</span><br />        circle <span class="kw">=</span> <span class="fu">(ctx, x, y) -&gt;</span><br />          ctx<span class="kw">.</span>strokeStyle <span class="kw">=</span> color<br />          ctx<span class="kw">.</span>beginPath<span class="kw">()</span><br />          ctx<span class="kw">.</span>arc x<span class="kw">,</span> y<span class="kw">,</span> <span class="dv">100</span><span class="kw">,</span> <span class="dv">0</span><span class="kw">,</span> <span class="dv">2</span><span class="kw">*</span><span class="ot">Math</span><span class="kw">.</span>PI<span class="kw">,</span> <span class="ot">false</span><br />          ctx<span class="kw">.</span>stroke<span class="kw">()</span><br /><br />        addElement <span class="kw">=</span> <span class="fu">(ni, num, text) -&gt;</span><br />          newdiv <span class="kw">=</span> document<span class="kw">.</span>createElement <span class="st">'div'</span><br />          newdiv<span class="kw">.</span>setAttribute <span class="st">'id'</span><span class="kw">,</span> <span class="st">'div'</span> <span class="kw">+</span> num<br />          newdiv<span class="kw">.</span>innerHTML <span class="kw">=</span> text<br />          ni<span class="kw">.</span>appendChild newdiv<br /><br />        wsUri <span class="kw">=</span> <span class="st">'ws://localhost:8080/'</span><br />        websocket <span class="kw">=</span> <span class="ot">undefined</span><br />        num <span class="kw">=</span> <span class="dv">0</span><br />        socketClient <span class="kw">=</span> <span class="fu">(buffer, ctx, x, y) -&gt;</span><br />          websocket <span class="kw">=</span> <span class="kw">new</span> <span class="dt">WebSocket</span> wsUri<br />          websocket<span class="kw">.</span>onopen <span class="kw">=</span> <span class="fu">(evt) -&gt;</span><br />            show <span class="st">'Connected'</span><br />          websocket<span class="kw">.</span>onclose <span class="kw">=</span> <span class="fu">(evt) -&gt;</span><br />            show <span class="st">'Closed'</span><br />          websocket<span class="kw">.</span>onerror <span class="kw">=</span> <span class="fu">(evt) -&gt;</span><br />            show <span class="st">'Error: '</span> <span class="kw">+</span> evt<span class="kw">.</span>data<br />          websocket<span class="kw">.</span>onmessage <span class="kw">=</span> <span class="fu">(evt) -&gt;</span><br />            <span class="co">#show evt.data</span><br />            addElement buffer<span class="kw">,</span> num<span class="kw">++,</span> evt<span class="kw">.</span>data<br />            pt <span class="kw">=</span> JSON<span class="kw">.</span>parse evt<span class="kw">.</span>data<br />            <span class="kw">if</span> pt<span class="kw">.</span>color<span class="kw">?</span> <span class="kw">then</span> color <span class="kw">=</span> pt<span class="kw">.</span>color<br />            circle ctx<span class="kw">,</span> x<span class="dv">+100</span><span class="kw">*</span>pt<span class="kw">.</span>x<span class="kw">,</span> y<span class="dv">+100</span><span class="kw">*</span>pt<span class="kw">.</span>y<br /><br />        window<span class="kw">.</span>onload <span class="kw">=</span> <span class="fu">-&gt;</span><br />          canvas <span class="kw">=</span> document<span class="kw">.</span>getElementById <span class="st">'drawCanvas'</span><br />          context <span class="kw">=</span> canvas<span class="kw">.</span>getContext <span class="st">'2d'</span><br />          buffer <span class="kw">=</span> document<span class="kw">.</span>getElementById <span class="st">'message'</span><br />          socketClient buffer<span class="kw">,</span> context<span class="kw">,</span> <span class="dv">300</span><span class="kw">,</span> <span class="dv">200</span><br /><br />        window<span class="kw">.</span>sendMessage <span class="kw">=</span> <span class="fu">-&gt;</span><br />          msg <span class="kw">=</span> document<span class="kw">.</span>getElementById<span class="kw">(</span><span class="st">'entryfield'</span><span class="kw">).</span>value<br />          websocket<span class="kw">.</span>send msg<br /><br />    body <span class="fu">-&gt;</span><br />      header <span class="fu">-&gt;</span> h1 <span class="st">'Seed of Life'</span><br />      input id<span class="kw">:</span><span class="st">'entryfield'</span><span class="kw">,</span> value<span class="kw">:</span><span class="st">'rgba(40,200,25,0.7)'</span><br />      button type<span class="kw">:</span> <span class="st">'button'</span><span class="kw">,</span> onclick<span class="kw">:</span> <span class="st">'sendMessage()'</span><br />        <span class="st">'Change Color'</span><br />      br<br />      canvas id<span class="kw">:</span> <span class="st">'drawCanvas'</span><span class="kw">,</span> width<span class="kw">:</span> <span class="dv">600</span><span class="kw">,</span> height<span class="kw">:</span> <span class="dv">400</span><br />      div id<span class="kw">:</span> <span class="st">'message'</span><br /><br /><span class="co"># Server-side WebSocket server</span><br />ws <span class="kw">=</span> require <span class="st">'./prelude/ws'</span><br />cp <span class="kw">=</span> require <span class="st">'./10-Circular'</span><br />wsHandler <span class="kw">=</span> <span class="fu">(websocket) -&gt;</span><br />  websocket<span class="kw">.</span><span class="ot">on</span> <span class="st">'connect'</span><span class="kw">,</span> <span class="fu">(resource) -&gt;</span><br />    show <span class="st">'connect: '</span> <span class="kw">+</span> resource<br />    <span class="co"># close connection after 10s</span><br />    <span class="ot">setTimeout</span> websocket<span class="kw">.</span>end<span class="kw">,</span> <span class="dv">10</span> <span class="kw">*</span> <span class="dv">1000</span><br /><br />  websocket<span class="kw">.</span><span class="ot">on</span> <span class="st">'data'</span><span class="kw">,</span> <span class="fu">(data) -&gt;</span><br />    show data <span class="co"># process data</span><br />    blue <span class="kw">=</span> <span class="st">'rgba(40,20,255,0.7)'</span><br />    websocket<span class="kw">.</span>write JSON<span class="kw">.</span>stringify<br />      color<span class="kw">:</span> <span class="kw">if</span> data <span class="kw">is</span> <span class="st">''</span> <span class="kw">then</span> blue <span class="kw">else</span> data<br /><br />  websocket<span class="kw">.</span><span class="ot">on</span> <span class="st">'close'</span><span class="kw">,</span> <span class="fu">-&gt;</span><br />    show <span class="st">'closing'</span><br />    process<span class="kw">.</span>exit <span class="dv">0</span> <span class="co"># Exit server completely</span><br /><br />  circ <span class="kw">=</span> <span class="kw">new</span> <span class="dt">cp.CircularPosition</span> <span class="fl">0.01</span><br />  annoy <span class="kw">=</span> <span class="ot">setInterval</span> <span class="kw">(</span><span class="fu">-&gt;</span><br />    websocket<span class="kw">.</span>write JSON<span class="kw">.</span>stringify circ<span class="kw">.</span>nextPoint<span class="kw">()),</span> <span class="dv">20</span><br /><br />wsServer <span class="kw">=</span> ws<span class="kw">.</span>createServer wsHandler<br />wsServer<span class="kw">.</span>listen <span class="dv">8080</span><br /><br /><span class="co"># Launch test server and client UI</span><br />require <span class="st">'./prelude'</span><br />viewServer webpage</code></pre>
</section>
<section id="section-240">
<h5>○•○</h5>
<p>Through the examples, exercises and explanations you have a foundation for your own projects: a collaborative web application, a multi-user game, a library with an aesthetically pleasing implementation, …</p>
<p>First choose what your project is going to be about, then look to <a href="https://github.com/languages/CoffeeScript">github</a> for supporting code and libraries. A couple of interesting ones for web applications are <a href="https://github.com/mauricemach/zappa">Zappa</a> and <a href="https://github.com/socketstream/socketstream">SocketStream</a>.</p>
<p>If you would like a broader foundation in computer science then read: <a href="http://cisnet.mit.edu/4i7o9/5cjhf/toc">Concepts, Techniques, and Models of Computer Programming</a> by Peter van Roy and Seif Haridi. Not a word of CoffeeScript, but plenty of insight.</p>
<blockquote>
<p><em>He who has begun has half done. Dare to be wise; begin!</em></p>
</blockquote>
<p>Quintus Horatius Flaccus</p>
<hr />
</section>
</section>
</section>
<section id="part-iv.-appendix">
<h2>Part IV. Appendix</h2>
<hr />
<section id="language-extras">
<h3>Language extras</h3>
<hr />
<p>Most of the CoffeeScript language has been introduced in Smooth CoffeeScript. This appendix illustrates some extra language constructs and idioms that may come in handy.</p>
<section id="section-241">
<h5>○•○</h5>
<p>There is a statement called <code>switch</code><a href="#index-switch"></a> which can be used to choose which code to execute based on some value. Alternatives include a chain of <code>if</code> statements or an associative data structure.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">weatherAdvice <span class="kw">=</span> <span class="fu">(weather) -&gt;</span><br />  show <span class="st">'When it is '</span> <span class="kw">+</span> weather<br />  <span class="kw">switch</span> weather<br />    <span class="kw">when</span> <span class="st">'sunny'</span><br />      show <span class="st">'Dress lightly.'</span><br />      show <span class="st">'Go outside.'</span><br />    <span class="kw">when</span> <span class="st">'cloudy'</span><br />      show <span class="st">'Go outside.'</span><br />    <span class="kw">when</span> <span class="st">'tornado'</span><span class="kw">,</span> <span class="st">'hurricane'</span><br />      show <span class="st">'Seek shelter'</span><br />    <span class="kw">else</span><br />      show <span class="st">'Unknown weather type: '</span> <span class="kw">+</span> weather<br />weatherAdvice <span class="st">'sunny'</span><br />weatherAdvice <span class="st">'cloudy'</span><br />weatherAdvice <span class="st">'tornado'</span><br />weatherAdvice <span class="st">'hailstorm'</span></code></pre>
<p>Inside the block opened by <code>switch</code>, you can write a number of <code>when</code> labels. The program will jump to the label that corresponds to the value that <code>switch</code> was given or to <code>else</code> if no matching value is found. Then it executes statements in the following block until it reaches the next <code>when</code> or <code>else</code> statement. Unlike some other languages there is no fall-through between <code>when</code> cases and no <code>break</code> statement is therefore needed. You can have a comma-separated lists after a <code>when</code>, any of the values is then used to find a match.</p>
</section>
<section id="section-242">
<h5>○•○</h5>
<p>Closely related to <code>break</code>, there is <code>continue</code><a href="#index-continue"></a>. They can be used in the same places. While <code>break</code> jumps <em>out</em> of a loop and causes the program to proceed after the loop, <code>continue</code> jumps to the next iteration of the loop.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false"><span class="kw">for</span> i <span class="kw">in</span> <span class="kw">[</span><span class="dv">20</span><span class="kw">...</span><span class="dv">30</span><span class="kw">]</span><br />  <span class="kw">if</span> i <span class="kw">%</span> <span class="dv">3</span> <span class="kw">isnt</span> <span class="dv">0</span><br />    <span class="kw">continue</span><br />  show i <span class="kw">+</span> <span class="st">' is divisible by three.'</span></code></pre>
<p>A similar effect can usually be produced using just <code>if</code>, but there are cases where <code>continue</code> looks nicer.</p>
</section>
<section id="section-243">
<h5>○•○</h5>
<p>Pattern matching has been touched upon, a few more examples can clarify the scope of it. You can assign an object to an anonymous object with matching attribute names.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false"><span class="kw">class</span> <span class="dt">Point</span><br />  <span class="kw">constructor</span><span class="kw">:</span> <span class="fu">(@x, @y) -&gt;</span><br />pt <span class="kw">=</span> <span class="kw">new</span> <span class="dt">Point</span> <span class="dv">3</span><span class="kw">,</span> <span class="dv">4</span><br /><br /><span class="kw">{</span>x<span class="kw">,</span> y<span class="kw">}</span> <span class="kw">=</span> pt<br />show <span class="st">&quot;x is </span><span class="ch">#{</span>x<span class="ch">}</span><span class="st"> and y is </span><span class="ch">#{</span>y<span class="ch">}</span><span class="st">&quot;</span></code></pre>
<p>Attribute names can be inferred from an anonymous object. A function can have an anonymous object as argument and extract the attributes as variables.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">firstName <span class="kw">=</span> <span class="st">&quot;Alan&quot;</span><br />lastName <span class="kw">=</span> <span class="st">&quot;Turing&quot;</span><br /><br />name <span class="kw">=</span> <span class="kw">{</span>firstName<span class="kw">,</span> lastName<span class="kw">}</span><br />show name<br /><br />decorate <span class="kw">=</span> <span class="fu">({firstName, lastName}) -&gt;</span><br />  show <span class="st">&quot;Distinguished </span><span class="ch">#{</span>firstName<span class="ch">}</span><span class="st"> &quot;</span> <span class="kw">+</span><br />       <span class="st">&quot;of the </span><span class="ch">#{</span>lastName<span class="ch">}</span><span class="st"> family.&quot;</span><br />decorate name</code></pre>
</section>
<section id="section-244">
<h5>○•○</h5>
<p>Unicode can be used in identifiers. Letter forms that are very similar to characters in the western alphabets should be avoided. It can be difficult in internationally shared projects due to different keyboard layouts, but useful in teaching math or in a local language.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">pi <span class="kw">=</span> &#960; <span class="kw">=</span> <span class="ot">Math</span><span class="kw">.</span>PI<br />sphereSurfaceArea <span class="kw">=</span> <span class="fu">(r) -&gt;</span> <span class="dv">4</span> <span class="kw">*</span> &#960; <span class="kw">*</span> r <span class="kw">*</span> r<br />radius <span class="kw">=</span> <span class="dv">1</span><br />show <span class="st">'4 * &#960; * r * r when r = '</span> <span class="kw">+</span> radius<br />show sphereSurfaceArea radius</code></pre>
</section>
<section id="section-245">
<h5>○•○</h5>
<p>Qualifying a <code>for</code> statement with a <code>when</code> clause can be used to filter array or object elements on a logical condition. Great for one-liners.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">evens <span class="kw">=</span> <span class="fu">(n) -&gt;</span> i <span class="kw">for</span> i <span class="kw">in</span> <span class="kw">[</span><span class="dv">0</span><span class="kw">..</span>n<span class="kw">]</span> <span class="kw">when</span> i <span class="kw">%</span> <span class="dv">2</span> <span class="kw">is</span> <span class="dv">0</span><br />show evens <span class="dv">6</span><br /><br />steppenwolf <span class="kw">=</span> <br />  title<span class="kw">:</span>   <span class="st">'Tonight at the Magic Theater'</span><br />  warning<span class="kw">:</span> <span class="st">'For Madmen only'</span><br />  caveat<span class="kw">:</span>  <span class="st">'Price of Admittance: Your Mind.'</span><br />  caution<span class="kw">:</span> <span class="st">'Not for Everybody.'</span><br /><br />stipulations <span class="kw">=</span> <span class="kw">(</span>text <span class="kw">for</span> key<span class="kw">,</span> text <span class="kw">of</span> steppenwolf \<br />  <span class="kw">when</span> key <span class="kw">in</span> <span class="kw">[</span><span class="st">'warning'</span><span class="kw">,</span> <span class="st">'caveat'</span><span class="kw">])</span><br />show stipulations<br />show ultimatum <span class="kw">for</span> ultimatum <span class="kw">in</span> stipulations \<br />  <span class="kw">when</span> ultimatum<span class="kw">.</span>match <span class="st">/Price/</span></code></pre>
</section>
<section id="section-246">
<h5>○•○</h5>
<p>Destructuring assignment can be used to swap or reassign variables. It is also handy for extracting values or returning multiple values from a function.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">tautounlogical <span class="kw">=</span> <span class="st">&quot;the reason is because I say so&quot;</span><br />splitStringAt <span class="kw">=</span> <span class="fu">(str, n) -&gt;</span><br />  <span class="kw">[</span>str<span class="kw">.</span>substring<span class="kw">(</span><span class="dv">0</span><span class="kw">,</span>n<span class="kw">),</span> str<span class="kw">.</span>substring<span class="kw">(</span>n<span class="kw">)]</span><br /><span class="kw">[</span>pre<span class="kw">,</span> post<span class="kw">]</span> <span class="kw">=</span> splitStringAt tautounlogical<span class="kw">,</span> <span class="dv">14</span><br /><span class="kw">[</span>pre<span class="kw">,</span> post<span class="kw">]</span> <span class="kw">=</span> <span class="kw">[</span>post<span class="kw">,</span> pre<span class="kw">]</span> <span class="co"># swap</span><br />show <span class="st">&quot;</span><span class="ch">#{</span>pre<span class="ch">}</span><span class="st"> </span><span class="ch">#{</span>post<span class="ch">}</span><span class="st">&quot;</span></code></pre>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false"><span class="kw">[</span>re<span class="kw">,</span>mi<span class="kw">,</span>fa<span class="kw">,</span>sol<span class="kw">,</span>la<span class="kw">,</span>ti<span class="kw">]</span> <span class="kw">=</span> <span class="kw">[</span><span class="dv">1</span><span class="kw">..</span><span class="dv">6</span><span class="kw">]</span><br /><span class="kw">[</span>dal<span class="kw">,</span>ra<span class="kw">...,</span>mim<span class="kw">]</span> <span class="kw">=</span> <span class="kw">[</span>ti<span class="kw">,</span>re<span class="kw">,</span>fa<span class="kw">,</span>sol<span class="kw">,</span>la<span class="kw">,</span>mi<span class="kw">]</span><br />show <span class="st">&quot;</span><span class="ch">#{</span>dal<span class="ch">}</span><span class="st">, </span><span class="ch">#{</span>ra<span class="ch">}</span><span class="st"> and </span><span class="ch">#{</span>mim<span class="ch">}</span><span class="st">&quot;</span><br /><br /><span class="kw">[</span>key<span class="kw">,</span> word<span class="kw">]</span> <span class="kw">=</span> <span class="kw">if</span> re <span class="kw">&gt;</span> ti <span class="kw">then</span> <span class="kw">[</span>mi<span class="kw">,</span> fa<span class="kw">]</span> <span class="kw">else</span> <span class="kw">[</span>fa<span class="kw">,</span> mi<span class="kw">]</span><br />show <span class="st">&quot;</span><span class="ch">#{</span>key<span class="ch">}</span><span class="st"> and </span><span class="ch">#{</span>word<span class="ch">}</span><span class="st">&quot;</span></code></pre>
</section>
<section id="section-247">
<h5>○•○</h5>
<p>A function can be bound to the <code>this</code> value that is in effect when it is defined. This can be needed when you are using event handlers or callback based libraries e.g. jQuery. Instead of <code>-&gt;</code> use <code>=&gt;</code> to bind <code>this</code>.</p>
<p>In the following example the <code>a.display</code> would show <code>undefined</code> when called in the <code>Container</code> if <code>display</code> was defined with <code>-&gt;</code>.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false"><span class="kw">class</span> <span class="dt">Widget</span><br />  id<span class="kw">:</span> <span class="st">'I am a widget'</span><br />  display<span class="kw">:</span> <span class="fu">=&gt;</span> show <span class="dt">@id</span><br /><br /><span class="kw">class</span> <span class="dt">Container</span><br />  id<span class="kw">:</span> <span class="st">'I am a container'</span><br />  callback<span class="kw">:</span> <span class="fu">(f) -&gt;</span><br />    show <span class="dt">@id</span><br />    f<span class="kw">()</span><br /><br />a <span class="kw">=</span> <span class="kw">new</span> <span class="dt">Widget</span><br />a<span class="kw">.</span>display<span class="kw">()</span><br />b <span class="kw">=</span> <span class="kw">new</span> <span class="dt">Container</span><br />b<span class="kw">.</span>callback a<span class="kw">.</span>display</code></pre>
</section>
<section id="section-248">
<h5>○•○</h5>
<p>With the <code>do</code> statement you can call a named or an anonymous function:</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">n <span class="kw">=</span> <span class="dv">3</span><br />f <span class="kw">=</span> <span class="fu">-&gt;</span> show <span class="st">&quot;Say: 'Yes!'&quot;</span><br />do f<br /><span class="kw">(</span>do <span class="fu">-&gt;</span> show <span class="st">&quot;Yes!&quot;</span><span class="kw">)</span> <span class="kw">while</span> n<span class="kw">--</span> <span class="kw">&gt;</span> <span class="dv">0</span></code></pre>
<p>Which is reminiscent of the syntax for a function that takes a function as its parameter.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">echoEchoEcho <span class="kw">=</span> <span class="fu">(msg) -&gt;</span> msg<span class="kw">()</span> <span class="kw">+</span> msg<span class="kw">()</span> <span class="kw">+</span> msg<span class="kw">()</span><br />show echoEchoEcho <span class="fu">-&gt;</span> <span class="st">&quot;No&quot;</span></code></pre>
<p>The <code>do</code> statement captures the environment, so it is available inside its block. The <code>setTimeout</code> function calls the innermost function after the loop has finished. Without capture the <code>i</code> variable is <code>4</code>.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">runOnDemand <span class="fu">-&gt;</span><br />  <span class="kw">for</span> i <span class="kw">in</span> <span class="kw">[</span><span class="dv">1</span><span class="kw">..</span><span class="dv">3</span><span class="kw">]</span><br />    do <span class="fu">(i) -&gt;</span><br />      <span class="ot">setTimeout</span> <span class="kw">(</span><span class="fu">-&gt;</span> show <span class="st">'With do: '</span> <span class="kw">+</span> i<span class="kw">),</span> <span class="dv">0</span><br />  <span class="kw">for</span> i <span class="kw">in</span> <span class="kw">[</span><span class="dv">1</span><span class="kw">..</span><span class="dv">3</span><span class="kw">]</span><br />    <span class="ot">setTimeout</span> <span class="kw">(</span><span class="fu">-&gt;</span> show <span class="st">'Without: '</span> <span class="kw">+</span> i<span class="kw">),</span> <span class="dv">0</span></code></pre>
<hr />
</section>
</section>
<section id="binary-heaps">
<h3>Binary Heaps</h3>
<hr />
<p>In <a href="#searching">Searching↑</a>, the binary heap<a href="#index-binary-heap"></a> was introduced as a method to store a collection of objects in such a way that the smallest element can be quickly found. As promised, this appendix will explain the details behind this data structure.</p>
<p>Consider again the problem we needed to solve. The A* algorithm created large amounts of small objects, and had to keep these in an ‘open list’. It was also constantly removing the smallest element from this list. The simplest approach would be to just keep all the objects in an array, and search for the smallest one when we need it. But, unless we have a <em>lot</em> of time, this will not do. Finding the smallest element in an unsorted array requires going over the whole array, and checking each element.</p>
<p>The next solution would be, of course, to sort our array. CoffeeScript arrays have a wonderful <code>sort</code><a href="#index-sort"></a> method, which can be used to do the heavy work. Unfortunately, re-sorting a whole array every time an element is removed is more work than searching for a minimum value in an unsorted array. Some tricks can be used, such as, instead of re-sorting the whole array, just making sure new values are inserted in the right place so that the array, which was sorted before, stays sorted. This is coming closer to the approach a binary heap uses already, but inserting a value in the middle of an array requires moving all the elements after it one place up, which is still just too slow.</p>
<p>Another approach is to not use an array at all, but to store the values in a set of interconnected objects. A simple form of this is to have every object hold one value and two (or less) links to other objects. There is one root object, holding the smallest value, which is used to access all the other objects. Links always point to objects holding greater values, so the whole structure looks something like this:</p>
<p align=center><img src="../img/tree-small.png" alt="figure ../img/tree-small.png" /><br /></p>
<p>Such structures are usually called tree<a href="#index-tree"></a>s, because of the way they branch. Now, when you need the smallest element, you just take off the top element and rearrange the tree so that one of the top element’s children — the one with the lowest value — becomes the new top. When inserting new elements, you ‘descend’ the tree until you find an element less than the new element, and insert it there. This takes a lot less searching than a sorted array does, but it has the disadvantage of creating a lot of objects, which also slows things down.</p>
<section id="section-249">
<h5>○•○</h5>
<p>A binary heap, then, does make use of a sorted array, but it is only partially sorted, much like the tree above. Instead of objects, the positions in the array are used to form a tree, as this picture tries to show:</p>
<p align=center><img src="../img/heap-small.png" alt="figure ../img/heap-small.png" /><br /></p>
<p>Array element <code>1</code> is the root of the tree, array element <code>2</code> and <code>3</code> are its children, and in general array element <code>X</code> has children <code>X * 2</code> and <code>X * 2 + 1</code>. You can see why this structure is called a ‘heap’. Note that this array starts at <code>1</code>, while CoffeeScript arrays start at <code>0</code>. The heap will always keep the smallest element in position <code>1</code>, and make sure that for every element in the array at position <code>X</code>, the element at <code>X / 2</code> (round down) is smaller.</p>
<p>Finding the smallest element is now a matter of taking the element at position <code>1</code>. But when this element is removed, the heap must make sure that there are no holes left in the array. To do this, it takes the last element in the array and moves it to the start, and then compares it to its child elements at position <code>2</code> and <code>3</code>. It is likely to be greater, so it is exchanged with one of them, and the process of comparing it with its children is repeated for the new position, and so on, until it comes to a position where its children are greater, or a position where it has no children.</p>
<pre class="sourceCode"><code class="sourceCode COFFEESCRIPT"><span class="kw">[</span><span class="dv">2</span><span class="kw">,</span> <span class="dv">3</span><span class="kw">,</span> <span class="dv">5</span><span class="kw">,</span> <span class="dv">4</span><span class="kw">,</span> <span class="dv">8</span><span class="kw">,</span> <span class="dv">7</span><span class="kw">,</span> <span class="dv">6</span><span class="kw">]</span><br /><span class="co"># Take out 2, move 6 to the front.</span><br /><span class="kw">[</span><span class="dv">6</span><span class="kw">,</span> <span class="dv">3</span><span class="kw">,</span> <span class="dv">5</span><span class="kw">,</span> <span class="dv">4</span><span class="kw">,</span> <span class="dv">8</span><span class="kw">,</span> <span class="dv">7</span><span class="kw">]</span><br /><span class="co"># 6 is greater than its first child 3, so swap them.</span><br /><span class="kw">[</span><span class="dv">3</span><span class="kw">,</span> <span class="dv">6</span><span class="kw">,</span> <span class="dv">5</span><span class="kw">,</span> <span class="dv">4</span><span class="kw">,</span> <span class="dv">8</span><span class="kw">,</span> <span class="dv">7</span><span class="kw">]</span><br /><span class="co"># Now 6 has children 4 and 8 (position 4 and 5).</span><br /><span class="co"># It is greater than 4, so we swap again.</span><br /><span class="kw">[</span><span class="dv">3</span><span class="kw">,</span> <span class="dv">4</span><span class="kw">,</span> <span class="dv">5</span><span class="kw">,</span> <span class="dv">6</span><span class="kw">,</span> <span class="dv">8</span><span class="kw">,</span> <span class="dv">7</span><span class="kw">]</span><br /><span class="co"># 6 is in position 4, and has no more children.</span><br /><span class="co"># The heap is in order again.</span></code></pre>
<p>Similarly, when an element has to be added to the heap, it is put at the end of the array and allowed to ‘bubble’ up by repeatedly exchanging it with its parent, until we find a parent that is less than the new node.</p>
<pre class="sourceCode"><code class="sourceCode COFFEESCRIPT"><span class="kw">[</span><span class="dv">3</span><span class="kw">,</span> <span class="dv">4</span><span class="kw">,</span> <span class="dv">5</span><span class="kw">,</span> <span class="dv">6</span><span class="kw">,</span> <span class="dv">8</span><span class="kw">,</span> <span class="dv">7</span><span class="kw">]</span><br /><span class="co"># Element 2 gets added again, it starts at the back.</span><br /><span class="kw">[</span><span class="dv">3</span><span class="kw">,</span> <span class="dv">4</span><span class="kw">,</span> <span class="dv">5</span><span class="kw">,</span> <span class="dv">6</span><span class="kw">,</span> <span class="dv">8</span><span class="kw">,</span> <span class="dv">7</span><span class="kw">,</span> <span class="dv">2</span><span class="kw">]</span><br /><span class="co"># 2 is in position 7, its parent is at 3, which</span><br /><span class="co"># is a 5. 5 is greater than 2, so we swap.</span><br /><span class="kw">[</span><span class="dv">3</span><span class="kw">,</span> <span class="dv">4</span><span class="kw">,</span> <span class="dv">2</span><span class="kw">,</span> <span class="dv">6</span><span class="kw">,</span> <span class="dv">8</span><span class="kw">,</span> <span class="dv">7</span><span class="kw">,</span> <span class="dv">5</span><span class="kw">]</span><br /><span class="co"># The parent of position 3 is position 1.</span><br /><span class="co"># Again, we swap.</span><br /><span class="kw">[</span><span class="dv">2</span><span class="kw">,</span> <span class="dv">4</span><span class="kw">,</span> <span class="dv">3</span><span class="kw">,</span> <span class="dv">6</span><span class="kw">,</span> <span class="dv">8</span><span class="kw">,</span> <span class="dv">7</span><span class="kw">,</span> <span class="dv">5</span><span class="kw">]</span><br /><span class="co"># The element can not go further than position 1,</span><br /><span class="co"># so we are done.</span></code></pre>
<p>Note how adding or inserting an element does not require it to be compared with every element in the array. In fact, because the jumps between parents and children get bigger as the array gets bigger, this advantage is especially large when we have a lot of elements<sup><a href="#fn36" class="footnoteRef" id="fnref36">36</a></sup>.</p>
</section>
<section id="section-250">
<h5>○•○</h5>
<p>Here is the full code of a binary heap implementation. Two things to note are that, instead of directly comparing the elements put into the heap, a function (<code>scoreFunction</code>) is first applied to them, so that it becomes possible to store objects that can not be directly compared. The default is the identity function.</p>
<p>Also, because CoffeeScript arrays start at <code>0</code>, and the parent/child calculations use a system that starts at <code>1</code>, there are a few strange calculations to compensate.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false"><span class="kw">class</span> <span class="dt">BinaryHeap</span><br /><br />  <span class="co"># Public</span><br />  <span class="co">#--------</span><br />  <span class="kw">constructor</span><span class="kw">:</span> <span class="kw">(</span><span class="dt">@scoreFunction</span> <span class="kw">=</span> <span class="fu">(x) -&gt;</span> x<span class="kw">)</span> <span class="fu">-&gt;</span><br />    <span class="dt">@content</span> <span class="kw">=</span> <span class="kw">[]</span><br /><br />  push<span class="kw">:</span> <span class="fu">(element) -&gt;</span><br />    <span class="co"># Add the new element to the end of the array.</span><br />    <span class="dt">@content</span><span class="kw">.</span>push element<br />    <span class="co"># Allow it to bubble up.</span><br />    <span class="dt">@_bubbleUp</span> <span class="dt">@content</span><span class="kw">.</span>length <span class="kw">-</span> <span class="dv">1</span><br /><br />  pop<span class="kw">:</span> <span class="fu">-&gt;</span><br />    <span class="co"># Store the first element so we can return it later.</span><br />    result <span class="kw">=</span> <span class="dt">@content</span><span class="kw">[</span><span class="dv">0</span><span class="kw">]</span><br />    <span class="co"># Get the element at the end of the array.</span><br />    end <span class="kw">=</span> <span class="dt">@content</span><span class="kw">.</span>pop<span class="kw">()</span><br />    <span class="co"># If there are any elements left, put the end</span><br />    <span class="co"># element at the start, and let it sink down.</span><br />    <span class="kw">if</span> <span class="dt">@content</span><span class="kw">.</span>length <span class="kw">&gt;</span> <span class="dv">0</span><br />      <span class="dt">@content</span><span class="kw">[</span><span class="dv">0</span><span class="kw">]</span> <span class="kw">=</span> end<br />      <span class="dt">@_sinkDown</span> <span class="dv">0</span><br />    result<br /><br />  size<span class="kw">:</span> <span class="fu">-&gt;</span> <span class="dt">@content</span><span class="kw">.</span>length<br /><br />  remove<span class="kw">:</span> <span class="fu">(node) -&gt;</span><br />    len <span class="kw">=</span> <span class="dt">@content</span><span class="kw">.</span>length<br />    <span class="co"># To remove a value, we must search through the</span><br />    <span class="co"># array to find it.</span><br />    <span class="kw">for</span> i <span class="kw">in</span> <span class="kw">[</span><span class="dv">0</span><span class="kw">...</span>len<span class="kw">]</span><br />      <span class="kw">if</span> <span class="dt">@content</span><span class="kw">[</span>i<span class="kw">]</span> <span class="kw">is</span> node<br />        <span class="co"># When it is found, the process seen in 'pop'</span><br />        <span class="co"># is repeated to fill up the hole.</span><br />        end <span class="kw">=</span> <span class="dt">@content</span><span class="kw">.</span>pop<span class="kw">()</span><br />        <span class="kw">if</span> i <span class="kw">isnt</span> len <span class="kw">-</span> <span class="dv">1</span><br />          <span class="dt">@content</span><span class="kw">[</span>i<span class="kw">]</span> <span class="kw">=</span> end<br />          <span class="kw">if</span> <span class="dt">@scoreFunction</span><span class="kw">(</span>end<span class="kw">)</span> <span class="kw">&lt;</span> <span class="dt">@scoreFunction</span><span class="kw">(</span>node<span class="kw">)</span><br />            <span class="dt">@_bubbleUp</span> i<br />          <span class="kw">else</span><br />            <span class="dt">@_sinkDown</span> i<br />        <span class="kw">return</span><br />    <span class="kw">throw</span> <span class="kw">new</span> <span class="dt">Error</span> <span class="st">'Node not found.'</span><br /><br />  <span class="co"># Private</span><br />  <span class="co">#---------</span><br />  _bubbleUp<span class="kw">:</span> <span class="fu">(n) -&gt;</span><br />    <span class="co"># Fetch the element that has to be moved.</span><br />    element <span class="kw">=</span> <span class="dt">@content</span><span class="kw">[</span>n<span class="kw">]</span><br />    <span class="co"># When at 0, an element can not go up any further.</span><br />    <span class="kw">while</span> n <span class="kw">&gt;</span> <span class="dv">0</span><br />      <span class="co"># Compute the parent element index, and fetch it.</span><br />      parentN <span class="kw">=</span> <span class="ot">Math</span><span class="kw">.</span>floor<span class="kw">((</span>n <span class="kw">+</span> <span class="dv">1</span><span class="kw">)</span> <span class="kw">/</span> <span class="dv">2</span><span class="kw">)</span> <span class="kw">-</span> <span class="dv">1</span><br />      parent <span class="kw">=</span> <span class="dt">@content</span><span class="kw">[</span>parentN<span class="kw">]</span><br />      <span class="co"># Swap the elements if the parent is greater.</span><br />      <span class="kw">if</span> <span class="dt">@scoreFunction</span><span class="kw">(</span>element<span class="kw">)</span> <span class="kw">&lt;</span> <span class="dt">@scoreFunction</span><span class="kw">(</span>parent<span class="kw">)</span><br />        <span class="dt">@content</span><span class="kw">[</span>parentN<span class="kw">]</span> <span class="kw">=</span> element<br />        <span class="dt">@content</span><span class="kw">[</span>n<span class="kw">]</span> <span class="kw">=</span> parent<br />        <span class="co"># Update 'n' to continue at the new position.</span><br />        n <span class="kw">=</span> parentN<br />      <span class="co"># Found a parent that is less,</span><br />      <span class="co"># no need to move it further.</span><br />      <span class="kw">else</span><br />        <span class="kw">break</span><br />    <span class="kw">return</span><br /><br />  _sinkDown<span class="kw">:</span> <span class="fu">(n) -&gt;</span><br />    <span class="co"># Look up the target element and its score.</span><br />    length <span class="kw">=</span> <span class="dt">@content</span><span class="kw">.</span>length<br />    element <span class="kw">=</span> <span class="dt">@content</span><span class="kw">[</span>n<span class="kw">]</span><br />    elemScore <span class="kw">=</span> <span class="dt">@scoreFunction</span> element<br />    <span class="kw">loop</span><br />      <span class="co"># Compute the indices of the child elements.</span><br />      child2N <span class="kw">=</span> <span class="kw">(</span>n <span class="kw">+</span> <span class="dv">1</span><span class="kw">)</span> <span class="kw">*</span> <span class="dv">2</span><br />      child1N <span class="kw">=</span> child2N <span class="kw">-</span> <span class="dv">1</span><br />      <span class="co"># This is used to store the new position of</span><br />      <span class="co"># the element, if any.</span><br />      swap <span class="kw">=</span> <span class="ot">null</span><br />      <span class="co"># If the first child exists (is inside the array)...</span><br />      <span class="kw">if</span> child1N <span class="kw">&lt;</span> length<br />        <span class="co"># Look it up and compute its score.</span><br />        child1 <span class="kw">=</span> <span class="dt">@content</span><span class="kw">[</span>child1N<span class="kw">]</span><br />        child1Score <span class="kw">=</span> <span class="dt">this</span><span class="kw">.</span>scoreFunction child1<br />        <span class="co"># If the score is less than our elements,</span><br />        <span class="co"># we need to swap.</span><br />        <span class="kw">if</span> child1Score <span class="kw">&lt;</span> elemScore<br />          swap <span class="kw">=</span> child1N<br />      <span class="co"># Do the same checks for the other child.</span><br />      <span class="kw">if</span> child2N <span class="kw">&lt;</span> length<br />        child2 <span class="kw">=</span> <span class="dt">@content</span><span class="kw">[</span>child2N<span class="kw">]</span><br />        child2Score <span class="kw">=</span> <span class="dt">@scoreFunction</span> child2<br />        compScore <span class="kw">=</span> <span class="kw">if</span> swap <span class="kw">is</span> <span class="ot">null</span><br />            elemScore<br />          <span class="kw">else</span><br />            child1Score<br />        <span class="kw">if</span> child2Score <span class="kw">&lt;</span> compScore<br />          swap <span class="kw">=</span> child2N<br />      <span class="co"># If the element needs to be moved,</span><br />      <span class="co"># swap it, and continue.</span><br />      <span class="kw">if</span> swap <span class="kw">isnt</span> <span class="ot">null</span><br />        <span class="dt">@content</span><span class="kw">[</span>n<span class="kw">]</span> <span class="kw">=</span> <span class="dt">@content</span><span class="kw">[</span>swap<span class="kw">]</span><br />        <span class="dt">@content</span><span class="kw">[</span>swap<span class="kw">]</span> <span class="kw">=</span> element<br />        n <span class="kw">=</span> swap<br />      <span class="co"># Otherwise, we are done.</span><br />      <span class="kw">else</span><br />        <span class="kw">break</span><br />    <span class="kw">return</span><br /><br /><span class="kw">(</span>exports <span class="kw">?</span> <span class="dt">this</span><span class="kw">).</span>BinaryHeap <span class="kw">=</span> BinaryHeap</code></pre>
<p>And some test cases…</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false">runOnDemand <span class="fu">-&gt;</span><br />  sortByValue <span class="kw">=</span> <span class="fu">(obj) -&gt;</span> _<span class="kw">.</span>sortBy obj<span class="kw">,</span> <span class="fu">(n) -&gt;</span> n<br />  buildHeap <span class="kw">=</span> <span class="fu">(c, a) -&gt;</span><br />      heap <span class="kw">=</span> <span class="kw">new</span> <span class="dt">BinaryHeap</span><br />      heap<span class="kw">.</span>push number <span class="kw">for</span> number <span class="kw">in</span> a<br />      c<span class="kw">.</span>note heap<br /><br />  declare <span class="st">'heap is created empty'</span><span class="kw">,</span> <span class="kw">[],</span><br />    <span class="fu">(c) -&gt;</span> c<span class="kw">.</span>assert <span class="kw">(</span><span class="kw">new</span> <span class="dt">BinaryHeap</span><span class="kw">).</span>size<span class="kw">()</span> <span class="kw">is</span> <span class="dv">0</span><br /><br />  declare <span class="st">'heap pop is undefined when empty'</span><span class="kw">,</span> <span class="kw">[],</span><br />    <span class="fu">(c) -&gt;</span> c<span class="kw">.</span>assert _<span class="kw">.</span>isUndefined <span class="kw">(</span><span class="kw">new</span> <span class="dt">BinaryHeap</span><span class="kw">).</span>pop<span class="kw">()</span><br /><br />  declare <span class="st">'heap contains number of inserted elements'</span><span class="kw">,</span><br />    <span class="kw">[</span>arbArray<span class="kw">(</span>arbInt<span class="kw">)],</span> <span class="fu">(c, a) -&gt;</span><br />      c<span class="kw">.</span>assert buildHeap<span class="kw">(</span>c<span class="kw">,</span> a<span class="kw">).</span>size<span class="kw">()</span> <span class="kw">is</span> a<span class="kw">.</span>length<br /><br />  declare <span class="st">'heap contains inserted elements'</span><span class="kw">,</span><br />    <span class="kw">[</span>arbArray<span class="kw">(</span>arbInt<span class="kw">)],</span> <span class="fu">(c, a) -&gt;</span><br />      heap <span class="kw">=</span> buildHeap c<span class="kw">,</span> a<br />      c<span class="kw">.</span>assert _<span class="kw">.</span>isEqual sortByValue<span class="kw">(</span>a<span class="kw">),</span> \<br />        sortByValue<span class="kw">(</span>heap<span class="kw">.</span>content<span class="kw">)</span><br /><br />  declare <span class="st">'heap pops elements in sorted order'</span><span class="kw">,</span><br />    <span class="kw">[</span>arbArray<span class="kw">(</span>arbInt<span class="kw">)],</span> <span class="fu">(c, a) -&gt;</span><br />      heap <span class="kw">=</span> buildHeap c<span class="kw">,</span> a<br />      <span class="kw">for</span> n <span class="kw">in</span> sortByValue a <span class="kw">then</span> c<span class="kw">.</span>assert n <span class="kw">is</span> heap<span class="kw">.</span>pop<span class="kw">()</span><br />      c<span class="kw">.</span>assert heap<span class="kw">.</span>size<span class="kw">()</span> <span class="kw">is</span> <span class="dv">0</span><br /><br />  declare <span class="st">'heap does not remove non-existent elements'</span><span class="kw">,</span><br />    <span class="kw">[</span>arbArray<span class="kw">(</span>arbInt<span class="kw">),</span> arbInt<span class="kw">],</span><br />    expectException <span class="fu">(c, a, b) -&gt;</span><br />      <span class="kw">if</span> b <span class="kw">in</span> a <span class="kw">then</span> c<span class="kw">.</span>guard <span class="ot">false</span><br />      heap <span class="kw">=</span> buildHeap c<span class="kw">,</span> a<br />      heap<span class="kw">.</span>remove b<br /><br />  declare <span class="st">'heap removes existing elements'</span><span class="kw">,</span><br />    <span class="kw">[</span>arbArray<span class="kw">(</span>arbInt<span class="kw">),</span> arbInt<span class="kw">],</span> <span class="fu">(c, a, b) -&gt;</span><br />      <span class="kw">if</span> <span class="kw">not</span> <span class="kw">(</span>b <span class="kw">in</span> a<span class="kw">)</span> <span class="kw">then</span> c<span class="kw">.</span>guard <span class="ot">false</span><br />      aSort <span class="kw">=</span> sortByValue _<span class="kw">.</span>without a<span class="kw">,</span> b<br />      count <span class="kw">=</span> a<span class="kw">.</span>length <span class="kw">-</span> aSort<span class="kw">.</span>length<br />      heap <span class="kw">=</span> buildHeap c<span class="kw">,</span> a<br />      heap<span class="kw">.</span>remove b <span class="kw">for</span> i <span class="kw">in</span> <span class="kw">[</span><span class="dv">0</span><span class="kw">...</span>count<span class="kw">]</span><br />      <span class="kw">for</span> n <span class="kw">in</span> aSort <span class="kw">then</span> c<span class="kw">.</span>assert n <span class="kw">is</span> heap<span class="kw">.</span>pop<span class="kw">()</span><br />      c<span class="kw">.</span>assert heap<span class="kw">.</span>size<span class="kw">()</span> <span class="kw">is</span> <span class="dv">0</span><br /><br />  test<span class="kw">()</span></code></pre>
<hr />
</section>
</section>
<section id="performance">
<h3>Performance</h3>
<hr />
<p>To give an idea of the relative performance of CoffeeScript for problem solving and number crunching we can compare it with CPython. First a small test of operations on a million floating point numbers.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false"><span class="co"># CoffeeScript</span><br /><br />runOnDemand <span class="fu">-&gt;</span><br />  start <span class="kw">=</span> <span class="kw">new</span> <span class="dt">Date</span><span class="kw">()</span><br /><br />  N <span class="kw">=</span> <span class="dv">1000000</span><br />  a <span class="kw">=</span> <span class="ot">Array</span><span class="kw">(</span>N<span class="kw">)</span><br />  <span class="kw">for</span> i <span class="kw">in</span> <span class="kw">[</span><span class="dv">0</span><span class="kw">...</span>N<span class="kw">]</span><br />    a<span class="kw">[</span>i<span class="kw">]</span> <span class="kw">=</span> <span class="ot">Math</span><span class="kw">.</span>random<span class="kw">()</span><br /><br />  s <span class="kw">=</span> <span class="dv">0</span><br />  <span class="kw">for</span> v <span class="kw">in</span> a<br />    s <span class="kw">+=</span> v<br /><br />  t <span class="kw">=</span> <span class="dv">0</span><br />  <span class="kw">for</span> v <span class="kw">in</span> a<br />    t <span class="kw">+=</span> v<span class="kw">*</span>v<br />  t <span class="kw">=</span> <span class="ot">Math</span><span class="kw">.</span>sqrt t<br /><br />  duration <span class="kw">=</span> <span class="kw">new</span> <span class="dt">Date</span><span class="kw">()</span> <span class="kw">-</span> start<br />  show <span class="st">&quot;N: </span><span class="ch">#{</span>N<span class="ch">}</span><span class="st"> in </span><span class="ch">#{</span>duration*0.001<span class="ch">}</span><span class="st"> s&quot;</span><br />  show <span class="st">&quot;Result: </span><span class="ch">#{</span>s<span class="ch">}</span><span class="st"> and </span><span class="ch">#{</span>t<span class="ch">}</span><span class="st">&quot;</span></code></pre>
<pre class="sourceCode"><code class="sourceCode python"><span class="co"># CPython</span><br /><span class="ch">import</span> time<br /><span class="ch">import</span> random<br /><span class="ch">import</span> math<br /><br />start = time.clock()<br />N = <span class="dv">1000000</span><br />a = [random.random()<br />  <span class="kw">for</span> i in <span class="dt">range</span>(N)]<br /><br />s = <span class="dv">0</span><br /><span class="kw">for</span> v in a:<br />  s += v<br /><br />t = <span class="dv">0</span><br /><span class="kw">for</span> v in a:<br />  t += v*v<br />t = math.sqrt(t)<br /><br />duration = time.clock() - start<br /><span class="kw">print</span> <span class="st">'N:'</span>, N, <span class="st">'in'</span>, duration, <span class="st">'s'</span><br /><span class="kw">print</span> <span class="st">'Result:'</span>, s, <span class="st">'and'</span>, t</code></pre>
<pre class="sourceCode"><code class="sourceCode cpp"><span class="co">// C++ pointer-free version using standard valarray template.</span><br /><span class="co">// LLVM: clang++ -O3 -std=c++0x A3-Microrun.cpp -o mb; ./mb</span><br /><span class="co">// Visual 2010 C++: cl /Ox /Ob2 /Oi /Ot /Oy- /EHsc A3-Microrun.cpp</span><br /><br /><span class="ot">#include </span><span class="ot">&lt;cstdlib&gt;</span><br /><span class="ot">#include </span><span class="ot">&lt;cmath&gt;</span><br /><span class="ot">#include </span><span class="ot">&lt;ctime&gt;</span><br /><span class="ot">#include </span><span class="ot">&lt;valarray&gt;</span><br /><span class="ot">#include </span><span class="ot">&lt;iostream&gt;</span><br /><br /><span class="kw">using</span> <span class="kw">namespace</span> std;<br /><br /><span class="kw">inline</span> <span class="dt">double</span> rand01() {<br />    <span class="kw">return</span> <span class="kw">static_cast</span>&lt;<span class="dt">double</span>&gt;(rand()) /<br />           <span class="kw">static_cast</span>&lt;<span class="dt">double</span>&gt;(RAND_MAX);<br />}<br /><br /><span class="dt">void</span> test() {<br />    clock_t start = clock();<br /><br />    <span class="dt">static</span> <span class="dt">const</span> size_t N = <span class="dv">1000000</span>;<br />    valarray&lt;<span class="dt">double</span>&gt; a(N);<br />    <span class="kw">for</span> (size_t i = <span class="dv">0</span>; i &lt; N; ++i)<br />        a[i] = rand01();<br /><br />    <span class="dt">double</span> s = a.sum();<br />    <span class="dt">double</span> t = sqrt((a*a).sum());<br /><br />    <span class="dt">double</span> duration = (clock() - start) /<br />        <span class="kw">static_cast</span>&lt;<span class="dt">double</span>&gt;(CLOCKS_PER_SEC);<br />    cout &lt;&lt; <span class="st">&quot;N: &quot;</span> &lt;&lt; N &lt;&lt; <span class="st">&quot; in &quot;</span> &lt;&lt; duration &lt;&lt; <span class="st">&quot;s&quot;</span> &lt;&lt; endl;<br />    cout &lt;&lt; <span class="st">&quot;Result: &quot;</span> &lt;&lt; s &lt;&lt; <span class="st">&quot; and &quot;</span> &lt;&lt; t &lt;&lt; endl;    <br />}<br /><br /><span class="dt">int</span> main() {<br />    srand(<span class="kw">static_cast</span>&lt;<span class="dt">unsigned</span> <span class="dt">int</span>&gt;(time(NULL)));<br />    test();<br />    <span class="kw">return</span> <span class="dv">0</span>;<br />}</code></pre>
<p>The source code and the results are quite similar. On my machine the time for CoffeeScript is about 0.41s and around 1.03s for CPython. You can try it yourself with <code>coffee A3-Microbench.coffee</code> and if you have CPython installed <code>python A3-Microtest.py</code>. C++ is 10 × to 30 × faster.</p>
<section id="section-251">
<h5>○•○</h5>
<p>Below you can find implementations<sup><a href="#fn37" class="footnoteRef" id="fnref37">37</a></sup> for the classic 8 queens problem. The objective is to place eight queens on a chessboard without any of the queens occupying the same row, column or diagonal. The two implementations use the same algorithm and produce the same results. Timing for CPython 0.27s and for CoffeeScript 0.06s.</p>
<pre class="sourceCode"><code class="sourceCode coffeescript" contenteditable="true" spellcheck="false"><span class="co"># CoffeeScript encoding: utf-8</span><br /><br /><span class="co"># Create variations to try</span><br />permute <span class="kw">=</span> <span class="fu">(L) -&gt;</span><br />  n <span class="kw">=</span> L<span class="kw">.</span>length<br />  <span class="kw">return</span> <span class="kw">([</span>elem<span class="kw">]</span> <span class="kw">for</span> elem <span class="kw">in</span> L<span class="kw">)</span> <span class="kw">if</span> n <span class="kw">is</span> <span class="dv">1</span><br />  <span class="kw">[</span>a<span class="kw">,</span> L<span class="kw">]</span> <span class="kw">=</span> <span class="kw">[</span> <span class="kw">[</span>L<span class="kw">[</span><span class="dv">0</span><span class="kw">]],</span> L<span class="kw">.</span>slice <span class="dv">1</span> <span class="kw">]</span><br />  result <span class="kw">=</span> <span class="kw">[]</span><br />  <span class="kw">for</span> p <span class="kw">in</span> permute L<br />    <span class="kw">for</span> i <span class="kw">in</span> <span class="kw">[</span><span class="dv">0</span><span class="kw">...</span>n<span class="kw">]</span><br />      result<span class="kw">.</span>push p<span class="kw">[...</span>i<span class="kw">].</span>concat a<span class="kw">,</span> p<span class="kw">[</span>i<span class="kw">...]</span><br />  result<br /><br /><span class="co"># Check a variation</span><br />test <span class="kw">=</span> <span class="fu">(p, n) -&gt;</span><br />  <span class="kw">for</span> i <span class="kw">in</span> <span class="kw">[</span><span class="dv">0</span><span class="kw">...</span>n <span class="kw">-</span> <span class="dv">1</span><span class="kw">]</span><br />    <span class="kw">for</span> j <span class="kw">in</span> <span class="kw">[</span>i <span class="kw">+</span> <span class="dv">1</span><span class="kw">...</span>n<span class="kw">]</span><br />      d <span class="kw">=</span> p<span class="kw">[</span>i<span class="kw">]</span> <span class="kw">-</span> p<span class="kw">[</span>j<span class="kw">]</span><br />      <span class="kw">return</span> <span class="ot">true</span> <span class="kw">if</span> j <span class="kw">-</span> i <span class="kw">is</span> d <span class="kw">or</span> i <span class="kw">-</span> j <span class="kw">is</span> d<br />  <span class="ot">false</span><br /><br /><span class="co"># N queens solver</span><br />nQueen <span class="kw">=</span> <span class="fu">(n) -&gt;</span><br />  result <span class="kw">=</span> <span class="kw">[]</span><br />  <span class="kw">for</span> p <span class="kw">in</span> permute <span class="kw">[</span><span class="dv">0</span><span class="kw">...</span>n<span class="kw">]</span><br />    result<span class="kw">.</span>push p <span class="kw">unless</span> test p<span class="kw">,</span> n<br />  result<br /><br /><span class="co"># Repeat a string a number of times</span><br />rep <span class="kw">=</span> <span class="fu">(s, n) -&gt;</span> <span class="kw">(</span>s <span class="kw">for</span> <span class="kw">[</span><span class="dv">0</span><span class="kw">...</span>n<span class="kw">]).</span>join <span class="st">''</span><br /><br /><span class="co"># Display a board with a solution</span><br />printBoard <span class="kw">=</span> <span class="fu">(solution) -&gt;</span><br />  board <span class="kw">=</span> <span class="st">&quot;\n&quot;</span><br />  end <span class="kw">=</span> solution<span class="kw">.</span>length<br />  <span class="kw">for</span> pos<span class="kw">,</span> row <span class="kw">in</span> solution<br />    board <span class="kw">+=</span> <span class="st">&quot;</span><span class="ch">#{</span>end - row<span class="ch">}</span><span class="st"> </span><span class="ch">#{</span>rep ' &#9744; ', pos<span class="ch">}</span><span class="st"> &quot;</span> <span class="kw">+</span><br />             <span class="st">&quot;&#9813; </span><span class="ch">#{</span>rep ' &#9744; ', end - pos - 1<span class="ch">}</span><span class="st">\n&quot;</span><br />  <span class="co"># Using radix 18 hack!</span><br />  board <span class="kw">+=</span> <span class="st">'   '</span> <span class="kw">+</span> <span class="kw">(</span>n<span class="kw">.</span>toString <span class="dv">18</span> \<br />    <span class="kw">for</span> n <span class="kw">in</span> <span class="kw">[</span><span class="dv">10</span><span class="kw">...</span><span class="dv">18</span><span class="kw">]).</span>join<span class="kw">(</span><span class="st">'  '</span><span class="kw">).</span>toUpperCase<span class="kw">()</span><br />  board <span class="kw">+</span> <span class="st">&quot;\n&quot;</span><br /><br /><br /><span class="co"># Find all solutions</span><br />solve <span class="kw">=</span> <span class="fu">(n) -&gt;</span><br />  <span class="kw">for</span> solution<span class="kw">,</span> count <span class="kw">in</span> nQueen n<br />    show <span class="st">&quot;Solution </span><span class="ch">#{</span>count+1<span class="ch">}</span><span class="st">:&quot;</span><br />    show printBoard solution<br />  count<br /><br />runOnDemand <span class="fu">-&gt;</span><br />  start <span class="kw">=</span> <span class="kw">new</span> <span class="dt">Date</span><span class="kw">()</span><br />  solve <span class="dv">8</span> <span class="co"># Normal chessboard size</span><br />  show <span class="st">&quot;Timing: </span><span class="ch">#{</span>(new Date() - start)*0.001<span class="ch">}</span><span class="st">s&quot;</span></code></pre>
<pre class="sourceCode"><code class="sourceCode python"><span class="co"># CPython encoding: utf-8</span><br /><br /><span class="kw">def</span> permute(L):<br />    <span class="st">&quot;Create variations to try&quot;</span><br />    n = <span class="dt">len</span>(L)<br />    <span class="kw">if</span> n == <span class="dv">1</span>:<br />        <span class="kw">for</span> elem in L:<br />            <span class="kw">yield</span> [elem]<br />    <span class="kw">else</span>:<br />        a = [L.pop(<span class="dv">0</span>)]<br />        <span class="kw">for</span> p in permute(L):<br />            <span class="kw">for</span> i in <span class="dt">range</span>(n):<br />                <span class="kw">yield</span> p[:i] + a + p[i:]<br /><br /><span class="kw">def</span> test(p, n):<br />    <span class="st">&quot;Check a variation&quot;</span><br />    <span class="kw">for</span> i in <span class="dt">range</span>(n - <span class="dv">1</span>):<br />        <span class="kw">for</span> j in <span class="dt">range</span>(i + <span class="dv">1</span>, n):<br />            d = p[i] - p[j]<br />            <span class="kw">if</span> j - i == d or i - j == d:<br />                <span class="kw">return</span> <span class="ot">True</span><br />    <span class="kw">return</span> <span class="ot">False</span><br /><br /><span class="kw">def</span> n_queen(n):<br />    <span class="st">&quot;N queens solver&quot;</span><br />    <span class="kw">for</span> p in permute(<span class="dt">range</span>(n)):<br />        <span class="kw">if</span> not test(p, n): <span class="kw">yield</span> p<br /><br /><span class="co"># Start columns from A</span><br />base_char = <span class="dt">ord</span>(<span class="st">'A'</span>)<br /><br /><span class="kw">def</span> print_board(solution):<br />    <span class="st">&quot;Display a board with a solution&quot;</span><br />    board = []<br />    end = <span class="dt">len</span>(solution)<br />    <span class="kw">for</span> row, pos in <span class="dt">enumerate</span>(solution):<br />        board += [<span class="st">&quot;</span><span class="ch">\n</span><span class="ot">%s</span><span class="st"> </span><span class="ot">%s</span><span class="st"> &#9813; </span><span class="ot">%s</span><span class="st">&quot;</span> % ((end - row),<br />          (<span class="st">' &#9744; '</span> * pos),<br />          (<span class="st">' &#9744; '</span> * (end - pos - <span class="dv">1</span>)))]<br />    <span class="co"># Using character set hack!</span><br />    board += <span class="st">'</span><span class="ch">\n</span><span class="st">   '</span> + \<br />      <span class="st">'  '</span>.join([<span class="dt">chr</span>(base_char+i)<br />        <span class="kw">for</span> i in <span class="dt">range</span>(<span class="dv">0</span>, end)])<br />    <span class="kw">return</span> <span class="st">''</span>.join(board) + <span class="st">'</span><span class="ch">\n</span><span class="st">'</span><br /><br /><span class="kw">def</span> solve(n):<br />    <span class="st">&quot;Find all solutions&quot;</span><br />    <span class="kw">for</span> count, solution in <span class="dt">enumerate</span>(n_queen(n)):<br />        <span class="kw">print</span> <span class="st">&quot;Solution </span><span class="ot">%d</span><span class="st">:&quot;</span> % count<br />        <span class="kw">print</span> print_board(solution)<br />    <span class="kw">return</span> count<br /><br /><span class="ch">import</span> time<br />t=time.clock()<br /><br />solve(<span class="dv">8</span>) <span class="co"># Normal chessboard size</span><br /><br /><span class="kw">print</span> <span class="st">&quot;Timing: &quot;</span>, time.clock()-t, <span class="st">&quot;s&quot;</span></code></pre>
<center>
Solution 1 ➞ Solution 92
</center>

<p align=center><img src="../img/queens-small.png" alt="figure ../img/queens-small.png" /><br /></p>
<hr />
</section>
</section>
<section id="command-line-utility">
<h3>Command Line Utility</h3>
<hr />
<p>The utility used to remove solutions from source files is shown here. Partly as an example of a command line program, partly to make this book and its accompanying source code self-containing.</p>
<p>The program uses the asynchronous file system functions in the same manner as server programs. The synchronous functions are more conventional, but less illustrative.</p>
<pre class="listing"><code>fs = require &quot;fs&quot;
show = console.log

String::contains = (pattern) -&gt;
  ///#{pattern}///.test this

leadingWhitespace = (str) -&gt;
  (str.match /(\s*)\w/)[1] ? &quot;&quot;

errorWrapper = (action) -&gt;
  (err, args...) -&gt;
    if err then throw err
    action args...

ifFileExists = (filename, action) -&gt;
  fs.stat filename, errorWrapper (stat) -&gt;
    if stat.isFile() then action()

getFileAsLines = (filename, action) -&gt;
  ifFileExists filename, -&gt;
    fs.readFile filename, &quot;utf8&quot;,
      errorWrapper (content) -&gt;
        action content.split &quot;\n&quot;

saveFile = (filename, content) -&gt;
  fs.writeFile filename, content,
    errorWrapper -&gt; show &quot;Saved #{filename}&quot;

stripSolutions = (lines) -&gt;
  out = &quot;&quot;
  inSolution = false
  concat = (str) -&gt; out += str + &quot;\n&quot;
  for line in lines
    if line.contains &quot;'— Exercise \\d+ —'&quot;
      inSolution = true
      concat line
      indent = leadingWhitespace line
      concat &quot;#{indent}process.exit()&quot; +
        &quot; # Replace this line with your solution&quot;
    else if inSolution
      if line.contains &quot;'— End of Exercise —'&quot;
        concat line
        inSolution = false
      # else ignore line in solution
    else
      concat line
  # Remove trailing newline
  out[...out.length-1]

stripFile = (fromName, toName) -&gt;
  if fromName?
    getFileAsLines fromName, (lines) -&gt;
      saveFile toName, stripSolutions lines
  else
    show &quot;Expected a file name &quot; +
         &quot;to strip for solutions&quot;

copyFile = (fromName, toName) -&gt;
  if fromName?
    ifFileExists fromName, -&gt;
      fs.readFile fromName, &quot;utf8&quot;,
        errorWrapper (content) -&gt;
          saveFile toName, content,
  else
    show &quot;Expected a file name to copy&quot;

toDir = &quot;../src-no-solutions&quot;
fs.mkdir toDir, 0777, (err) -&gt;
  if err
    throw err unless err.code is 'EEXIST'
    show &quot;Reusing&quot;
  else
    show &quot;Created&quot;

fromDir = process.argv[2]
if fromDir?
  fs.readdir fromDir, errorWrapper (files) -&gt;
    for filename in files
      if filename.contains &quot;\\w\\w-\\w+.coffee&quot;
        stripFile filename, &quot;#{toDir}/#{filename}&quot;
      else
        copyFile filename, &quot;#{toDir}/#{filename}&quot;
else
  show &quot;Expected a directory with &quot; +
       &quot;solutions to strip&quot;
</code></pre>
<hr />
</section>
</section>
<section id="part-v.-reference-and-index">
<h2>Part V. Reference and Index</h2>
<hr />
<section id="language-reference">
<h3>Language Reference</h3>
<hr />
<p>Also available as a two page <a href="http://autotelicum.github.com/Smooth-CoffeeScript/CoffeeScript%20Quick%20Ref.pdf">Quick Reference</a> in pdf format.</p>
<p>Refer to <a href="http://coffeescript.org">coffeescript.org</a> for further reference material and examples.</p>
<p><strong>General</strong></p>
<ul>
<li>Whitespace is significant</li>
<li>Ending a line will terminate expressions - no need to use semicolons</li>
<li>Semicolons can be used to fit multiple expressions onto a single line</li>
<li>Use indentation instead of curly braces <code>{ }</code> to surround blocks of code in functions, <code>if</code> statements, <code>switch</code>, and <code>try/catch</code></li>
<li>Comments starts with <code>#</code> and run to the end of the line</li>
</ul>
<p><strong>Embedded JavaScript</strong></p>
<ul>
<li>Use backquotes `` to embed JavaScript code within CoffeeScript</li>
</ul>
<p><strong>Functions</strong></p>
<ul>
<li>Functions are defined by an optional list of parameters in parentheses, an arrow, and an optional function body. The empty function looks like: <code>-&gt;</code></li>
<li>Mostly no need to use parentheses to invoke a function if it is passed arguments. The implicit call wraps forward to the end of the line or block expression.</li>
<li>Functions may have default values for arguments. Override the default value by passing a non-null argument.</li>
</ul>
<p><strong>Objects and arrays</strong></p>
<ul>
<li>Objects and arrays are similar to JavaScript</li>
<li>When each property is listed on its own line, the commas are optional</li>
<li>Objects may be created using indentation instead of explicit braces, similar to YAML</li>
<li>Reserved words, like <code>class</code>, can be used as properties of an object without quoting them as strings</li>
</ul>
<p><strong>Lexical Scoping and Variable Safety</strong></p>
<ul>
<li>Variables are declared implicitly when used (no <code>var</code> keyword).</li>
<li>The compiler ensures that variables are declared within lexical scope. An outer variable is not redeclared within an inner function when it is in scope</li>
<li>Using an inner variable can not shadow an outer variable, only refer to it. So avoid reusing the name of an external variable in a deeply nested function</li>
<li>CoffeeScript output is wrapped in an anonymous function, making it difficult to accidentally pollute the global namespace</li>
<li>To create top-level variables for other scripts, attach them as properties on <code>window</code>, or to <code>exports</code> in CommonJS. Use: <code>exports ? this</code></li>
</ul>
<p><strong>If, Else, Unless, and Conditional Assignment</strong></p>
<ul>
<li><code>if/else</code> can be written without parentheses and curly braces</li>
<li>Multi-line conditionals are delimited by indentation</li>
<li><code>if</code> and <code>unless</code> can be used in postfix form i.e. at the end of the statement</li>
<li><code>if</code> statements can be used as expressions. No need for <code>?:</code></li>
</ul>
<p><strong>Splats</strong></p>
<ul>
<li>Splats <code>...</code> can be used instead of the variable number of <code>arguments</code> object and are available for both function definition and invocation</li>
</ul>
<p><strong>Loops and Comprehensions</strong></p>
<ul>
<li>Comprehensions <code>for ... in</code> work over arrays, objects, and ranges</li>
<li>Comprehensions replace for loops, with optional guard clauses and the value of the current array index: <code>for value, index in array</code></li>
<li>Array comprehensions are expressions, and can be returned and assigned</li>
<li>Comprehensions may replace <code>each/forEach</code>, <code>map</code> or <code>select/filter</code></li>
<li>Use a range when the start and end of a loop is known (integer steps)</li>
<li>Use <code>by</code> to step in fixed-size increments</li>
<li>When assigning the value of a comprehension to a variable, CoffeeScript collects the result of each iteration into an array</li>
<li>Return <code>null</code>, <code>undefined</code> or <code>true</code> if a loop is only for side-effects</li>
<li>To iterate over the key and value properties in an object, use <code>of</code></li>
<li>Use: <code>for own key, value of object</code> to iterate over the keys that are directly defined on an object</li>
<li>The only low-level loop is the <code>while</code> loop. It can be used as an expression, returning an array containing the result of each iteration through the loop</li>
<li><code>until</code> is equivalent to <code>while not</code></li>
<li><code>loop</code> is equivalent to <code>while true</code></li>
<li>The <code>do</code> keyword inserts a closure wrapper, forwards any arguments and invokes a passed function</li>
</ul>
<p><strong>Array Slicing and Splicing with Ranges</strong></p>
<ul>
<li>Ranges can be used to extract slices of arrays</li>
<li>With two dots <code>[3..6]</code>, the range is inclusive (3, 4, 5, 6)</li>
<li>With three dots <code>[3...6]</code>, the range excludes the end (3, 4, 5)</li>
<li>The same syntax can be used with assignment to replace a segment of an array with new values, splicing it</li>
<li>Strings are immutable and can not be spliced</li>
</ul>
<p><strong>Everything is an Expression</strong></p>
<ul>
<li>Functions return their final value</li>
<li>The return value is fetched from each branch of execution</li>
<li>Return early from a function body by using an explicit <code>return</code></li>
<li>Variable declarations are at the top of the scope, so assignment can be used within expressions, even for variables that have not been seen before</li>
<li>Statements, when used as part of an expression, are converted into expressions with a closure wrapper. This allows assignment of the result of a comprehension to a variable</li>
<li>The following are not expressions: <code>break</code>, <code>continue</code>, and <code>return</code></li>
</ul>
<p><strong>Operators and Aliases</strong></p>
<ul>
<li>CoffeeScript compiles <code>==</code> into <code>===</code>, and <code>!=</code> into <code>!==</code>. There is no equivalent to the JavaScript <code>==</code> operator</li>
<li>The alias <code>is</code> is equivalent to <code>===</code>, and <code>isnt</code> corresponds to <code>!==</code></li>
<li><code>not</code> is an alias for <code>!</code></li>
<li>Logical operator aliases: <code>and</code> is <code>&amp;&amp;</code>, <code>or</code> is <code>||</code></li>
<li>In <code>while</code>, <code>if/else</code> and <code>switch/when</code> statements the <code>then</code> keyword can be used to keep the body on the same line</li>
<li>Alias for boolean <code>true</code> is <code>on</code> and <code>yes</code> (as in YAML)</li>
<li>Alias for boolean <code>false</code> is <code>off</code> and <code>no</code></li>
<li>For single-line statements, <code>unless</code> can be used as the inverse of <code>if</code></li>
<li>Use <code>@property</code> instead of <code>this.property</code></li>
<li>Use <code>in</code> to test for array presence</li>
<li>Use <code>of</code> to test for object-key presence</li>
</ul>
<p><strong>Existential Operator</strong></p>
<ul>
<li>Use the existential operator <code>?</code> to check if a variable exists</li>
<li><code>?</code> returns <code>true</code> unless a variable is <code>null</code> or <code>undefined</code></li>
<li>Use <code>?=</code> for safer conditional assignment than <code>||=</code> when handling numbers or strings</li>
<li>The accessor variant of the existential operator <code>?.</code> can be used to soak up null references in a chain of properties</li>
<li>Use <code>?.</code> instead of the dot accessor <code>.</code> in cases where the base value may be <code>null</code> or <code>undefined</code>. If all of the properties exist then the expected result is returned, if the chain is broken, then <code>undefined</code> is returned instead</li>
</ul>
<p><strong>Classes, Inheritance, and Super</strong></p>
<ul>
<li>Object orientation as in most other object oriented languages</li>
<li>The <code>class</code> structure allows to name the class, set the superclass with <code>extends</code>, assign prototypal properties, and define a <code>constructor</code>, in a single assignable expression</li>
<li>Constructor functions are named as the <code>class</code> name, to support reflection</li>
<li>Lower level operators: The <code>extends</code> operator helps with proper prototype setup. <code>::</code> gives access to an object’s prototype. <code>super()</code> calls the immediate ancestor’s method of the same name</li>
<li>A class definition is a block of executable code, which may be used for meta programming.</li>
<li>In the context of a class definition, <code>this</code> is the class object itself (the <code>constructor</code> function), so static properties can be assigned by using <code>@property: value</code>, and functions defined in parent classes can be called with: <code>@inheritedMethodName()</code></li>
</ul>
<p><strong>Destructuring Assignment</strong></p>
<ul>
<li>To make extracting values from complex arrays and objects convenient, CoffeeScript implements destructuring assignment</li>
<li>When assigning an array or object literal to a value, CoffeeScript breaks up and matches both sides against each other, assigning the values on the right to the variables on the left</li>
<li>The simplest case is parallel assignment <code>[a,b] = [b,a]</code></li>
<li>It can be used with functions that return multiple values</li>
<li>It can be used with any depth of array and object nesting to get deeply nested properties and can be combined with splats</li>
</ul>
<p><strong>Function binding</strong></p>
<ul>
<li>The fat arrow <code>=&gt;</code> can be used to define a function and bind it to the current value of <code>this</code></li>
<li>This is helpful when using callback-based libraries, for creating iterator functions to pass to <code>each</code> or event-handler functions to use with <code>bind</code></li>
<li>Functions created with <code>=&gt;</code> are able to access properties of the <code>this</code> where they are defined</li>
</ul>
<p><strong>Switch/When/Else</strong></p>
<ul>
<li>The <code>switch</code> statement do not need a <code>break</code> after every case</li>
<li>A <code>switch</code> is a returnable, assignable expression</li>
<li>The format is: <code>switch</code> condition, <code>when</code> clauses, <code>else</code> the default case</li>
<li>Multiple values, comma separated, can be given for each <code>when</code> clause. If any of the values match, the clause runs</li>
</ul>
<p><strong>Try/Catch/Finally</strong></p>
<ul>
<li><code>try/catch</code> statements are as in JavaScript (although they are expressions)</li>
</ul>
<p><strong>String Interpolation, Heredocs, and Block Comments</strong></p>
<ul>
<li>Single-quoted strings are literal. Use backslash for escape characters</li>
<li>Double-quoted strings allow for interpolated values, using <code>#{ ... }</code></li>
<li>Multiline strings are allowed</li>
<li>A heredoc <code>'''</code> can be used for formatted or indentation-sensitive text (or to avoid escaping quotes and apostrophes)</li>
<li>The indentation level that begins a heredoc is maintained throughout, so the text can be aligned with the body of the code</li>
<li>Double-quoted heredocs <code>&quot;&quot;&quot;</code> allow for interpolation</li>
<li>Block comments <code>###</code> are similar to heredocs, and are preserved in the generated code</li>
</ul>
<p><strong>Chained Comparisons</strong></p>
<ul>
<li>Use a chained comparison <code>minimum &lt; value &lt; maximum</code> to test if a value falls within a range</li>
</ul>
<p><strong>Extended Regular Expressions</strong></p>
<ul>
<li>Extended regular expressions “heregexes” are delimited by <code>///</code> and are similar to heredocs and block comments</li>
<li>Extended regular expressions ignore internal whitespace and can contain comments</li>
</ul>
<hr />
</section>
<section id="reserved-words">
<h3>Reserved Words</h3>
<hr />
<p><em>Keywords</em></p>
<pre><code>break             by                catch
class             continue          debugger
delete            do                else
extends           false             finally
for               if                in
instanceof        loop              new
null              of                return
super             switch            then
this              throw             true
try               typeof            undefined
unless            until             when
while
</code></pre>
<p><em>Aliases</em></p>
<pre><code>and  :  &amp;&amp;        or   :  ||        not  :  !
is   :  ==        isnt :  !=
yes  :  true      no   :  false
on   :  true      off  :  false
</code></pre>
<hr />
</section>
<section id="underscore">
<h3>Underscore</h3>
<hr />
<p>General call convention: <code>functional obj, iterator, context</code>.</p>
<p>See the <a href="http://autotelicum.github.com/Smooth-CoffeeScript/literate/underscore.html">interactive Underscore reference</a>.</p>
<p>Read the <a href="http://jashkenas.github.com/coffee-script/documentation/docs/underscore.html">annotated source</a>.</p>
<hr />
</section>
<section id="quickcheck">
<h3>QuickCheck</h3>
<hr />
<p>Exported definitions from prelude version of <code>qc.js</code></p>
<dl>
<dt><strong>arbChoose</strong></dt>
<dd><p>Generator that chooses uniformly among the given generators.<br /><code>parameter: generators…</code></p>
</dd>
<dt><strong>arbConst</strong></dt>
<dd><p>Generator that always returns one of the given constant values.<br /><code>parameter: values…</code></p>
</dd>
<dt><strong>arbBool</strong></dt>
<dd><p>Boolean value generator with 50:50 chance of <code>true</code> or <code>false</code>.</p>
</dd>
<dt><strong>arbNull</strong></dt>
<dd><p>Null generator that always generates <code>null</code>.</p>
</dd>
<dt><strong>arbWholeNum</strong></dt>
<dd><p>Integer value generator for values ≥ 0. Supports shrinking.</p>
</dd>
<dt><strong>arbInt</strong></dt>
<dd><p>Integer value generator. Supports shrinking.</p>
</dd>
<dt><strong>arbFloatUnit</strong></dt>
<dd><p>Generator for a floating point value in between 0.0 and 1.0. Supports shrinking.</p>
</dd>
<dt><strong>arbRange</strong></dt>
<dd><p>Integer range value generator.<br /><code>parameter minimum value</code><br /><code>parameter maximum value</code></p>
</dd>
<dt><strong>arbNullOr</strong></dt>
<dd><p>Chooses <code>null</code> with 10% probability and the given generator with 90%. Supports shrinking.<br /><code>parameter another generator</code></p>
</dd>
<dt><strong>arrShrinkOne</strong></dt>
<dd><p>Array shrinking strategy that builds new Arrays by removing one element from a given array.</p>
</dd>
<dt><strong>arbArray</strong></dt>
<dd><p>Array generator. Generates an array of arbitrary length with the given generator.<br /><code>parameter generator that creates the resulting array values.</code><br /><code>parameter an optional shrinking strategy. Default is 'arrShrinkOne'.</code></p>
</dd>
<dt><strong>arbDate</strong></dt>
<dd><p>Date value generator. Always generates a new Date object by calling <code>new Date()</code>.</p>
</dd>
<dt><strong>arbMod</strong></dt>
<dd><p>Basis generator for arbChar and arbString.</p>
</dd>
<dt><strong>arbChar</strong></dt>
<dd><p>Character value generator for any character with character code in range 32–255.</p>
</dd>
<dt><strong>arbString</strong></dt>
<dd><p>String value generator. All characters in the generated String are in range 32–255. Supports shrinking.</p>
</dd>
<dt><strong>arbUndef</strong></dt>
<dd><p>Generator that always generates <code>undefined</code>.</p>
</dd>
<dt><strong>arbUndefOr</strong></dt>
<dd><p>Chooses undefined with 10% probability and the given generator with 90%. Supports shrinking.<br /><code>parameter another generator</code></p>
</dd>
<dt><strong>expectException</strong></dt>
<dd><p>Property test function modifier. Using this modifier, it is assumed that the testing function will throw an exception and if not the property will fail.</p>
</dd>
<dt><strong>failOnException</strong></dt>
<dd><p>Property test function modifier. Instead of finishing testing when an unexpected exception is thrown, the offending property is marked as failure and <code>qc</code> will continue.</p>
</dd>
<dt><strong>Case</strong></dt>
<dd><p>Test case class generated every time a property is tested. An instance of Case is always passed as first argument to a property’s testing function so it can control the test case’s properties.</p>
</dd>
<dt><strong>Case::assert</strong></dt>
<dd><p>Tests and notifies <code>qc</code> if a property fails or not.<br /><code>parameter pass false, if the property failed, true otherwise</code></p>
</dd>
<dt><strong>Case::guard</strong></dt>
<dd><p>Used to test if the input is good for testing the property.<br /><code>parameter pass false to mark the property as invalid for the given input.</code></p>
</dd>
<dt><strong>Case::classify</strong></dt>
<dd><p>Adds a tag to a test run.<br /><code>parameter if true then the tag is added to the case, else not.</code><br /><code>parameter tag value to add</code></p>
</dd>
<dt><strong>Case::collect</strong></dt>
<dd><p>Collect builds a histogram of all collected values for all runs of the property.<br /><code>parameter value to collect</code></p>
</dd>
<dt><strong>Case::noteArg</strong></dt>
<dd><p>Adds the given value to the test case for reporting in case of failure.<br /><code>parameter value to add</code></p>
</dd>
<dt><strong>Case::note</strong></dt>
<dd><p>Same as Case::noteArg but returning its argument so it can be used inline. Defined in prelude.</p>
</dd>
<dt><strong>Case::noteVerbose</strong></dt>
<dd><p>Same as Case::note but also logs the noted args. Defined in prelude.</p>
</dd>
<dt><strong>declare</strong></dt>
<dd><p>Builds and registers a new property.<br /><code>parameter the property's name</code><br /><code>parameter array of generators with a length equal to the arity of the body function. The entry at position i will drive the i-th argument of the body function.</code><br /><code>parameter body function that test the property</code><br /><code>return a new registered property object of type Prop.</code></p>
</dd>
<dt><strong>testPure</strong></dt>
<dd><p>Helper to declare a named test property for a pure function. Defined in prelude.<br /><code>parameter function to test</code><br /><code>parameter array of generators matching argument types</code><br /><code>parameter a descriptive name</code><br /><code>parameter property function which is passed the test-case, the arguments and the result of calling the function being tested. Must return true if the property test succeeded, false otherwise.</code></p>
</dd>
<dt><strong>Prop</strong></dt>
<dd><p>Creates a new property with a given array of argument generators and a testing function. For each generator a value is generated, so for testing a 2-ary function the array must contain 2 generators.</p>
</dd>
<dt><strong>Prop::run</strong></dt>
<dd><p>Tests the property.<br /><code>parameter configuration of type Config to test property with</code><br /><code>return depending on test result a Pass, Fail or Invalid object</code></p>
</dd>
<dt><strong>allProps</strong></dt>
<dd><p>Internal array of all declared/registered properties</p>
</dd>
<dt><strong>resetProps</strong></dt>
<dd><p>Deletes all declared properties.</p>
</dd>
<dt><strong>runAllProps</strong></dt>
<dd><p>Tests all registered properties.<code>\</code>parameter configuration of type Config to test the properties with<code>\</code>parameter listener of a subclass of ConsoleListener`</p>
</dd>
<dt><strong>test</strong></dt>
<dd><p>Test all known properties with a NodeListener and a configuration of 100 pass and 1000 invalid tests. Defined in prelude.</p>
</dd>
<dt><strong>Invalid</strong></dt>
<dd><p>Report class for invalid tested properties.</p>
</dd>
<dt><strong>Pass</strong></dt>
<dd><p>Report class for successful tested properties.</p>
</dd>
<dt><strong>Fail</strong></dt>
<dd><p>Report class for failed tested properties.</p>
</dd>
<dt><strong>Stats</strong></dt>
<dd><p>Statistics class for counting number of pass/invalid runs, building histograms and other statistics for reporting on a property and its test results.</p>
</dd>
<dt><strong>Config</strong></dt>
<dd><p>Testing Configuration.<code>\</code>parameter maximum passes per property<code>\</code>parameter maximum invalid tests per property<code>\</code>parameter maximum number of shrinking steps per property`</p>
</dd>
<dt><strong>ConsoleListener</strong></dt>
<dd><p>Abstract class for building ‘console’ based listeners.</p>
</dd>
<dt><strong>NodeListener</strong></dt>
<dd><p>Listener with node compatible output in colors. Defined in prelude.</p>
</dd>
<dt><strong>FBCListener</strong></dt>
<dd><p>Listener for sending property results to FireBug’s console</p>
</dd>
<dt><strong>RhinoListener</strong></dt>
<dd><p>Listener for Rhino, sending property results to stdout.</p>
</dd>
<dt><strong>Distribution</strong></dt>
<dd><p>Probability distributions</p>
</dd>
<dt><strong>genvalue</strong></dt>
<dd><p>Draws a new value from a generator. A generator is either a function accepting a seed argument or an object with a method ‘arb’ accepting a seed argument.</p>
</dd>
<dt><strong>genshrinked</strong></dt>
<dd><p>Uses the generator specific shrinking method to shrink a value that the generator created earlier. If the generator is a function or has no method named ‘shrink’ or is an objects with a ‘shrink’ method set to <code>null</code>, then no shrinking will be performed. If a shrinking method is defined, then it is called with the original seed and the value the generator created. The shrinking method must return an array of ‘shrinked’ values or null, undefined, or an empty array if no ‘shrinked’ values could be created.</p>
</dd>
<dt><strong>justSize</strong></dt>
<dd><p>Passes the size ‘seed’ argument used to drive generators directly to the property test function.</p>
</dd>
<dt><strong>Utilities</strong></dt>
<dd><p>A group of utilities that can be used to build generators: <code>frequency</code>, <code>choose</code>, <code>randWhole</code>, <code>randInt</code>, <code>randRange</code>, <code>randFloatUnit</code>.</p>
</dd>
</dl>
<hr />
</section>
<section id="additional-words">
<h3>Additional Words</h3>
<hr />
<p><em>Prelude definitions</em></p>
<pre class="sourceCode"><code class="sourceCode COFFEESCRIPT">show              globalize<br />confirm           prompt            getServerURL<br />viewURL           viewServer        stopServer<br />fileExists        readTextFile      readBinaryFile<br />_                 kup               qc</code></pre>
<p>Refer to <code>src/prelude/prelude.coffee</code> for the annotated source.</p>
<p><em>CoffeeScript environment</em></p>
<pre class="sourceCode"><code class="sourceCode COFFEESCRIPT">Buffer            <span class="ot">clearInterval</span>     <span class="ot">clearTimeout</span><br /><span class="ot">console</span>           global            GLOBAL<br />process           root              <span class="ot">setInterval</span><br /><span class="ot">setTimeout</span></code></pre>
<p>View the interactive environment with: →∣ / ‘Tab’.</p>
<p><em>JavaScript future words</em></p>
<pre class="listing"><code>abstract    boolean     byte        case
char        const       default     double
enum        export      final       float
function    goto        implements  import
int         interface   let         long
native      package     private     protected
public      short       static      synchronized
throws      transient   var         void
volatile    with        yield
</code></pre>
<!--

* * * * * * * * * *

## Index

* * * * * * * * * *


%: [↑](#entry-%-0)

&&: [↑](#entry-&&-0)

(): [↑](#entry-()-0), [↑](#entry-()-1)

\*=: [↑](#entry-*=-0)

++: [↑](#entry-++-0)

+=: [↑](#entry-+=-0)

-: [↑](#entry---0)

-\>: [↑](#entry--%3E-0)

--: [↑](#entry---0)

-=: [↑](#entry--=-0)

/: [↑](#entry-/-0)

///: [↑](#entry-///-0)

/=: [↑](#entry-/=-0)

=: [↑](#entry-=-0)

==: [↑](#entry-==-0), [↑](#entry-==-1)

?: [↑](#entry-?-0)

?.: [↑](#entry-?.-0)

A\*: [↑](#entry-A*-0)

Boolean: [↑](#entry-Boolean-0)

Date: [↑](#entry-Date-0)

Dictionary: [↑](#entry-Dictionary-0)

Error: [↑](#entry-Error-0)

HTML: [↑](#entry-HTML-0)

Math: [↑](#entry-Math-0)

Math.ceil: [↑](#entry-Math.ceil-0)

Math.floor: [↑](#entry-Math.floor-0)

Math.max: [↑](#entry-Math.max-0), [↑](#entry-Math.max-1)

Math.pow: [↑](#entry-Math.pow-0)

Math.random: [↑](#entry-Math.random-0)

Math.round: [↑](#entry-Math.round-0)

NaN: [↑](#entry-NaN-0)

Number: [↑](#entry-Number-0)

Object: [↑](#entry-Object-0)

String: [↑](#entry-String-0)

Unicode: [↑](#entry-Unicode-0)

XML: [↑](#entry-XML-0)

[]: [↑](#entry-[]-0), [↑](#entry-[]-1)

abstraction: [↑](#entry-abstraction-0)

anonymous function: [↑](#entry-anonymous-function-0)

any: [↑](#entry-any-0)

apply: [↑](#entry-apply-0), [↑](#entry-apply-1)

applying: [↑](#entry-applying-0), [↑](#entry-applying-1)

argument: [↑](#entry-argument-0), [↑](#entry-argument-1)

arguments: [↑](#entry-arguments-0)

array: [↑](#entry-array-0)

attribute: [↑](#entry-attribute-0)

backquotes: [↑](#entry-backquotes-0)

binary heap: [↑](#entry-binary-heap-0), [↑](#entry-binary-heap-1)

binary operator: [↑](#entry-binary-operator-0)

block: [↑](#entry-block-0)

body: [↑](#entry-body-0), [↑](#entry-body-1)

boolean: [↑](#entry-boolean-0)

break: [↑](#entry-break-0)

call: [↑](#entry-call-0)

capitalisation: [↑](#entry-capitalisation-0)

catch: [↑](#entry-catch-0), [↑](#entry-catch-1)

chained comparison: [↑](#entry-chained-comparison-0)

charAt: [↑](#entry-charAt-0)

class: [↑](#entry-class-0), [↑](#entry-class-1)

closure: [↑](#entry-closure-0)

comment: [↑](#entry-comment-0)

compose: [↑](#entry-compose-0)

concat: [↑](#entry-concat-0), [↑](#entry-concat-1)

confirm: [↑](#entry-confirm-0)

constructor: [↑](#entry-constructor-0), [↑](#entry-constructor-1),
[↑](#entry-constructor-2)

continue: [↑](#entry-continue-0)

control flow: [↑](#entry-control-flow-0)

corner case: [↑](#entry-corner-case-0)

delete: [↑](#entry-delete-0)

depend: [↑](#entry-depend-0)

domain-specific language: [↑](#entry-domain-specific-language-0)

efficiency: [↑](#entry-efficiency-0)

elegance: [↑](#entry-elegance-0)

else: [↑](#entry-else-0)

embedded JavaScript: [↑](#entry-embedded-JavaScript-0)

encapsulation: [↑](#entry-encapsulation-0)

environment: [↑](#entry-environment-0)

eval: [↑](#entry-eval-0)

every: [↑](#entry-every-0)

exception: [↑](#entry-exception-0)

exception handling: [↑](#entry-exception-handling-0)

existential accessor: [↑](#entry-existential-accessor-0)

existential operator: [↑](#entry-existential-operator-0)

exports: [↑](#entry-exports-0)

expression: [↑](#entry-expression-0)

extends: [↑](#entry-extends-0)

filter: [↑](#entry-filter-0)

finally: [↑](#entry-finally-0)

for: [↑](#entry-for-0)

forEachOf: [↑](#entry-forEachOf-0)

fragile base class: [↑](#entry-fragile-base-class-0),
[↑](#entry-fragile-base-class-1)

function: [↑](#entry-function-0), [↑](#entry-function-1)

function composition: [↑](#entry-function-composition-0)

functional programming: [↑](#entry-functional-programming-0)

generate and test: [↑](#entry-generate-and-test-0)

getProperty: [↑](#entry-getProperty-0)

getTimezoneOffset: [↑](#entry-getTimezoneOffset-0)

graph: [↑](#entry-graph-0)

hasOwnProperty: [↑](#entry-hasOwnProperty-0)

heredocs: [↑](#entry-heredocs-0)

hidden properties: [↑](#entry-hidden-properties-0)

higher-order function: [↑](#entry-higher-order-function-0)

if: [↑](#entry-if-0)

indentation: [↑](#entry-indentation-0), [↑](#entry-indentation-1)

indexOf: [↑](#entry-indexOf-0)

interface: [↑](#entry-interface-0)

invoking: [↑](#entry-invoking-0)

isNaN: [↑](#entry-isNaN-0)

join: [↑](#entry-join-0)

keyword: [↑](#entry-keyword-0)

length: [↑](#entry-length-0), [↑](#entry-length-1), [↑](#entry-length-2)

library: [↑](#entry-library-0)

local environment: [↑](#entry-local-environment-0)

loop: [↑](#entry-loop-0), [↑](#entry-loop-1)

map: [↑](#entry-map-0)

method: [↑](#entry-method-0)

module: [↑](#entry-module-0)

modulo: [↑](#entry-modulo-0)

mutability: [↑](#entry-mutability-0)

name-space pollution: [↑](#entry-name-space-pollution-0)

new: [↑](#entry-new-0), [↑](#entry-new-1)

newline: [↑](#entry-newline-0)

null: [↑](#entry-null-0)

number: [↑](#entry-number-0)

object: [↑](#entry-object-0)

object-oriented programming: [↑](#entry-object-oriented-programming-0)

of: [↑](#entry-of-0), [↑](#entry-of-1), [↑](#entry-of-2),
[↑](#entry-of-3)

parameter: [↑](#entry-parameter-0)

partial application: [↑](#entry-partial-application-0)

pop: [↑](#entry-pop-0)

precedence: [↑](#entry-precedence-0)

prompt: [↑](#entry-prompt-0)

properties: [↑](#entry-properties-0)

propertyIsEnumerable: [↑](#entry-propertyIsEnumerable-0)

prototype: [↑](#entry-prototype-0)

pure function: [↑](#entry-pure-function-0)

push: [↑](#entry-push-0), [↑](#entry-push-1)

raise: [↑](#entry-raise-0)

range: [↑](#entry-range-0)

read-only properties: [↑](#entry-read-only-properties-0)

recursion: [↑](#entry-recursion-0), [↑](#entry-recursion-1)

reduce: [↑](#entry-reduce-0)

reference: [↑](#entry-reference-0)

regular expression: [↑](#entry-regular-expression-0)

replace: [↑](#entry-replace-0)

reserved words: [↑](#entry-reserved-words-0)

return: [↑](#entry-return-0), [↑](#entry-return-1)

script: [↑](#entry-script-0)

search: [↑](#entry-search-0), [↑](#entry-search-1)

semicolon: [↑](#entry-semicolon-0)

set: [↑](#entry-set-0)

shadow: [↑](#entry-shadow-0)

show: [↑](#entry-show-0), [↑](#entry-show-1)

side effect: [↑](#entry-side-effect-0)

slice: [↑](#entry-slice-0)

sort: [↑](#entry-sort-0)

split: [↑](#entry-split-0)

stack: [↑](#entry-stack-0), [↑](#entry-stack-1)

statement: [↑](#entry-statement-0)

string: [↑](#entry-string-0)

substitution principle: [↑](#entry-substitution-principle-0)

super: [↑](#entry-super-0)

switch: [↑](#entry-switch-0)

tag: [↑](#entry-tag-0)

test: [↑](#entry-test-0)

testing: [↑](#entry-testing-0)

this: [↑](#entry-this-0), [↑](#entry-this-1)

throw: [↑](#entry-throw-0), [↑](#entry-throw-1)

timezone: [↑](#entry-timezone-0)

toLowerCase: [↑](#entry-toLowerCase-0)

toString: [↑](#entry-toString-0), [↑](#entry-toString-1)

toUpperCase: [↑](#entry-toUpperCase-0)

top-level environment: [↑](#entry-top-level-environment-0)

tree: [↑](#entry-tree-0)

try: [↑](#entry-try-0)

type conversion: [↑](#entry-type-conversion-0),
[↑](#entry-type-conversion-1)

unary operator: [↑](#entry-unary-operator-0)

undefined: [↑](#entry-undefined-0)

unless: [↑](#entry-unless-0)

until: [↑](#entry-until-0)

unwinding the stack: [↑](#entry-unwinding-the-stack-0)

value: [↑](#entry-value-0)

variable: [↑](#entry-variable-0)

watched properties: [↑](#entry-watched-properties-0)

while: [↑](#entry-while-0)

{}: [↑](#entry-%7B%7D-0)

||: [↑](#entry----0)

-->

<hr />
</section>
</section>
<section id="footnotes">
<h2>Footnotes</h2>
</section>
</section>
<div class="footnotes">
<hr />
<ol>
<li id="fn1"><p>The runtime environment for this interactive edition is <em>a work in progress</em>. It is itself an interactive literate HTML<sub>5</sub> application that contains its own code and documentation: <a href="./grimoire.html">Grimoire</a>.</p>
<p>The interactive edition was created with <a href="http://acme.cat-v.org/">acme</a> and <a href="http://sam.cat-v.org/">ssam</a> from <a href="http://code.swtch.com/plan9port/">plan9port</a>, <a href="http://johnmacfarlane.net/pandoc/">Pandoc</a>, <a href="http://codemirror.net/">CodeMirror</a> and <a href="http://coffeescript.org/">CoffeeScript</a>. <a href="#fnref1" class="footnoteBackLink">↩</a></p></li>
<li id="fn2"><p>The interactive environment requires a web browser with support for HTML<sub>5</sub> technologies. Most current desktop browsers (Safari, Firefox, Opera) and Mobile Safari on iOS 5 are fully compatible. Offline reading is enabled on capable browsers.</p>
<p>Chrome 16 and Internet Explorer 9 do not display MathML, but there is very little math in the book anyway. Internet Explorer 9 does not display some of the graphical output (showDocument uses a data URL), so choose another browser if possible; older versions of Internet Explorer are less functional.</p>
<p>A test of the Android 2.3 browser on a mobile device did not result in a usable interactive environment. An upgrade to a newer version was not available.</p>
<p>Used technologies and API’s: EcmaScript 5, canvas with text, data URLs, contenteditable, mathml, offline manifest, localstorage, CSS hyphenation, getElementsByClassName and UTF–8 unicode. This list relates to the interactive environment — CoffeeScript is compatible with a much wider range of browsers and servers including Internet Explorer 6. More information on <a href="http://caniuse.com">browser capabilities</a>.</p>
<p>See the <a href="http://autotelicum.github.com/Smooth-CoffeeScript/">web site</a> if you would like a static HTML or PDF version for an e-reader or print. You can also download source files from there. <a href="#fnref2" class="footnoteBackLink">↩</a></p></li>
<li id="fn3"><p>Some examples are read-only and can not be executed. A few are locked to avoid spoiling exercises, some because they are intended to run on a server, and a few only show a concept without the surrounding program. <a href="#fnref3" class="footnoteBackLink">↩</a></p></li>
<li id="fn4"><p>Manual evaluation is only intended for net-books and mobile devices without sufficient processing power. It is more inconvenient when you have to remember to evaluate <em>every</em> time you have typed something. In particular code attached to <code>Run</code> buttons do <em>not</em> change unless the newly entered program text is evaluated. <a href="#fnref4" class="footnoteBackLink">↩</a></p></li>
<li id="fn5"><p>‘Code’ is the substance that programs are made of. Every piece of a program, whether it is a single line or the whole thing, can be referred to as ‘code’. <a href="#fnref5" class="footnoteBackLink">↩</a></p></li>
<li id="fn6"><p>Bits are any kinds of two-valued things, usually described as <code>0</code>s and <code>1</code>s. Inside the computer, they take forms like a high or low electrical charge, a strong or weak signal, a shiny or dull spot on the surface of a CD. <a href="#fnref6" class="footnoteBackLink">↩</a></p></li>
<li id="fn7"><p>If you were expecting something like <code>10010000</code> here — good call, but read on. CoffeeScript’s numbers are not stored as integers. <a href="#fnref7" class="footnoteBackLink">↩</a></p></li>
<li id="fn8"><p>Actually, 53, because of a trick that can be used to get one bit for free. Look up the ‘IEEE 754’ format if you are curious about the details. <a href="#fnref8" class="footnoteBackLink">↩</a></p></li>
<li id="fn9"><p>An example of this, if <code>p = 1/3</code> then <code>6*p</code> is equal to <code>2</code>. However <code>p+p+p+p+p+p</code> is not equal to <code>2</code> because the minute rounding errors increase for every addition. This happens in the <code>for</code> loop shown in the <a href="#foreword">Foreword example, Seed of Life↑</a>. It is a general issue with floating point approximations and not a bug in CoffeeScript. A way of dealing with it is to test if a number is inside a narrow interval instead of testing for an exact match. <a href="#fnref9" class="footnoteBackLink">↩</a></p></li>
<li id="fn10"><p>Note that there is no space between the unary minus and the value. <a href="#fnref10" class="footnoteBackLink">↩</a></p></li>
<li id="fn11"><p>The bit bucket is supposedly the place where old bits are kept. On some systems, the programmer has to manually empty it now and then. Fortunately, CoffeeScript comes with a fully-automatic bit-recycling system. <a href="#fnref11" class="footnoteBackLink">↩</a></p></li>
<li id="fn12"><p>In the interactive environment the rules are slightly different. Variables can only be used outside the code block where they are defined if they are named in the <code>@globalNames</code> list (defined in <a href="#getting-started">Getting Started</a>) or if they are attached explicitly to the global environment i.e. starts with an <code>@</code>-sign or is a <code>window</code> property. This prevents unintended use of variables from earlier chapters and gives a bit of protection from accidental overwrites of system variables. <a href="#fnref12" class="footnoteBackLink">↩</a></p></li>
<li id="fn13"><p>Technically, a pure function can not use the value of any external variables. These values might change, and this could make the function return a different value for the same arguments. In practice, the programmer may consider some variables ‘constant’ — they are not expected to change — and consider functions that use only constant variables pure. Variables that contain a function value are often good examples of constant variables. <a href="#fnref13" class="footnoteBackLink">↩</a></p></li>
<li id="fn14"><p>Koen Claessen and John Hughes from Chalmers University of Technology created QuickCheck for Haskell and its ideas has since been reimplemented in many other programming languages. The <code>qc</code> library is an implementation for JavaScript by Darrin Thompson. A CoffeeScript compatible version is included in the interactive environment. <a href="#fnref14" class="footnoteBackLink">↩</a></p></li>
<li id="fn15"><p>The ECMAScript standard allows these deviations for JavaScript and thus for CoffeeScript. If you should need unlimited precision integers then either use a third party library or a more mathematically inclined programming language such as Pure. <a href="#fnref15" class="footnoteBackLink">↩</a></p></li>
<li id="fn16"><p>Maxima is the source of this result. Maxima is a computer algebra system that does symbolic and unlimited precision calculations. <a href="#fnref16" class="footnoteBackLink">↩</a></p></li>
<li id="fn17"><p>Most JavaScript test tools are compatible with CoffeeScript or can easily be adapted. <a href="#fnref17" class="footnoteBackLink">↩</a></p></li>
<li id="fn18"><p>Such a function is already present, it is <code>show</code>. <a href="#fnref18" class="footnoteBackLink">↩</a></p></li>
<li id="fn19"><p>In the underscore library you can find a function <code>isEqual</code> which compares two objects based on all layers of their contents. <a href="#fnref19" class="footnoteBackLink">↩</a></p></li>
<li id="fn20"><p>Some test cases for <code>startsWith</code> are present in the source code file for this chapter. <a href="#fnref20" class="footnoteBackLink">↩</a></p></li>
<li id="fn21"><p>In <em>Mathematica</em> a function can be set as <code>Listable</code> — eliminating the need for a loop:</p>
<pre class="listing"><code>f[x_] := If[x &gt; 0, Sqrt[x], Sqrt[-x]];
SetAttributes[f, Listable];
f[{3, 0, -2}]

⇒ {√3, 0, √2}
</code></pre>
 <a href="#fnref21" class="footnoteBackLink">↩</a></li>
<li id="fn22"><p>Unfortunately, on at least older versions of the Internet Explorer browser a lot of built-in functions, such as <code>alert</code>, are not <em>really</em> functions… or something. They report their type as <code>'object'</code> when given to the <code>typeof</code> operator, and they do not have an <code>apply</code> method. Your own functions do not suffer from this, they are always real functions. <a href="#fnref22" class="footnoteBackLink">↩</a></p></li>
<li id="fn23"><p>In the standalone environment, the prelude has a function <code>viewURL</code> that can be used to look at HTML documents. The example document above is stored in the file <code>'06-Quote.html'</code>, so you can view it by executing the following code:</p>
<pre class="sourceCode"><code class="sourceCode COFFEESCRIPT">viewURL <span class="st">'06-Quote.html'</span></code></pre>
<p>You can also run a tiny server from your program or the interactive CoffeeScript environment (REPL). It can serve a webpage either from a string variable or from a file. If you have created a web page in a string variable, say <code>stroustrupQuote</code> then you can start the server with:</p>
<pre class="sourceCode"><code class="sourceCode COFFEESCRIPT">viewServer stroustrupQuote</code></pre>
<p>Or you could give it a filename as its argument. When you are done with the server then you can either type <code>stopServer()</code> or <code>CTRL-C</code>. <a href="#fnref23" class="footnoteBackLink">↩</a></p></li>
<li id="fn24"><p>Like this… <a href="#fnref24" class="footnoteBackLink">↩</a></p></li>
<li id="fn25"><p>An <a href="http://autotelicum.github.com/Smooth-CoffeeScript/literate/partial.html">extended version</a> can allow arbitrary arguments to be fixed. <a href="#fnref25" class="footnoteBackLink">↩</a></p></li>
<li id="fn26"><p>Computers are deterministic machines: They always react in the same way to the input they receive, so they can not produce truly random values. Therefore, we have to make do with series of numbers that look random, but are in fact the result of some complicated deterministic computation. <a href="#fnref26" class="footnoteBackLink">↩</a></p></li>
<li id="fn27"><p>No really, it is. <a href="#fnref27" class="footnoteBackLink">↩</a></p></li>
<li id="fn28"><p>A few integrated development environments automatically generate diagrams as you are writing your code, for example Visual Studio Ultimate, but it is neither cheap nor compatible with CoffeeScript. <a href="#fnref28" class="footnoteBackLink">↩</a></p></li>
<li id="fn29"><p>In this case, the backslashes were not really necessary, because the characters occur between <code>[</code> and <code>]</code>, but it is easier to just escape them anyway, so you will not have to think about it. <a href="#fnref29" class="footnoteBackLink">↩</a></p></li>
<li id="fn30"><p>The main examples in this chapter show web and WebSocket servers, to run them you have to install CoffeeScript with the book source code, see <a href="../literate/install-notes.html">Quick CoffeeScript Install</a>. It is optional and you can follow along without running those examples. You can recognize the examples that you can run in the browser; they have a line in them with output below. <a href="#fnref30" class="footnoteBackLink">↩</a></p></li>
<li id="fn31"><p>The system underlying standard CoffeeScript has an EventEmitter to help you do this. Search for event in the documentation for the runtime system you use to learn more. <a href="#fnref31" class="footnoteBackLink">↩</a></p></li>
<li id="fn32"><p>Projects such as <a href="https://github.com/substack/node-browserify">browserify</a> is aiming at bringing <code>require</code> to the browser. <a href="#fnref32" class="footnoteBackLink">↩</a></p></li>
<li id="fn33"><p>How to use a separate test module is shown in <a href="#binary-heaps">Binary Heaps↓</a>. <a href="#fnref33" class="footnoteBackLink">↩</a></p></li>
<li id="fn34"><p>Depending on your operating system you can also use numerical IP addresses. <code>127.0.0.1</code> conventionally address your local machine. In a <code>hosts</code> file you can map names into IP addresses, its location depend on your operating system. <a href="#fnref34" class="footnoteBackLink">↩</a></p></li>
<li id="fn35"><p>If you want to understand how to write your own HTTP server then Manuel Kiessling has a <a href="http://www.nodebeginner.org/">tutorial</a> that you can easily translate into your own CoffeeScript web server. <a href="#fnref35" class="footnoteBackLink">↩</a></p></li>
<li id="fn36"><p>The amount of comparisons and swaps that are needed — in the worst case — can be approached by taking the logarithm (base 2) of the amount of elements in the heap. <a href="#fnref36" class="footnoteBackLink">↩</a></p></li>
<li id="fn37"><p>Background information on <a href="http://en.wikipedia.org/wiki/Eight_queens_puzzle">8 queens puzzle</a>, <a href="http://code.activestate.com/recipes/190465-generator-for-permutations-combinations-selections/">implementation</a> and <a href="http://aminsblog.wordpress.com/2011/05/29/n-queen-problem-python-2-6-5-vs-pypy-1-5-0/">performance</a>. <a href="#fnref37" class="footnoteBackLink">↩</a></p></li>
</ol>
</div>
</body>
</html>